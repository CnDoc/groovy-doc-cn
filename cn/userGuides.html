<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.0.preview.7">
<title>Groovy Language Documentation</title>
<link rel="stylesheet" href="../assets/css/style.css">
<link rel="stylesheet" href="../font-awesome.min.css">
<link rel="stylesheet" href="../prettify.min.css">
<script src="../prettify.min.js"></script>
<script>document.addEventListener('DOMContentLoaded', prettyPrint)</script>
<link rel="stylesheet" href="../assets/css/view-example.css">
<script src='../assets/js/jquery-2.1.1.min.js'></script>
<script src='../assets/js/view-example.js'></script></head>
<body class="book toc2 toc-left">

<style type="text/css">#modify_div {opacity:0.6; position: fixed;right: 0px;top: 60px;	background-color: #000000;	
height: 30px;width: 100px;border-top-width: 2px;border-right-width: 2px;border-bottom-width: 2px;border-left-width: 2px;
border-top-style: dashed;border-right-style: none;border-bottom-style: dashed;border-left-style: dashed;border-top-color: #333333;
border-right-color: #333333;border-bottom-color: #333333;border-left-color: #333333;}
#modify {display: block;position: fixed;right: 23px;top: 70px;color: #FFFFFF;text-decoration: none;font-size: 12px;font-weight: bold;}
#modify:hover {text-decoration: underline;}</style><div id="modify_div"></div>
<a href="https://github.com/CnDoc/groovy-doc-cn/blob/gh-pages/cn/userGuides.html" id="modify" target="_blank">修改本页</a>


<div id="header">
<h1>Groovy Language Documentation</h1>
<span id="revnumber">version 2.3.6</span>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="index.html">&lt;&lt;Back</a></li>
<li>


<ul class="sectlevel1">
<li><a href="userGuides.html#_user_guides">4. User Guides</a></li>
<li>
<ul class="sectlevel2">
<li><a href="userGuides.html#_getting_started">4.1. Getting started</a></li>
<li>
<ul class="sectlevel3">
<li><a href="userGuides.html#_download">4.1.1. Download</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_stable">Stable</a></li>
<li><a href="userGuides.html#_snapshots">Snapshots</a></li>
</ul>
</li>
<li><a href="userGuides.html#_maven_repository">4.1.2. Maven Repository</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_stable_release">Stable Release</a></li>
<li><a href="userGuides.html#_snapshot_releases">Snapshot Releases</a></li>
</ul>
</li>
<li><a href="userGuides.html#_gvm_the_groovy_environment_manager">4.1.3. GVM (the Groovy enVironment Manager)</a></li>
<li><a href="userGuides.html#_other_ways_to_get_groovy">4.1.4. Other ways to get Groovy</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_installation_on_mac_os_x">Installation on Mac OS X</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_macports">MacPorts</a></li>
<li><a href="userGuides.html#_homebrew">Homebrew</a></li>
</ul>
</li>
<li><a href="userGuides.html#_installation_on_windows">Installation on Windows</a></li>
<li><a href="userGuides.html#_other_distributions">Other Distributions</a></li>
<li><a href="userGuides.html#_source_code">Source Code</a></li>
<li><a href="userGuides.html#_ide_plugin">IDE plugin</a></li>
</ul>
</li>
<li><a href="userGuides.html#_install_binary">4.1.5. Install Binary</a></li>
</ul>
</li>
<li><a href="userGuides.html#_differences_with_java">4.2. Differences with Java</a></li>
<li>
<ul class="sectlevel3">
<li><a href="userGuides.html#_default_imports_2">4.2.1. Default imports</a></li>
<li><a href="userGuides.html#_multi_methods">4.2.2. Multi-methods</a></li>
<li><a href="userGuides.html#_array_initializers">4.2.3. Array initializers</a></li>
<li><a href="userGuides.html#_package_scope_visibility">4.2.4. Package scope visibility</a></li>
<li><a href="userGuides.html#_arm_blocks">4.2.5. ARM blocks</a></li>
<li><a href="userGuides.html#_inner_classes">4.2.6. Inner classes</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_static_inner_classes">Static inner classes</a></li>
<li><a href="userGuides.html#_anonymous_inner_classes">Anonymous Inner Classes</a></li>
<li><a href="userGuides.html#_creating_instances_of_non_static_inner_classes">Creating Instances of Non-Static Inner Classes</a></li>
</ul>
</li>
<li><a href="userGuides.html#_lambdas">4.2.7. Lambdas</a></li>
</ul>
</li>
<li><a href="userGuides.html#_groovy_development_kit_tbd">4.3. Groovy Development Kit (TBD)</a></li>
<li>
<ul class="sectlevel3">
<li><a href="userGuides.html#_working_with_io_tbd">4.3.1. Working with IO (TBD)</a></li>
<li><a href="userGuides.html#_working_with_collections_tbd">4.3.2. Working with collections (TBD)</a></li>
<li><a href="userGuides.html#_handy_utilities">4.3.3. Handy utilities</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_configslurper">ConfigSlurper</a></li>
<li><a href="userGuides.html#_expando">Expando</a></li>
<li><a href="userGuides.html#_observable_list_map_and_set">Observable list, map and set</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#_metaprogramming">4.4. Metaprogramming</a></li>
<li>
<ul class="sectlevel3">
<li><a href="userGuides.html#_runtime_metaprogramming_tbd">4.4.1. Runtime metaprogramming (TBD)</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_groovyobject_interface_tbd">GroovyObject interface (TBD)</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_invokemethod_tbd">invokeMethod (TBD)</a></li>
<li><a href="userGuides.html#_get_setproperty_tbd">get/setProperty (TBD)</a></li>
<li><a href="userGuides.html#_get_setmetaclass_tbd">get/setMetaClass (TBD)</a></li>
</ul>
</li>
<li><a href="userGuides.html#_get_setattribute_tbd">get/setAttribute (TBD)</a></li>
<li><a href="userGuides.html#_methodmissing">methodMissing</a></li>
<li><a href="userGuides.html#_propertymissing">propertyMissing</a></li>
<li><a href="userGuides.html#_groovyinterceptable_tbd">GroovyInterceptable (TBD)</a></li>
<li><a href="userGuides.html#_categories">Categories</a></li>
<li><a href="userGuides.html#_metaclasses_tbd">Metaclasses (TBD)</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_custom_metaclasses_tbd">Custom metaclasses (TBD)</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#_delegating_metaclass_tbd">Delegating metaclass (TBD)</a></li>
<li><a href="userGuides.html#_magic_package_tbd">Magic package (TBD)</a></li>
</ul>
</li>
<li><a href="userGuides.html#_per_instance_metaclass_tbd">Per instance metaclass (TBD)</a></li>
<li><a href="userGuides.html#metaprogramming_emc">ExpandoMetaClass</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#_methods_2">Methods</a></li>
<li><a href="userGuides.html#_properties_2">Properties</a></li>
<li><a href="userGuides.html#_constructors">Constructors</a></li>
<li><a href="userGuides.html#_static_methods">Static Methods</a></li>
<li><a href="userGuides.html#_borrowing_methods">Borrowing Methods</a></li>
<li><a href="userGuides.html#_dynamic_method_names">Dynamic Method Names</a></li>
<li><a href="userGuides.html#_runtime_discovery">Runtime Discovery</a></li>
<li><a href="userGuides.html#_groovyobject_methods">GroovyObject Methods</a></li>
<li><a href="userGuides.html#_overriding_static_invokemethod">Overriding Static invokeMethod</a></li>
<li><a href="userGuides.html#_extending_interfaces">Extending Interfaces</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#_extension_modules">Extension modules</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_extending_existing_classes">Extending existing classes</a></li>
<li><a href="userGuides.html#_instance_methods">Instance methods</a></li>
<li><a href="userGuides.html#_static_methods_2">Static methods</a></li>
<li><a href="userGuides.html#module-descriptor">Module descriptor</a></li>
<li><a href="userGuides.html#_extension_modules_and_classpath">Extension modules and classpath</a></li>
<li><a href="userGuides.html#_compatibility_with_type_checking">Compatibility with type checking</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#_compile_time_metaprogramming">4.4.2. Compile-time metaprogramming</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_available_ast_transformations">Available AST transformations</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_code_generation_transformations">Code generation transformations</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#xform-ToString">@groovy.transform.ToString</a></li>
<li><a href="userGuides.html#xform-EqualsAndHashCode">@groovy.transform.EqualsAndHashCode</a></li>
<li><a href="userGuides.html#xform-TupleConstructor">@groovy.transform.TupleConstructor</a></li>
<li><a href="userGuides.html#xform-Canonical">@groovy.transform.Canonical</a></li>
<li><a href="userGuides.html#xform-InheritConstructors">@groovy.transform.InheritConstructors</a></li>
<li><a href="userGuides.html#xform-Category">@groovy.lang.Category</a></li>
<li><a href="userGuides.html#xform-IndexedProperty">@groovy.transform.IndexedProperty</a></li>
<li><a href="userGuides.html#xform-Lazy">@groovy.lang.Lazy</a></li>
<li><a href="userGuides.html#xform-Newify">@groovy.lang.Newify</a></li>
<li><a href="userGuides.html#xform-Sortable">@groovy.lang.Sortable</a></li>
<li><a href="userGuides.html#xform-Builder">@groovy.transform.builder.Builder</a></li>
</ul>
</li>
<li><a href="userGuides.html#_class_design_annotations">Class design annotations</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#xform-Delegate">@groovy.lang.Delegate</a></li>
<li><a href="userGuides.html#xform-Immutable">@groovy.transform.Immutable</a></li>
<li><a href="userGuides.html#xform-Memoized">@groovy.transform.Memoized</a></li>
<li><a href="userGuides.html#xform-Singleton">@groovy.lang.Singleton</a></li>
<li><a href="userGuides.html#xform-Mixin">@groovy.transform.Mixin</a></li>
</ul>
</li>
<li><a href="userGuides.html#_logging_improvements">Logging improvements</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#xform-Log">@groovy.util.logging.Log</a></li>
<li><a href="userGuides.html#xform-Commons">@groovy.util.logging.Commons</a></li>
<li><a href="userGuides.html#xform-Log4j">@groovy.util.logging.Log4j</a></li>
<li><a href="userGuides.html#xform-Log4j2">@groovy.util.logging.Log4j2</a></li>
<li><a href="userGuides.html#xform-Slf4j">@groovy.util.logging.Slf4j</a></li>
</ul>
</li>
<li><a href="userGuides.html#_declarative_concurrency">Declarative concurrency</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#xform-Synchronized">@groovy.transform.Synchronized</a></li>
<li><a href="userGuides.html#xform-WithReadLock">@groovy.transform.WithReadLock and @groovy.transform.WithWriteLock</a></li>
</ul>
</li>
<li><a href="userGuides.html#_easier_cloning_and_externalizing">Easier cloning and externalizing</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#xform-AutoClone">@groovy.transform.AutoClone</a></li>
<li><a href="userGuides.html#xform-AutoExternalize">@groovy.transform.AutoExternalize</a></li>
</ul>
</li>
<li><a href="userGuides.html#_safer_scripting">Safer scripting</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#xform-ThreadInterrupt">@groovy.transform.ThreadInterrupt</a></li>
<li><a href="userGuides.html#xform-TimedInterrupt">@groovy.transform.TimedInterrupt</a></li>
<li><a href="userGuides.html#xform-ConditionalInterrupt">@groovy.transform.ConditionalInterrupt</a></li>
</ul>
</li>
<li><a href="userGuides.html#_compiler_directives">Compiler directives</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#xform-Field">@groovy.transform.Field</a></li>
<li><a href="userGuides.html#xform-PackageScope">@groovy.transform.PackageScope</a></li>
<li><a href="userGuides.html#xform-AnnotationCollector">@groovy.transform.AnnotationCollector</a></li>
<li><a href="userGuides.html#xform-TypeChecked">@groovy.transform.TypeChecked</a></li>
<li><a href="userGuides.html#xform-CompileStatic">@groovy.transform.CompileStatic</a></li>
<li><a href="userGuides.html#xform-CompileDynamic">@groovy.transform.CompileDynamic</a></li>
<li><a href="userGuides.html#xform-DelegatesTo">@groovy.lang.DelegatesTo</a></li>
</ul>
</li>
<li><a href="userGuides.html#_swing_patterns">Swing patterns</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#xform-Bindable">@groovy.beans.Bindable</a></li>
<li><a href="userGuides.html#xform-ListenerList">@groovy.beans.ListenerList</a></li>
<li><a href="userGuides.html#xform-Vetoable">@groovy.beans.Vetoable</a></li>
</ul>
</li>
<li><a href="userGuides.html#_test_assistance">Test assistance</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#xform-NotYetImplemented">@groovy.lang.NotYetImplemented</a></li>
<li><a href="userGuides.html#xform-ASTTest">@groovy.transform.ASTTest</a></li>
</ul>
</li>
<li><a href="userGuides.html#_grape_handling">Grape handling</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#xform-Grab">@groovy.lang.Grab</a></li>
<li><a href="userGuides.html#xform-GrabConfig">@groovy.lang.GrabConfig</a></li>
<li><a href="userGuides.html#xform-GrabExclude">@groovy.lang.GrabExclude</a></li>
<li><a href="userGuides.html#xform-GrabResolver">@groovy.lang.GrabResolver</a></li>
<li><a href="userGuides.html#xform-Grapes">@groovy.lang.Grapes</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#developing-ast-xforms">Developing AST transformations (TBD)</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_compilation_phases_guide_tbd">Compilation phases guide (TBD)</a></li>
<li><a href="userGuides.html#_local_transformations_tbd">Local transformations (TBD)</a></li>
<li><a href="userGuides.html#_global_transformations_tbd">Global transformations (TBD)</a></li>
<li><a href="userGuides.html#_ast_api_guide_tbd">AST API guide (TBD)</a></li>
<li><a href="userGuides.html#_testing_ast_transformations_tbd">Testing AST transformations (TBD)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#section-grape">4.5. Dependency management with Grape</a></li>
<li>
<ul class="sectlevel3">
<li><a href="userGuides.html#_quick_start">4.5.1. Quick start</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_add_a_dependency">Add a Dependency</a></li>
<li><a href="userGuides.html#Grape-SpecifyAdditionalRepositories">Specify Additional Repositories</a></li>
<li><a href="userGuides.html#Grape-MavenClassifiers">Maven Classifiers</a></li>
<li><a href="userGuides.html#Grape-ExcludingTransitiveDependencies">Excluding Transitive Dependencies</a></li>
<li><a href="userGuides.html#Grape-JDBCDrivers">JDBC Drivers</a></li>
<li><a href="userGuides.html#Grape-UsingGrapeFromtheGroovyShell">Using Grape From the Groovy Shell</a></li>
<li><a href="userGuides.html#Grape-Proxysettings">Proxy settings</a></li>
<li><a href="userGuides.html#Grape-Logging">Logging</a></li>
</ul>
</li>
<li><a href="userGuides.html#Grape-Detail">4.5.2. Detail</a></li>
<li><a href="userGuides.html#Grape-Usage">4.5.3. Usage</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#Grape-Annotation">Annotation</a></li>
<li><a href="userGuides.html#Grape-MultipleGrapeAnnotations">Multiple Grape Annotations</a></li>
<li><a href="userGuides.html#Grape-Methodcall">Method call</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#Grape-grabHashMapParameters">grab(HashMap) Parameters</a></li>
<li><a href="userGuides.html#Grape-ArgumentsMaparguments">Arguments Map arguments</a></li>
</ul>
</li>
<li><a href="userGuides.html#Grape-CommandLineTool">Command Line Tool</a></li>
<li><a href="userGuides.html#Grape-Advancedconfiguration">Advanced configuration</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#Grape-RepositoryDirectory">Repository Directory</a></li>
<li><a href="userGuides.html#Grape-CustomizeIvysettings">Customize Ivy settings</a></li>
<li><a href="userGuides.html#Grape-AddyourlocalMaven2repository">Add your local Maven2 repository</a></li>
</ul>
</li>
<li><a href="userGuides.html#Grape-MoreExamples">More Examples</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#_testing_guide">4.6. Testing Guide</a></li>
<li>
<ul class="sectlevel3">
<li><a href="userGuides.html#_introduction_2">4.6.1. Introduction</a></li>
<li><a href="userGuides.html#_language_features">4.6.2. Language Features</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_power_assertions">Power Assertions</a></li>
<li><a href="userGuides.html#_mocking_and_stubbing">Mocking and Stubbing</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_map_coercion">Map Coercion</a></li>
<li><a href="userGuides.html#_closure_coercion">Closure Coercion</a></li>
<li><a href="userGuides.html#_mockfor_and_stubfor">MockFor and StubFor</a></li>
<li><a href="userGuides.html#testing_guide_emc">Expando Meta-Class (EMC)</a></li>
</ul>
</li>
<li><a href="userGuides.html#_gdk_methods">GDK Methods</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_iterable_combinations">Iterable#combinations</a></li>
<li><a href="userGuides.html#_iterable_eachcombination">Iterable#eachCombination</a></li>
</ul>
</li>
<li><a href="userGuides.html#_tool_support">Tool Support</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_test_code_coverage">Test Code Coverage</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#_unit_tests_with_junit_3_and_4">4.6.3. Unit Tests with JUnit 3 and 4</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_junit_3">JUnit 3</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_assertion_methods">Assertion Methods</a></li>
<li><a href="userGuides.html#_shouldfail_methods">shouldFail Methods</a></li>
<li><a href="userGuides.html#_notyetimplemented_method">notYetImplemented Method</a></li>
</ul>
</li>
<li><a href="userGuides.html#_junit_4">JUnit 4</a></li>
</ul>
</li>
<li><a href="userGuides.html#_testing_with_spock">4.6.4. Testing with Spock</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_specifications">Specifications</a></li>
<li><a href="userGuides.html#_more_spock">More Spock</a></li>
</ul>
</li>
<li><a href="userGuides.html#_functional_tests_with_geb">4.6.5. Functional Tests with Geb</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_a_geb_script">A Geb Script</a></li>
<li><a href="userGuides.html#_more_geb">More Geb</a></li>
</ul>
</li>
<li><a href="userGuides.html#_other_testing_libraries_and_frameworks">4.6.6. Other Testing Libraries and Frameworks</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_testng">TestNG</a></li>
<li><a href="userGuides.html#_mockito">Mockito</a></li>
<li><a href="userGuides.html#_easymock">EasyMock</a></li>
<li><a href="userGuides.html#_jbehave">JBehave</a></li>
<li><a href="userGuides.html#_jmockit">JMockit</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#_processing_json_tbd">4.7. Processing JSON (TBD)</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_interacting_with_a_sql_database_tbd">Interacting with a SQL database (TBD)</a></li>
<li><a href="userGuides.html#_processing_xml_tbd">Processing XML (TBD)</a></li>
<li><a href="userGuides.html#_scripting_ant_tasks_tbd">Scripting Ant tasks (TBD)</a></li>
</ul>
</li>
<li><a href="userGuides.html#_template_engines">4.8. Template engines</a></li>
<li>
<ul class="sectlevel3">
<li><a href="userGuides.html#_introduction_3">4.8.1. Introduction</a></li>
<li><a href="userGuides.html#_template_framework">4.8.2. Template framework</a></li>
<li><a href="userGuides.html#_simpletemplateengine">4.8.3. SimpleTemplateEngine</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_advanced_usage_note">Advanced Usage Note</a></li>
</ul>
</li>
<li><a href="userGuides.html#_gstringtemplateengine">4.8.4. GStringTemplateEngine</a></li>
<li><a href="userGuides.html#_xmltemplateengine">4.8.5. XmlTemplateEngine</a></li>
<li><a href="userGuides.html#_the_markuptemplateengine">4.8.6. The MarkupTemplateEngine</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_the_template_format">The template format</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_basics">Basics</a></li>
<li><a href="userGuides.html#_support_methods">Support methods</a></li>
<li><a href="userGuides.html#_includes">Includes</a></li>
<li><a href="userGuides.html#_fragments">Fragments</a></li>
<li><a href="userGuides.html#_layouts">Layouts</a></li>
</ul>
</li>
<li><a href="userGuides.html#_rendering_contents">Rendering contents</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_creation_of_a_template_engine">Creation of a template engine</a></li>
<li><a href="userGuides.html#markuptemplate-config">Configuration options</a></li>
<li><a href="userGuides.html#markuptemplate-autoformat">Automatic formatting</a></li>
<li><a href="userGuides.html#markuptemplate-autoescape">Automatic escaping</a></li>
<li><a href="userGuides.html#markuptemplate-gotchas">Common gotchas</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#_strings_containing_markup">Strings containing markup</a></li>
</ul>
</li>
<li><a href="userGuides.html#markuptemplate-i18n">Internationalization</a></li>
<li><a href="userGuides.html#markuptemplate-basetemplate">Custom template classes</a></li>
</ul>
</li>
<li><a href="userGuides.html#_type_checked_templates">Type checked templates</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_optional_type_checking">Optional type checking</a></li>
<li><a href="userGuides.html#_alternative_declaration_of_types">Alternative declaration of types</a></li>
<li><a href="userGuides.html#_performance_of_type_checked_templates">Performance of type checked templates</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#_other_solutions">4.8.7. Other solutions</a></li>
</ul>
</li>
<li><a href="userGuides.html#_servlet_support_tbd">4.9. Servlet support (TBD)</a></li>
<li><a href="userGuides.html#_integrating_groovy_in_a_java_application">4.10. Integrating Groovy in a Java application</a></li>
<li>
<ul class="sectlevel3">
<li><a href="userGuides.html#_groovy_integration_mechanisms">4.10.1. Groovy integration mechanisms</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#integ-eval">Eval</a></li>
<li><a href="userGuides.html#integ-groovyshell">GroovyShell</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_multiple_sources">Multiple sources</a></li>
<li><a href="userGuides.html#_sharing_data_between_a_script_and_the_application">Sharing data between a script and the application</a></li>
<li><a href="userGuides.html#_custom_script_class">Custom script class</a></li>
</ul>
</li>
<li><a href="userGuides.html#groovyclassloader">GroovyClassLoader</a></li>
<li><a href="userGuides.html#_groovyscriptengine">GroovyScriptEngine</a></li>
<li><a href="userGuides.html#_compilationunit">CompilationUnit</a></li>
</ul>
</li>
<li><a href="userGuides.html#_bean_scripting_framework">4.10.2. Bean Scripting Framework</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_getting_started_2">Getting started</a></li>
<li><a href="userGuides.html#_passing_in_variables">Passing in variables</a></li>
<li><a href="userGuides.html#_other_calling_options">Other calling options</a></li>
<li><a href="userGuides.html#_access_to_the_scripting_engine">Access to the scripting engine</a></li>
</ul>
</li>
<li><a href="userGuides.html#jsr223">4.10.3. JSR 223 javax.script API (TBD)</a></li>
</ul>
</li>
<li><a href="userGuides.html#_domain_specific_languages">4.11. Domain-Specific Languages</a></li>
<li>
<ul class="sectlevel3">
<li><a href="userGuides.html#_command_chains">4.11.1. Command chains</a></li>
<li><a href="userGuides.html#_operator_overloading_tbd">4.11.2. Operator overloading (TBD)</a></li>
<li><a href="userGuides.html#_script_base_classes_tbd">4.11.3. Script base classes (TBD)</a></li>
<li><a href="userGuides.html#_adding_properties_to_numbers_tbd">4.11.4. Adding properties to numbers (TBD)</a></li>
<li><a href="userGuides.html#section-delegatesto">4.11.5. @DelegatesTo</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#TheDelegatesToannotation-DSLsmadeeasy">Explaining delegation strategy at compile time</a></li>
<li><a href="userGuides.html#TheDelegatesToannotation-DelegatesTo">@DelegatesTo</a></li>
<li><a href="userGuides.html#TheDelegatesToannotation-DelegatesTomodes">DelegatesTo modes</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#TheDelegatesToannotation-Simpledelegation">Simple delegation</a></li>
<li><a href="userGuides.html#TheDelegatesToannotation-Delegationstrategy">Delegation strategy</a></li>
<li><a href="userGuides.html#TheDelegatesToannotation-Delegatetoparameter">Delegate to parameter</a></li>
<li><a href="userGuides.html#TheDelegatesToannotation-Multipleclosures">Multiple closures</a></li>
<li><a href="userGuides.html#_delegating_to_a_generic_type">Delegating to a generic type</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#compilation-customizers">4.11.6. Compilation customizers</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_introduction_4">Introduction</a></li>
<li><a href="userGuides.html#_import_customizer">Import customizer</a></li>
<li><a href="userGuides.html#_ast_transformation_customizer">AST transformation customizer</a></li>
<li><a href="userGuides.html#_secure_ast_customizer">Secure AST customizer</a></li>
<li><a href="userGuides.html#_source_aware_customizer">Source aware customizer</a></li>
<li><a href="userGuides.html#_customizer_builder">Customizer builder</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_import_customizer_2">Import customizer</a></li>
<li><a href="userGuides.html#_ast_transformation_customizer_2">AST transformation customizer</a></li>
<li><a href="userGuides.html#_secure_ast_customizer_2">Secure AST customizer</a></li>
<li><a href="userGuides.html#_source_aware_customizer_2">Source aware customizer</a></li>
<li><a href="userGuides.html#_inlining_a_customizer">Inlining a customizer</a></li>
<li><a href="userGuides.html#_multiple_customizers">Multiple customizers</a></li>
</ul>
</li>
<li><a href="userGuides.html#_config_script_flag">Config script flag</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_static_compilation_by_default">Static compilation by default</a></li>
</ul>
</li>
<li><a href="userGuides.html#_ast_transformations_tbd">AST transformations (TBD)</a></li>
</ul>
</li>
<li><a href="userGuides.html#_custom_type_checking_extensions_tbd">4.11.7. Custom type checking extensions (TBD)</a></li>
<li><a href="userGuides.html#_builders_tbd">4.11.8. Builders (TBD)</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_creating_a_builder_tbd">Creating a builder (TBD)</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_buildersupport_tbd">BuilderSupport (TBD)</a></li>
<li><a href="userGuides.html#_factorybuildersupport_tbd">FactoryBuilderSupport (TBD)</a></li>
</ul>
</li>
<li><a href="userGuides.html#_existing_builders_tbd">Existing builders (TBD)</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_markupbuilder_tbd">MarkupBuilder (TBD)</a></li>
<li><a href="userGuides.html#_streamingmarkupbuilder_tbd">StreamingMarkupBuilder (TBD)</a></li>
<li><a href="userGuides.html#_saxbuilder_tbd">SaxBuilder (TBD)</a></li>
<li><a href="userGuides.html#_staxbuilder_tbd">StaxBuilder (TBD)</a></li>
<li><a href="userGuides.html#_dombuilder_tbd">DomBuilder (TBD)</a></li>
<li><a href="userGuides.html#_nodebuilder_tbd">NodeBuilder (TBD)</a></li>
<li><a href="userGuides.html#_jsonbuilder_tbd">JsonBuilder (TBD)</a></li>
<li><a href="userGuides.html#_streamingjsonbuilder_tbd">StreamingJsonBuilder (TBD)</a></li>
<li><a href="userGuides.html#_swingbuilder_tbd">SwingBuilder (TBD)</a></li>
<li><a href="userGuides.html#_antbuilder_tbd">AntBuilder (TBD)</a></li>
<li><a href="userGuides.html#_clibuilder_tbd">CliBuilder (TBD)</a></li>
<li><a href="userGuides.html#_objectgraphbuilder_tbd">ObjectGraphBuilder (TBD)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#_working_with_jmx">4.12. Working with JMX</a></li>
<li>
<ul class="sectlevel3">
<li><a href="userGuides.html#_introduction_5">4.12.1. Introduction</a></li>
<li><a href="userGuides.html#_monitoring_the_jvm">4.12.2. Monitoring the JVM</a></li>
<li><a href="userGuides.html#_monitoring_tomcat">4.12.3. Monitoring Tomcat</a></li>
<li><a href="userGuides.html#_oc4j_example">4.12.4. OC4J Example</a></li>
<li><a href="userGuides.html#_weblogic_example">4.12.5. WebLogic Example</a></li>
<li><a href="userGuides.html#_spring_example">4.12.6. Spring Example</a></li>
<li><a href="userGuides.html#_troubleshooting">4.12.7. Troubleshooting</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_groovy_lang_missingmethodexception_or_groovy_lang_groovyruntimeexception">groovy.lang.MissingMethodException or groovy.lang.GroovyRuntimeException</a></li>
<li><a href="userGuides.html#_java_lang_securityexception">java.lang.SecurityException</a></li>
</ul>
</li>
<li><a href="userGuides.html#_jmxbuilder">4.12.8. JmxBuilder</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_instantiating_jmxbuilder">Instantiating JmxBuilder</a></li>
<li><a href="userGuides.html#_jmx_connectors">JMX Connectors</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_connector_server">Connector Server</a></li>
<li><a href="userGuides.html#_connector_client">Connector Client</a></li>
</ul>
</li>
<li><a href="userGuides.html#_jmxbuilder_mbean_export">JmxBuilder MBean Export</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_implicit_vs_explicit_descriptors">Implicit vs Explicit Descriptors</a></li>
<li><a href="userGuides.html#_the_jmxbuilder_export_node">The JmxBuilder.export() Node</a></li>
<li><a href="userGuides.html#_jmxbuilder_export_syntax">JmxBuilder.export() Syntax</a></li>
<li><a href="userGuides.html#_integration_with_groovymbean_class">Integration with GroovyMBean Class</a></li>
<li><a href="userGuides.html#_mbean_registration_with_jmxbuilder_bean">MBean Registration with JmxBuilder.bean()</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#_implicit_export">Implicit Export</a></li>
<li>
<ul class="sectlevel7">
<li><a href="userGuides.html#_jconsole_view_of_exported_bean">JConsole view of Exported Bean</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#_jmxbuilder_bean_syntax">JmxBuilder.bean() Syntax</a></li>
<li><a href="userGuides.html#_bean_node_specifying_mbean_objectname">Bean() Node - Specifying MBean ObjectName</a></li>
</ul>
</li>
<li><a href="userGuides.html#_bean_node_attribute_export">Bean() Node - Attribute Export</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_export_all_attributes_with_wildcard">Export All Attributes with Wildcard "*"</a></li>
<li><a href="userGuides.html#_export_attribute_list">Export Attribute List</a></li>
<li><a href="userGuides.html#_export_attribute_with_explicit_descriptors">Export Attribute with Explicit Descriptors</a></li>
</ul>
</li>
<li><a href="userGuides.html#_bean_node_constructor_export">Bean() Node - Constructor Export</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_export_all_constructors_with">Export all Constructors with "*"</a></li>
<li><a href="userGuides.html#_export_constructors_using_parameter_descriptor">Export Constructors using Parameter Descriptor</a></li>
<li><a href="userGuides.html#_export_constructor_with_explicit_descriptors">Export Constructor with Explicit Descriptors</a></li>
</ul>
</li>
<li><a href="userGuides.html#_bean_node_operation_export">Bean() Node - Operation Export</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_export_all_operations_with">Export All Operations with "*"</a></li>
<li><a href="userGuides.html#_export_operation_list">Export Operation List</a></li>
<li><a href="userGuides.html#_export_operations_by_signature">Export Operations by Signature</a></li>
<li><a href="userGuides.html#_export_operations_with_explicit_descriptors">Export Operations with Explicit Descriptors</a></li>
</ul>
</li>
<li><a href="userGuides.html#_embedding_descriptor">Embedding Descriptor</a></li>
<li><a href="userGuides.html#_timer_export">Timer Export</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_timer_node_syntax">Timer Node Syntax</a></li>
<li><a href="userGuides.html#_exporting_a_timer">Exporting a Timer</a></li>
<li><a href="userGuides.html#_timer_period">Timer Period</a></li>
</ul>
</li>
<li><a href="userGuides.html#_jmxbuilder_and_events">JmxBuilder and Events</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_event_handling_closures">Event Handling Closures</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#_parameterless">Parameterless</a></li>
<li><a href="userGuides.html#_with_event_parameter">With Event Parameter</a></li>
</ul>
</li>
<li><a href="userGuides.html#_handling_attribute_onchange_event">Handling Attribute onChange Event</a></li>
<li><a href="userGuides.html#_attribute_onchange_event_object">Attribute onChange Event Object</a></li>
<li><a href="userGuides.html#_handling_operation_oncall_event">Handling Operation onCall Event</a></li>
<li><a href="userGuides.html#_operation_oncall_event_object">Operation onCall Event Object</a></li>
</ul>
</li>
<li><a href="userGuides.html#_listener_mbean">Listener MBean</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_listening_to_jmx_events">Listening to JMX Events</a></li>
<li><a href="userGuides.html#_listener_node_syntax">Listener Node Syntax</a></li>
</ul>
</li>
<li><a href="userGuides.html#_emitting_jmx_events">Emitting JMX Events</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_emitter_syntax">Emitter Syntax</a></li>
<li><a href="userGuides.html#_declare_the_emitter">Declare the Emitter</a></li>
<li><a href="userGuides.html#_broadcast_event">Broadcast Event</a></li>
<li><a href="userGuides.html#_sending_event_objects">Sending Event Objects</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#_further_jmx_information">4.12.9. Further JMX Information</a></li>
</ul>
</li>
<li><a href="userGuides.html#_creating_swing_uis_tbd">4.13. Creating Swing UIs (TBD)</a></li>
<li><a href="userGuides.html#_security_tbd">4.14. Security (TBD)</a></li>
<li><a href="userGuides.html#_design_patterns_in_groovy">4.15. Design patterns in Groovy</a></li>
<li>
<ul class="sectlevel3">
<li><a href="userGuides.html#_patterns">4.15.1. Patterns</a></li>
<li>
<ul class="sectlevel4">
<li><a href="userGuides.html#_abstract_factory_pattern">Abstract Factory Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_example">Example</a></li>
</ul>
</li>
<li><a href="userGuides.html#_adapter_pattern">Adapter Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_delegation_example">Delegation Example</a></li>
<li><a href="userGuides.html#_inheritance_example">Inheritance Example</a></li>
<li><a href="userGuides.html#_adapting_using_closures">Adapting using Closures</a></li>
<li><a href="userGuides.html#_adapting_using_the_expandometaclass">Adapting using the ExpandoMetaClass</a></li>
</ul>
</li>
<li><a href="userGuides.html#_bouncer_pattern">Bouncer Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_null_checking_example">Null Checking Example</a></li>
<li><a href="userGuides.html#_validation_example">Validation Example</a></li>
</ul>
</li>
<li><a href="userGuides.html#_chain_of_responsibility_pattern">Chain of Responsibility Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_example_2">Example</a></li>
</ul>
</li>
<li><a href="userGuides.html#_composite_pattern">Composite Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_example_3">Example</a></li>
</ul>
</li>
<li><a href="userGuides.html#_decorator_pattern">Decorator Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_traditional_example">Traditional Example</a></li>
<li><a href="userGuides.html#_a_touch_of_dynamic_behaviour">A touch of dynamic behaviour</a></li>
<li><a href="userGuides.html#_runtime_behaviour_embellishment">Runtime behaviour embellishment</a></li>
<li><a href="userGuides.html#_more_dynamic_decorating">More dynamic decorating</a></li>
<li><a href="userGuides.html#_decorating_with_an_interceptor">Decorating with an Interceptor</a></li>
<li><a href="userGuides.html#_decorating_with_java_lang_reflect_proxy">Decorating with java.lang.reflect.Proxy</a></li>
<li><a href="userGuides.html#_decorating_with_spring">Decorating with Spring</a></li>
<li><a href="userGuides.html#_asynchronous_decorators_using_gpars">Asynchronous Decorators using GPars</a></li>
</ul>
</li>
<li><a href="userGuides.html#_delegation_pattern">Delegation Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_implement_delegation_pattern_using_expandometaclass">Implement Delegation Pattern using ExpandoMetaClass</a></li>
<li><a href="userGuides.html#_implement_delegation_pattern_using_delegate_annotation">Implement Delegation Pattern using @Delegate annotation</a></li>
</ul>
</li>
<li><a href="userGuides.html#_flyweight_pattern">Flyweight Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_example_4">Example</a></li>
</ul>
</li>
<li><a href="userGuides.html#_iterator_pattern">Iterator Pattern</a></li>
<li><a href="userGuides.html#_loan_my_resource_pattern">Loan my Resource Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_example_5">Example</a></li>
</ul>
</li>
<li><a href="userGuides.html#_null_object_pattern">Null Object Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_simple_example">Simple Example</a></li>
<li><a href="userGuides.html#_tree_example">Tree Example</a></li>
</ul>
</li>
<li><a href="userGuides.html#_pimp_my_library_pattern">Pimp my Library Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_example_6">Example</a></li>
</ul>
</li>
<li><a href="userGuides.html#_proxy_pattern">Proxy Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_example_7">Example</a></li>
</ul>
</li>
<li><a href="userGuides.html#_singleton_pattern">Singleton Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_example_the_classic_java_singleton">Example: The Classic Java Singleton</a></li>
<li><a href="userGuides.html#_example_singleton_via_metaprogramming">Example: Singleton via MetaProgramming</a></li>
<li><a href="userGuides.html#_guice_example">Guice Example</a></li>
<li><a href="userGuides.html#_spring_example_2">Spring Example</a></li>
<li><a href="userGuides.html#_further_information">Further information</a></li>
</ul>
</li>
<li><a href="userGuides.html#_state_pattern">State Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_example_8">Example</a></li>
<li><a href="userGuides.html#_variation_1_leveraging_interface_oriented_design">Variation 1: Leveraging Interface-Oriented Design</a></li>
<li><a href="userGuides.html#_variation_2_extract_state_pattern_logic">Variation 2: Extract State Pattern Logic</a></li>
<li><a href="userGuides.html#_variation_3_bring_on_the_dsl">Variation 3: Bring on the DSL</a></li>
</ul>
</li>
<li><a href="userGuides.html#_strategy_pattern">Strategy Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_example_9">Example</a></li>
</ul>
</li>
<li><a href="userGuides.html#_template_method_pattern">Template Method Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_example_10">Example</a></li>
</ul>
</li>
<li><a href="userGuides.html#_visitor_pattern">Visitor Pattern</a></li>
<li>
<ul class="sectlevel5">
<li><a href="userGuides.html#_simple_example_2">Simple Example</a></li>
<li><a href="userGuides.html#_advanced_example">Advanced Example</a></li>
<li>
<ul class="sectlevel6">
<li><a href="userGuides.html#_why_to_use_this">Why to use this</a></li>
<li><a href="userGuides.html#_what_happens_if_we_add_a_new_type">What happens if we add a new type?</a></li>
<li><a href="userGuides.html#_what_if_we_want_to_have_different_iteration_patterns">What if we want to have different iteration patterns?</a></li>
<li><a href="userGuides.html#_make_it_groovy">Make it Groovy</a></li>
<li><a href="userGuides.html#_summary">Summary</a></li>
</ul>
</li>
<li><a href="userGuides.html#_further_information_2">Further Information</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="userGuides.html#_references">4.15.2. References</a></li>
</ul>
</li>
</ul>
</li>

</ul>


</li>
</ul>
</div>
</div>


<div id="content">

<div class="sect1">
<h2 id="_user_guides">4. User Guides</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_getting_started">4.1. Getting started</h3>
<div class="sect3">
<h4 id="_download">4.1.1. Download</h4>
<div class="paragraph">
<p>In this download area, you will be able to download the distribution (binary and source), the Windows installer and the documentation for <strong>Groovy</strong>.</p>
</div>
<div class="paragraph">
<p>For a quick and effortless start on Mac OSX, Linux or Cygwin, you can use <a href="http://gvmtool.net">GVM</a> (the Groovy enVironment Manager) to download and configure any <strong>Groovy</strong> version of your choice. Basic <a href="userGuides.html#gvm-the-groovy-environment-manager">instructions</a> can be found below.</p>
</div>
<div class="sect4">
<h5 id="_stable">Stable</h5>
<div class="ulist">
<ul>
<li>
<p><strong>Download zip</strong>: <a href="http://dist.groovy.codehaus.org/distributions/groovy-binary-2.3.6.zip"><strong>Binary Release</strong></a> | <a href="http://dist.groovy.codehaus.org/distributions/groovy-src-2.3.6.zip">Source Release</a></p>
</li>
<li>
<p><strong>Download documentation</strong>: <a href="http://dist.groovy.codehaus.org/distributions/groovy-docs-2.3.6.zip"><strong>JavaDoc and zipped online documentation</strong></a></p>
</li>
<li>
<p><strong>Combined binary / source / documentation bundle</strong>: <a href="http://dist.groovy.codehaus.org/distributions/groovy-sdk-2.3.6.zip"><strong>Distribution bundle</strong></a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can learn more about this version in the <a href="http://groovy.codehaus.org/Groovy+2.3+release+notes">release notes</a> or in the <a href="http://jira.codehaus.org/secure/ReleaseNote.jspa?projectId=10242&amp;version=19074">JIRA release notes</a>.</p>
</div>
<div class="paragraph">
<p>If you plan on using invokedynamic support, <a href="invokedynamic-support.html">read those notes</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_snapshots">Snapshots</h5>
<div class="paragraph">
<p>For those who want to test the very latest versions of Groovy and live on the bleeding edge, you can use our <a href="http://snapshots.repository.codehaus.org/org/codehaus/groovy/groovy-all/">snapshot builds</a>. As soon as a build succeeds on our continuous integration server a snapshot is deployed to Codehaus&#8217; snapshot repository.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_maven_repository">4.1.2. Maven Repository</h4>
<div class="paragraph">
<p>If you wish to embed Groovy in your application, you may just prefer to point to your favourite maven repositories or the <a href="http://repository.codehaus.org/org/codehaus/groovy">codehaus maven repository</a>.</p>
</div>
<div class="sect4">
<h5 id="_stable_release">Stable Release</h5>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Gradle</th>
<th class="tableblock halign-left valign-top">Maven</th>
<th class="tableblock halign-left valign-top">Explanation</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">'org.codehaus.groovy:groovy:2.3.6'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;groupId&gt;org.codehaus.groovy&lt;/groupId&gt;
&lt;artifactId&gt;groovy&lt;/artifactId&gt;
&lt;version&gt;2.3.6&lt;/version&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Just the core of groovy without the modules (see below). Treats Antlr, ASM, etc. as standard dependencies. Only useful if you happen to also use the same versions of these jars yourself as it will save you having two copies of these jars.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">'org.codehaus.groovy:groovy-$module:2.3.6'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;groupId&gt;org.codehaus.groovy&lt;/groupId&gt;
&lt;artifactId&gt;groovy-$module&lt;/artifactId&gt;
&lt;version&gt;2.3.6&lt;/version&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">"$module" stands for the different optional groovy modules "ant", "bsf", "console", "docgenerator", "groovydoc", "groovysh", "jmx", "json", "jsr223", "servlet", "sql", "swing", "test", "testng" and "xml". Example: &lt;artifactId&gt;groovy-sql&lt;/artifactId&gt;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">'org.codehaus.groovy:groovy-all:2.3.6'</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&lt;groupId&gt;org.codehaus.groovy&lt;/groupId&gt;
&lt;artifactId&gt;groovy-all&lt;/artifactId&gt;
&lt;version&gt;2.3.6&lt;/version&gt;</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The core plus all the modules. Also includes jar versions of Antlr, ASM, Commons-CLI and Retrotranslator runtime. Allows you or your other dependencies (e.g. Hibernate) to use other versions of these jars. Optional dependencies are marked as optional. You may need to include some of the optional dependencies to use some features of Groovy, e.g. AntBuilder, GroovyMBeans, etc.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To use the <a href="invokedynamic-support.html">InvokeDynamic</a> version of the jars just append ':indy&#8217; for Gradle or &lt;classifier&gt;indy&lt;/classifier&gt; for Maven.</p>
</div>
</div>
<div class="sect4">
<h5 id="_snapshot_releases">Snapshot Releases</h5>
<div class="paragraph">
<p>In addition to the stable and milestone releases you can find intermediate SNAPSHOT releases at the <a href="http://snapshots.repository.codehaus.org/org/codehaus/groovy">codehaus snapshot maven repository</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_gvm_the_groovy_environment_manager">4.1.3. GVM (the Groovy enVironment Manager)</h4>
<div class="paragraph">
<p>This tool makes installing Groovy on any Bash platform (Mac OSX, Linux, Cygwin, Solaris or FreeBSD) very easy.</p>
</div>
<div class="paragraph">
<p>Simply open a new terminal and enter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="shell language-shell">$ curl -s get.gvmtool.net | bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Follow the instructions on-screen to complete installation.</p>
</div>
<div class="paragraph">
<p>Open a new terminal or type the command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="shell language-shell">$ source "$HOME/.gvm/bin/gvm-init.sh"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then install the latest stable Groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="shell language-shell">$ gvm install groovy</code></pre>
</div>
</div>
<div class="paragraph">
<p>After installation is complete and you&#8217;ve made it your default version, test it with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="shell language-shell">$ groovy -version</code></pre>
</div>
</div>
<div class="paragraph">
<p>That&#8217;s all there is to it!</p>
</div>
</div>
<div class="sect3">
<h4 id="_other_ways_to_get_groovy">4.1.4. Other ways to get Groovy</h4>
<div class="sect4">
<h5 id="_installation_on_mac_os_x">Installation on Mac OS X</h5>
<div class="sect5">
<h6 id="_macports">MacPorts</h6>
<div class="paragraph">
<p>If you&#8217;re on MacOS and have <a href="http://www.macports.org">MacPorts</a> installed, you can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="shell language-shell">sudo port install groovy</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_homebrew">Homebrew</h6>
<div class="paragraph">
<p>If you&#8217;re on MacOS and have <a href="http://mxcl.github.com/homebrew">Homebrew</a> installed, you can run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="shell language-shell">brew install groovy</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_installation_on_windows">Installation on Windows</h5>
<div class="paragraph">
<p>If you&#8217;re on Windows, you can also use the <a href="http://beta.groovy-lang.org/docs/groovy-2.3.6/html/documentation/TODO-Windows+NSIS-Installer">NSIS Windows installer</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_other_distributions">Other Distributions</h5>
<div class="paragraph">
<p>You may download other distributions of Groovy from <a href="http://dist.codehaus.org/groovy/distributions/">this site</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_source_code">Source Code</h5>
<div class="paragraph">
<p>If you prefer to live on the bleeding edge, you can also grab the <a href="https://github.com/groovy/groovy-core">source code from GitHub</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_ide_plugin">IDE plugin</h5>
<div class="paragraph">
<p>If you are an IDE user, you can just grab the latest <a href="http://beta.groovy-lang.org/docs/groovy-2.3.6/html/documentation/tools/tools-ide.html">IDE plugin</a> and follow the plugin installation instructions.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_install_binary">4.1.5. Install Binary</h4>
<div class="paragraph">
<p>These instructions describe how to install a binary distribution of <strong>Groovy</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, <a href="userGuides.html#download-groovy">Download</a> a binary distribution of Groovy and unpack it into some file on your local file system.</p>
</li>
<li>
<p>Set your <code>GROOVY_HOME</code> environment variable to the directory you unpacked the distribution.</p>
</li>
<li>
<p>Add <code>GROOVY_HOME/bin</code> to your <code>PATH</code> environment variable.</p>
</li>
<li>
<p>Set your <code>JAVA_HOME</code> environment variable to point to your JDK. On OS X this is <code>/Library/Java/Home</code>, on other unixes its often <code>/usr/java</code> etc. If you&#8217;ve already installed tools like Ant or Maven you&#8217;ve probably already done this step.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You should now have Groovy installed properly. You can test this by typing the following in a command shell:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="shell language-shell">groovysh</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which should create an interactive groovy shell where you can type Groovy statements. Or to run the <a href="http://beta.groovy-lang.org/docs/groovy-2.3.6/html/documentation/tools/tools-groovyconsole.html">Swing interactive console</a> type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="shell language-shell">groovyConsole</code></pre>
</div>
</div>
<div class="paragraph">
<p>To run a specific Groovy script type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="shell language-shell">groovy SomeScript</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_differences_with_java">4.2. Differences with Java</h3>
<div class="paragraph">
<p>Groovy tries to be as natural as possible for Java developers. We’ve
tried to follow the principle of least surprise when designing Groovy,
particularly for developers learning Groovy who’ve come from a Java
background.</p>
</div>
<div class="paragraph">
<p>Here we list all the major differences between Java and Groovy.</p>
</div>
<div class="sect3">
<h4 id="_default_imports_2">4.2.1. Default imports</h4>
<div class="paragraph">
<p>All these packages and classes are imported by default, i.e. you do not
have to use an explicit <code>import</code> statement to use them:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>java.io.*</p>
</li>
<li>
<p>java.lang.*</p>
</li>
<li>
<p>java.math.BigDecimal</p>
</li>
<li>
<p>java.math.BigInteger</p>
</li>
<li>
<p>java.net.*</p>
</li>
<li>
<p>java.util.*</p>
</li>
<li>
<p>groovy.lang.*</p>
</li>
<li>
<p>groovy.util.*</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_multi_methods">4.2.2. Multi-methods</h4>
<div class="paragraph">
<p>In Groovy, the methods which will be invoked are chosen at runtime. This is called runtime dispatch or multi-methods. It
means that the method will be chosen based on the types of the arguments at runtime. In Java, this is the opposite: methods
are chosen at compile time, based on the declared types.</p>
</div>
<div class="paragraph">
<p>The following code, written as Java code, can be compiled in both Java and Groovy, but it will behave differently:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">int method(String arg) {
    return 1;
}
int method(Object arg) {
    return 2;
}
Object o = "Object";
int result = method(o);</code></pre>
</div>
</div>
<div class="paragraph">
<p>In Java, you would have:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">assertEquals(2, result);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Whereas in Groovy:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">assertEquals(1, result);</code></pre>
</div>
</div>
<div class="paragraph">
<p>That is because Java will use the static information type, which is that <code>o</code> is declared as an <code>Object</code>, whereas
Groovy will choose at runtime, when the method is actually called. Since it is called with a <code>String</code>, then the
<code>String</code> version is called.</p>
</div>
</div>
<div class="sect3">
<h4 id="_array_initializers">4.2.3. Array initializers</h4>
<div class="paragraph">
<p>In Groovy, the <code>{ ... }</code> block is reserved for closures. That means that you cannot create array literals with this
syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">int[] array = { 1, 2, 3}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You actually have to use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">int[] array = [1,2,3]</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_package_scope_visibility">4.2.4. Package scope visibility</h4>
<div class="paragraph">
<p>In Groovy, omitting a modifier on a field doesn&#8217;t result in a package-private field like in Java:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Person {
    String name
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead, it is used to create a <em>property</em>, that is to say a <em>private field</em>, an associated <em>getter</em> and an associated
_setter.</p>
</div>
<div class="paragraph">
<p>It is possible to create a package-private field by annotating it with <code>@PackageScope</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Person {
    @PackageScope String name
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_arm_blocks">4.2.5. ARM blocks</h4>
<div class="paragraph">
<p>ARM (Automatic Resource Management) block from Java 7 are not supported in Groovy. Instead, Groovy provides various
methods relying on closures, which have the same effect while being more idiomatic. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">Path file = Paths.get("/path/to/file");
Charset charset = Charset.forName("UTF-8");
try (BufferedReader reader = Files.newBufferedReader(file, charset)) {
    String line;
    while ((line = reader.readLine()) != null) {
        System.out.println(line);
    }

} catch (IOException e) {
    e.printStackTrace();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>can be written like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">new File('/path/to/file').eachLine('UTF-8') {
   println it
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or, if you want a version closer to Java:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">new File('/path/to/file').withReader('UTF-8') { reader -&gt;
   reader.eachLine {
       println it
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_inner_classes">4.2.6. Inner classes</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
The implementation of anonymous inner classes and nested classes follows the Java lead, but
you should not take out the Java Language Spec and keep shaking the head
about things that are different. The implementation done looks much like
what we do for <code>groovy.lang.Closure</code>, with some benefits and some
differences. Accessing private fields and methods for example can become
a problem, but on the other hand local variables don’t have to be final.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_static_inner_classes">Static inner classes</h5>
<div class="paragraph">
<p>Here’s an example of static inner class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class A {
    static class B {}
}

new A.B()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The usage of static inner classes is the best supported one. If you
absolutely need an inner class, you should make it a static one.</p>
</div>
</div>
<div class="sect4">
<h5 id="_anonymous_inner_classes">Anonymous Inner Classes</h5>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">boolean called = false

Timer timer = new Timer()
timer.schedule(new TimerTask() {
    void run() {
        called = true
    }
}, 0)
sleep 100

assert called</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_creating_instances_of_non_static_inner_classes">Creating Instances of Non-Static Inner Classes</h5>
<div class="paragraph">
<p>In Java you can do this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">public class Y {
    public class X {}
    public X foo() {
        return new X();
    }
    public static X createX(Y y) {
        return y.new X();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Groovy doesn&#8217;t support the <code>y.new X()</code> syntax. Instead, you have to write <code>new X(y)</code>, like in the code below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">public class Y {
    public class X {}
    public X foo() {
        return new X()
    }
    public static X createX(Y y) {
        return new X(y)
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
Caution though, Groovy supports calling methods with one
parameter without giving an argument. The parameter will then have the
value null. Basically the same rules apply to calling a constructor.
There is a danger that you will write new X() instead of new X(this) for
example. Since this might also be the regular way we have not yet found
a good way to prevent this problem.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_lambdas">4.2.7. Lambdas</h4>
<div class="paragraph">
<p>Java 8 supports lambdas and method references:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">Runnable run = () -&gt; System.out.println("Run");
list.forEach(System.out::println);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Java 8 lambdas can be more or less considered as anonymous inner classes. Groovy doesn&#8217;t support that syntax, but has closures
instead:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">Runnable run = { println 'run' }
list.each { println it } // or list.each(this.&amp;println)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_groovy_development_kit_tbd">4.3. Groovy Development Kit (TBD)</h3>
<div class="sect3">
<h4 id="_working_with_io_tbd">4.3.1. Working with IO (TBD)</h4>

</div>
<div class="sect3">
<h4 id="_working_with_collections_tbd">4.3.2. Working with collections (TBD)</h4>

</div>
<div class="sect3">
<h4 id="_handy_utilities">4.3.3. Handy utilities</h4>
<div class="sect4">
<h5 id="_configslurper">ConfigSlurper</h5>
<div class="paragraph">
<p><code>ConfigSlurper</code> is a utility class for reading configuration files defined in the form of Groovy scripts. Like it is
the case with Java <code>*.properties</code> files, <code>ConfigSlurper</code> allows a dot notation. But in addition, it allows for Closure scoped
configuration values and arbitrary object types.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def config = new ConfigSlurper().parse('''
    app.date = new Date()  <i class="conum" data-value="1"></i><b>(1)</b>
    app.age  = 42
    app {                  <i class="conum" data-value="2"></i><b>(2)</b>
        name = "Test${42}"
    }
''')

assert config.app.date instanceof Date
assert config.app.age == 42
assert config.app.name == 'Test42'</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Usage of the dot notation</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Usage of Closure scopes as an alternative to the dot notation</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As can be seen in the above example, the <code>parse</code> method can be used to retrieve <code>groovy.util.ConfigObject</code> instances. The
<code>ConfigObject</code> is a specialized <code>java.util.Map</code> implementation that either returns the configured value or a new <code>ConfigObject</code>
instance but never <code>null</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def config = new ConfigSlurper().parse('''
    app.date = new Date()
    app.age  = 42
    app.name = "Test${42}"
''')

assert config.test != null   <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>config.test</code> has not been specified yet it returns a <code>ConfigObject</code> when being called.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the case of a dot being part of a configuration variable name, it can be escaped by using single or double quotes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def config = new ConfigSlurper().parse('''
    app."person.age"  = 42
''')

assert config.app."person.age" == 42</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition, <code>ConfigSlurper</code> comes with support for <code>environments</code>. The <code>environments</code> method can be used to hand over
a Closure instance that itself may consist of a several sections. Let&#8217;s say we wanted to create a particular configuration
value for the development environment. When creating the <code>ConfigSlurper</code> instance we can use the <code>ConfigSlurper(String)</code>
constructor to specify the target environment.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def config = new ConfigSlurper('development').parse('''
  environments {
       development {
           app.port = 8080
       }

       test {
           app.port = 8082
       }

       production {
           app.port = 80
       }
  }
''')

assert config.app.port == 8080</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
The <code>ConfigSlurper</code> environments aren&#8217;t restricted to any particular environment names. It solely depends on the
<code>ConfigSlurper</code> client code what value are supported and interpreted accordingly.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>environments</code> method is built-in but the <code>registerConditionalBlock</code> method can be used to register other method names
in addition to the <code>environments</code> name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def slurper = new ConfigSlurper()
slurper.registerConditionalBlock('myProject', 'developers')   <i class="conum" data-value="1"></i><b>(1)</b>

def config = slurper.parse('''
  sendMail = true

  myProject {
       developers {
           sendMail = false
       }
  }
''')

assert !config.sendMail</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Once the new block is registered <code>ConfigSlurper</code> can parse it.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>For Java integration purposes the <code>toProperties</code> method can be used to convert the <code>ConfigObject</code> to a <code>java.util.Properties</code>
object that might be stored to a <code>*.properties</code> text file. Be aware though that the configuration values are converted to
<code>String</code> instances during adding them to the newly created <code>Properties</code> instance.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def config = new ConfigSlurper().parse('''
    app.date = new Date()
    app.age  = 42
    app {
        name = "Test${42}"
    }
''')

def properties = config.toProperties()

assert properties."app.date" instanceof String
assert properties."app.age" == '42'
assert properties."app.name" == 'Test42'</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_expando">Expando</h5>
<div class="paragraph">
<p>The <code>Expando</code> class can be used to create a dynamically expandable object. Despite its name it does not use the
<code>ExpandoMetaClass</code> underneath. Each <code>Expando</code> object represents a standalone, dynamically-crafted instance that can be
extended with properties (or methods) at runtime.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def expando = new Expando()
expando.name = 'John'

assert expando.name == 'John'</code></pre>
</div>
</div>
<div class="paragraph">
<p>A special case occurs when a dynamic property registers a <code>Closure</code> code block. Once being registered it can be invoked
as it would be done with a method call.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def expando = new Expando()
expando.toString = { -&gt; 'John' }
expando.say = { String s -&gt; "John says: ${s}" }

assert expando as String == 'John'
assert expando.say('Hi') == 'John says: Hi'</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_observable_list_map_and_set">Observable list, map and set</h5>
<div class="paragraph">
<p>Groovy comes with observable lists, maps and sets. Each of these collections trigger <code>java.beans.PropertyChangeEvent</code> events when elements
are added, removed or changed. Note that a <code>PropertyChangeEvent</code> is not only signaling that a certain event has
 occurred, moreover, it holds information on the property name and the old/new value a certain property has been changed to.</p>
</div>
<div class="paragraph">
<p>Depending on the type of change that has happened, observable collections might fire more specialized <code>PropertyChangeEvent</code>
 types. For example, adding an element to an observable list fires an <code>ObservableList.ElementAddedEvent</code> event.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def event                                       <i class="conum" data-value="1"></i><b>(1)</b>
def listener = {
    if (it instanceof ObservableList.ElementEvent)  {  <i class="conum" data-value="2"></i><b>(2)</b>
        event = it
    }
} as PropertyChangeListener


def observable = [1, 2, 3] as ObservableList    <i class="conum" data-value="3"></i><b>(3)</b>
observable.addPropertyChangeListener(listener)  <i class="conum" data-value="4"></i><b>(4)</b>

observable.add 42                               <i class="conum" data-value="5"></i><b>(5)</b>

assert event instanceof ObservableList.ElementAddedEvent

def elementAddedEvent = event as ObservableList.ElementAddedEvent
assert elementAddedEvent.changeType == ObservableList.ChangeType.ADDED
assert elementAddedEvent.index == 3
assert elementAddedEvent.oldValue == null
assert elementAddedEvent.newValue == 42</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Declares a <code>PropertyChangeEventListener</code> that is capturing the fired events</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>ObservableList.ElementEvent</code> and its descendant types are relevant for this listener</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Registers the listener</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Creates an <code>ObservableList</code> from the given list</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Triggers an <code>ObservableList.ElementAddedEvent</code> event</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
Be aware that adding an element in fact causes two events to be triggered. The first is of type <code>ObservableList.ElementAddedEvent</code>,
the second is a plain <code>PropertyChangeEvent</code> that informs listeners about the change of property <code>size</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>ObservableList.ElementClearedEvent</code> event type is another interesting one. Whenever multiple
 elements are removed, for example when calling <code>clear()</code>, it holds the elements being removed from the list.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def event
def listener = {
    if (it instanceof ObservableList.ElementEvent)  {
        event = it
    }
} as PropertyChangeListener


def observable = [1, 2, 3] as ObservableList
observable.addPropertyChangeListener(listener)

observable.clear()

assert event instanceof ObservableList.ElementClearedEvent

def elementClearedEvent = event as ObservableList.ElementClearedEvent
assert elementClearedEvent.values == [1, 2, 3]
assert observable.size() == 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>To get an overview of all the supported event types the reader is encouraged to have a look at the JavaDoc documentation
or the source code of the observable collection in use.</p>
</div>
<div class="paragraph">
<p><code>ObservableMap</code> and <code>ObservableSet</code> come with the same concepts as we have seen for <code>ObservableList</code> in this section.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_metaprogramming">4.4. Metaprogramming</h3>
<div class="paragraph">
<p>The Groovy language supports two flavors of metaprogramming: runtime metaprogramming and compile-time metaprogramming.
The first one allows altering the class model and the behavior of a program at runtime, while the second only occurs
at compile-time. Both have pros and cons, that we will detail in this section.</p>
</div>
<div class="sect3">
<h4 id="_runtime_metaprogramming_tbd">4.4.1. Runtime metaprogramming (TBD)</h4>
<div class="sect4">
<h5 id="_groovyobject_interface_tbd">GroovyObject interface (TBD)</h5>
<div class="sect5">
<h6 id="_invokemethod_tbd">invokeMethod (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_get_setproperty_tbd">get/setProperty (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_get_setmetaclass_tbd">get/setMetaClass (TBD)</h6>

</div>
</div>
<div class="sect4">
<h5 id="_get_setattribute_tbd">get/setAttribute (TBD)</h5>

</div>
<div class="sect4">
<h5 id="_methodmissing">methodMissing</h5>
<div class="paragraph">
<p>Groovy supports the concept of <code>methodMissing</code>. This method differs from <code>invokeMethod</code> in that it
is only invoked in the case of a failed method dispatch, when no method can be found for the given name and/or the
given arguments.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Foo {
   def methodMissing(String name, def args) {
        return "this is me"
   }
}

assert new Foo().someUnknownMethod(42l) == 'this is me'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Typically when using <code>methodMissing</code> the code will react in some way that makes it possible for the next time the same
method is called, that it goes through the regular Groovy method dispatch logic.</p>
</div>
<div class="paragraph">
<p>For example consider dynamic finders in GORM. These are implemented in terms of <code>methodMissing</code>. The code resembles
something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class GORM {
   def dynamicMethods = [...] // an array of dynamic methods that use regex
   def methodMissing(String name, args) {
       def method = dynamicMethods.find { it.match(name) }
       if(method) {
          GORM.metaClass."$name" = { Object[] varArgs -&gt;
             method.invoke(delegate, name, varArgs)
          }
          return method.invoke(delegate,name, args)
       }
       else throw new MissingMethodException(name, delegate, args)
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice how, if we find a method to invoke then we dynamically register a new method on the fly using <code>ExpandoMetaClass</code>.
This is so that the next time the same method is called it is more efficient. This way <code>methodMissing</code> doesn&#8217;t have
the overhead of <code>invokeMethod</code> <em>and</em> is not expensive for the second call.</p>
</div>
</div>
<div class="sect4">
<h5 id="_propertymissing">propertyMissing</h5>
<div class="paragraph">
<p>Groovy supports the concept of <code>propertyMissing</code> for intercepting otherwise failing property resolution attempts. In the
case of a getter method, <code>propertyMissing</code> takes a single String argument resembling the property name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Foo {
   def propertyMissing(String name) { name }
}

assert new Foo().boo == 'boo'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>propertyMissing(String)</code> method is only called when no getter method for the given property can be found by the Groovy
runtime.</p>
</div>
<div class="paragraph">
<p>For a setter methods a second <code>propertyMissing</code> definition can be added that takes an additional value argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Foo {
   def storage = [:]
   def propertyMissing(String name, value) { storage[name] = value }
   def propertyMissing(String name) { storage[name] }
}

def f = new Foo()
f.foo = "bar"

assert f.foo == "bar"</code></pre>
</div>
</div>
<div class="paragraph">
<p>As with <code>methodMissing</code> it is best practice to dynamically register new properties at runtime to improve the overall lookup
performance.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
<code>methodMissing</code> and <code>propertyMissing</code> that deal with static methods and properties can be added via
the <a href="core-metaprogramming.html#metaprogramming_emc">ExpandoMetaClass</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_groovyinterceptable_tbd">GroovyInterceptable (TBD)</h5>

</div>
<div class="sect4">
<h5 id="_categories">Categories</h5>
<div class="paragraph">
<p>There are situations where it is useful if a class <em>not</em> under control had additional methods. In order to enable this
capability, Groovy implements a feature borrowed from Objective-C, called <em>Categories</em>.</p>
</div>
<div class="paragraph">
<p>Categories are implemented with so-called <em>category classes</em>. A category class is special in that it needs to meet certain
pre-defined rules for defining extension methods.</p>
</div>
<div class="paragraph">
<p>There are a few categories that are included in the system for adding functionality to classes that make them more
usable within the Groovy environment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://groovy.codehaus.org/api/groovy/time/TimeCategory.html">groovy.time.TimeCategory</a></p>
</li>
<li>
<p><a href="http://groovy.codehaus.org/api/groovy/servlet/ServletCategory.html">groovy.servlet.ServletCategory</a></p>
</li>
<li>
<p><a href="http://groovy.codehaus.org/api/groovy/xml/dom/DOMCategory.html">groovy.xml.dom.DOMCategory</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Category classes aren&#8217;t enabled by default. To use the methods defined in a category class it is necessary to apply
the scoped <code>use</code> method that is provided by the GDK and available from inside every Groovy object instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">use(TimeCategory)  {
    println 1.minute.from.now       <i class="conum" data-value="1"></i><b>(1)</b>
    println 10.hours.ago

    def someDate = new Date()       <i class="conum" data-value="2"></i><b>(2)</b>
    println someDate - 3.months
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>TimeCategory</code> adds methods to <code>Integer</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>TimeCategory</code> adds methods to <code>Date</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>use</code> method takes the category class as its first parameter and a closure code block as second parameter. Inside the
<code>Closure</code> access to the category methods is available. As can be seen in the example above even JDK classes
like <code>java.lang.Integer</code> or <code>java.util.Date</code> can be enriched with user-defined methods.</p>
</div>
<div class="paragraph">
<p>A category needs not to be directly exposed to the user code, the following will also do:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class JPACategory{
  // Let's enhance JPA EntityManager without getting into the JSR committee
  static void persistAll(EntityManager em , Object[] entities) { //add an interface to save all
    entities?.each { em.persist(it) }
  }
}

def transactionContext = {
  EntityManager em, Closure c -&gt;
  def tx = em.transaction
  try {
    tx.begin()
    use(JPACategory) {
      c()
    }
    tx.commit()
  } catch (e) {
    tx.rollback()
  } finally {
    //cleanup your resource here
  }
}

// user code, they always forget to close resource in exception, some even forget to commit, let's not rely on them.
EntityManager em; //probably injected
transactionContext (em) {
 em.persistAll(obj1, obj2, obj3)
 // let's do some logics here to make the example sensible
 em.persistAll(obj2, obj4, obj6)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When we have a look at the <code>groovy.time.TimeCategory</code> class we see that the extension methods are all declared as <code>static</code>
methods. In fact, this is one of the requirements that must be met by category classes for its methods to be successfully added to
a class inside the <code>use</code> code block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">public class TimeCategory {

    public static Date plus(final Date date, final BaseDuration duration) {
        return duration.plus(date);
    }

    public static Date minus(final Date date, final BaseDuration duration) {
        final Calendar cal = Calendar.getInstance();

        cal.setTime(date);
        cal.add(Calendar.YEAR, -duration.getYears());
        cal.add(Calendar.MONTH, -duration.getMonths());
        cal.add(Calendar.DAY_OF_YEAR, -duration.getDays());
        cal.add(Calendar.HOUR_OF_DAY, -duration.getHours());
        cal.add(Calendar.MINUTE, -duration.getMinutes());
        cal.add(Calendar.SECOND, -duration.getSeconds());
        cal.add(Calendar.MILLISECOND, -duration.getMillis());

        return cal.getTime();
    }

    // ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another requirement is the first argument of the static method must define the type the method is attached to once being activated. The
other arguments are the normal arguments the method will take as parameters.</p>
</div>
<div class="paragraph">
<p>Because of the parameter and static method convention, category method definitions may be a bit less intuitive than
normal method definitions. As an alternative Groovy comes with a <code>@Category</code> annotation that transforms annotated classes
into category classes at compile-time.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Distance {
    def number
    String toString() { "${number}m" }
}

@Category(Number)
class NumberCategory {
    Distance getMeters() {
        new Distance(number: this)
    }
}

use (NumberCategory)  {
    assert 42.meters.toString() == '42m'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Applying the <code>@Category</code> annotation has the advantage of being able to use instance methods without the target type as a
first parameter. The target type class is given as an argument to the annotation instead.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
There is a distinct section on <code>@Category</code> in the <a href="core-metaprogramming.html#xform-Category">compile-time metaprogramming section</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_metaclasses_tbd">Metaclasses (TBD)</h5>
<div class="sect5">
<h6 id="_custom_metaclasses_tbd">Custom metaclasses (TBD)</h6>
<div class="sect6">
<h7 id="_delegating_metaclass_tbd">Delegating metaclass (TBD)</h7>

</div>
<div class="sect6">
<h7 id="_magic_package_tbd">Magic package (TBD)</h7>

</div>
</div>
<div class="sect5">
<h6 id="_per_instance_metaclass_tbd">Per instance metaclass (TBD)</h6>

</div>
<div class="sect5">
<h6 id="metaprogramming_emc">ExpandoMetaClass</h6>
<div class="paragraph">
<p>Groovy comes with a special <code>MetaClass</code> the so-called <code>ExpandoMetaClass</code>. It is special in that it allows for dynamically
adding or changing methods, constructors, properties and even static methods by using a neat closure syntax.</p>
</div>
<div class="paragraph">
<p>Applying those modifications can be especially useful in mocking or stubbing scenarios as shown in the <a href="core-testing-guide.html#testing_guide_emc">Testing Guide</a>.</p>
</div>
<div class="paragraph">
<p>Every <code>java.lang.Class</code> is supplied by Groovy with a special <code>metaClass</code> property that will give you a reference to an
<code>ExpandoMetaClass</code> instance. This instance can then be used to add methods or change the behaviour of already existing
ones.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
By default <code>ExpandoMetaClass</code> doesn&#8217;t do inheritance. To enable this you must call <code>ExpandoMetaClass#enableGlobally()</code>
before your app starts such as in the main method or servlet bootstrap.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following sections go into detail on how <code>ExpandoMetaClass</code> can be used in various scenarios.</p>
</div>
<div class="sect6">
<h7 id="_methods_2">Methods</h7>
<div class="paragraph">
<p>Once the <code>ExpandoMetaClass</code> is accessed by calling the <code>metaClass</code> property, methods can added by using either the left shift
<code>&lt;&lt;</code> or the <code>=</code> operator.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
Note that the left shift operator is used to <em>append</em> a new method. If the method already exists
an exception will be thrown. If you want to <em>replace</em> a method you can use the <code>=</code> operator.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The operators are applied on a non-existent property of <code>metaClass</code> passing an instance of a <code>Closure</code> code block.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Book {
   String title
}

Book.metaClass.titleInUpperCase &lt;&lt; {-&gt; title.toUpperCase() }

def b = new Book(title:"The Stand")

assert "THE STAND" == b.titleInUpperCase()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above shows how a new method can be added to a class by accessing the <code>metaClass</code> property and using the <code>&lt;&lt;</code> or
 <code>=</code> operator to assign a <code>Closure</code> code block. The <code>Closure</code> parameters are interpreted as method parameters. Parameterless methods
 can be added by using the <code>{-&gt; ...}</code> syntax.</p>
</div>
</div>
<div class="sect6">
<h7 id="_properties_2">Properties</h7>
<div class="paragraph">
<p><code>ExpandoMetaClass</code> supports two mechanisms for adding or overriding properties.</p>
</div>
<div class="paragraph">
<p>Firstly, it has support for declaring a <em>mutable property</em> by simply assigning a value to a property of <code>metaClass</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Book {
   String title
}

Book.metaClass.author = "Stephen King"
def b = new Book()

assert "Stephen King" == b.author</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another way is to add getter and/or setter methods by using the standard mechanisms for adding instance methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Book {
  String title
}
Book.metaClass.getAuthor &lt;&lt; {-&gt; "Stephen King" }

def b = new Book()

assert "Stephen King" == b.author</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the source code example above the property is dictated by the closure and is a read-only property. It is feasible to add
an equivalent setter method but then the property value needs to be stored for later usage. This could be done as
shown in the following example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Book {
  String title
}

def properties = Collections.synchronizedMap([:])

Book.metaClass.setAuthor = { String value -&gt;
   properties[System.identityHashCode(delegate) + "author"] = value
}
Book.metaClass.getAuthor = {-&gt;
   properties[System.identityHashCode(delegate) + "author"]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is not the only technique however. For example in a servlet container one way might be to store the values in
the currently executing request as request attributes (as is done in some cases in Grails).</p>
</div>
</div>
<div class="sect6">
<h7 id="_constructors">Constructors</h7>
<div class="paragraph">
<p>Constructors can be added by using a special <code>constructor</code> property. Either the <code>&lt;&lt;</code> or <code>=</code> operator can be used
to assign a <code>Closure</code> code block. The <code>Closure</code> arguments will become the constructor arguments when the code is
executed at runtime.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Book {
    String title
}
Book.metaClass.constructor &lt;&lt; { String title -&gt; new Book(title:title) }

def book = new Book('Groovy in Action - 2nd Edition')
assert book.title == 'Groovy in Action - 2nd Edition'</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
Be careful when adding constructors however, as it is very easy to get into stack overflow troubles.
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="_static_methods">Static Methods</h7>
<div class="paragraph">
<p>Static methods can be added using the same technique as instance methods with the addition of the <code>static</code> qualifier
before the method name.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Book {
   String title
}

Book.metaClass.static.create &lt;&lt; { String title -&gt; new Book(title:title) }

def b = Book.create("The Stand")</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_borrowing_methods">Borrowing Methods</h7>
<div class="paragraph">
<p>With <code>ExpandoMetaClass</code> it is possible to use Groovy&#8217;s method pointer syntax to borrow methods from other classes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Person {
    String name
}
class MortgageLender {
   def borrowMoney() {
      "buy house"
   }
}

def lender = new MortgageLender()

Person.metaClass.buyHouse = lender.&amp;borrowMoney

def p = new Person()

assert "buy house" == p.buyHouse()</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_dynamic_method_names">Dynamic Method Names</h7>
<div class="paragraph">
<p>Since Groovy allows you to use Strings as property names this in turns allows you to dynamically create method and
property names at runtime. To create a method with a dynamic name simply use the language feature of reference property
names as strings.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Person {
   String name = "Fred"
}

def methodName = "Bob"

Person.metaClass."changeNameTo${methodName}" = {-&gt; delegate.name = "Bob" }

def p = new Person()

assert "Fred" == p.name

p.changeNameToBob()

assert "Bob" == p.name</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same concept can be applied to static methods and properties.</p>
</div>
<div class="paragraph">
<p>One application of dynamic method names can be found in the Grails web application framework. The concept of "dynamic
codecs" is implemented by using dynamic method names.</p>
</div>
<div class="listingblock">
<div class="title"><code>HTMLCodec</code> Class</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class HTMLCodec {
    static encode = { theTarget -&gt;
        HtmlUtils.htmlEscape(theTarget.toString())
    }

    static decode = { theTarget -&gt;
    	HtmlUtils.htmlUnescape(theTarget.toString())
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above shows a codec implementation. Grails comes with various codec implementations each defined in a single class.
At runtime there will be multiple codec classes in the application classpath. At application startup the framework adds
a <code>encodeXXX</code> and a <code>decodeXXX</code> method to certain meta-classes where <code>XXX</code> is the first part of the codec class name (e.g.
<code>encodeHTML</code>). This mechanism is in the following shown in some Groovy pseudo-code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def codecs = classes.findAll { it.name.endsWith('Codec') }

codecs.each { codec -&gt;
    Object.metaClass."encodeAs${codec.name-'Codec'}" = { codec.newInstance().encode(delegate) }
    Object.metaClass."decodeFrom${codec.name-'Codec'}" = { codec.newInstance().decode(delegate) }
}


def html = '&lt;html&gt;&lt;body&gt;hello&lt;/body&gt;&lt;/html&gt;'

assert '&lt;html&gt;&lt;body&gt;hello&lt;/body&gt;&lt;/html&gt;' == html.encodeAsHTML()</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="_runtime_discovery">Runtime Discovery</h7>
<div class="paragraph">
<p>At runtime it is often useful to know what other methods or properties exist at the time the method is executed. <code>ExpandoMetaClass</code>
provides the following methods as of this writing:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>getMetaMethod</code></p>
</li>
<li>
<p><code>hasMetaMethod</code></p>
</li>
<li>
<p><code>getMetaProperty</code></p>
</li>
<li>
<p><code>hasMetaProperty</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Why can&#8217;t you just use reflection? Well because Groovy is different, it has the methods that are "real" methods and
methods that are available only at runtime. These are sometimes (but not always) represented as MetaMethods. The
MetaMethods tell you what methods are available at runtime, thus your code can adapt.</p>
</div>
<div class="paragraph">
<p>This is of particular use when overriding <code>invokeMethod</code>, <code>getProperty</code> and/or <code>setProperty</code>.</p>
</div>
</div>
<div class="sect6">
<h7 id="_groovyobject_methods">GroovyObject Methods</h7>
<div class="paragraph">
<p>Another feature of <code>ExpandoMetaClass</code> is that it allows to override the methods <code>invokeMethod</code>, <code>getProperty</code> and
<code>setProperty</code>, all of them can be found in the <code>groovy.lang.GroovyObject</code> class.</p>
</div>
<div class="paragraph">
<p>The following example shows how to override <code>invokeMethod</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Stuff {
   def invokeMe() { "foo" }
}

Stuff.metaClass.invokeMethod = { String name, args -&gt;
   def metaMethod = Stuff.metaClass.getMetaMethod(name, args)
   def result
   if(metaMethod) result = metaMethod.invoke(delegate,args)
   else {
      result = "bar"
   }
   result
}

def stf = new Stuff()

assert "foo" == stf.invokeMe()
assert "bar" == stf.doStuff()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first step in the <code>Closure</code> code is to lookup the <code>MetaMethod</code> for the given name and arguments. If the method
can be found everything is fine and it is delegated to. If not, a dummy value is returned.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
A <code>MetaMethod</code> is a method that is known to exist on the <code>MetaClass</code> whether added at runtime or at compile-time.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The same logic can be used to override <code>setProperty</code> or <code>getProperty</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Person {
   String name = "Fred"
}

Person.metaClass.getProperty = { String name -&gt;
   def metaProperty = Person.metaClass.getMetaProperty(name)
   def result
   if(metaProperty) result = metaProperty.getProperty(delegate)
   else {
      result = "Flintstone"
   }
   result
}

def p = new Person()

assert "Fred" == p.name
assert "Flintstone" == p.other</code></pre>
</div>
</div>
<div class="paragraph">
<p>The important thing to note here is that instead of a <code>MetaMethod</code> a <code>MetaProperty</code> instance is looked up. If that exists
the <code>getProperty</code> method of the <code>MetaProperty</code> is called, passing the delegate.</p>
</div>
</div>
<div class="sect6">
<h7 id="_overriding_static_invokemethod">Overriding Static invokeMethod</h7>
<div class="paragraph">
<p><code>ExpandoMetaClass</code> even allows for overriding static method with a special <code>invokeMethod</code> syntax.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Stuff {
   static invokeMe() { "foo" }
}

Stuff.metaClass.'static'.invokeMethod = { String name, args -&gt;
   def metaMethod = Stuff.metaClass.getStaticMetaMethod(name, args)
   def result
   if(metaMethod) result = metaMethod.invoke(delegate,args)
   else {
      result = "bar"
   }
   result
}

assert "foo" == Stuff.invokeMe()
assert "bar" == Stuff.doStuff()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The logic that is used for overriding the static method is the same as we&#8217;ve seen before for overriding instance methods. The
only difference is the access to the <code>metaClass.static</code> property and the call to <code>getStaticMethodName</code> for retrieving
the static <code>MetaMethod</code> instance.</p>
</div>
</div>
<div class="sect6">
<h7 id="_extending_interfaces">Extending Interfaces</h7>
<div class="paragraph">
<p>It is possible to add methods onto interfaces with <code>ExpandoMetaClass</code>. To do this however, it <strong>must</strong> be enabled
globally using the <code>ExpandoMetaClass.enableGlobally()</code> method before application start-up.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">List.metaClass.sizeDoubled = {-&gt; delegate.size() * 2 }

def list = []

list &lt;&lt; 1
list &lt;&lt; 2

assert 4 == list.sizeDoubled()</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_extension_modules">Extension modules</h5>
<div class="sect5">
<h6 id="_extending_existing_classes">Extending existing classes</h6>
<div class="paragraph">
<p>An extension module allows you to add new methods to existing classes, including classes which are precompiled, like
classes from the JDK. Those new methods, unlike those defined through a metaclass or using a category, are available
globally. For example, when you write:</p>
</div>
<div class="listingblock">
<div class="title">Standard extension method</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def file = new File(...)
def contents = file.getText('utf-8')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>getText</code> method doesn’t exist on the <code>File</code> class. However, Groovy knows it because it is defined in a special
class, <code>ResourceGroovyMethods</code>:</p>
</div>
<div class="listingblock">
<div class="title">ResourceGroovyMethods.java</div>
<div class="content">
<pre class="prettyprint"><code class="java language-java">public static String getText(File file, String charset) throws IOException {
 return IOGroovyMethods.getText(newReader(file, charset));
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may notice that the extension method is defined using a static method in a &#8220;helper&#8221; class (where various extension
methods are defined). The first argument of the <code>getText</code> method corresponds to the receiver, while additional parameters
correspond to the arguments of the extension method. So here, we are defining a method called <em>getText</em> on
the <code>File</code> class (because the first argument is of type <code>File</code>), which takes a single argument as a parameter (the encoding <code>String</code>).</p>
</div>
<div class="paragraph">
<p>The process of creating an extension module is simple:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>write an extension class like above</p>
</li>
<li>
<p>write a module descriptor file</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Then you have to make the extension module visible to Groovy, which is as simple as having the extension module classes
and descriptor available on classpath. This means that you have the choice:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>either provide the classes and module descriptor directly on classpath</p>
</li>
<li>
<p>or bundle your extension module into a jar for reusability</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An extension module may add two kind of methods to a class:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>instance methods (to be called on an instance of a class)</p>
</li>
<li>
<p>static methods (to be called on the class itself)</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_instance_methods">Instance methods</h6>
<div class="paragraph">
<p>To add an instance method to an existing class, you need to create an extension class. For example, let&#8217;s say you
want to add a <code>maxRetries</code> method on <code>Integer</code> which accepts a closure and executes it at most <em>n</em> times until no
exception is thrown. To do that, you only need to write the following:</p>
</div>
<div class="listingblock">
<div class="title">MaxRetriesExtension.groovy</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class MaxRetriesExtension {                                     <i class="conum" data-value="1"></i><b>(1)</b>
    static void maxRetries(Integer self, Closure code) {        <i class="conum" data-value="2"></i><b>(2)</b>
        int retries = 0
        Throwable e
        while (retries&lt;self) {
            try {
                code.call()
                break
            } catch (Throwable err) {
                e = err
                retries++
            }
        }
        if (retries==0 &amp;&amp; e) {
            throw e
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The extension class</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>First argument of the static method corresponds to the receiver of the message, that is to say the extended instance</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, after <a href="userGuides.html#module-descriptor">having declared your extension class</a>, you can call it this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">int i=0
5.maxRetries {
    i++
}
assert i == 1
i=0
try {
    5.maxRetries {
        throw new RuntimeException("oops")
    }
} catch (RuntimeException e) {
    assert i == 5
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_static_methods_2">Static methods</h6>
<div class="paragraph">
<p>It is also possible to add static methods to a class. In that case, the static method needs to be defined in its <strong>own</strong>
file:</p>
</div>
<div class="listingblock">
<div class="title">StaticStringExtension.groovy</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class StaticStringExtension {                                       <i class="conum" data-value="1"></i><b>(1)</b>
    static String greeting(String self) {                           <i class="conum" data-value="2"></i><b>(2)</b>
        'Hello, world!'
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The static extension class</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>First argument of the static method corresponds to the class being extended and is <strong>unused</strong></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In which case you can call it directly on the <code>String</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">assert String.greeting() == 'Hello, world!'</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="module-descriptor">Module descriptor</h6>
<div class="paragraph">
<p>For Groovy to be able to load your extension methods, you must declare
your extension helper classes. You must create a file named
<code>org.codehaus.groovy.runtime.ExtensionModule</code> into the
<code>META-INF/services</code> directory:</p>
</div>
<div class="listingblock">
<div class="title">org.codehaus.groovy.runtime.ExtensionModule</div>
<div class="content">
<pre>moduleName=Test module for specifications
moduleVersion=1.0-test
extensionClasses=support.MaxRetriesExtension
staticExtensionClasses=support.StaticStringExtension</pre>
</div>
</div>
<div class="paragraph">
<p>The module descriptor requires 4 keys:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>moduleName</em> : the name of your module</p>
</li>
<li>
<p><em>moduleVersion</em>: the version of your module. Note that version number
is only used to check that you don’t load the same module in two
different versions.</p>
</li>
<li>
<p><em>extensionClasses</em>: the list of extension helper classes for instance
methods. You can provide several classes, given that they are comma
separated.</p>
</li>
<li>
<p><em>staticExtensionClasses</em>: the list of extension helper classes for
static methods. You can provide several classes, given that they are
comma separated.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that it is not required for a module to define both static helpers
and instance helpers, and that you may add several classes to a single
module. You can also extend different classes in a single module without
problem. It is even possible to use different classes in a single
extension class, but it is recommended to group extension methods into
classes by feature set.</p>
</div>
</div>
<div class="sect5">
<h6 id="_extension_modules_and_classpath">Extension modules and classpath</h6>
<div class="paragraph">
<p>It&#8217;s worth noting that you can&#8217;t use an extension which is compiled at the same time as code using it. That means that
to use an extension, it <strong>has</strong> to be available on classpath, as compiled classes, before the code using it gets compiled.
Usually, this means that you can&#8217;t have the <em>test</em> classes in the same source unit as the extension class itself. Since
in general, test sources are separated from normal sources and executed in another step of the build, this is not an issue.</p>
</div>
</div>
<div class="sect5">
<h6 id="_compatibility_with_type_checking">Compatibility with type checking</h6>
<div class="paragraph">
<p>Unlike categories, extension modules are compatible with type checking: if they are found on classpath, then the type
checker is aware of the extension methods and will not complain when you call them. It is also compatible with static
compilation.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_compile_time_metaprogramming">4.4.2. Compile-time metaprogramming</h4>
<div class="paragraph">
<p>Compile-time metaprogramming in Groovy allows code generation at compile-time. Those transformations are altering the
Abstract Syntax Tree (AST) of a program, which is why in Groovy we call it AST transformations. AST transformations
allow you to hook into the compilation process, modify the AST and continue the compilation process to generate regular
bytecode. Compared to runtime metaprogramming, this has the advantage of making the changes visible in the class file
itself (that is to say, in the bytecode). Making it visible in the bytecode is important for example if you want the
transformations to be part of the class contract (implementing interfaces, extending abstract classes, &#8230;) or even
if you need your class to be callable from Java (or other JVM languages). For example, an AST transformation can add
methods to a class. If you do it with runtime metaprogramming, the new method would only be visible from Groovy. If you
do the same using compile-time metaprogramming, the method would be visible from Java too. Last but not least, performance
would likely be better with compile-time metaprogramming (because no initialization phase is required).</p>
</div>
<div class="paragraph">
<p>In this section, we will start with explaining the various compile-time transformations that are bundled with the Groovy
distribution. In a subsequent section, we will describe how you can <a href="userGuides.html#developing-ast-xforms">implement your own AST transformations</a>
and what are the disadvantages of this technique.</p>
</div>
<div class="sect4">
<h5 id="_available_ast_transformations">Available AST transformations</h5>
<div class="paragraph">
<p>Groovy comes with various AST transformations covering different needs: reducing boilerplate (code generation), implementing
design patterns (delegation, &#8230;), logging, declarative concurrency, cloning, safer scripting, tweaking the compilation,
implementing Swing patterns, testing and eventually managing dependencies. If none of those AST transformations cover
your needs, you can still implement your own, as show in section <a href="userGuides.html#developing-ast-xforms">Developing your own AST
transformations</a>.</p>
</div>
<div class="paragraph">
<p>AST transformations can be separated into two categories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>global AST transformations are applied transparently, globally, as soon as they are found on compile classpath</p>
</li>
<li>
<p>local AST transformations are applied by annotating the source code with markers. Unlike global AST transformations,
local AST transformations may support parameters.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Groovy doesn&#8217;t ship with any global AST transformation, but you can find a list of local AST transformations
available for you to use in your code here:</p>
</div>
<div class="sect5">
<h6 id="_code_generation_transformations">Code generation transformations</h6>
<div class="paragraph">
<p>This category of transformation includes AST transformations which help removing boilerplate code. This is typically
code that you have to write but that does not carry any useful information. By autogenerating this boilerplate code,
the code you have to write is left clean and concise and the chance of introducing an error by getting such
boilerplate code incorrect is reduced.</p>
</div>
<div class="sect6">
<h7 id="xform-ToString">@groovy.transform.ToString</h7>
<div class="paragraph">
<p>The <code>@ToString</code> AST transformation generates a human readable <code>toString</code> representation of the class. For example,
annotating the <code>Person</code> class like below will automatically generate the <code>toString</code> method for you:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.ToString

@ToString
class Person {
    String firstName
    String lastName
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this definition, then the following assertion passes, meaning that a <code>toString</code> method taking the field valuess from
the class and printing them out has been generated:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def p = new Person(firstName: 'Jack', lastName: 'Nicholson')
assert p.toString() == 'Person(Jack, Nicholson)'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@ToString</code> annotation accepts several parameters which are summarized in the following table:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 28%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includeNames</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to include names of properties in generated toString.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ToString(includeNames=true)
class Person {
    String firstName
    String lastName
}

def p = new Person(firstName: 'Jack', lastName: 'Nicholson')
assert p.toString() == 'Person(firstName:Jack, lastName:Nicholson)'</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">excludes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of properties to exclude from toString</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ToString(excludes=['firstName'])
class Person {
    String firstName
    String lastName
}

def p = new Person(firstName: 'Jack', lastName: 'Nicholson')
assert p.toString() == 'Person(Nicholson)'</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of fields to include in toString</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ToString(includes=['lastName'])
class Person {
    String firstName
    String lastName
}

def p = new Person(firstName: 'Jack', lastName: 'Nicholson')
assert p.toString() == 'Person(Nicholson)'</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includeSuper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should superclass be included in toString</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ToString
class Id { long id }

@ToString(includeSuper=true)
class Person extends Id {
    String firstName
    String lastName
}

def p = new Person(id:1, firstName: 'Jack', lastName: 'Nicholson')
assert p.toString() == 'Person(Jack, Nicholson, Id(1))'</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includeFields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should fields be included in toString, in addition to properties</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ToString(includeFields=true)
class Person {
    String firstName
    String lastName
    private int age
    void test() {
       age = 42
    }
}

def p = new Person(firstName: 'Jack', lastName: 'Nicholson')
p.test()
assert p.toString() == 'Person(Jack, Nicholson, 42)'</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ignoreNulls</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should properties/fields with null value be displayed</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ToString(ignoreNulls=true)
class Person {
    String firstName
    String lastName
}

def p = new Person(firstName: 'Jack')
assert p.toString() == 'Person(Jack)'</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includePackage</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use fully qualified class name instead of simple name in toString</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ToString(includePackage=true)
class Person {
    String firstName
    String lastName
}

def p = new Person(firstName: 'Jack', lastName:'Nicholson')
assert p.toString() == 'acme.Person(Jack, Nicholson)'</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cache the toString string. Should only be set to true if the class is immutable.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ToString(cache=true)
class Person {
    String firstName
    String lastName
}

def p = new Person(firstName: 'Jack', lastName:'Nicholson')
def s1 = p.toString()
def s2 = p.toString()
assert s1 == s2
assert s1 == 'Person(Jack, Nicholson)'
assert s1.is(s2) // same instance</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="xform-EqualsAndHashCode">@groovy.transform.EqualsAndHashCode</h7>
<div class="paragraph">
<p>The <code>@EqualsAndHashCode</code> AST transformation aims at generating <code>equals</code> and <code>hashCode</code> methods for you. The generated
hashcode follows the best practices as described in <em>Effective Java</em> by <em>Josh Bloch</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.EqualsAndHashCode
@EqualsAndHashCode
class Person {
    String firstName
    String lastName
}

def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson')
def p2 = new Person(firstName: 'Jack', lastName: 'Nicholson')

assert p1==p2
assert p1.hashCode() == p2.hashCode()</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are several options available to tweak the behavior of <code>@EqualsAndHashCode</code>:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 28%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">excludes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of properties to exclude from equals/hashCode</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.EqualsAndHashCode
@EqualsAndHashCode(excludes=['firstName'])
class Person {
    String firstName
    String lastName
}

def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson')
def p2 = new Person(firstName: 'Bob', lastName: 'Nicholson')

assert p1==p2
assert p1.hashCode() == p2.hashCode()</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of fields to include in equals/hashCode</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.EqualsAndHashCode
@EqualsAndHashCode(includes=['lastName'])
class Person {
    String firstName
    String lastName
}

def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson')
def p2 = new Person(firstName: 'Bob', lastName: 'Nicholson')

assert p1==p2
assert p1.hashCode() == p2.hashCode()</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">callSuper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to include super in equals and hashCode calculations</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.EqualsAndHashCode

@EqualsAndHashCode
class Living {
    String race
}

@EqualsAndHashCode(callSuper=true)
class Person extends Living {
    String firstName
    String lastName
}

def p1 = new Person(race:'Human', firstName: 'Jack', lastName: 'Nicholson')
def p2 = new Person(race: 'Human beeing', firstName: 'Jack', lastName: 'Nicholson')

assert p1!=p2
assert p1.hashCode() != p2.hashCode()</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includeFields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should fields be included in equals/hashCode, in addition to properties</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ToString(includeFields=true)
class Person {
    String firstName
    String lastName
    private int age
    void test() {
       age = 42
    }
}

def p = new Person(firstName: 'Jack', lastName: 'Nicholson')
p.test()
assert p.toString() == 'Person(Jack, Nicholson, 42)'</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cache</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Cache the hashCode computation. Should only be set to true if the class is immutable.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ToString(cache=true)
class Person {
    String firstName
    String lastName
}

def p = new Person(firstName: 'Jack', lastName:'Nicholson')
def s1 = p.toString()
def s2 = p.toString()
assert s1 == s2
assert s1 == 'Person(Jack, Nicholson)'
assert s1.is(s2) // same instance</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">useCanEqual</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should equals call canEqual helper method.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>See <a href="http://www.artima.com/lejava/articles/equality.html">http://www.artima.com/lejava/articles/equality.html</a></p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="xform-TupleConstructor">@groovy.transform.TupleConstructor</h7>
<div class="paragraph">
<p>The <code>@TupleConstructor</code> annotation aims at eliminating boilerplate code by generating constructors for you. A tuple
constructor is created for each property, with default values (using the Java default values). For example, the
following code will generate 3 constructors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.TupleConstructor

@TupleConstructor
class Person {
    String firstName
    String lastName
}

// traditional map-style constructor
def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson')
// generated tuple constructor
def p2 = new Person('Jack', 'Nicholson')
// generated tuple constructor with default value for second property
def p3 = new Person('Jack')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first constructor is a no-arg constructor which allows the traditional map-style construction. It is worth noting
that if the first property (or field) has type LinkedHashMap or if there is a single Map, AbstractMap or HashMap
property (or field), then the map-style mapping is not available.</p>
</div>
<div class="paragraph">
<p>The other constructors are generated by taking the properties in the order they are defined. Groovy will generate as
many constructors as they are properties (or fields, depending on the options).</p>
</div>
<div class="paragraph">
<p>The <code>@TupleConstructor</code> AST transformation accepts several configuration options:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 28%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">excludes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of properties to exclude from tuple constructor generation</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.TupleConstructor

@TupleConstructor(excludes=['lastName'])
class Person {
    String firstName
    String lastName
}

def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson')
def p2 = new Person('Jack')
try {
    // will fail because the second property is excluded
    def p3 = new Person('Jack', 'Nicholson')
} catch (e) {
    assert e.message.contains ('Could not find matching constructor')
}</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of fields to include in tuple constructor generation</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.TupleConstructor

@TupleConstructor(includes=['firstName'])
class Person {
    String firstName
    String lastName
}

def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson')
def p2 = new Person('Jack')
try {
    // will fail because the second property is not included
    def p3 = new Person('Jack', 'Nicholson')
} catch (e) {
    assert e.message.contains ('Could not find matching constructor')
}</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includeFields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should fields be included in tuple constructor generation, in addition to properties</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.TupleConstructor

@TupleConstructor(includeFields=true)
class Person {
    String firstName
    String lastName
    private String occupation
    public String toString() {
        "$firstName $lastName: $occupation"
    }
}

def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson', occupation: 'Actor')
def p2 = new Person('Jack', 'Nicholson', 'Actor')

assert p1.firstName == p2.firstName
assert p1.lastName == p2.lastName
assert p1.toString() == 'Jack Nicholson: Actor'
assert p1.toString() == p2.toString()</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includeProperties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should properties be included in tuple constructor generation</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.TupleConstructor

@TupleConstructor(includeProperties=false)
class Person {
    String firstName
    String lastName
}

def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson')

try {
    def p2 = new Person('Jack', 'Nicholson')
} catch(e) {
    // will fail because properties are not included
}</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includeSuperFields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should fields from super classes be included in tuple constructor generation</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.TupleConstructor

class Base {
    protected String occupation
    public String occupation() { this.occupation }
}

@TupleConstructor(includeSuperFields=true)
class Person extends Base {
    String firstName
    String lastName
    public String toString() {
        "$firstName $lastName: ${occupation()}"
    }
}

def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson', occupation: 'Actor')

def p2 = new Person('Actor', 'Jack', 'Nicholson')

assert p1.firstName == p2.firstName
assert p1.lastName == p2.lastName
assert p1.toString() == 'Jack Nicholson: Actor'
assert p2.toString() == p1.toString()</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includeSuperProperties</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should properties from super classes be included in tuple constructor generation</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.TupleConstructor

class Base {
    String occupation
}

@TupleConstructor(includeSuperProperties=true)
class Person extends Base {
    String firstName
    String lastName
    public String toString() {
        "$firstName $lastName: $occupation"
    }
}

def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson')

def p2 = new Person('Actor', 'Jack', 'Nicholson')

assert p1.firstName == p2.firstName
assert p1.lastName == p2.lastName
assert p1.toString() == 'Jack Nicholson: null'
assert p2.toString() == 'Jack Nicholson: Actor'</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">callSuper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should super properties be called within a call to the parent constructor rather than set as properties</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.TupleConstructor

class Base {
    String occupation
    Base() {}
    Base(String job) { occupation = job?.toLowerCase() }
}

@TupleConstructor(includeSuperProperties = true, callSuper=true)
class Person extends Base {
    String firstName
    String lastName
    public String toString() {
        "$firstName $lastName: $occupation"
    }
}

def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson')

def p2 = new Person('ACTOR', 'Jack', 'Nicholson')

assert p1.firstName == p2.firstName
assert p1.lastName == p2.lastName
assert p1.toString() == 'Jack Nicholson: null'
assert p2.toString() == 'Jack Nicholson: actor'</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">force</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By default, the transformation will do nothing if a constructor is already defined. Setting this property
to true, the constructor will be generated and it&#8217;s your responsability to ensure that no duplicate constructor
is defined</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>See javadocs</p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="xform-Canonical">@groovy.transform.Canonical</h7>
<div class="paragraph">
<p>The <code>@Canonical</code> AST transformation combines the effects of the <a href="userGuides.html#xform-ToString">@ToString</a>,
<a href="userGuides.html#xform-EqualsAndHashCode">@EqualsAndHashCode</a> and <a href="userGuides.html#xform-TupleConstructor">@TupleConstructor</a>
annotations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.Canonical

@Canonical
class Person {
    String firstName
    String lastName
}
def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson')
assert p1.toString() == 'Person(Jack, Nicholson)' // Effect of @ToString

def p2 = new Person('Jack','Nicholson') // Effect of @TupleConstructor
assert p2.toString() == 'Person(Jack, Nicholson)'

assert p1==p2 // Effect of @EqualsAndHashCode
assert p1.hashCode()==p2.hashCode() // Effect of @EqualsAndHashCode</code></pre>
</div>
</div>
<div class="paragraph">
<p>A similar immutable class can be generated using the <a href="userGuides.html#xform-Immutable">@Immutable</a> AST transformation instead.
The <code>@Canonical</code> AST transformation supports several configuration options:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 28%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">excludes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of properties to exclude from tuple constructor generation</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.Canonical

@Canonical(excludes=['lastName'])
class Person {
    String firstName
    String lastName
}
def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson')
assert p1.toString() == 'Person(Jack)' // Effect of @ToString

def p2 = new Person('Jack') // Effect of @TupleConstructor
assert p2.toString() == 'Person(Jack)'

assert p1==p2 // Effect of @EqualsAndHashCode
assert p1.hashCode()==p2.hashCode() // Effect of @EqualsAndHashCode</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">List of fields to include in tuple constructor generation</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.Canonical

@Canonical(includes=['firstName'])
class Person {
    String firstName
    String lastName
}
def p1 = new Person(firstName: 'Jack', lastName: 'Nicholson')
assert p1.toString() == 'Person(Jack)' // Effect of @ToString

def p2 = new Person('Jack') // Effect of @TupleConstructor
assert p2.toString() == 'Person(Jack)'

assert p1==p2 // Effect of @EqualsAndHashCode
assert p1.hashCode()==p2.hashCode() // Effect of @EqualsAndHashCode</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="xform-InheritConstructors">@groovy.transform.InheritConstructors</h7>
<div class="paragraph">
<p>The <code>@InheritConstructor</code> AST transformation aims at generating constructors matching super constructors for you. This
is in particular useful when overridding exception classes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.InheritConstructors

@InheritConstructors
class CustomException extends Exception {}

// all those are generated constructors
new CustomException()
new CustomException("A custom message")
new CustomException("A custom message", new RuntimeException())
new CustomException(new RuntimeException())

// Java 7 only
// new CustomException("A custom message", new RuntimeException(), false, true)</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="xform-Category">@groovy.lang.Category</h7>
<div class="paragraph">
<p>The <code>@Category</code> AST transformation simplifies the creation of Groovy categories. Historically, a Groovy category was
written like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class TripleCategory {
    public static Integer triple(Integer self) {
        3*self
    }
}
use (TripleCategory) {
    assert 9 == 3.triple()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Category</code> transformation lets you write the same using an instance-style class, rather that a static class style.
This removes the need for having the first argument of each method being the receiver. The category can be written like
this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Category(Integer)
class TripleCategory {
    public Integer triple() { 3*this }
}
use (TripleCategory) {
    assert 9 == 3.triple()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the mixed in class can be referenced using <code>this</code> instead. It&#8217;s also worth noting that using instance fields
in a category class is inherently unsafe: categories are not stateful (like traits).</p>
</div>
</div>
<div class="sect6">
<h7 id="xform-IndexedProperty">@groovy.transform.IndexedProperty</h7>
<div class="paragraph">
<p>The <code>@IndexedProperty</code> annotation aims at generating indexed getters/setters for properties of list/array types.
This is in particular useful if you want to use a Groovy class from Java. While Groovy supports GPath to access properties,
this is not available from Java. The <code>@IndexedProperty</code> annotation will generate indexed properties of the following
form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class SomeBean {
    @IndexedProperty String[] someArray = new String[2]
    @IndexedProperty List someList = []
}

def bean = new SomeBean()
bean.setSomeArray(0, 'value')
bean.setSomeList(0, 123)

assert bean.someArray[0] == 'value'
assert bean.someList == [123]</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="xform-Lazy">@groovy.lang.Lazy</h7>
<div class="paragraph">
<p>The <code>@Lazy</code> AST transformation implements lazy initialization of fields. For example, the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class SomeBean {
    @Lazy LinkedList myField
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>will produce the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">List $myField
List getMyField() {
    if ($myField!=null) { return $myField }
    else {
        $myField = new LinkedList()
        return $myField
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default value which is used to initialize the field is the default constructor of the declaration type. It is possible
to define a default value by using a closure on the right hand side of the property assignment, as in the following
example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>class SomeBean {
    @Lazy LinkedList myField = { ['a','b','c']}()
}</pre>
</div>
</div>
<div class="paragraph">
<p>In that case, the generated code looks like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>List $myField
List getMyField() {
    if ($myField!=null) { return $myField }
    else {
        $myField = { ['a','b','c']}()
        return $myField
    }
}</pre>
</div>
</div>
<div class="paragraph">
<p>If the field is declared volatile then initialization will be synchronized using the
<a href="http://en.wikipedia.org/wiki/Double-checked_locking">double-checked locking</a> pattern.</p>
</div>
<div class="paragraph">
<p>Using the <code>soft=true</code> parameter, the helper field will use a <code>SoftReference</code> instead, providing a simple way to
implement caching. In that case, if the garbage collector decides to collect the reference, initialization will occur
the next time the field is accessed.</p>
</div>
</div>
<div class="sect6">
<h7 id="xform-Newify">@groovy.lang.Newify</h7>
<div class="paragraph">
<p>The <code>@Newify</code> AST transformation is used to bring alternative syntaxes to construct objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using the <code>Python</code> style:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@Newify([Tree,Leaf])
class TreeBuilder {
    Tree tree = Tree(Leaf('A'),Leaf('B'),Tree(Leaf('C')))
}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>or using the <code>Ruby</code> style:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>@Newify([Tree,Leaf])
class TreeBuilder {
    Tree tree = Tree.new(Leaf.new('A'),Leaf.new('B'),Tree.new(Leaf.new('C')))
}</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Ruby</code> version can be disabled by setting the <code>auto</code> flag to <code>false</code>.</p>
</div>
</div>
<div class="sect6">
<h7 id="xform-Sortable">@groovy.lang.Sortable</h7>
<div class="paragraph">
<p>The <code>@Sortable</code> AST transformation is used to help write classes that are <code>Comparable</code> and easily sorted by
numerous properties. It is easy to use as shown in the following example where we annotate the <code>Person</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.Sortable

@Sortable class Person {
    String first
    String last
    Integer born
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated class has the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it implements the <code>Comparable</code> interface</p>
</li>
<li>
<p>it contains a <code>compareTo</code> method with an implementation based on the natural ordering of the <code>first</code>, <code>last</code> and <code>born</code> properties</p>
</li>
<li>
<p>it has three methods returning comparators: <code>comparatorByFirst</code>, <code>comparatorByLast</code> and <code>comparatorByBorn</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The generated <code>compareTo</code> method will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">public int compareTo(java.lang.Object obj) {
    if (this.is(obj)) {
        return 0
    }
    if (!(obj instanceof Person)) {
        return -1
    }
    java.lang.Integer value = this.first &lt;=&gt; obj.first
    if (value != 0) {
        return value
    }
    value = this.last &lt;=&gt; obj.last
    if (value != 0) {
        return value
    }
    value = this.born &lt;=&gt; obj.born
    if (value != 0) {
        return value
    }
    return 0
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As an example of the generated comparators, the <code>comparatorByFirst</code> comparator will have a <code>compare</code> method that looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">public int compare(java.lang.Object arg0, java.lang.Object arg1) {
    if (arg0 == arg1) {
        return 0
    }
    if (arg0 != null &amp;&amp; arg1 == null) {
        return -1
    }
    if (arg0 == null &amp;&amp; arg1 != null) {
        return 1
    }
    return arg0.first &lt;=&gt; arg1.first
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Person</code> class can be used wherever a <code>Comparable</code> is expected and the generated comparators
wherever a <code>Comparator</code> is expected as shown by these examples:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def people = [
    new Person(first: 'Johnny', last: 'Depp', born: 1963),
    new Person(first: 'Keira', last: 'Knightley', born: 1985),
    new Person(first: 'Geoffrey', last: 'Rush', born: 1951),
    new Person(first: 'Orlando', last: 'Bloom', born: 1977)
]

assert people[0] &gt; people[2]
assert people.sort()*.last == ['Rush', 'Depp', 'Knightley', 'Bloom']
assert people.sort(false, Person.comparatorByFirst())*.first == ['Geoffrey', 'Johnny', 'Keira', 'Orlando']
assert people.sort(false, Person.comparatorByLast())*.last == ['Bloom', 'Depp', 'Knightley', 'Rush']
assert people.sort(false, Person.comparatorByBorn())*.last == ['Rush', 'Depp', 'Bloom', 'Knightley']</code></pre>
</div>
</div>
<div class="paragraph">
<p>Normally, all properties are used in the generated <code>compareTo</code> method in the priority order in which they are defined.
You can include or exclude certain properties from the generated <code>compareTo</code> method by giving a list of property names
in the <code>includes</code> or <code>excludes</code> annotation attributes. If using <code>includes</code>, the order of the property names given will
determine the priority of properties when comparing. To illustrate, consider the following <code>Person</code> class definition:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Sortable(includes='first,born') class Person {
    String last
    int born
    String first
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It will have two comparator methods <code>comparatorByFirst</code> and <code>comparatorByBorn</code> and the generated <code>compareTo</code> method will look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">public int compareTo(java.lang.Object obj) {
    if (this.is(obj)) {
        return 0
    }
    if (!(obj instanceof Person)) {
        return -1
    }
    java.lang.Integer value = this.first &lt;=&gt; obj.first
    if (value != 0) {
        return value
    }
    value = this.born &lt;=&gt; obj.born
    if (value != 0) {
        return value
    }
    return 0
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>Person</code> class can be used as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def people = [
    new Person(first: 'Ben', last: 'Affleck', born: 1972),
    new Person(first: 'Ben', last: 'Stiller', born: 1965)
]

assert people.sort()*.last == ['Stiller', 'Affleck']</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="xform-Builder">@groovy.transform.builder.Builder</h7>
<div class="paragraph">
<p>The <code>@Builder</code> AST transformation is used to help write classes that can be created using <em>fluent</em> api calls.
The transform supports multiple building strategies to cover a range of cases and there are a number
of configuration options to customize the building process. If you&#8217;re an AST hacker, you can also define your own
strategy class. The following table lists the available strategies that are bundled with Groovy and the
configuration options each strategy supports.</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 14%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Strategy</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Description</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">builderClassName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">builderMethodName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">buildMethodName</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">prefix</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">includes/excludes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SimpleStrategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">chained setters</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes, default "set"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ExternalStrategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">explicit builder class, class being built untouched</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">n/a</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes, default "build"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes, default ""</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DefaultStrategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">creates a nested helper class</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes, default <em>&lt;TypeName&gt;</em>Builder</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes, default "builder"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes, default "build"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes, default ""</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>InitializerStrategy</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">creates a nested helper class providing type-safe fluent creation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes, default <em>&lt;TypeName&gt;</em>Initializer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes, default "createInitializer"</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes, default "create" but usually only used internally</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes, default ""</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">yes</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<div class="title">SimpleStrategy</div>
<p>To use the <code>SimpleStrategy</code>, annotate your Groovy class using the <code>@Builder</code> annotation, and specify the strategy as shown in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.builder.*

@Builder(builderStrategy=SimpleStrategy)
class Person {
    String first
    String last
    Integer born
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, just call the setters in a chained fashion as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def p1 = new Person().setFirst('Johnny').setLast('Depp').setBorn(1963)
assert "$p1.first $p1.last" == 'Johnny Depp'</code></pre>
</div>
</div>
<div class="paragraph">
<p>For each property, a generated setter will be created which looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">public Person setFirst(java.lang.String first) {
    this.first = first
    return this
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can specify a prefix as shown in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.builder.*

@Builder(builderStrategy=SimpleStrategy, prefix="")
class Person {
    String first
    String last
    Integer born
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And calling the chained setters would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def p = new Person().first('Johnny').last('Depp').born(1963)
assert "$p.first $p.last" == 'Johnny Depp'</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>SimpleStrategy</code> in conjunction with <code>@Canonical</code>. If your <code>@Builder</code> annotation doesn&#8217;t have
explicit <code>includes</code> or <code>excludes</code> annotation attributes but your <code>@Canonical</code> annotation does, the ones
from <code>@Canonical</code> will be re-used for <code>@Builder</code>.</p>
</div>
<div class="paragraph">
<p>The annotation attributes <code>builderClassName</code>, <code>buildMethodName</code>, <code>builderMethodName</code> and <code>forClass</code> are not supported for this strategy.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
Groovy already has built-in building mechanisms. Don&#8217;t rush to using <code>@Builder</code> if the built-in mechanisms meet your needs. Some examples:
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def p2 = new Person(first: 'Keira', last: 'Knightley', born: 1985)
def p3 = new Person().with {
    first = 'Geoffrey'
    last = 'Rush'
    born = 1951
}</code></pre>
</div>
</div>
<div class="paragraph">
<div class="title">ExternalStrategy</div>
<p>To use the <code>ExternalStrategy</code>, create and annotate a Groovy builder class using the <code>@Builder</code> annotation, specify the
class the builder is for using <code>forClass</code> and indicate use of the <code>ExternalStrategy</code>.
Suppose you have the following class you would like a builder for:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Person {
    String first
    String last
    int born
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>you explicitly create and use your builder class as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.builder.*

@Builder(builderStrategy=ExternalStrategy, forClass=Person)
class PersonBuilder { }

def p = new PersonBuilder().first('Johnny').last('Depp').born(1963).build()
assert "$p.first $p.last" == 'Johnny Depp'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the (normally empty) builder class you provide will be filled in with appropriate setters and a build method.
The generated build method will look something like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">public Person build() {
    Person _thePerson = new Person()
    _thePerson.first = first
    _thePerson.last = last
    _thePerson.born = born
    return _thePerson
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The class you are creating the builder for can be any Java or Groovy class following the normal JavaBean conventions,
e.g. a no-arg constructor and setters for the properties. Here is an example using a Java class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.builder.*

@Builder(builderStrategy=ExternalStrategy, forClass=javax.swing.DefaultButtonModel)
class ButtonModelBuilder {}

def model = new ButtonModelBuilder().enabled(true).pressed(true).armed(true).rollover(true).selected(true).build()
assert model.isArmed()
assert model.isPressed()
assert model.isEnabled()
assert model.isSelected()
assert model.isRollover()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated builder can be customised using the <code>prefix</code>, <code>includes</code>, <code>excludes</code> and <code>buildMethodName</code> annotation attributes.
Here is an example illustrating various customisations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.builder.*
import groovy.transform.Canonical

@Canonical
class Person {
    String first
    String last
    int born
}

@Builder(builderStrategy=ExternalStrategy, forClass=Person, includes=['first', 'last'], buildMethodName='create', prefix='with')
class PersonBuilder { }

def p = new PersonBuilder().withFirst('Johnny').withLast('Depp').create()
assert "$p.first $p.last" == 'Johnny Depp'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>builderMethodName</code> and <code>builderClassName</code> annotation attributes for <code>@Builder</code> aren&#8217;t applicable for this strategy.</p>
</div>
<div class="paragraph">
<p>You can use the <code>ExternalStrategy</code> in conjunction with <code>@Canonical</code>. If your <code>@Builder</code> annotation doesn&#8217;t have
explicit <code>includes</code> or <code>excludes</code> annotation attributes but the <code>@Canonical</code> annotation of the class you are creating
the builder for does, the ones from <code>@Canonical</code> will be re-used for <code>@Builder</code>.</p>
</div>
<div class="paragraph">
<div class="title">DefaultStrategy</div>
<p>To use the <code>DefaultStrategy</code>, annotate your Groovy class using the <code>@Builder</code> annotation as shown in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.builder.Builder

@Builder
class Person {
    String firstName
    String lastName
    int age
}

def person = Person.builder().firstName("Robert").lastName("Lewandowski").age(21).build()
assert person.firstName == "Robert"
assert person.lastName == "Lewandowski"
assert person.age == 21</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you want, you can customize various aspects of the building process
using the <code>builderClassName</code>, <code>buildMethodName</code>, <code>builderMethodName</code>, <code>prefix</code>, <code>includes</code> and <code>excludes</code> annotation attributes,
some of which are used in the example here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.builder.Builder

@Builder(buildMethodName='make', builderMethodName='maker', prefix='with', excludes='age')
class Person {
    String firstName
    String lastName
    int age
}

def p = Person.maker().withFirstName("Robert").withLastName("Lewandowski").make()
assert "$p.firstName $p.lastName" == "Robert Lewandowski"</code></pre>
</div>
</div>
<div class="paragraph">
<p>This strategy also supports annotating static methods and constructors. In this case, the static method or constructor
parameters become the properties to use for building purposes and in the case of static methods, the return type
of the method becomes the target class being built. If you have more than one <code>@Builder</code> annotation used within
a class (at either the class, method or constructor positions) then it is up to you to ensure that the generated
helper classes and factory methods have unique names (i.e. no more than one can use the default name values).
Here is an example highlighting method and constructor usage (and also illustrating the renaming required for unique names).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.builder.*
import groovy.transform.*

@ToString
@Builder
class Person {
  String first, last
  int born

  Person(){}

  @Builder(builderClassName='MovieBuilder', builderMethodName='byRoleBuilder')
  Person(String roleName) {
     if (roleName == 'Jack Sparrow') {
         this.first = 'Johnny'; this.last = 'Depp'; this.born = 1963
     }
  }

  @Builder(builderClassName='NameBuilder', builderMethodName='nameBuilder', prefix='having', buildMethodName='fullName')
  static String join(String first, String last) {
      first + ' ' + last
  }

  @Builder(builderClassName='SplitBuilder', builderMethodName='splitBuilder')
  static Person split(String name, int year) {
      def parts = name.split(' ')
      new Person(first: parts[0], last: parts[1], born: year)
  }
}

assert Person.splitBuilder().name("Johnny Depp").year(1963).build().toString() == 'Person(Johnny, Depp, 1963)'
assert Person.byRoleBuilder().roleName("Jack Sparrow").build().toString() == 'Person(Johnny, Depp, 1963)'
assert Person.nameBuilder().havingFirst('Johnny').havingLast('Depp').fullName() == 'Johnny Depp'
assert Person.builder().first("Johnny").last('Depp').born(1963).build().toString() == 'Person(Johnny, Depp, 1963)'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>forClass</code> annotation attribute is not supported for this strategy.</p>
</div>
<div class="paragraph">
<div class="title">InitializerStrategy</div>
<p>To use the <code>InitializerStrategy</code>, annotate your Groovy class using the <code>@Builder</code> annotation, and specify the strategy as shown in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.builder.*
import groovy.transform.*

@ToString
@Builder(builderStrategy=InitializerStrategy)
class Person {
    String firstName
    String lastName
    int age
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Your class will be locked down to have a single public constructor taking a "fully set" initializer.
It will also have a factory method to create the initializer. These are used as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@CompileStatic
def firstLastAge() {
    assert new Person(Person.createInitializer().firstName("John").lastName("Smith").age(21)).toString() == 'Person(John, Smith, 21)'
}
firstLastAge()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any attempt to use the initializer which doesn&#8217;t involve setting all the properties (though order is not important) will result in
a compilation error. If you don&#8217;t need this level of strictness, you don&#8217;t need to use <code>@CompileStatic</code>.</p>
</div>
<div class="paragraph">
<p>You can use the <code>InitializerStrategy</code> in conjunction with <code>@Canonical</code> and <code>@Immutable</code>. If your <code>@Builder</code> annotation
doesn&#8217;t have explicit <code>includes</code> or <code>excludes</code> annotation attributes but your <code>@Canonical</code> annotation does, the ones
from <code>@Canonical</code> will be re-used for <code>@Builder</code>. Here is an example using <code>@Builder</code> with <code>@Immutable</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.builder.*
import groovy.transform.*

@Builder(builderStrategy=InitializerStrategy)
@Immutable
class Person {
    String first
    String last
    int born
}

@CompileStatic
def createFirstLastBorn() {
  def p = new Person(Person.createInitializer().first('Johnny').last('Depp').born(1963))
  assert "$p.first $p.last $p.born" == 'Johnny Depp 1963'
}

createFirstLastBorn()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The annotation attribute <code>forClass</code> is not supported for this strategy.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_class_design_annotations">Class design annotations</h6>
<div class="paragraph">
<p>This category of annotations are aimed at simplifying the implementation of well-known design patterns (delegation,
singleton, &#8230;) by using a declarative style.</p>
</div>
<div class="sect6">
<h7 id="xform-Delegate">@groovy.lang.Delegate</h7>
<div class="paragraph">
<p>The <code>@Delegate</code> AST transformation aims at implementing the delegation design pattern. In the following class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Event {
    @Delegate Date when
    String title
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>when</code> field is annotated with <code>@Delegate</code>, meaning that the <code>Event</code> class will delegate calls to <code>Date</code> methods
to the <code>when</code> field. In this case, the generated code looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Event {
    Date when
    String title
    boolean before(Date other) {
        when.before(other)
    }
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can call the <code>before</code> method, for example, directly on the <code>Event</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def ev = new Event(title:'Groovy keynote', when: Date.parse('yyyy/MM/dd', '2013/09/10'))
def now = new Date()
assert ev.before(now)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The behavior of the <code>@Delegate</code> AST transformation can be changed using the following parameters:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 28%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">interfaces</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">True</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the interfaces implemented by the field be implemented by the class too</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">interface Greeter { void sayHello() }
class MyGreeter implements Greeter { void sayHello() { println 'Hello!'} }

class DelegatingGreeter { // no explicit interface
    @Delegate MyGreeter greeter = new MyGreeter()
}
def greeter = new DelegatingGreeter()
assert greeter instanceof Greeter // interface was added transparently</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">deprecated</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, also delegates methods annotated with @Deprecated</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class WithDeprecation {
    @Deprecated
    void foo() {}
}
class WithoutDeprecation {
    @Deprecated
    void bar() {}
}
class Delegating {
    @Delegate(deprecated=true) WithDeprecation with = new WithDeprecation()
    @Delegate WithoutDeprecation without = new WithoutDeprecation()
}
def d = new Delegating()
d.foo() // passes thanks to deprecated=true
d.bar() // fails because of @Deprecated</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">methodAnnotations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to carry over annotations from the methods of the delegate to your delegating method.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class WithAnnotations {
    @Transactional
    void method() {
    }
}
class DelegatingWithoutAnnotations {
    @Delegate WithAnnotations delegate
}
class DelegatingWithAnnotations {
    @Delegate(methodAnnotations = true) WithAnnotations delegate
}
def d1 = new DelegatingWithoutAnnotations()
def d2 = new DelegatingWithAnnotations()
assert d1.class.getDeclaredMethod('method').annotations.length==0
assert d2.class.getDeclaredMethod('method').annotations.length==1</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">parameterAnnotations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">False</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether to carry over annotations from the method parameters of the delegate to your delegating method.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class WithAnnotations {
    void method(@NotNull String str) {
    }
}
class DelegatingWithoutAnnotations {
    @Delegate WithAnnotations delegate
}
class DelegatingWithAnnotations {
    @Delegate(parameterAnnotations = true) WithAnnotations delegate
}
def d1 = new DelegatingWithoutAnnotations()
def d2 = new DelegatingWithAnnotations()
assert d1.class.getDeclaredMethod('method',String).parameterAnnotations[0].length==0
assert d2.class.getDeclaredMethod('method',String).parameterAnnotations[0].length==1</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">excludes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of methods to be excluded from delegation. For more fine-grained control, see also <code>excludeTypes</code>.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Worker {
    void task1() {}
    void task2() {}
}
class Delegating {
    @Delegate(excludes=['task2']) Worker worker = new Worker()
}
def d = new Delegating()
d.task1() // passes
d.task2() // fails because method is excluded</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of methods to be included in delegation. For more fine-grained control, see also <code>includeTypes</code>.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Worker {
    void task1() {}
    void task2() {}
}
class Delegating {
    @Delegate(includes=['task1']) Worker worker = new Worker()
}
def d = new Delegating()
d.task1() // passes
d.task2() // fails because method is not included</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">excludeTypes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of interfaces containing method signatures to be excluded from delegation</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">interface AppendStringSelector {
    StringBuilder append(String str)
}
class UpperStringBuilder {
    @Delegate(excludeTypes=AppendStringSelector)
    StringBuilder sb1 = new StringBuilder()

    @Delegate(includeTypes=AppendStringSelector)
    StringBuilder sb2 = new StringBuilder()

    String toString() { sb1.toString() + sb2.toString().toUpperCase() }
}
def usb = new UpperStringBuilder()
usb.append(3.5d)
usb.append('hello')
usb.append(true)
assert usb.toString() == '3.5trueHELLO'</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includeTypes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty array</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of interfaces containing method signatures to be included in delegation</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">interface AppendBooleanSelector {
    StringBuilder append(boolean b)
}
interface AppendFloatSelector {
    StringBuilder append(float b)
}
class NumberBooleanBuilder {
    @Delegate(includeTypes=AppendBooleanSelector, interfaces=false)
    StringBuilder nums = new StringBuilder()
    @Delegate(includeTypes=[AppendFloatSelector], interfaces=false)
    StringBuilder bools = new StringBuilder()
    String result() { "${nums.toString()}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="xform-Immutable">@groovy.transform.Immutable</h7>
<div class="paragraph">
<p>The <code>@Immutable</code> AST transformation simplifies the creation of immutable classes, that is to say classes for which
members are deemed immutable. For that, all you have to do is annotating the class like in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.Immutable

@Immutable
class Point {
    int x
    int y
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Immutable classes generated with <code>@Immutable</code> are automatically made final. For a class to be immutable, you have to
make sure that properties are of an immutable type (primitive or boxed types), of a known-immutable type or another
class annotated with <code>@Immutable</code>. The effect of applying <code>@Immutable</code> to a class are pretty similar to those of
applying the <a href="userGuides.html#xform-Canonical">@Canonical</a> AST transformation, but with an immutable class: automatic generation of
<code>toString</code>, <code>equals</code> and <code>hashCode</code> methods for example, but trying to modify a property would throw a <code>ReadOnlyPropertyException</code>
in that case.</p>
</div>
<div class="paragraph">
<p>Since <code>@Immutable</code> relies on a predefined list of known immutable classes (like <code>java.net.URI</code> or <code>java.lang.String</code>
and fails if you use a type which is not in that list, you are allowed to instruct the transformation that some types
are deemed immutable thanks to the following parameters:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 28%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">knownImmutableClasses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of classes which are deemed immutable.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.Immutable
import groovy.transform.TupleConstructor

@TupleConstructor
final class Point {
    final int x
    final int y
    public String toString() { "($x,$y)" }
}

@Immutable(knownImmutableClasses=[Point])
class Triangle {
    Point a,b,c
}</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">knownImmutables</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of property names which are deemed immutable.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.Immutable
import groovy.transform.TupleConstructor

@TupleConstructor
final class Point {
    final int x
    final int y
    public String toString() { "($x,$y)" }
}

@Immutable(knownImmutables=['a','b','c'])
class Triangle {
    Point a,b,c
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">copyWith</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A boolean whether to generate a <code>copyWith( Map )</code> method.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.Immutable

@Immutable( copyWith=true )
class User {
    String  name
    Integer age
}

def bob   = new User( 'bob', 43 )
def alice = bob.copyWith( name:'alice' )
assert alice.name == 'alice'
assert alice.age  == 43</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="xform-Memoized">@groovy.transform.Memoized</h7>
<div class="paragraph">
<p>The <code>@Memoized</code> AST transformations simplifies the implementation of caching by allowing the result of method calls
to be cached just by annotating the method with <code>@Memoized</code>. Let&#8217;s imagine the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">long longComputation(int seed) {
    // slow computation
    Thread.sleep(1000*seed)
    System.nanoTime()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This emulates a long computation, based on the actual parameters of the method. Without <code>@Memoized</code>, each method call
would take several seconds plus it would return a random result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def x = longComputation(1)
def y = longComputation(1)
assert x!=y</code></pre>
</div>
</div>
<div class="paragraph">
<p>Adding <code>@Memoized</code> changes the semantics of the method by adding caching, based on the parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Memoized
long longComputation(int seed) {
    // slow computation
    Thread.sleep(1000*seed)
    System.nanoTime()
}

def x = longComputation(1) // returns after 1 second
def y = longComputation(1) // returns immediatly
def z = longComputation(2) // returns after 2 seconds
assert x==y
assert x!=z</code></pre>
</div>
</div>
<div class="paragraph">
<p>The size of the cache can be configured using two optional parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>protectedCacheSize</em>: the number of results which are guaranteed not to be cleared after garbage collection</p>
</li>
<li>
<p><em>maxCacheSize</em>: the maximum number of results that can be kept in memory</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>By default, the size of the cache is unlimited and no cache result is protected from garbage collection. Setting a
<em>protectedCacheSize&gt;0</em> would create an unlimited cache with some results protected. Setting <em>maxCacheSize&gt;0</em> would
 create a limited cache but without any protection from garbage protection. Setting both would create a limited,
 protected cache.</p>
</div>
</div>
<div class="sect6">
<h7 id="xform-Singleton">@groovy.lang.Singleton</h7>
<div class="paragraph">
<p>The <code>@Singleton</code> annotation can be used to implement the singleton design pattern on a class. The singleton instance
is defined eagerly by default, using class initialization, or lazily, in which case the field is initialized using
double checked locking.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Singleton
class GreetingService {
    String greeting(String name) { "Hello, $name!" }
}
assert GreetingService.instance.greeting('Bob') == 'Hello, Bob!'</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the singleton is created eagerly when the class is initialized and available through the <code>instance</code> property.
It is possible to change the name of the singleton using the <code>property</code> parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Singleton(property='theOne')
class GreetingService {
    String greeting(String name) { "Hello, $name!" }
}

assert GreetingService.theOne.greeting('Bob') == 'Hello, Bob!'</code></pre>
</div>
</div>
<div class="paragraph">
<p>And it is also possible to make initialization lazy using the <code>lazy</code> parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Collaborator {
    public static boolean init = false
}
@Singleton(lazy=true,strict=false)
class GreetingService {
    static void init() {}
    GreetingService() {
        Collaborator.init = true
    }
    String greeting(String name) { "Hello, $name!" }
}
GreetingService.init() // make sure class is initialized
assert Collaborator.init == false
GreetingService.instance
assert Collaborator.init == true
assert GreetingService.instance.greeting('Bob') == 'Hello, Bob!'</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, we also set the <code>strict</code> parameter to false, which allows us to define our own constructor.</p>
</div>
</div>
<div class="sect6">
<h7 id="xform-Mixin">@groovy.transform.Mixin</h7>
<div class="paragraph">
<p>Deprecated. Consider using traits instead.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_logging_improvements">Logging improvements</h6>
<div class="paragraph">
<p>Groovy provides AST transformation that helps integrating with the most widely used logging frameworks. It&#8217;s worth noting
that annotating a class with one of those annotations doesn&#8217;t prevent you from adding the appropriate logging framework
on classpath.</p>
</div>
<div class="paragraph">
<p>All transformations work in a similar way:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>add static final <code>log</code> field corresponding to the logger</p>
</li>
<li>
<p>wrap all calls to <code>log.level()</code> into the appropriate <code>log.isLevelEnabled</code> guard, depending on the underlying framework</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those transformations support two parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>value</code> (default <code>log</code>) corresponds to the name of the logger field</p>
</li>
<li>
<p><code>category</code> (defaults to the class name) is the name of the logger category</p>
</li>
</ul>
</div>
<div class="sect6">
<h7 id="xform-Log">@groovy.util.logging.Log</h7>
<div class="paragraph">
<p>The first logging AST transformation available is the <code>@Log</code> annotation which relies on the JDK logging framework. Writing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@groovy.util.logging.Log
class Greeter {
    void greet() {
        log.info 'Called greeter'
        println 'Hello, world!'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>is equivalent to writing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import java.util.logging.Level
import java.util.logging.Logger

class Greeter {
    private static final Logger log = Logger.getLogger(Greeter.name)
    void greet() {
        if (log.isLoggable(Level.INFO)) {
            log.info 'Called greeter'
        }
        println 'Hello, world!'
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="xform-Commons">@groovy.util.logging.Commons</h7>
<div class="paragraph">
<p>Groovy supports the <a href="http://commons.apache.org/proper/commons-logging/">Apache Commons Logging</a> framework using to the
<code>@Commons</code> annotation. Writing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@groovy.util.logging.Commons
class Greeter {
    void greet() {
        log.debug 'Called greeter'
        println 'Hello, world!'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>is equivalent to writing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.apache.commons.logging.LogFactory
import org.apache.commons.logging.Log

class Greeter {
    private static final Log log = LogFactory.getLog(Greeter)
    void greet() {
        if (log.isDebugEnabled()) {
            log.debug 'Called greeter'
        }
        println 'Hello, world!'
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="xform-Log4j">@groovy.util.logging.Log4j</h7>
<div class="paragraph">
<p>Groovy supports the <a href="http://logging.apache.org/log4j/1.2/">Apache Log4j 1.x</a> framework using to the
<code>@Log4j</code> annotation. Writing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@groovy.util.logging.Log4j
class Greeter {
    void greet() {
        log.debug 'Called greeter'
        println 'Hello, world!'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>is equivalent to writing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.apache.log4j.Logger

class Greeter {
    private static final Logger log = Logger.getLogger(Greeter)
    void greet() {
        if (log.isDebugEnabled()) {
            log.debug 'Called greeter'
        }
        println 'Hello, world!'
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="xform-Log4j2">@groovy.util.logging.Log4j2</h7>
<div class="paragraph">
<p>Groovy supports the <a href="http://logging.apache.org/log4j/2.x/">Apache Log4j 2.x</a> framework using to the
<code>@Log4j2</code> annotation. Writing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@groovy.util.logging.Log4j2
class Greeter {
    void greet() {
        log.debug 'Called greeter'
        println 'Hello, world!'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>is equivalent to writing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.apache.logging.log4j.LogManager
import org.apache.logging.log4j.Logger

class Greeter {
    private static final Logger log = LogManager.getLogger(Greeter)
    void greet() {
        if (log.isDebugEnabled()) {
            log.debug 'Called greeter'
        }
        println 'Hello, world!'
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="xform-Slf4j">@groovy.util.logging.Slf4j</h7>
<div class="paragraph">
<p>Groovy supports the <a href="http://www.slf4j.org/">Simple Logging Facade for Java (SLF4J)</a> framework using to the
<code>@Slf4j</code> annotation. Writing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@groovy.util.logging.Slf4j
class Greeter {
    void greet() {
        log.debug 'Called greeter'
        println 'Hello, world!'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>is equivalent to writing:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.slf4j.LoggerFactory
import org.slf4j.Logger

class Greeter {
    private static final Logger log = LoggerFactory.getLogger(Greeter)
    void greet() {
        if (log.isDebugEnabled()) {
            log.debug 'Called greeter'
        }
        println 'Hello, world!'
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_declarative_concurrency">Declarative concurrency</h6>
<div class="paragraph">
<p>The Groovy language provides a set of annotations aimed at simplifying common concurrency patterns in a declarative
approach.</p>
</div>
<div class="sect6">
<h7 id="xform-Synchronized">@groovy.transform.Synchronized</h7>
<div class="paragraph">
<p>The <code>@Synchronized</code> AST transformations works in a similar way to the <code>synchronized</code> keyword but locks on different
objects for safer concurrency. It can be applied on any method or static method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.Synchronized

import java.util.concurrent.Executors
import java.util.concurrent.TimeUnit

class Counter {
    int cpt
    @Synchronized
    int incrementAndGet() {
        cpt++
    }
    int get() {
        cpt
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Writing this is equivalent to creating a lock object and wrapping the whole method into a synchronized block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Counter {
    int cpt
    private final Object $lock = new Object()

    int incrementAndGet() {
        synchronized($lock) {
            cpt++
        }
    }
    int get() {
        cpt
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, <code>@Synchronized</code> creates a field named <code>$lock</code> (or <code>$LOCK</code> for a static method) but you can make it use any
field you want by specifying the value attribute, like in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.Synchronized

import java.util.concurrent.Executors
import java.util.concurrent.TimeUnit

class Counter {
    int cpt
    private final Object myLock = new Object()

    @Synchronized('myLock')
    int incrementAndGet() {
        cpt++
    }
    int get() {
        cpt
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="xform-WithReadLock">@groovy.transform.WithReadLock and @groovy.transform.WithWriteLock</h7>
<div class="paragraph">
<p>The <code>@WithReadLock</code> AST transformation works in conjunction with the <code>@WithWriteLock</code> transformation
to provide read/write synchronization using the <code>ReentrantReadWriteLock</code> facility that the JDK provides. The annotation
can be added to a method or a static method. It will transparently create a <code>$reentrantLock</code> final field (or
<code>$REENTRANTLOCK</code> for a static method) and proper synchronization code will be added. For example, the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.WithReadLock
import groovy.transform.WithWriteLock

class Counters {
    public final Map&lt;String,Integer&gt; map = [:].withDefault { 0 }

    @WithReadLock
    int get(String id) {
        map.get(id)
    }

    @WithWriteLock
    void add(String id, int num) {
        Thread.sleep(200) // emulate long computation
        map.put(id, map.get(id)+num)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>is equivalent to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.WithReadLock as WithReadLock
import groovy.transform.WithWriteLock as WithWriteLock

public class Counters {

    private final Map&lt;String, Integer&gt; map
    private final java.util.concurrent.locks.ReentrantReadWriteLock $reentrantlock

    public int get(java.lang.String id) {
        $reentrantlock.readLock().lock()
        try {
            map.get(id)
        }
        finally {
            $reentrantlock.readLock().unlock()
        }
    }

    public void add(java.lang.String id, int num) {
        $reentrantlock.writeLock().lock()
        try {
            java.lang.Thread.sleep(200)
            map.put(id, map.get(id) + num )
        }
        finally {
            $reentrantlock.writeLock().unlock()
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both <code>@WithReadLock</code> and <code>@WithWriteLock</code> support specifying an alternative lock object. In that case, the referenced
 field must be declared by the user, like in the following alternative:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.WithReadLock
import groovy.transform.WithWriteLock

import java.util.concurrent.locks.ReentrantReadWriteLock

class Counters {
    public final Map&lt;String,Integer&gt; map = [:].withDefault { 0 }
    private final ReentrantReadWriteLock customLock = new ReentrantReadWriteLock()

    @WithReadLock('customLock')
    int get(String id) {
        map.get(id)
    }

    @WithWriteLock('customLock')
    void add(String id, int num) {
        Thread.sleep(200) // emulate long computation
        map.put(id, map.get(id)+num)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For details</p>
</div>
<div class="ulist">
<ul>
<li>
<p>See Javadoc for <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/WithReadLock.html' target='_blank'><code>groovy.transform.WithReadLock</code></a></p>
</li>
<li>
<p>See Javadoc for <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/WithWriteLock.html' target='_blank'><code>groovy.transform.WithWriteLock</code></a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_easier_cloning_and_externalizing">Easier cloning and externalizing</h6>
<div class="paragraph">
<p>Groovy provides two annotations aimed at facilitating the implementation of <code>Clonable</code> and <code>Externalizable</code> interfaces,
respectively named <code>@AutoClone</code> and <code>@AutoExternalize</code>.</p>
</div>
<div class="sect6">
<h7 id="xform-AutoClone">@groovy.transform.AutoClone</h7>
<div class="paragraph">
<p>The <code>@AutoClone</code> annotation is aimed at implementing the <code>@java.lang.Cloneable</code> interface using various strategies, thanks to the <code>style</code> parameter:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the default <code>AutoCloneStyle.CLONE</code> strategy calls <code>super.clone()</code> first then <code>clone()</code> on each cloneable property</p>
</li>
<li>
<p>the <code>AutoCloneStyle.SIMPLE</code> strategy uses a regular constructor call and copies properties from the source to the clone</p>
</li>
<li>
<p>the <code>AutoCloneStyle.COPY_CONSTRUCTOR</code> strategy creates and uses a copy constructor</p>
</li>
<li>
<p>the <code>AutoCloneStyle.SERIALIZATION</code> strategy uses serialization (or externalization) to clone the object</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each of those strategies have pros and cons which are discussed in the Javadoc for <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/AutoClone.html' target='_blank'><code>groovy.transform.AutoClone</code></a> and <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/AutoCloneStyle.html' target='_blank'><code>groovy.transform.AutoCloneStyle</code></a> .</p>
</div>
<div class="paragraph">
<p>For example, the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.AutoClone

@AutoClone
class Book {
    String isbn
    String title
    List&lt;String&gt; authors
    Date publicationDate
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>is equivalent to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Book implements Cloneable {
    String isbn
    String title
    List&lt;String&gt; authors
    Date publicationDate

    public Book clone() throws CloneNotSupportedException {
        Book result = super.clone()
        result.authors = authors instanceof Cloneable ? (List) authors.clone() : authors
        result.publicationDate = publicationDate.clone()
        result
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the String properties aren&#8217;t explicitly handled because Strings are immutable and the <code>clone()</code> method from <code>Object</code> will copy the String references. The same would apply to primitive fields and most of the concrete subclasses of <code>java.lang.Number</code>.</p>
</div>
<div class="paragraph">
<p>In addition to cloning styles, <code>@AutoClone</code> supports multiple options:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 28%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">excludes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of property or field names that need to be excluded from cloning. A string consisting of a comma-separated field/property names is also allowed.
See <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/AutoClone.html#excludes' target='_blank'><code>groovy.transform.AutoClone</code></a> for details</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.AutoClone
import groovy.transform.AutoCloneStyle

@AutoClone(style=AutoCloneStyle.SIMPLE,excludes='authors')
class Book {
    String isbn
    String title
    List authors
    Date publicationDate
}</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includeFields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By default, only properties are cloned. Setting this flag to true will also clone fields.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.AutoClone
import groovy.transform.AutoCloneStyle

@AutoClone(style=AutoCloneStyle.SIMPLE,includeFields=true)
class Book {
    String isbn
    String title
    List authors
    protected Date publicationDate
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="xform-AutoExternalize">@groovy.transform.AutoExternalize</h7>
<div class="paragraph">
<p>The <code>@AutoExternalize</code> AST transformation will assist in the creation of <code>java.io.Externalizable</code> classes. It will
automatically add the interface to the class and generate the <code>writeExternal</code> and <code>readExternal</code> methods. For example, this
code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.AutoExternalize

@AutoExternalize
class Book {
    String isbn
    String title
    float price
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>will be converted into:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Book implements java.io.Externalizable {
    String isbn
    String title
    float price

    void writeExternal(ObjectOutput out) throws IOException {
        out.writeObject(isbn)
        out.writeObject(title)
        out.writeFloat( price )
    }

    public void readExternal(ObjectInput oin) {
        isbn = (String) oin.readObject()
        title = (String) oin.readObject()
        price = oin.readFloat()
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@AutoExternalize</code> annotation supports two parameters which will let you slightly customize its behavior:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 28%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">excludes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Empty list</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A list of property or field names that need to be excluded from externalizing. A string consisting of a comma-separated field/property names is also allowed.
See <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/AutoExternalize.html#excludes' target='_blank'><code>groovy.transform.AutoExternalize</code></a> for details</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.AutoExternalize

@AutoExternalize(excludes='price')
class Book {
    String isbn
    String title
    float price
}</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">includeFields</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By default, only properties are externalized. Setting this flag to true will also clone fields.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.AutoExternalize

@AutoExternalize(includeFields=true)
class Book {
    String isbn
    String title
    protected float price
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_safer_scripting">Safer scripting</h6>
<div class="paragraph">
<p>The Groovy language makes it easy to execute user scripts at runtime (for example using <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/lang/GroovyShell.html' target='_blank'><code>groovy.lang.GroovyShell</code></a>),
but how do you make sure that a script won&#8217;t eat all CPU (infinite loops) or that concurrent scripts won&#8217;t slowly consume
all available threads of a thread pool? Groovy provides several annotations which are aimed towards safer scripting,
generating code which will for example allow you to interrupt execution automatically.</p>
</div>
<div class="sect6">
<h7 id="xform-ThreadInterrupt">@groovy.transform.ThreadInterrupt</h7>
<div class="paragraph">
<p>One complicated situation in the JVM world is when a thread can&#8217;t be stopped. The <code>Thread#stop</code> method exists but is
deprecated (and isn&#8217;t reliable) so your only chance relies in <code>Thread#interrupt</code>. Calling the latter will set the
<code>interrupt</code> flag on the thread, but it will <strong>not</strong> stop the execution of the thread. This is problematic because it&#8217;s the
responsability of the code executing in the thread to check the interrupt flag and properly exit. This makes sense when
you, as a developer, know that the code you are executing is meant to be run in an independent thread, but in general,
you don&#8217;t know it. It&#8217;s even worse with user scripts, who might not even know what a thread is (think of DSLs).</p>
</div>
<div class="paragraph">
<p><code>@ThreadInterrupt</code> simplifies this by adding thread interruption checks at critical places in the code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>loops (for, while)</p>
</li>
<li>
<p>first instruction of a method</p>
</li>
<li>
<p>first instruction of a closure body</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Let&#8217;s imagine the following user script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">while (true) {
    i++
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is an obvious infinite loop. If this code executes in its own thread, interrupting wouldn&#8217;t help: if you <code>join</code> on
the thread, then the calling code would be able to continue, but the thread would still be alive, running in background
without any ability for you to stop it, slowly causing thread starvation.</p>
</div>
<div class="paragraph">
<p>One possibility to work around this is to setup your shell this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def config = new CompilerConfiguration()
config.addCompilationCustomizers(
        new ASTTransformationCustomizer(ThreadInterrupt)
)
def binding = new Binding(i:0)
def shell = new GroovyShell(binding,config)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The shell is then configured to automatically apply the <code>@ThreadInterrupt</code> AST transformations on all scripts. This allows
you to execute user scripts this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def t = Thread.start {
    shell.evaluate(userCode)
}
t.join(500) // give at most 500ms for the script to complete
if (t.alive) {
    t.interrupt()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The transformation automatically modified user code like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">while (true) {
    if (Thread.currentThread().interrupted) {
        throw new InterruptedException('The current thread has been interrupted.')
    }
    i++
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The check which is introduced inside the loop guarantees that if the <code>interrupt</code> flag is set on the current thread, an
exception will be thrown, interrupting the execution of the thread.</p>
</div>
<div class="paragraph">
<p><code>@ThreadInterrupt</code> supports multiple options that will let you further customize the behavior of the transformation:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 28%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">thrown</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.InterruptedException</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the type of exception which is thrown if the thread is interrupted.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class BadException extends Exception {
    BadException(String message) { super(message) }
}

def config = new CompilerConfiguration()
config.addCompilationCustomizers(
        new ASTTransformationCustomizer(thrown:BadException, ThreadInterrupt)
)
def binding = new Binding(i:0)
def shell = new GroovyShell(this.class.classLoader,binding,config)

def userCode = """
try {
    while (true) {
        i++
    }
} catch (BadException e) {
    i = -1
}
"""

def t = Thread.start {
    shell.evaluate(userCode)
}
t.join(1000) // give at most 1s for the script to complete
assert binding.i &gt; 0
if (t.alive) {
    t.interrupt()
}
Thread.sleep(100)
assert binding.i == -1'''</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checkOnMethodStart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should an interruption check be inserted at the beginning of each method body. See <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/ThreadInterrupt.html' target='_blank'><code>groovy.transform.ThreadInterrupt</code></a> for details.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ThreadInterrupt(checkOnMethodStart=false)</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">applyToAllClasses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the transformation be applied on all classes of the same source unit (in the same source file). See <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/ThreadInterrupt.html' target='_blank'><code>groovy.transform.ThreadInterrupt</code></a> for details.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ThreadInterrupt(applyToAllClasses=false)
class A { ... } // interrupt checks added
class B { ... } // no interrupt checks</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">applyToAllMembers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the transformation be applied on all members of class. See <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/ThreadInterrupt.html' target='_blank'><code>groovy.transform.ThreadInterrupt</code></a> for details.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class A {
    @ThreadInterrupt(applyToAllMembers=false)
    void method1() { ... } // interrupt checked added
    void method2() { ... } // no interrupt checks
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="xform-TimedInterrupt">@groovy.transform.TimedInterrupt</h7>
<div class="paragraph">
<p>The <code>@TimedInterrupt</code> AST transformation tries to solve a slightly different problem from <a href="userGuides.html#xform-ThreadInterrupt">@groovy.transform.ThreadInterrupt</a>: instead of checking the <code>interrupt</code> flag of the thread, it will automatically
throw an exception if the thread has been running for too long.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
This annotation does <strong>not</strong> spawn a monitoring thread. Instead, it works in a similar manner as <code>@ThreadInterrupt</code> by placing checks at appropriate places in the code. This means that if you
have a thread blocked by I/O, it will <strong>not</strong> be interrupted.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Imagine the following user code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def fib(int n) { n&lt;2?n:fib(n-1)+fib(n-2) }

result = fib(600)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The implementation of the famous Fibonacci number computation here is far from optimized. If it is called with a high <code>n</code> value, it can take minutes to answer. With <code>@TimedInterrupt</code>, you can
choose how long a script is allowed to run. The following setup code will allow the user script to run for 1 second at max:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def config = new CompilerConfiguration()
config.addCompilationCustomizers(
        new ASTTransformationCustomizer(value:1, TimedInterrupt)
)
def binding = new Binding(result:0)
def shell = new GroovyShell(this.class.classLoader, binding,config)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This code is equivalent to annotating a class with <code>@TimedInterrupt</code> like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@TimedInterrup(value=1, unit=TimeUnit.SECONDS)
class MyClass {
    def fib(int n) {
        n&lt;2?n:fib(n-1)+fib(n-2)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@TimedInterrupt</code> supports multiple options that will let you further customize the behavior of the transformation:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 28%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">value</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long.MAX_VALUE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used in combination with <code>unit</code> to specify after how long execution times out.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@TimedInterrupt(value=500L, unit= TimeUnit.MILLISECONDS, applyToAllClasses = false)
class Slow {
    def fib(n) { n&lt;2?n:fib(n-1)+fib(n-2) }
}
def result
def t = Thread.start {
    result = new Slow().fib(500)
}
t.join(1000)
assert result == null
assert !t.alive</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">unit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TimeUnit.SECONDS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Used in combination with <code>value</code> to specify after how long execution times out.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@TimedInterrupt(value=500L, unit= TimeUnit.MILLISECONDS, applyToAllClasses = false)
class Slow {
    def fib(n) { n&lt;2?n:fib(n-1)+fib(n-2) }
}
def result
def t = Thread.start {
    result = new Slow().fib(500)
}
t.join(1000)
assert result == null
assert !t.alive</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">thrown</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.util.concurrent.TimeoutException</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the type of exception which is thrown if timeout is reached.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@TimedInterrupt(thrown=TooLongException, applyToAllClasses = false, value=1L)
class Slow {
    def fib(n) { Thread.sleep(100); n&lt;2?n:fib(n-1)+fib(n-2) }
}
def result
def t = Thread.start {
    try {
        result = new Slow().fib(50)
    } catch (TooLongException e) {
        result = -1
    }
}
t.join(2000)
assert result == -1</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checkOnMethodStart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should an interruption check be inserted at the beginning of each method body. See <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/TimedInterrupt.html' target='_blank'><code>groovy.transform.TimedInterrupt</code></a> for details.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@TimedInterrupt(checkOnMethodStart=false)</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">applyToAllClasses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the transformation be applied on all classes of the same source unit (in the same source file). See <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/TimedInterrupt.html' target='_blank'><code>groovy.transform.TimedInterrupt</code></a> for details.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@TimedInterrupt(applyToAllClasses=false)
class A { ... } // interrupt checks added
class B { ... } // no interrupt checks</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">applyToAllMembers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the transformation be applied on all members of class. See <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/TimedInterrupt.html' target='_blank'><code>groovy.transform.TimedInterrupt</code></a> for details.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class A {
    @TimedInterrupt(applyToAllMembers=false)
    void method1() { ... } // interrupt checked added
    void method2() { ... } // no interrupt checks
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>@TimedInterrupt</code> is currently not compatible with static methods!
</td>
</tr>
</table>
</div>
</div>
<div class="sect6">
<h7 id="xform-ConditionalInterrupt">@groovy.transform.ConditionalInterrupt</h7>
<div class="paragraph">
<p>The last annotation for safer scripting is the base annotation when you want to interrupt a script using a custom strategy. In particular, this is the annotation of choice if you
want to use resource management (limit the number of calls to an API, &#8230;). In the following example, user code is using an infinite loop, but <code>@ConditionalInterrupt</code> will allow us
to check a quota manager and interrupt automatically the script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ConditionalInterrupt({Quotas.disallow('user')})
class UserCode {
    void doSomething() {
        int i=0
        while (true) {
            println "Consuming resources ${++i}"
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The quota checking is very basic here, but it can be any code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Quotas {
    static def quotas = [:].withDefault { 10 }
    static boolean disallow(String userName) {
        println "Checking quota for $userName"
        (quotas[userName]--)&lt;0
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can make sure <code>@ConditionalInterrupt</code> works properly using this test code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">assert Quotas.quotas['user'] == 10
def t = Thread.start {
    new UserCode().doSomething()
}
t.join(1000)
assert !t.alive
assert Quotas.quotas['user'] &lt; 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course, in practice, it is unlikely that <code>@ConditionalInterrupt</code> will be itself added by hand on user code. It can be injected in a similar manner as the example shown in the
<a href="userGuides.html#xform-ThreadInterrupt">ThreadInterrupt</a> section, using the <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?org/codehaus/groovy/control/customizers/ASTTransformationCustomizer.html' target='_blank'><code>org.codehaus.groovy.control.customizers.ASTTransformationCustomizer</code></a> :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def config = new CompilerConfiguration()
def checkExpression = new ClosureExpression(
        Parameter.EMPTY_ARRAY,
        new ExpressionStatement(
                new MethodCallExpression(new ClassExpression(ClassHelper.make(Quotas)), 'disallow', new ConstantExpression('user'))
        )
)
config.addCompilationCustomizers(
        new ASTTransformationCustomizer(value: checkExpression, ConditionalInterrupt)
)

def shell = new GroovyShell(this.class.classLoader,new Binding(),config)

def userCode = """
        int i=0
        while (true) {
            println "Consuming resources \\${++i}"
        }
"""

assert Quotas.quotas['user'] == 10
def t = Thread.start {
    shell.evaluate(userCode)
}
t.join(1000)
assert !t.alive
assert Quotas.quotas['user'] &lt; 0</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@ConditionalInterrupt</code> supports multiple options that will let you further customize the behavior of the transformation:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 28%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">value</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The closure which will be called to check if execution is allowed. If the closure returns false, execution is allowed. If it returns true, then an exception will be thrown.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ConditionalInterrupt({ ... })</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">thrown</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.lang.InterruptedException</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specifies the type of exception which is thrown if execution should be aborted.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">config.addCompilationCustomizers(
        new ASTTransformationCustomizer(thrown: QuotaExceededException,value: checkExpression, ConditionalInterrupt)
)
assert Quotas.quotas['user'] == 10
def t = Thread.start {
    try {
        shell.evaluate(userCode)
    } catch (QuotaExceededException) {
        Quotas.quotas['user'] = 'Quota exceeded'
    }
}
t.join(1000)
assert !t.alive
assert Quotas.quotas['user'] == 'Quota exceeded'</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">checkOnMethodStart</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should an interruption check be inserted at the beginning of each method body. See <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/ConditionalInterrupt.html' target='_blank'><code>groovy.transform.ConditionalInterrupt</code></a> for details.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ConditionalInterrupt(checkOnMethodStart=false)</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">applyToAllClasses</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the transformation be applied on all classes of the same source unit (in the same source file). See <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/ConditionalInterrupt.html' target='_blank'><code>groovy.transform.ConditionalInterrupt</code></a> for details.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@ConditionalInterrupt(applyToAllClasses=false)
class A { ... } // interrupt checks added
class B { ... } // no interrupt checks</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">applyToAllMembers</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Should the transformation be applied on all members of class. See <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?groovy/transform/ConditionalInterrupt.html' target='_blank'><code>groovy.transform.ConditionalInterrupt</code></a> for details.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class A {
    @ConditionalInterrupt(applyToAllMembers=false)
    void method1() { ... } // interrupt checked added
    void method2() { ... } // no interrupt checks
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_compiler_directives">Compiler directives</h6>
<div class="paragraph">
<p>This category of AST transformations groups annotations which have a direct impact on the semantics of the code, rather
than focusing on code generation. With that regards, they can be seen as compiler directives that either change the
behavior of a program at compile time or runtime.</p>
</div>
<div class="sect6">
<h7 id="xform-Field">@groovy.transform.Field</h7>
<div class="paragraph">
<p>The <code>@Field</code> annotation only makes sense in the context of a script and aims at solving a common scoping error with
scripts. The following example will for example fail at runtime:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def x

String line() {
    "="*x
}

x=3
assert "===" == line()
x=5
assert "=====" == line()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The error that is thrown may be difficult to interpret: <code>groovy.lang.MissingPropertyException: No such property: x</code>. The reason is that scripts are compiled
to classes and the script body is itself compiled as a single <em>run()</em> method. Methods which are defined in the scripts are independent, so the code above is
equivalent to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class MyScript extends Script {

    String line() {
        "="*x
    }

    public def run() {
        def x
        x=3
        assert "===" == line()
        x=5
        assert "=====" == line()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>So <code>def x</code> is effectiveley interpreted as a local variable, outside of the scope of the <code>line</code> method. The <code>@Field</code> AST transformation aims at fixing this
by changing the scope of the variable to a field of the enclosing script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Field def x

String line() {
    "="*x
}

x=3
assert "===" == line()
x=5
assert "=====" == line()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting, equivalent, code is now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class MyScript extends Script {

    def x

    String line() {
        "="*x
    }

    public def run() {
        x=3
        assert "===" == line()
        x=5
        assert "=====" == line()
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="xform-PackageScope">@groovy.transform.PackageScope</h7>
<div class="paragraph">
<p>By default, Groovy visibility rules imply that if you create a field without specifying a modifier, then the field is interpreted as a property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Person {
    String name // this is a property
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Should you want to create a package private field instead of a property (private field+getter/setter), then annotate your field with <code>@PackageScope</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Person {
    @PackageScope String name // not a property anymore
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="xform-AnnotationCollector">@groovy.transform.AnnotationCollector</h7>
<div class="paragraph">
<p><code>@AnnotationCollector</code> allows the creation of meta-annotation, which are described in a <a href="userGuides.html#meta-annotations">dedicated section</a>.</p>
</div>
</div>
<div class="sect6">
<h7 id="xform-TypeChecked">@groovy.transform.TypeChecked</h7>
<div class="paragraph">
<p><code>@TypeChecked</code> activates compile-time type checking on your Groovy code. See <a href="userGuides.html#section-typechecked">section on type checking</a> for details.</p>
</div>
</div>
<div class="sect6">
<h7 id="xform-CompileStatic">@groovy.transform.CompileStatic</h7>
<div class="paragraph">
<p><code>@CompileStatic</code> activates static compilation on your Groovy code. See <a href="userGuides.html#section-typechecked">section on type checking</a> for details.</p>
</div>
</div>
<div class="sect6">
<h7 id="xform-CompileDynamic">@groovy.transform.CompileDynamic</h7>
<div class="paragraph">
<p><code>@CompileDynamic</code> disables static compilation on parts of your Groovy code. See <a href="userGuides.html#section-typechecked">section on type checking</a> for details.</p>
</div>
</div>
<div class="sect6">
<h7 id="xform-DelegatesTo">@groovy.lang.DelegatesTo</h7>
<div class="paragraph">
<p><code>@DelegatesTo</code> is not, technically speaking, an AST transformation. It is aimed at documenting code and helping the compiler in case you are
using <a href="userGuides.html#xform-TypeChecked">type checking</a> or <a href="userGuides.html#xform-CompileStatic">static compilation</a>. The annotation is described throughfully in the
<a href="userGuides.html#section-delegatesto">DSL section</a> of this guide.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_swing_patterns">Swing patterns</h6>
<div class="sect6">
<h7 id="xform-Bindable">@groovy.beans.Bindable</h7>
<div class="paragraph">
<p><code>@Bindable</code> is an AST transformation that transforms a regular property into a bound property (according to the <a href="http://download.oracle.com/otndocs/jcp/7224-javabeans-1.01-fr-spec-oth-JSpec/">JavaBeans specification</a>).
The <code>@Bindable</code> annotation can be placed on a property or a class. To convert all properties of a class into bound properties, on can annotate the class like in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.beans.Bindable

@Bindable
class Person {
    String name
    int age
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is equivalent to writing this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import java.beans.PropertyChangeListener
import java.beans.PropertyChangeSupport

class Person {
    final private PropertyChangeSupport this$propertyChangeSupport

    String name
    int age

    public void addPropertyChangeListener(PropertyChangeListener listener) {
        this$propertyChangeSupport.addPropertyChangeListener(listener)
    }

    public void addPropertyChangeListener(String name, PropertyChangeListener listener) {
        this$propertyChangeSupport.addPropertyChangeListener(name, listener)
    }

    public void removePropertyChangeListener(PropertyChangeListener listener) {
        this$propertyChangeSupport.removePropertyChangeListener(listener)
    }

    public void removePropertyChangeListener(String name, PropertyChangeListener listener) {
        this$propertyChangeSupport.removePropertyChangeListener(name, listener)
    }

    public void firePropertyChange(String name, Object oldValue, Object newValue) {
        this$propertyChangeSupport.firePropertyChange(name, oldValue, newValue)
    }

    public PropertyChangeListener[] getPropertyChangeListeners() {
        return this$propertyChangeSupport.getPropertyChangeListeners()
    }

    public PropertyChangeListener[] getPropertyChangeListeners(String name) {
        return this$propertyChangeSupport.getPropertyChangeListeners(name)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@Bindable</code> therefore removes a lot of boilerplate from your class, dramatically increasing readability. If the annotation is put on a single property, only that property is bound:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.beans.Bindable

class Person {
    String name
    @Bindable int age
}</code></pre>
</div>
</div>
</div>
<div class="sect6">
<h7 id="xform-ListenerList">@groovy.beans.ListenerList</h7>
<div class="paragraph">
<p>The <code>@ListenerList</code> AST transformation generates code for adding, removing and getting the list of listeners to a class, just by annotating a collection property:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import java.awt.event.ActionListener
import groovy.beans.ListenerList

class Component {
    @ListenerList
    List&lt;ActionListener&gt; listeners;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The transform will generate the appropriate add/remove methods based on the generic type of the list. In addition, it will also create <code>fireXXX</code> methods based on the public methods declared on the class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import java.awt.event.ActionEvent
import java.awt.event.ActionListener as ActionListener
import groovy.beans.ListenerList as ListenerList

public class Component {

    @ListenerList
    private List&lt;ActionListener&gt; listeners

    public void addActionListener(ActionListener listener) {
        if ( listener == null) {
            return
        }
        if ( listeners == null) {
            listeners = []
        }
        listeners.add(listener)
    }

    public void removeActionListener(ActionListener listener) {
        if ( listener == null) {
            return
        }
        if ( listeners == null) {
            listeners = []
        }
        listeners.remove(listener)
    }

    public ActionListener[] getActionListeners() {
        Object __result = []
        if ( listeners != null) {
            __result.addAll(listeners)
        }
        return (( __result ) as ActionListener[])
    }

    public void fireActionPerformed(ActionEvent param0) {
        if ( listeners != null) {
            ArrayList&lt;ActionListener&gt; __list = new ArrayList&lt;ActionListener&gt;(listeners)
            for (def listener : __list ) {
                listener.actionPerformed(param0)
            }
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@Bindable</code> supports multiple options that will let you further customize the behavior of the transformation:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 28%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generic type name</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">By default, the suffix which will be appended to add/remove/&#8230; methods is the simple class name of the generic type of the list.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Component {
    @ListenerList(name='item')
    List&lt;ActionListener&gt; listeners;
}</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">synchronize</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If set to true, generated methods will be synchronized</p></td>
<td class="tableblock halign-left valign-top"><div><div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Component {
    @ListenerList(synchronize = true)
    List&lt;ActionListener&gt; listeners;
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect6">
<h7 id="xform-Vetoable">@groovy.beans.Vetoable</h7>
<div class="paragraph">
<p>The <code>@Vetoable</code> annotation works in a similar manner to <code>@Bindable</code> but generates constrained property according to the JavaBeans specification, instead of bound properties. The annotation
can be placed on a class, meaning that all properties will be converted to constrained properties, or on a single property. For example, annotating this class with <code>@Vetoable</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.beans.Vetoable

import java.beans.PropertyVetoException
import java.beans.VetoableChangeListener

@Vetoable
class Person {
    String name
    int age
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>is equivalent to writing this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">public class Person {

    private String name
    private int age
    final private java.beans.VetoableChangeSupport this$vetoableChangeSupport

    public void addVetoableChangeListener(VetoableChangeListener listener) {
        this$vetoableChangeSupport.addVetoableChangeListener(listener)
    }

    public void addVetoableChangeListener(String name, VetoableChangeListener listener) {
        this$vetoableChangeSupport.addVetoableChangeListener(name, listener)
    }

    public void removeVetoableChangeListener(VetoableChangeListener listener) {
        this$vetoableChangeSupport.removeVetoableChangeListener(listener)
    }

    public void removeVetoableChangeListener(String name, VetoableChangeListener listener) {
        this$vetoableChangeSupport.removeVetoableChangeListener(name, listener)
    }

    public void fireVetoableChange(String name, Object oldValue, Object newValue) throws PropertyVetoException {
        this$vetoableChangeSupport.fireVetoableChange(name, oldValue, newValue)
    }

    public VetoableChangeListener[] getVetoableChangeListeners() {
        return this$vetoableChangeSupport.getVetoableChangeListeners()
    }

    public VetoableChangeListener[] getVetoableChangeListeners(String name) {
        return this$vetoableChangeSupport.getVetoableChangeListeners(name)
    }

    public void setName(String value) throws PropertyVetoException {
        this.fireVetoableChange('name', name, value)
        name = value
    }

    public void setAge(int value) throws PropertyVetoException {
        this.fireVetoableChange('age', age, value)
        age = value
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the annotation is put on a single property, only that property is made vetoable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.beans.Vetoable

class Person {
    String name
    @Vetoable int age
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_test_assistance">Test assistance</h6>
<div class="sect6">
<h7 id="xform-NotYetImplemented">@groovy.lang.NotYetImplemented</h7>
<div class="paragraph">
<p><code>@NotYetImplemented</code> is used to invert the result of a JUnit 3/4 test case. It is in particular useful if a feature is not yet implemented but the test is. In that case, it is expected
that the test fails. Marking it with <code>@NotYetImplemented</code> will inverse the result of the test, like in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.NotYetImplemented

class Maths {
    static int fib(int n) {
        // todo: implement later
    }
}

class MathsTest extends GroovyTestCase {
    @NotYetImplemented
    void testFib() {
        def dataTable = [
                1:1,
                2:1,
                3:2,
                4:3,
                5:5,
                6:8,
                7:13
        ]
        dataTable.each { i, r -&gt;
            assert Maths.fib(i) == r
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another advantage of using this technique is that you can write test cases for bugs before knowing how to fix them. If some time in the future, a modification in the code fixes a bug by side effect,
you&#8217;ll be notified because a test which was expected to fail passed.</p>
</div>
</div>
<div class="sect6">
<h7 id="xform-ASTTest">@groovy.transform.ASTTest</h7>
<div class="paragraph">
<p><code>@ASTTest</code> is a special AST transformation meant to help debugging other AST transformations or the Groovy compiler itself. It will let the developer "explore" the AST during compilation and
perform assertions on the AST rather than on the result of compilation. This means that this AST transformations gives access to the AST before the bytecode is produced. <code>@ASTTest</code> can be
placed on any annotable node and requires two parameters:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><em>phase</em>: sets at which phase at which <code>@ASTTest</code> will be triggered. The test code will work on the AST tree at the end of this phase.</p>
</li>
<li>
<p><em>value</em>: the code which will be executed once the phase is reached, on the annotated node</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="icon-tip" title="Tip"></i>
</td>
<td class="content">
Compile phase has to be chosen from one of <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?org/codehaus/groovy/control/CompilePhase.html' target='_blank'><code>org.codehaus.groovy.control.CompilePhase</code></a> . However, since it is not possible to annotate a node twice with the same annotation, you will
not be able to use <code>@ASTTest</code> on the same node at two distinct compile phases.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>value</code> is a closure expression which has access to a special variable <code>node</code> corresponding to the annotated node, and a helper <code>lookup</code> method which will be discussed <a href="userGuides.html#asttest-lookup">here</a>.
For example, you can annotate a class node like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.ASTTest
import org.codehaus.groovy.ast.ClassNode
import static org.codehaus.groovy.control.CompilePhase.*

@ASTTest(phase=CONVERSION, value={   <i class="conum" data-value="1"></i><b>(1)</b>
    assert node instanceof ClassNode <i class="conum" data-value="2"></i><b>(2)</b>
    assert node.name == 'Person'     <i class="conum" data-value="3"></i><b>(3)</b>
})
class Person {

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>we&#8217;re checking the state of the Abstract Syntax Tree after the CONVERSION phase</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>node refers to the AST node which is annotated by @ASTTest</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>it can be used to perform assertions at compile time</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One interesting feature of <code>@ASTTest</code> is that if an assertion fails, then <strong>compilation will fail</strong>. Now imagine that we want to check the behavior of an AST transformation at compile time.
We will take <code>@PackageScope</code> here, and we will want to verify that a property annotated with <code>@PackageScope</code> becomes a package private field. For this, we have to know at which phase the
transform runs, which can be found in <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?org/codehaus/groovy/transform/PackageScopeASTTransformation.html' target='_blank'><code>org.codehaus.groovy.transform.PackageScopeASTTransformation</code></a> : semantic analysis. Then a test can be written like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.ASTTest
import groovy.transform.PackageScope

import static org.codehaus.groovy.control.CompilePhase.*

@ASTTest(phase=SEMANTIC_ANALYSIS, value= {
    def nameNode = node.properties.find { it.name == 'name' }
    def ageNode = node.properties.find { it.name == 'age' }
    assert nameNode
    assert ageNode == null // shouldn't be a property anymore
    def ageField = node.getDeclaredField 'age'
    assert ageField.modifiers == 0
})
class Person {
    String name
    @PackageScope int age
}</code></pre>
</div>
</div>
<div id="asttest-lookup" class="paragraph">
<p>The <code>@ASTTest</code> annotation can only be placed wherever the grammar allows it. Sometimes, you would like to test the contents of an AST node which is not annotable. In this case,
<code>@ASTTest</code> provides a convenient <code>lookup</code> method which will search the AST for nodes which are labelled with a special token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def list = lookup('anchor') <i class="conum" data-value="1"></i><b>(1)</b>
Statement stmt = list[0] <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>returns the list of AST nodes which label is <em>anchor</em></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>it is always necessary to choose which element to process since lookup always returns a list</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Imagine, for example, that you want to test the declared type of a for loop variable. Then you can do it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.transform.ASTTest
import groovy.transform.PackageScope
import org.codehaus.groovy.ast.ClassHelper
import org.codehaus.groovy.ast.expr.DeclarationExpression
import org.codehaus.groovy.ast.stmt.ForStatement

import static org.codehaus.groovy.control.CompilePhase.*

class Something {
    @ASTTest(phase=SEMANTIC_ANALYSIS, value= {
        def forLoop = lookup('anchor')[0]
        assert forLoop instanceof ForStatement
        def decl = forLoop.collectionExpression.expressions[0]
        assert decl instanceof DeclarationExpression
        assert decl.variableExpression.name == 'i'
        assert decl.variableExpression.originType == ClassHelper.int_TYPE
    })
    void someMethod() {
        int x = 1;
        int y = 10;
        anchor: for (int i=0; i&lt;x+y; i++) {
            println "$i"
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_grape_handling">Grape handling</h6>
<div class="sect6">
<h7 id="xform-Grab">@groovy.lang.Grab</h7>

</div>
<div class="sect6">
<h7 id="xform-GrabConfig">@groovy.lang.GrabConfig</h7>

</div>
<div class="sect6">
<h7 id="xform-GrabExclude">@groovy.lang.GrabExclude</h7>

</div>
<div class="sect6">
<h7 id="xform-GrabResolver">@groovy.lang.GrabResolver</h7>

</div>
<div class="sect6">
<h7 id="xform-Grapes">@groovy.lang.Grapes</h7>
<div class="paragraph">
<p><code>Grape</code> is a dependency management engine embedded into Groovy, relying on several annotations which are described
throughfully in this <a href="userGuides.html#section-grape">section of the guide</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="developing-ast-xforms">Developing AST transformations (TBD)</h5>
<div class="sect5">
<h6 id="_compilation_phases_guide_tbd">Compilation phases guide (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_local_transformations_tbd">Local transformations (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_global_transformations_tbd">Global transformations (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_ast_api_guide_tbd">AST API guide (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_testing_ast_transformations_tbd">Testing AST transformations (TBD)</h6>

</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="section-grape">4.5. Dependency management with Grape</h3>
<div class="sect3">
<h4 id="_quick_start">4.5.1. Quick start</h4>
<div class="sect4">
<h5 id="_add_a_dependency">Add a Dependency</h5>
<div class="paragraph">
<p>Grape is a JAR dependency manager embedded into Groovy. Grape lets you quickly add maven repository dependencies to your
classpath, making scripting even easier. The simplest use is as simple as adding an annotation to your script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grab(group='org.springframework', module='spring-orm', version='3.2.5.RELEASE')
import org.springframework.jdbc.core.JdbcTemplate</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@Grab</code> also supports a shorthand notation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grab('org.springframework:spring-orm:3.2.5.RELEASE')
import org.springframework.jdbc.core.JdbcTemplate</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we are using an annotated import here, which is the recommanded way. You can also search for
dependencies on <a href="http://mvnrepository.com">mvnrepository.com</a> and it will
provide you the <code>@Grab</code> annotation form of the <code>pom.xml</code> entry.</p>
</div>
</div>
<div class="sect4">
<h5 id="Grape-SpecifyAdditionalRepositories">Specify Additional Repositories</h5>
<div class="paragraph">
<p>Not all dependencies are in maven central. You can add new ones like
this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@GrabResolver(name='restlet', root='http://maven.restlet.org/')
@Grab(group='org.restlet', module='org.restlet', version='1.1.6')</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Grape-MavenClassifiers">Maven Classifiers</h5>
<div class="paragraph">
<p>Some maven dependencies need classifiers in order to be able to resolve.
You can fix that like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grab(group='net.sf.json-lib', module='json-lib', version='2.2.3', classifier='jdk15')</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Grape-ExcludingTransitiveDependencies">Excluding Transitive Dependencies</h5>
<div class="paragraph">
<p>Sometimes you will want to exclude transitive dependencies as you might
be already using a slightly different but compatible version of some
artifact. You can do this as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grab('net.sourceforge.htmlunit:htmlunit:2.8')
@GrabExclude('xml-apis:xml-apis')</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Grape-JDBCDrivers">JDBC Drivers</h5>
<div class="paragraph">
<p>Because of the way JDBC drivers are loaded, you’ll need to configure
Grape to attach JDBC driver dependencies to the system class loader.
I.e:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@GrabConfig(systemClassLoader=true)
@Grab(group='mysql', module='mysql-connector-java', version='5.1.6')</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Grape-UsingGrapeFromtheGroovyShell">Using Grape From the Groovy Shell</h5>
<div class="paragraph">
<p>From groovysh use the method call variant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">groovy.grape.Grape.grab(group:'org.springframework', module:'spring', version:'2.5.6')</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Grape-Proxysettings">Proxy settings</h5>
<div class="paragraph">
<p>If you are behind a firewall and/or need to use Groovy/Grape through a
proxy server, you can specify those settings on the command like via the
http.proxyHost and http.proxyPort system properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>groovy -Dhttp.proxyHost=yourproxy -Dhttp.proxyPort=8080 yourscript.groovy</pre>
</div>
</div>
<div class="paragraph">
<p>Or you can make this system wide by adding these properties to your
JAVA_OPTS environment variable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>JAVA_OPTS = -Dhttp.proxyHost=yourproxy -Dhttp.proxyPort=8080</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Grape-Logging">Logging</h5>
<div class="paragraph">
<p>If you want to see what Grape is doing set the system property
&#8220;groovy.grape.report.downloads&#8221; to &#8220;true&#8221; (e.g. add
&#8220;-Dgroovy.grape.report.downloads=true&#8221; to JAVA_OPTS) and Grape will
print the following infos to System.error:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Starting resolve of a dependency</p>
</li>
<li>
<p>Starting download of an artifact</p>
</li>
<li>
<p>Retrying download of an artifact</p>
</li>
<li>
<p>Download size and time for downloaded artifacts</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Grape-Detail">4.5.2. Detail</h4>
<div class="paragraph">
<p>Grape (The <em>Groovy Adaptable Packaging Engine</em> or <em>Groovy Advanced
Packaging Engine</em>) is the infrastructure enabling the grab() calls in
Groovy, a set of classes leveraging <a href="http://ant.apache.org/ivy/">Ivy</a> to allow for a repository driven
module system for Groovy. This allows a developer to write a script with
an essentially arbitrary library requirement, and ship just the script.
Grape will, at runtime, download as needed and link the named libraries
and all dependencies forming a transitive closure when the script is run
from existing repositories such as JCenter, Ibiblio, Codehaus, and java.net.</p>
</div>
<div class="paragraph">
<p>Grape follows the Ivy conventions for module version identification,
with naming change.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>group</code> - Which module group the module comes from. Translates
directly to a Maven groupId or an Ivy Organization. Any group matching
<code>/groovy[x][\..*]^/</code> is reserved and may have special meaning to the
groovy endorsed modules.</p>
</li>
<li>
<p><code>module</code> - The name of the module to load. Translated directly to a
Maven artifactId or an Ivy artifact.</p>
</li>
<li>
<p><code>version</code> - The version of the module to use. Either a literal version
&#8216;1.1-RC3&#8217; or an Ivy Range &#8216;[2.2.1,)&#8217; meaning 2.2.1 or any greater
version).</p>
</li>
<li>
<p><code>classifier</code> - The optional classifier to use (for example, <em>jdk15</em>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The downloaded modules will be stored according to Ivy’s standard
mechanism with a cache root of <code>~/.groovy/grape</code></p>
</div>
</div>
<div class="sect3">
<h4 id="Grape-Usage">4.5.3. Usage</h4>
<div class="sect4">
<h5 id="Grape-Annotation">Annotation</h5>
<div class="paragraph">
<p>One or more <code>groovy.lang.Grab</code> annotations can be added at any place that
annotations are accepted to tell the compiler that this code relies on
the specific library. This will have the effect of adding the library to
the classloader of the groovy compiler. This annotation is detected and
evaluated before any other resolution of classes in the script, so
imported classes can be properly resolved by a <code>@Grab</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import com.jidesoft.swing.JideSplitButton
@Grab(group='com.jidesoft', module='jide-oss', version='[2.2.1,2.3.0)')
public class TestClassAnnotation {
    public static String testMethod () {
        return JideSplitButton.class.name
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An appropriate <code>grab(...)</code> call will be added to the static initializer
of the class of the containing class (or script class in the case of an
annotated script element).</p>
</div>
</div>
<div class="sect4">
<h5 id="Grape-MultipleGrapeAnnotations">Multiple Grape Annotations</h5>
<div class="paragraph">
<p>In order to use a Grape annotation multiple times on the same node you must use the
<code>@Grapes</code> annotation, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grapes([
   @Grab(group='commons-primitives', module='commons-primitives', version='1.0'),
   @Grab(group='org.ccil.cowan.tagsoup', module='tagsoup', version='0.9.7')])
class Example {
// ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Otherwise you’ll encounter the following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Cannot specify duplicate annotation on the same member</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Grape-Methodcall">Method call</h5>
<div class="paragraph">
<p>Typically a call to grab will occur early in the script or in class
initialization. This is to insure that the libraries are made available
to the ClassLoader before the groovy code relies on the code. A couple
of typical calls may appear as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.grape.Grape
// random maven library
Grape.grab(group:'com.jidesoft', module:'jide-oss', version:'[2.2.0,)')
Grape.grab([group:'org.apache.ivy', module:'ivy', version:'2.0.0-beta1', conf:['default', 'optional']],
     [group:'org.apache.ant', module:'ant', version:'1.7.0'])

// endorsed Groovy Module
// FUTURE grab('Scriptom')</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Multiple calls to grab in the same context with the same parameters
should be idempotent. However, if the same code is called with a
different <code>ClassLoader</code> context then resolution may be re-run.</p>
</li>
<li>
<p>If the <code>args</code> map passed into the <code>grab</code> call has an attribute
<code>noExceptions</code> that evaluates true no exceptions will be thrown.</p>
</li>
<li>
<p><code>grab</code> requires that a <code>RootLoader</code> or <code>GroovyClassLoader</code> be specified or
be in the <code>ClassLoader</code> chain of the calling class. By default failure to
have such a <code>ClassLoader</code> available will result in module resolution and
an exception being thrown</p>
<div class="ulist">
<ul>
<li>
<p>The ClassLoader passed in via the <code>classLoader:</code> argument and it’s
parent classloaders.</p>
</li>
<li>
<p>The ClassLoader of the object passed in as the <code>referenceObject:</code>
argument, and it’s parent classloaders.</p>
</li>
<li>
<p>The ClassLoader of the class issuing the call to <code>grab</code></p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="Grape-grabHashMapParameters">grab(HashMap) Parameters</h6>
<div class="ulist">
<ul>
<li>
<p><code>group:</code> - &lt;String&gt; - Which module group the module comes from.
Translates directly to a Maven groupId. Any group matching
<code>/groovy(|\..|x|x\..)/</code> is reserved and may have special meaning to the
groovy endorsed modules.</p>
</li>
<li>
<p><code>module:</code> - &lt;String&gt; - The name of the module to load. Translated
directly to a Maven artifactId.</p>
</li>
<li>
<p><code>version:</code> - &lt;String&gt; and possibly &lt;Range&gt; - The version of the module
to use. Either a literal version &#8216;1.1-RC3&#8217; or an Ivy Range &#8216;[2.2.1,)&#8217;
meaning 2.2.1 or any greater version).</p>
</li>
<li>
<p><code>classifier:</code> - &lt;String&gt; - The Maven classifier to resolve by.</p>
</li>
<li>
<p><code>conf:</code> - &lt;String&gt;, default <code>default' - The configuration or scope of
the module to download. The default conf is `default:</code> which maps to the
maven <code>runtime</code> and <code>master</code> scopes.</p>
</li>
<li>
<p><code>force:</code>- &lt;boolean&gt;, defaults true - Used to indicate that this
revision must be used in case of conflicts, independently of</p>
</li>
<li>
<p>conflicts manager</p>
</li>
<li>
<p><code>changing:</code> - &lt;boolean&gt;, default false - Whether the artifact can
change without it’s version designation changing.</p>
</li>
<li>
<p><code>transitive:</code> - &lt;boolean&gt;, default true - Whether to resolve other
dependencies this module has or not.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There are two principal variants of <code>grab</code>, one with a single Map and
one with an arguments Map and multiple dependencies map. A call to the
single map grab is the same as calling grab with the same map passed in
twice, so grab arguments and dependencies can be mixed in the same map,
and grab can be called as a single method with named parameters.</p>
</div>
<div class="paragraph">
<p>There are synonyms for these parameters. Submitting more than one is a
runtime exception.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>group:</code>, <code>groupId:</code>, <code>organisation:</code>, <code>organization:</code>, <code>org:</code></p>
</li>
<li>
<p><code>module:</code>, <code>artifactId:</code>, <code>artifact:</code></p>
</li>
<li>
<p><code>version:</code>, <code>revision:</code>, <code>rev:</code></p>
</li>
<li>
<p><code>conf:</code>, <code>scope:</code>, <code>configuration:</code></p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="Grape-ArgumentsMaparguments">Arguments Map arguments</h6>
<div class="ulist">
<ul>
<li>
<p><code>classLoader:</code> - &lt;GroovyClassLaoder&gt; or &lt;RootClassLoader&gt; - The
ClassLoader to add resolved Jars to</p>
</li>
<li>
<p><code>refObject:</code> - &lt;Object&gt; - The closest parent ClassLoader for the
object’s class will be treated as though it were passed in as
<code>classLoader:</code></p>
</li>
<li>
<p><code>validate:</code> - &lt;boolean&gt;, default false - Should poms or ivy files be
validated (true), or should we trust the cache (false).</p>
</li>
<li>
<p><code>noExceptions:</code> - &lt;boolean&gt;, default false - If ClassLoader resolution
or repository querying fails, should we throw an exception (false) or
fail silently (true).</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Grape-CommandLineTool">Command Line Tool</h5>
<div class="paragraph">
<p>Grape added a command line executable &#8216;grape&#8217; that allows for the
inspection and management of the local grape cache.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>grape install &lt;groupId&gt; &lt;artifactId&gt; [&lt;version&gt;]</pre>
</div>
</div>
<div class="paragraph">
<p>This installs the specified groovy module or maven artifact. If a
version is specified that specific version will be installed, otherwise
the most recent version will be used (as if &#8216;*&#8217; we passed in).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>grape list</pre>
</div>
</div>
<div class="paragraph">
<p>Lists locally installed modules (with their full maven name in the case
of groovy modules) and versions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>grape resolve (&lt;groupId&gt; &lt;artifactId&gt; &lt;version&gt;)+</pre>
</div>
</div>
<div class="paragraph">
<p>This returns the file locations of the jars representing the artifcats
for the specified module(s) and the respective transitive dependencies.
You may optionally pass in -ant, -dos, or -shell to get the dependencies
expressed in a format applicable for an ant script, windows batch file,
or unix shell script respectively. -ivy may be passed to see the
dependencies expressed in an ivy like format.</p>
</div>
</div>
<div class="sect4">
<h5 id="Grape-Advancedconfiguration">Advanced configuration</h5>
<div class="sect5">
<h6 id="Grape-RepositoryDirectory">Repository Directory</h6>
<div class="paragraph">
<p>If you need to change the directory grape uses for downloading libraries
you can specify the grape.root system property to change the default
(which is ~/.groovy/grape)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>groovy -Dgrape.root=/repo/grape yourscript.groovy</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="Grape-CustomizeIvysettings">Customize Ivy settings</h6>
<div class="paragraph">
<p>You can customize the ivy settings that Grape uses by creating a
~/.groovy/grapeConfig.xml file. If no such file exists,
<a href="http://svn.codehaus.org/groovy/tags/GROOVY_1_6_0/src/main/groovy/grape/defaultGrapeConfig.xml">here</a>
are the default settings used by Grape:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;ivysettings&gt;
  &lt;settings defaultResolver="downloadGrapes"/&gt;
  &lt;resolvers&gt;
    &lt;chain name="downloadGrapes"&gt;
      &lt;filesystem name="cachedGrapes"&gt;
        &lt;ivy pattern="${user.home}/.groovy/grapes/[organisation]/[module]/ivy-[revision].xml"/&gt;
        &lt;artifact pattern="${user.home}/.groovy/grapes/[organisation]/[module]/[type]s/[artifact]-[revision].[ext]"/&gt;
      &lt;/filesystem&gt;
      &lt;!-- todo add 'endorsed groovy extensions' resolver here --&gt;
      &lt;ibiblio name="codehaus" root="http://repository.codehaus.org/" m2compatible="true"/&gt;
      &lt;ibiblio name="ibiblio" m2compatible="true"/&gt;
      &lt;ibiblio name="java.net2" root="http://download.java.net/maven/2/" m2compatible="true"/&gt;
    &lt;/chain&gt;
  &lt;/resolvers&gt;
&lt;/ivysettings&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information on how to customize these settings, please refer to
the <a href="http://ant.apache.org/ivy/history/latest-release/settings.html">Ivy
documentation</a>.</p>
</div>
</div>
<div class="sect5">
<h6 id="Grape-AddyourlocalMaven2repository">Add your local Maven2 repository</h6>
<div class="paragraph">
<p>If you find yourself wanting to reuse artifacts that you already have
locally in your Maven2 repository, then you can add this line to your
~/.groovy/grapeConfig.xml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;ibiblio name="local" root="file:${user.home}/.m2/repository/" m2compatible="true"/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>And further customize your Grape configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version="1.0"?&gt;
&lt;ivysettings&gt;
    &lt;settings defaultResolver="downloadGrapes"/&gt;
    &lt;resolvers&gt;
        &lt;chain name="downloadGrapes"&gt;
            &lt;!-- todo add 'endorsed groovy extensions' resolver here --&gt;
            &lt;ibiblio name="local" root="file:${user.home}/.m2/repository/" m2compatible="true"/&gt;
            &lt;filesystem name="cachedGrapes"&gt;
                &lt;ivy pattern="${user.home}/.groovy/grapes/[organisation]/[module]/ivy-[revision].xml"/&gt;
                &lt;artifact pattern="${user.home}/.groovy/grapes/[organisation]/[module]/[type]s/[artifact]-[revision].[ext]"/&gt;
            &lt;/filesystem&gt;
            &lt;ibiblio name="codehaus" root="http://repository.codehaus.org/" m2compatible="true"/&gt;
            &lt;ibiblio name="ibiblio" m2compatible="true"/&gt;
            &lt;ibiblio name="java.net2" root="http://download.java.net/maven/2/" m2compatible="true"/&gt;
        &lt;/chain&gt;
    &lt;/resolvers&gt;
&lt;/ivysettings&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="Grape-MoreExamples">More Examples</h5>
<div class="paragraph">
<p>Using Apache Commons Collections:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">// create and use a primitive array
import org.apache.commons.collections.primitives.ArrayIntList

@Grab(group='commons-primitives', module='commons-primitives', version='1.0')
def createEmptyInts() { new ArrayIntList() }

def ints = createEmptyInts()
ints.add(0, 42)
assert ints.size() == 1
assert ints.get(0) == 42</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using TagSoup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">// find the PDF links in the Java 1.5.0 documentation
@Grab(group='org.ccil.cowan.tagsoup', module='tagsoup', version='0.9.7')
def getHtml() {
    def parser = new XmlParser(new org.ccil.cowan.tagsoup.Parser())
    parser.parse("http://java.sun.com/j2se/1.5.0/download-pdf.html")
}
html.body.'**'.a.@href.grep(~/.*\.pdf/).each{ println it }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using Google Collections:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">// Google Collections example


import com.google.common.collect.HashBiMap
@Grab(group='com.google.code.google-collections', module='google-collect', version='snapshot-20080530')
def getFruit() { [grape:'purple', lemon:'yellow', orange:'orange'] as HashBiMap }
assert fruit.lemon == 'yellow'
assert fruit.inverse().yellow == 'lemon'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Launching a Jetty server to serve Groovy templates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grapes([
    @Grab(group='org.eclipse.jetty.aggregate', module='jetty-server', version='8.1.7.v20120910'),
    @Grab(group='org.eclipse.jetty.aggregate', module='jetty-servlet', version='8.1.7.v20120910'),
    @Grab(group='javax.servlet', module='javax.servlet-api', version='3.0.1')])

import org.eclipse.jetty.server.Server
import org.eclipse.jetty.servlet.*
import groovy.servlet.*

def runServer(duration) {
    def server = new Server(8080)
    def context = new ServletContextHandler(server, "/", ServletContextHandler.SESSIONS);
    context.resourceBase = "."
    context.addServlet(TemplateServlet, "*.gsp")
    server.start()
    sleep duration
    server.stop()
}

runServer(10000)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Grape will download Jetty and its dependencies on first launch of this
script, and cache them. We’re creating a new Jetty Server on port 8080,
then expose Groovy’s TemplateServlet at the root of the context — Groovy
comes with its own powerful template engine mechanism. We start the
server and let it run for a certain duration. Each time someone will hit
<a href="http://localhost:8080/somepage.gsp">http://localhost:8080/somepage.gsp</a>, it will display the somepage.gsp
template to the user — those template pages should be situated in the
same directory as this server script.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_testing_guide">4.6. Testing Guide</h3>
<div class="sect3">
<h4 id="_introduction_2">4.6.1. Introduction</h4>
<div class="paragraph">
<p>The Groovy programming language comes with great support for writing tests. In addition to the language
features and test integration with state-of-the-art testing libraries and frameworks, the Groovy ecosystem has born
a rich set of testing libraries and frameworks.</p>
</div>
<div class="paragraph">
<p>This chapter will start with language specific testing features and continue with a closer look at JUnit integration,
Spock for specifications and Geb for functional tests. Finally, we an overview of other testing libraries known to
be working with Groovy.</p>
</div>
</div>
<div class="sect3">
<h4 id="_language_features">4.6.2. Language Features</h4>
<div class="paragraph">
<p>Besides integrated support for JUnit, the Groovy programming language comes with features that have proven
to be very valuable for test-driven development. This section gives insight on them.</p>
</div>
<div class="sect4">
<h5 id="_power_assertions">Power Assertions</h5>
<div class="paragraph">
<p>Writing tests means formulating assumptions by using assertions. In Java this can be done by using the <code>assert</code>
keyword that has been added in J2SE 1.4. In Java, <code>assert</code> statements can be enabled via the JVM parameters <code>-ea</code>
(or <code>-enableassertions</code>) and <code>-da</code> (or <code>-disableassertions</code>). Assertion statements in Java are disabled by default.</p>
</div>
<div class="paragraph">
<p>Groovy comes with a rather <em>powerful variant</em> of <code>assert</code> also known as <em>power assertion statement</em>. Groovy&#8217;s power
<code>assert</code> differs from the Java version in its output given the boolean expression validates to <code>false</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def x = 1
assert x == 2

// Output:             <i class="conum" data-value="1"></i><b>(1)</b>
//
// Assertion failed:
// assert x == 2
//        | |
//        1 false</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>This section shows the std-err output</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>java.lang.AssertionError</code> that is thrown whenever the assertion can not be validated successfully, contains
an extended version of the original exception message. The power assertion output shows evaluation results from
the outer to the inner expression.</p>
</div>
<div class="paragraph">
<p>The power assertion statements true power unleashes in complex Boolean statements, or statements with
collections or other <code>toString</code>-enabled classes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def x = [1,2,3,4,5]
assert (x &lt;&lt; 6) == [6,7,8,9,10]

// Output:
//
// Assertion failed:
// assert (x &lt;&lt; 6) == [6,7,8,9,10]
//         | |     |
//         | |     false
//         | [1, 2, 3, 4, 5, 6]
//         [1, 2, 3, 4, 5, 6]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another important difference from Java is that in Groovy assertions are <em>enabled by default</em>. It has been a language design
decision to remove the possibility to deactivate assertions. Or, as Bertrand Meyer stated, ``it makes no sense to take
off your swim ring if you put your feet into real water``.</p>
</div>
<div class="paragraph">
<p>One thing to be aware of are methods with side-effects inside Boolean expressions in power assertion statements. As
the internal error message construction mechanism does only store references to instances under target,
 it happens that the error message text is invalid at rendering time in case of side-effecting methods involved:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">assert [[1,2,3,3,3,3,4]].first().unique() == [1,2,3]

// Output:
//
// Assertion failed:
// assert [[1,2,3,3,3,3,4]].first().unique() == [1,2,3]
//                          |       |        |
//                          |       |        false
//                          |       [1, 2, 3, 4]
//                          [1, 2, 3, 4]           <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The error message shows the actual state of the collection, not the state before the <code>unique</code> method was applied</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
If you choose to provide a custom assertion error message this can be done by using the Java syntax <code>assert
expression1 : expression2</code> where <code>expression1</code> is the Boolean expression and <code>expression2</code> is the custom error message.
 Be aware though that this will disable the power assert and will fully fallback to custom
 error messages on assertion errors.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_mocking_and_stubbing">Mocking and Stubbing</h5>
<div class="paragraph">
<p>Groovy has excellent built-in support for a range of mocking and stubbing alternatives. When using Java, dynamic mocking
frameworks are very popular. A key reason for this is that it is hard work creating custom hand-crafted mocks using Java.
Such frameworks can be used easily with Groovy if you choose but creating custom mocks is much easier in Groovy. You
can often get away with simple maps or closures to build your custom mocks.</p>
</div>
<div class="paragraph">
<p>The following sections show ways to create mocks and stubs with Groovy language features only.</p>
</div>
<div class="sect5">
<h6 id="_map_coercion">Map Coercion</h6>
<div class="paragraph">
<p>By using maps or expandos, we can incorporate desired behaviour of a collaborator very easily as shown here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class TranslationService {
    String convert(String key) {
        return "test"
    }
}

def service = [convert: { String key -&gt; 'some text' }] as TranslationService
assert 'some text' == service.convert('key.text')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>as</code> operator can be used to coerce a map to a particular class. The given map keys are interpreted as
method names and the values, being <code>groovy.lang.Closure</code> blocks, are interpreted as method code blocks.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
Be aware that map coercion can get into the way if you deal with custom <code>java.util.Map</code> descendant classes in combination
with the <code>as</code> operator. The map coercion mechanism is targeted directly at certain collection classes, it doesn&#8217;t take
custom classes into account.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_closure_coercion">Closure Coercion</h6>
<div class="paragraph">
<p>The <em>as</em> operator can be used with closures in a neat way which is great for developer testing in simple scenarios.
We haven&#8217;t found this technique to be so powerful that we want to do away with dynamic mocking, but it can be very
useful in simple cases none-the-less.</p>
</div>
<div class="paragraph">
<p>Classes or interfaces holding a single method, including SAM (single abstract method) classes, can be used to coerce
a closure block to be an object of the given type. Be aware that for doing this, Groovy internally create a proxy object
descending for the given class. So the object will not be a direct instance of the given class. This important if, for
example, the generated proxy object&#8217;s meta-class is altered afterwards.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have an example on coercing a closure to be of a specific type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def service = { String key -&gt; 'some text' } as TranslationService
assert 'some text' == service.convert('key.text')</code></pre>
</div>
</div>
<div class="paragraph">
<p>Groovy supports a feature called implicit SAM coercion. This means that the <code>as</code> operator is not necessary in situations
where the runtime can infer the target SAM type. This type of coercion might be useful in tests to mock entire SAM
classes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">abstract class BaseService {
    abstract void doSomething()
}

BaseService service = { -&gt; println 'doing something' }
service.doSomething()</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_mockfor_and_stubfor">MockFor and StubFor</h6>
<div class="paragraph">
<p>The Groovy mocking and stubbing classes can be found in the <code>groovy.mock.interceptor</code> package.</p>
</div>
<div class="paragraph">
<p>The <code>MockFor</code> class supports (typically unit) testing of classes in isolation by allowing a <em>strictly ordered</em> expectation
of the behavior of collaborators to be defined. A typical test scenario involves a class under test and one or more collaborators. In such a scenario it is
often desirable to just test the business logic of the class under test. One strategy for doing that is to replace
the collaborator instances with simplified mock objects to help isolate out the logic in the test target. MockFor
allows such mocks to be created using meta-programming. The desired behavior of collaborators is defined as a behavior
specification. The behavior is enforced and checked automatically.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s assume our target classes looked like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Person {
    String first, last
}

class Family {
    Person father, mother
    def nameOfMother() { "$mother.first $mother.last" }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With <code>MockFor</code>, a mock expectation is always sequence dependent and its use automatically ends with a call to <code>verify</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def mock = new MockFor(Person)      <i class="conum" data-value="1"></i><b>(1)</b>
mock.demand.getFirst{ 'dummy' }
mock.demand.getLast{ 'name' }
mock.use {                          <i class="conum" data-value="2"></i><b>(2)</b>
    def mary = new Person(first:'Mary', last:'Smith')
    def f = new Family(mother:mary)
    assert f.nameOfMother() == 'dummy name'
}
mock.expect.verify()                <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>a new mock is created by a new instance of <code>MockFor</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>a <code>Closure</code> is passed to <code>use</code> which enables the mocking functionality</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>a call to <code>verify</code> checks whether the sequence and number of method calls is as expected</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>StubFor</code> class supports (typically unit) testing of classes in isolation by allowing a <em>loosely-ordered</em> expectation
of the behavior of collaborators to be defined. A typical test scenario involves a class under test and one or more
collaborators. In such a scenario it is often desirable to just test the business logic of the CUT. One strategy for
doing that is to replace the collaborator instances with simplified stub objects to help isolate out the logic
in the target class. <code>StubFor</code> allows such stubs to be created using meta-programming. The desired behavior of
collaborators is defined as a behavior specification.</p>
</div>
<div class="paragraph">
<p>In contrast to <code>MockFor</code> the stub expectation checked with <code>verify</code> is sequence independent and its use is optional:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def stub = new StubFor(Person)      <i class="conum" data-value="1"></i><b>(1)</b>
stub.demand.with {                  <i class="conum" data-value="2"></i><b>(2)</b>
    getLast{ 'name' }
    getFirst{ 'dummy' }
}
stub.use {                          <i class="conum" data-value="3"></i><b>(3)</b>
    def john = new Person(first:'John', last:'Smith')
    def f = new Family(father:john)
    assert f.father.first == 'dummy'
    assert f.father.last == 'name'
}
stub.expect.verify()                <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>a new stub is created by a new instance of <code>StubFor</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the <code>with</code> method is used for delegating all calls inside the closure to the <code>StubFor</code> instance</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>a <code>Closure</code> is passed to <code>use</code> which enables the stubbing functionality</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>a call to <code>verify</code> (optional) checks whether the number of method calls is as expected</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>MockFor</code> and <code>StubFor</code> can not be used to test statically compiled classes e.g for Java classes or Groovy classes that
make use of <code>@CompileStatic</code>. To stub and/or mock these classes you can use Spock or one of the Java mocking libraries.</p>
</div>
</div>
<div class="sect5">
<h6 id="testing_guide_emc">Expando Meta-Class (EMC)</h6>
<div class="paragraph">
<p>Groovy includes a special <code>MetaClass</code> the so-called <code>ExpandoMetaClass</code> (EMC). It allows to dynamically add methods,
constructors, properties and static methods using a neat closure syntax.</p>
</div>
<div class="paragraph">
<p>Every <code>java.lang.Class</code> is supplied with a special <code>metaClass</code> property that will give a reference to an
<code>ExpandoMetaClass</code> instance. The expando meta-class is not restricted to custom classes, it can be used for
JDK classes like for example <code>java.lang.String</code> as well:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">String.metaClass.swapCase = {-&gt;
    def sb = new StringBuffer()
    delegate.each {
        sb &lt;&lt; (Character.isUpperCase(it as char) ? Character.toLowerCase(it as char) :
            Character.toUpperCase(it as char))
    }
    sb.toString()
}

def s = "heLLo, worLD!"
assert s.swapCase() == 'HEllO, WORld!'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ExpandoMetaClass</code> is a rather good candidate for mocking functionality as it allows for more advanced stuff
like mocking static methods</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Book {
    String title
}

Book.metaClass.static.create &lt;&lt; { String title -&gt; new Book(title:title) }

def b = Book.create("The Stand")
assert b.title == 'The Stand'</code></pre>
</div>
</div>
<div class="paragraph">
<p>or even constructors</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">Book.metaClass.constructor &lt;&lt; { String title -&gt; new Book(title:title) }

def b = new Book("The Stand")
assert b.title == 'The Stand'</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
Mocking constructors might seem like a hack that&#8217;s better not even to be considered but even there might be valid
use cases. An example can be found in Grails where domain class constructors are added at run-time with the
help of <code>ExpandoMetaClass</code>. This lets the domain object register itself in the Spring application context and allows
for injection of services or other beans controlled by the dependency-injection container.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you want to change the <code>metaClass</code> property on a per test method level you need to remove the changes that were
done to the meta-class, otherwise those changes would be persistent across test method calls. Changes are removed by
replacing the meta-class in the <code>GroovyMetaClassRegistry</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">GroovySystem.metaClassRegistry.setMetaClass(java.lang.String, null)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another alternative is to register a <code>MetaClassRegistryChangeEventListener</code>, track the changed classes and remove
the changes in the cleanup method of your chosen testing runtime. A good example can be found <a href="https://github.com/grails/grails-core/blob/master/grails-bootstrap/src/main/groovy/org/codehaus/groovy/grails/cli/support/MetaClassRegistryCleaner.java">in the Grails web
development framework</a>.</p>
</div>
<div class="paragraph">
<p>Besides using the <code>ExpandoMetaClass</code> on a class-level, there is also support for using the meta-class on a per-object
level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def b = new Book(title: "The Stand")
b.metaClass.getTitle {-&gt; 'My Title' }

assert b.title == 'My Title'</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the meta-class change is related to the instance only. Depending on the test scenario this might be a better
fit than the global meta-class change.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_gdk_methods">GDK Methods</h5>
<div class="paragraph">
<p>The following section gives a brief overview on GDK methods that can be leveraged in test case scenarios, for example for
test data generation.</p>
</div>
<div class="sect5">
<h6 id="_iterable_combinations">Iterable#combinations</h6>
<div class="paragraph">
<p>The <code>combinations</code> method that is added on <code>java.lang.Iterable</code> compliant classes can be used to get a list of
combinations from a list containing two or more sub-lists:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">void testCombinations() {
    def combinations = [[2, 3],[4, 5, 6]].combinations()
    assert combinations == [[2, 4], [3, 4], [2, 5], [3, 5], [2, 6], [3, 6]]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The method could be used in test case scenarios to generate all possible argument combinations for a specific method
call.</p>
</div>
</div>
<div class="sect5">
<h6 id="_iterable_eachcombination">Iterable#eachCombination</h6>
<div class="paragraph">
<p>The <code>eachCombination</code> method that is added on <code>java.lang.Iterable</code> can be used to apply a function (or in this
 case a <code>groovy.lang.Closure</code>) to each if the combinations that has been built by the <code>combinations</code> method:</p>
</div>
<div class="paragraph">
<p><code>eachCombination</code> is a GDK method that is added to all classes conforming to the <code>java.lang.Iterable</code> interface.
It applies a function on each combination of the input lists:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">void testEachCombination() {
    [[2, 3],[4, 5, 6]].eachCombination { println it[0] + it[1] }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The method could be used in the testing context to call methods with each of the generated combinations.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_tool_support">Tool Support</h5>
<div class="sect5">
<h6 id="_test_code_coverage">Test Code Coverage</h6>
<div class="paragraph">
<p>Code coverage is a useful measure of the effectiveness of (unit) tests. A program with high code coverage has a
lower chance to hold critical bugs than a program with no or low coverage. To get code coverage metrics,
the generated byte-code usually needs to be instrumented before the tests are executed. One tool with Groovy support
 for this task is <a href="http://cobertura.github.io/cobertura/">Cobertura</a>.</p>
</div>
<div class="paragraph">
<p>Various frameworks and build tools come with Cobertura integration. For Grails, there is the <a href="http://grails.org/plugin/code-coverage">code coverage plugin</a> based
on Cobertura, for Gradle there is the <a href="https://github.com/eriwen/gradle-cobertura-plugin">gradle-cobertura plugin</a>, to name only two of them.</p>
</div>
<div class="paragraph">
<p>The following code listing shows an example on how to enable Cobertura test coverage reports in a Gradle build script from
a Groovy project:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def pluginVersion = '&lt;plugin version&gt;'
def groovyVersion = '&lt;groovy version&gt;'
def junitVersion = '&lt;junit version&gt;'

buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath 'com.eriwen:gradle-cobertura-plugin:${pluginVersion}'
    }
}

apply plugin: 'groovy'
apply plugin: 'cobertura'

repositories {
    mavenCentral()
}

dependencies {
    compile "org.codehaus.groovy:groovy-all:${groovyVersion}"
    testCompile "junit:junit:${junitVersion}"
}

cobertura {
    format = 'html'
    includes = ['**/*.java', '**/*.groovy']
    excludes = ['com/thirdparty/**/*.*']
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Several output formats can be chosen for Cobertura coverage reports and test code coverage reports can be added to
continuous integration build tasks.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_unit_tests_with_junit_3_and_4">4.6.3. Unit Tests with JUnit 3 and 4</h4>
<div class="paragraph">
<p>Groovy simplifies JUnit testing, making it more Groovy. In the following sections we will have a closer look at
JUnit 3/4 Groovy integration.</p>
</div>
<div class="sect4">
<h5 id="_junit_3">JUnit 3</h5>
<div class="paragraph">
<p>Maybe one of the most prominent Groovy classes supporting JUnit 3 tests is the <code>GroovyTestCase</code> class. Being
derived from <code>junit.framework.TestCase</code> it offers a bunch of additional methods that make testing in Groovy a breeze.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
Although <code>GroovyTestCase</code> inherits from <code>TestCase</code> doesn&#8217;t mean you can&#8217;t use JUnit 4 features in your project. In fact,
the most recent Groovy versions come with a bundled JUnit 4 and that comes with a backwards compatible <code>TestCase</code>
implementation. There have been some discussion on the Groovy mailing-list on whether to use <code>GroovyTestCase</code> or JUnit 4
with the result that it is mostly a matter of taste, but with <code>GroovyTestCase</code> you get a bunch of methods for free that
make certain types of tests easier to write.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In this section, we will have a look at some of the methods provided by <code>GroovyTestCase</code>. A full list of these can be
found in the JavaDoc documentation for <a href="http://groovy.codehaus.org/api/groovy/util/GroovyTestCase.html">groovy.util.GroovyTestCase</a>,
don&#8217;t forget it is inherited from <code>junit.framework.TestCase</code> which inherits all the <code>assert*</code> methods.</p>
</div>
<div class="sect5">
<h6 id="_assertion_methods">Assertion Methods</h6>
<div class="paragraph">
<p><code>GroovyTestCase</code> is inherited from <code>junit.framework.TestCase</code> therefore it inherits a large number of assertion methods
being available to be called in every test method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class MyTestCase extends GroovyTestCase {

    void testAssertions() {
        assertTrue(1 == 1)
        assertEquals("test", "test")

        def x = "42"
        assertNotNull "x must not be null", x
        assertNull null

        assertSame x, x
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As can be seen above, in contrast to Java it is possible to leave out the parenthesis in most situations which
leads to even more readability of JUnit assertion method call expressions.</p>
</div>
<div class="paragraph">
<p>An interesting assertion method that is added by <code>GroovyTestCase</code> is <code>assertScript</code>. It ensures that the given Groovy
code string succeeds without any exception:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">void testScriptAssertions() {
    assertScript '''
        def x = 1
        def y = 2

        assert x + y == 3
    '''
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_shouldfail_methods">shouldFail Methods</h6>
<div class="paragraph">
<p><code>shouldFail</code> can be used to check whether the given code block fails or not. In case it fails, the assertion does hold,
otherwise the assertion fails:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">void testInvalidIndexAccess1() {
    def numbers = [1,2,3,4]
    shouldFail {
        numbers.get(4)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example above uses the basic <code>shouldFail</code> method interface that takes a <code>groovy.lang.Closure</code> as a single argument.
 The <code>Closure</code> instance holds the code that is supposed to be breaking during run-time.</p>
</div>
<div class="paragraph">
<p>If we wanted to assert <code>shouldFail</code> on a specific <code>java.lang.Exception</code> type we could have done so by using the <code>shouldFail</code>
implementation that takes the <code>Exception</code> class as first argument and the <code>Closure</code> as second argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">void testInvalidIndexAccess2() {
    def numbers = [1,2,3,4]
    shouldFail IndexOutOfBoundsException, {
        numbers.get(4)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If anything other than <code>IndexOutOfBoundsException</code> (or a descendant class of it) is thrown, the test case will fail.</p>
</div>
<div class="paragraph">
<p>A pretty nice feature of <code>shouldFail</code> hasn&#8217;t been visible so far: it returns the exception message. This is really
useful if you want to assert on the exception error message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">void testInvalidIndexAccess3() {
    def numbers = [1,2,3,4]
    def msg = shouldFail IndexOutOfBoundsException, {
        numbers.get(4)
    }
    assert msg.contains('Index: 4, Size: 4')
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_notyetimplemented_method">notYetImplemented Method</h6>
<div class="paragraph">
<p>The <code>notYetImplemented</code> method has been greatly influenced by HtmlUnit. It allows to write a test method but mark it
as not yet implemented. As long as the test method fails and is marked with <code>notYetImplemented</code> the test goes green:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">void testNotYetImplemented1() {
    if (notYetImplemented()) return   <i class="conum" data-value="1"></i><b>(1)</b>

    assert 1 == 2                     <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>a call to <code>notYetImplemented</code> is necessary for <code>GroovyTestCase</code> to get the current method stack.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>as long as the test evaluates to <code>false</code> the test execution will be successful.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>An alternative to the <code>notYetImplemented</code> method is the <code>@NotYetImplemented</code> annotation. It allows for annotating a
method as not yet implemented, with the exact same behavior as <code>GroovyTestCase#notYetImplemented</code> but without the need
for the <code>notYetImplemented</code> method call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@NotYetImplemented
void testNotYetImplemented2() {
    assert 1 == 2
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_junit_4">JUnit 4</h5>
<div class="paragraph">
<p>Groovy can be used to write JUnit 4 test cases without any restrictions. The <code>groovy.test.GroovyAssert</code> holds
various static methods that can be used as replacement for the <code>GroovyTestCase</code> methods in JUnit 4 tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.junit.Test

import static groovy.test.GroovyAssert.shouldFail

class JUnit4ExampleTests {

    @Test
    void indexOutOfBoundsAccess() {
        def numbers = [1,2,3,4]
        shouldFail {
            numbers.get(4)
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As can be seen in the example above, the static methods found in <code>GroovyAssert</code> are imported at the beginning of the
 class definition thus <code>shouldFail</code> can be used the same way it can be used in a <code>GroovyTestCase</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
<code>groovy.test.GroovyAssert</code> descends from <code>org.junit.Assert</code> that means it inherits all JUnit assertion methods. However,
with the introduction of the power assertion statement, it turned out to be <em>good practice to rely on assertion statements</em>
instead of using the JUnit assertion methods with the improved message being the main reason.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_testing_with_spock">4.6.4. Testing with Spock</h4>
<div class="paragraph">
<p>Spock is a testing and specification framework for Java and Groovy applications. What makes it stand out from the
crowd is its beautiful and highly expressive specification DSL. In practice, Spock specifications are written as
Groovy classes. Although written in Groovy they can be used to test Java classes. Spock can be used for unit,
integration or BDD (behavior-driven-development) testing, it doesn&#8217;t put itself into a specific category of testing
frameworks or libraries.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
Beside these awesome features Spock is a good example on how to leverage advanced Groovy programming
language features in third party libraries, for example, by using Groovy AST transformations.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
This section should not serve as detailed guide on how to use Spock, it should rather give an impression what Spock
is about and how it can be leveraged for unit, integration, functional or any other type of testing.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next section we will have an first look at the anatomy of a Spock specification. It should give a
pretty good feeling on what Spock is up to.</p>
</div>
<div class="sect4">
<h5 id="_specifications">Specifications</h5>
<div class="paragraph">
<p>Spock lets you write specifications that describe features (properties, aspects) exhibited by a system of
interest. The "system" can be anything between a single class and an entire application, a more advanced term for it is
<em>system under specification</em>. The <em>feature description</em> starts from a specific snapshot of the system and its
collaborators, this snapshot is called the <em>feature&#8217;s fixture</em>.</p>
</div>
<div class="paragraph">
<p>Spock specification classes are derived from <code>spock.lang.Specification</code>. A concrete specification class might consist
of fields, fixture methods, features methods and helper methods.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s have a look at a simple specification with a single feature method for an imaginary <code>Stack</code> class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class StackSpec extends Specification {

    def "adding an element leads to size increase"() {  <i class="conum" data-value="1"></i><b>(1)</b>
        setup: "a new stack instance is created"        <i class="conum" data-value="2"></i><b>(2)</b>
            def stack = new Stack()

        when:                                           <i class="conum" data-value="3"></i><b>(3)</b>
            stack.push 42

        then:                                           <i class="conum" data-value="4"></i><b>(4)</b>
            stack.size() == 1
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Feature method, is by convention named with a String literal.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Setup block, here is where any setup work for this feature needs to be done.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>When block describes a stimulus, a certain action under target by this feature specification.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Then block any expressions that can be used to validate the result of the code that was triggered by the when block.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Spock feature specifications are defined as methods inside a <code>spock.lang.Specification</code> class. They describe the feature
by using a String literal instead of a method name.</p>
</div>
<div class="paragraph">
<p>A feature method holds multiple blocks, in our example we used <code>setup</code>, <code>when</code> and <code>then</code>. The <code>setup</code> block is special
in that it is optional and allows to configure local variables visible inside the feature method. The <code>when</code> block
defines the stimulus and is a companion of the <code>then</code> block which describes the response to the stimulus.</p>
</div>
<div class="paragraph">
<p>Note that the <code>setup</code> method in the <code>StackSpec</code> above additionally
  has a description String. Description Strings are optional and can be added after block labels (like <code>setup</code>, <code>when</code>,
  <code>then</code>).</p>
</div>
</div>
<div class="sect4">
<h5 id="_more_spock">More Spock</h5>
<div class="paragraph">
<p>Spock provides much more features like data tables or advanced mocking capabilities. Feel free to consult the
<a href="https://github.com/spockframework/spock">Spock GitHub page</a> for more documentation and download information.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_functional_tests_with_geb">4.6.5. Functional Tests with Geb</h4>
<div class="paragraph">
<p>Geb is a functional web testing and scraper library that integrates with JUnit and Spock. It is based upon the
Selenium web drivers and, like Spock, provides a Groovy DSL to write functional tests for web applications.</p>
</div>
<div class="paragraph">
<p>Geb has great features that make it a good fit for a functional testing library:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>DOM access via a JQuery-like <code>$</code> function</p>
</li>
<li>
<p>implements the <em>page pattern</em></p>
</li>
<li>
<p>support for modularization of certain web components (e.g. menu-bars, etc.) with <em>modules</em></p>
</li>
<li>
<p>integration with JavaScript via the JS variable</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
This section should not serve as detailed guide on how to use Geb, it should rather give an impression what Geb
is about and how it can be leveraged functional testing.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The next section will give an example on how Geb can be used to write a functional test for a simple
 web page with a single search field.</p>
</div>
<div class="sect4">
<h5 id="_a_geb_script">A Geb Script</h5>
<div class="paragraph">
<p>Although Geb can be used standalone in a Groovy script, in many scenarios it&#8217;s used in combination with other testing
frameworks. Geb comes with various base classes that can be used in JUnit 3, 4, TestNG or Spock tests. The base classes
are part of additional Geb modules that need to be added as a dependency.</p>
</div>
<div class="paragraph">
<p>For example, the following <code>@Grab</code> dependencies have to be used to run Geb with the Selenium Firefox driver in
JUnit4 tests. The module that is needed for JUnit 3/4 support is <code>geb-junit</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grapes([
    @Grab("org.gebish:geb-core:0.9.2"),
    @Grab("org.gebish:geb-junit:0.9.2"),
    @Grab("org.seleniumhq.selenium:selenium-firefox-driver:2.26.0"),
    @Grab("org.seleniumhq.selenium:selenium-support:2.26.0")
])</code></pre>
</div>
</div>
<div class="paragraph">
<p>The central class in Geb is the <code>geb.Browser</code> class. As its name implies it is used
 to browse pages and access DOM elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def browser = new Browser(driver: new FirefoxDriver(), baseUrl: 'http://myhost:8080/myapp')  <i class="conum" data-value="1"></i><b>(1)</b>
browser.drive {
    go "/login"                        <i class="conum" data-value="2"></i><b>(2)</b>

    $("#username").text = 'John'       <i class="conum" data-value="3"></i><b>(3)</b>
    $("#password").text = 'Doe'

    $("#loginButton").click()

    assert title == "My Application - Dashboard"
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A new <code>Browser</code> instance is created. In this case it uses the Selenium <code>FirefoxDriver</code> and sets the <code>baseUrl</code>.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>go</code> is used to navigate to an URL or relative URI</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>$</code> together with CSS selectors is used to access the <code>username</code> and <code>password</code> DOM fields.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>Browser</code> class comes with a <code>drive</code> method that delegates all method/property calls to the current
<code>browser</code> instance. The <code>Browser</code> configuration must not be done inline, it can also be externalized in a
<code>GebConfig.groovy</code> configuration file for example. In practice, the usage of the <code>Browser</code> class is mostly hidden
by Geb test base classes. They delegate all missing properties and method calls to the current <code>browser</code> instance
that exists in the background:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class SearchTests extends geb.junit4.GebTest {

    @Test
    void executeSeach() {
        go 'http://somehost/mayapp/search'              <i class="conum" data-value="1"></i><b>(1)</b>
        $('#searchField').text = 'John Doe'             <i class="conum" data-value="2"></i><b>(2)</b>
        $('#searchButton').click()                      <i class="conum" data-value="3"></i><b>(3)</b>

        assert $('.searchResult a').first().text() == 'Mr. John Doe' <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>Browser#go</code> takes a relative or absolute link and calls the page.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>Browser#$</code> is used to access DOM content. Any CSS selectors supported by the underlying Selenium drivers are allowed</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>click</code> is used to click a button.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td><code>$</code> is used to get the first link out of the <code>searchResult</code> block</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The example above shows a simple Geb web test with the JUnit 4 base class <code>geb.junit4.GebTest</code>. Note that in this case
the <code>Browser</code> configuration is externalized. <code>GebTest</code> delegates methods like <code>go</code> and <code>$</code> to the underlying <code>browser</code>
 instance.</p>
</div>
</div>
<div class="sect4">
<h5 id="_more_geb">More Geb</h5>
<div class="paragraph">
<p>In the previous section we only scratched the surface of the available Geb features. More information on Geb can be found
at the <a href="http://gebish.org">project homepage</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_other_testing_libraries_and_frameworks">4.6.6. Other Testing Libraries and Frameworks</h4>
<div class="sect4">
<h5 id="_testng">TestNG</h5>
<div class="paragraph">
<p><a href="http://testng.org/">TestNG</a> is a testing framework inspired from JUnit and NUnit but with new functionality to make
it more powerful and easier to use. Features include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JDK 5 Annotations</p>
</li>
<li>
<p>Flexible test configuration</p>
</li>
<li>
<p>Support for data-driven testing (with <code>@DataProvider</code>)</p>
</li>
<li>
<p>Support for parameters</p>
</li>
<li>
<p>Allows distribution of tests on slave machines</p>
</li>
<li>
<p>Powerful execution model (no more TestSuite)</p>
</li>
<li>
<p>Supported by a variety of tools and plug-ins (Eclipse, IDEA, Maven, etc&#8230;)</p>
</li>
<li>
<p>Embeds <code>BeanShell</code> for further flexibility</p>
</li>
<li>
<p>Default JDK functions for runtime and logging (no dependencies)</p>
</li>
<li>
<p>Dependent methods for application server testing</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_mockito">Mockito</h5>
<div class="paragraph">
<p><a href="https://code.google.com/p/mockito/">Mockito</a> is a Java mocking library. It has very slim API, almost no time is needed
to start mocking. Features include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Mocks concrete classes as well as interfaces</p>
</li>
<li>
<p>Little annotation syntax sugar - <code>@Mock</code></p>
</li>
<li>
<p>Verification errors are clean - click on stack trace to see failed verification in test; click on exception&#8217;s cause
to navigate to actual interaction in code. Stack trace is always clean.</p>
</li>
<li>
<p>Allows flexible verification in order (e.g: verify in order what you want, not every single interaction)</p>
</li>
<li>
<p>Supports exact-number-of-times and at-least-once verification</p>
</li>
<li>
<p>Flexible verification or stubbing using argument matchers (<code>anyObject()</code>, <code>anyString()</code> or <code>refEq()</code> for reflection-based
equality matching)</p>
</li>
<li>
<p>Allows creating custom argument matchers or using existing Hamcrest matchers</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_easymock">EasyMock</h5>
<div class="paragraph">
<p><a href="http://easymock.org/">EasyMock</a> is a mocking library for Java. Features include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Hand-writing classes for Mock Objects is not needed.</p>
</li>
<li>
<p>Supports refactoring-safe Mock Objects: test code will not break at runtime when renaming methods or reordering method parameters</p>
</li>
<li>
<p>Supports return values and exceptions.</p>
</li>
<li>
<p>Supports checking the order of method calls, for one or more Mock Objects.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_jbehave">JBehave</h5>
<div class="paragraph">
<p><a href="http://jbehave.org/">JBehave</a> is a framework for Behaviour-Driven Development (BDD). BDD is an evolution of test-driven
development and acceptance-test driven design, and is intended to make these practices more accessible and intuitive
to newcomers and experts alike. It shifts the vocabulary from being test-based to behaviour-based, and positions itself
as a design philosophy.</p>
</div>
</div>
<div class="sect4">
<h5 id="_jmockit">JMockit</h5>
<div class="paragraph">
<p><a href="https://code.google.com/p/jmockit/">jmockit</a> is a mocking library for Java.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_processing_json_tbd">4.7. Processing JSON (TBD)</h3>
<div class="sect4">
<h5 id="_interacting_with_a_sql_database_tbd">Interacting with a SQL database (TBD)</h5>

</div>
<div class="sect4">
<h5 id="_processing_xml_tbd">Processing XML (TBD)</h5>

</div>
<div class="sect4">
<h5 id="_scripting_ant_tasks_tbd">Scripting Ant tasks (TBD)</h5>

</div>
</div>
<div class="sect2">
<h3 id="_template_engines">4.8. Template engines</h3>
<div class="sect3">
<h4 id="_introduction_3">4.8.1. Introduction</h4>
<div class="paragraph">
<p>Groovy supports multiple ways to generate text dynamically including <code>GStrings</code>, <code>printf</code> if you are using Java 5, and <a href="userGuides.html#_markupbuilder">MarkupBuilder</a> just to name a few. In addition to these, there is a dedicated template framework which is well-suited to applications where the text to be generated follows the form of a static template.</p>
</div>
</div>
<div class="sect3">
<h4 id="_template_framework">4.8.2. Template framework</h4>
<div class="paragraph">
<p>The template framework in Groovy consists of a <code>TemplateEngine</code> abstract base class that engines must implement and a <code>Template</code> interface that the resulting templates they generate must implement.</p>
</div>
<div class="paragraph">
<p>Included with Groovy are several template engines:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SimpleTemplateEngine</code> - for basic templates</p>
</li>
<li>
<p><code>GStringTemplateEngine</code> - stores the template as writable closures (useful for streaming scenarios)</p>
</li>
<li>
<p><code>XmlTemplateEngine</code> - works well when the template and output are valid XML</p>
</li>
<li>
<p><code>MarkupTemplateEngine</code> - a very complete, optimized, template engine</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_simpletemplateengine">4.8.3. SimpleTemplateEngine</h4>
<div class="paragraph">
<p>Shown here is the <code>SimpleTemplateEngine</code> that allows you to use JSP-like scriptlets (see example below), script, and EL expressions in your template in order to generate parameterized text. Here is an example of using the system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def text = 'Dear "$firstname $lastname",\nSo nice to meet you in &lt;% print city %&gt;.\nSee you in ${month},\n${signed}'

def binding = ["firstname":"Sam", "lastname":"Pullara", "city":"San Francisco", "month":"December", "signed":"Groovy-Dev"]

def engine = new groovy.text.SimpleTemplateEngine()
def template = engine.createTemplate(text).make(binding)

def result = 'Dear "Sam Pullara",\nSo nice to meet you in San Francisco.\nSee you in December,\nGroovy-Dev'

assert result == template.toString()</code></pre>
</div>
</div>
<div class="paragraph">
<p>While it is generally not deemed good practice to mix processing logic in your template (or view), sometimes very simple logic can be useful. E.g. in the example above, we could change this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">$firstname</code></pre>
</div>
</div>
<div class="paragraph">
<p>to this (assuming we have set up a static import for capitalize <strong>inside</strong> the template):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">${firstname.capitalize()}</code></pre>
</div>
</div>
<div class="paragraph">
<p>or this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">&lt;% print city %&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">&lt;% print city == "New York" ? "The Big Apple" : city %&gt;</code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_advanced_usage_note">Advanced Usage Note</h5>
<div class="paragraph">
<p>If you happen to be embedding your template directly in your script (as we did above) you have to be careful about backslash escaping. Because the template string itself will be parsed by Groovy before it is passed to the the templating framework, you have to escape any backslashes inside GString expressions or scriptlet <em>code</em> that are entered as part of a Groovy program. E.g. if we wanted quotes around <em>The Big Apple</em> above, we would use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">&lt;% print city == "New York" ? "\\"The Big Apple\\"" : city %&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Similarly, if we wanted a newline, we would use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">\\n</code></pre>
</div>
</div>
<div class="paragraph">
<p>in any GString expression or scriptlet 'code' that appears inside a Groovy script. A normal "<code>\n</code>" is fine within the static template text itself or if the entire template itself is in an external template file. Similarly, to represent an actual backslash in your text you would need</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">\\\\</code></pre>
</div>
</div>
<div class="paragraph">
<p>in an external file or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">\\\\</code></pre>
</div>
</div>
<div class="paragraph">
<p>in any GString expression or scriptlet 'code'. (Note: the necessity to have this extra slash may go away in a future version of Groovy if we can find an easy way to support such a change.)</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_gstringtemplateengine">4.8.4. GStringTemplateEngine</h4>
<div class="paragraph">
<p>As an example of using the <code>GStringTemplateEngine</code>, here is the example above done again (with a few changes to show some other options). First we will store the template in a file this time:</p>
</div>
<div class="listingblock">
<div class="title">test.template</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">Dear "$firstname $lastname",
So nice to meet you in &lt;% out &lt;&lt; (city == "New York" ? "\\"The Big Apple\\"" : city) %&gt;.
See you in ${month},
${signed}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we used <code>out</code> instead of <code>print</code> to support the streaming nature of <code>GStringTemplateEngine</code>. Because we have the template in a separate file, there is no need to escape the backslashes. Here is how we call it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def f = new File('test.template')
def engine = new groovy.text.GStringTemplateEngine()
def template = engine.createTemplate(f).make(binding)
println template.toString()</code></pre>
</div>
</div>
<div class="paragraph">
<p>and here is the output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Dear "Sam Pullara",
So nice to meet you in "The Big Apple".
See you in December,
Groovy-Dev</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_xmltemplateengine">4.8.5. XmlTemplateEngine</h4>
<div class="paragraph">
<p><code>XmlTemplateEngine</code> for use in templating scenarios where both the template source and the expected output are intended to be XML. Templates may use the normal <code>${expression}</code> and <code>$variable</code> notations to insert an arbitrary expression into the template. In addition, support is also provided for special tags: <code>&lt;gsp:scriptlet&gt;</code> (for inserting code fragments) and <code>&lt;gsp:expression&gt;</code> (for code fragments which produce output).</p>
</div>
<div class="paragraph">
<p>Comments and processing instructions will be removed as part of processing and special XML characters such as <code>&lt;</code>, <code>&gt;</code>, <code>"</code> and <code>'</code> will be escaped using the respective XML notation. The output will also be indented using standard XML pretty printing.</p>
</div>
<div class="paragraph">
<p>The xmlns namespace definition for gsp: tags will be removed but other namespace definitions will be preserved (but may change to an equivalent position within the XML tree).</p>
</div>
<div class="paragraph">
<p>Normally, the template source will be in a file but here is a simple example providing the XML template as a string:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def binding = [firstname: 'Jochen', lastname: 'Theodorou', nickname: 'blackdrag', salutation: 'Dear']
def engine = new groovy.text.XmlTemplateEngine()
def text = '''\
    &lt;document xmlns:gsp='http://groovy.codehaus.org/2005/gsp' xmlns:foo='baz' type='letter'&gt;
        &lt;gsp:scriptlet&gt;def greeting = "${salutation}est"&lt;/gsp:scriptlet&gt;
        &lt;gsp:expression&gt;greeting&lt;/gsp:expression&gt;
        &lt;foo:to&gt;$firstname "$nickname" $lastname&lt;/foo:to&gt;
        How are you today?
    &lt;/document&gt;
'''
def template = engine.createTemplate(text).make(binding)
println template.toString()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example will produce this output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;document type='letter'&gt;
  Dearest
  &lt;foo:to xmlns:foo='baz'&gt;
    Jochen &amp;quot;blackdrag&amp;quot; Theodorou
  &lt;/foo:to&gt;
  How are you today?
&lt;/document&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_markuptemplateengine">4.8.6. The MarkupTemplateEngine</h4>
<div class="paragraph">
<p>This template engine is a template engine primarily aimed at generating XML-like markup (XML, XHTML, HTML5, &#8230;), but that
can be used to generate any text based content. Unlike traditional template engines, this one relies on a DSL that uses the
builder syntax. Here is a sample template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">xmlDeclaration()
cars {
   cars.each {
       car(make: it.make, model: it.model)
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you feed it with the following model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">model = [cars: [new Car(make: 'Peugeot', model: '508'), new Car(make: 'Toyota', model: 'Prius')]]</code></pre>
</div>
</div>
<div class="paragraph">
<p>It would be rendered as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version='1.0'?&gt;
&lt;cars&gt;&lt;car make='Peugeot' model='508'/&gt;&lt;car make='Toyota' model='Prius'/&gt;&lt;/cars&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The key features of this template engine are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a <em>markup builder like</em> syntax</p>
</li>
<li>
<p>templates are compiled into bytecode</p>
</li>
<li>
<p>fast rendering</p>
</li>
<li>
<p>optional type checking of the model</p>
</li>
<li>
<p>includes</p>
</li>
<li>
<p>internationalization support</p>
</li>
<li>
<p>fragments/layouts</p>
</li>
</ul>
</div>
<div class="sect4">
<h5 id="_the_template_format">The template format</h5>
<div class="sect5">
<h6 id="_basics">Basics</h6>
<div class="paragraph">
<p>Templates consist of Groovy code. Let&#8217;s explore the first example more throughfully:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">xmlDeclaration()                                <i class="conum" data-value="1"></i><b>(1)</b>
cars {                                          <i class="conum" data-value="2"></i><b>(2)</b>
   cars.each {                                  <i class="conum" data-value="3"></i><b>(3)</b>
       car(make: it.make, model: it.model)      <i class="conum" data-value="4"></i><b>(4)</b>
   }                                            <i class="conum" data-value="5"></i><b>(5)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>renders the XML declaration string.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>opens a <code>cars</code> tag</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>cars</code> is a variable found in the <em>template model</em>, which is a list of <code>Car</code> instances</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>for each item, we create a <code>car</code> tag with the attributes from the <code>Car</code> instance</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>closes the <code>cars</code> tag</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see, regular Groovy code can be used in the template. Here, we are calling <code>each</code> on a list (retrieved from the model), allowing us to
render one <code>car</code> tag per entry.</p>
</div>
<div class="paragraph">
<p>In a similar fashion, rendering HTML code is as simple as this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">yieldUnescaped '&lt;!DOCTYPE html&gt;'                                                    <i class="conum" data-value="1"></i><b>(1)</b>
html(lang:'en') {                                                                   <i class="conum" data-value="2"></i><b>(2)</b>
    head {                                                                          <i class="conum" data-value="3"></i><b>(3)</b>
        meta('http-equiv':'"Content-Type" content="text/html; charset=utf-8"')      <i class="conum" data-value="4"></i><b>(4)</b>
        title('My page')                                                            <i class="conum" data-value="5"></i><b>(5)</b>
    }                                                                               <i class="conum" data-value="6"></i><b>(6)</b>
    body {                                                                          <i class="conum" data-value="7"></i><b>(7)</b>
        p('This is an example of HTML contents')                                    <i class="conum" data-value="8"></i><b>(8)</b>
    }                                                                               <i class="conum" data-value="9"></i><b>(9)</b>
}                                                                                   <i class="conum" data-value="10"></i><b>(10)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>renders the HTML doctype special tag</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>opens the <code>html</code> tag with an attribute</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>opens the <code>head</code> tag</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>renders a <code>meta</code> tag with one <code>http-equiv</code> attribute</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>renders the <code>title</code> tag</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>closes the <code>head</code> tag</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>opens the <code>body</code> tag</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>renders a <code>p</code> tag</td>
</tr>
<tr>
<td><i class="conum" data-value="9"></i><b>9</b></td>
<td>closes the <code>body</code> tag</td>
</tr>
<tr>
<td><i class="conum" data-value="10"></i><b>10</b></td>
<td>closes the <code>html</code> tag</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The output is straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;!DOCTYPE html&gt;&lt;html lang='en'&gt;&lt;head&gt;&lt;meta http-equiv='"Content-Type" content="text/html; charset=utf-8"'/&gt;&lt;title&gt;My page&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;This is an example of HTML contents&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
With some <a href="userGuides.html#markuptemplate-config">configuration</a>, you can have the output pretty printed, with newlines and indent automatically added.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_support_methods">Support methods</h6>
<div class="paragraph">
<p>In the previous example, the doctype declaration was rendered using the <code>yieldUnescaped</code> method. We have also seen the <code>xmlDeclaration</code> method.
The template engine provides several support methods that will help you render contents appropriately:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 16%;">
<col style="width: 33%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">yield</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Renders contents, but escapes it before rendering</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>Template</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">yield 'Some text with &lt;angle brackets&gt;'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">Some text with &amp;lt;angle brackets&amp;gt;</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">yieldUnescaped</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Renders raw contents. The argument is rendered as is, without escaping.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>Template</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">yieldUnescaped 'Some text with &lt;angle brackets&gt;'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">Some text with &lt;angle brackets&gt;</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xmlDeclaration</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Renders an XML declaration String. If the encoding is specified in the configuration, it is written in the declaration.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>Template</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">xmlDeclaration()</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;?xml version='1.0'?&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>TemplateConfiguration#getDeclarationEncoding</code> is not null:</p>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;?xml version='1.0' encoding='UTF-8'?&gt;</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">comment</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Renders raw contents inside an XML comment</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>Template</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">comment 'This is &lt;a href="foo.html"&gt;commented out&lt;/a&gt;'</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;!--This is &lt;a href="foo.html"&gt;commented out&lt;/a&gt;--&gt;</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">newLine</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Renders a new line. See also <code>TemplateConfiguration#setAutoNewLine</code> and <code>TemplateConfiguration#setNewLineString</code>.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>Template</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">p('text')
newLine()
p('text on new line')</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;p&gt;text&lt;/p&gt;
&lt;p&gt;text on new line&lt;/p&gt;</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">pi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Renders an XML processing instruction.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>Template</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">pi("xml-stylesheet":[href:"mystyle.css", type:"text/css"])</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml-stylesheet href='mystyle.css' type='text/css'?&gt;</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">tryEscape</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns an escaped string for an object, if it is a <code>String</code> (or any type derived from <code>CharSequence</code>). Otherwise returns the object itself.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>Template</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">yieldUnescaped tryEscape('Some text with &lt;angle brackets&gt;')</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">Some text with &amp;lt;angle brackets&amp;gt;</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="_includes">Includes</h6>
<div class="paragraph">
<p>The <code>MarkupTemplateEngine</code> supports inclusion of contents from another file. Included contents may be:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>another template</p>
</li>
<li>
<p>raw contents</p>
</li>
<li>
<p>contents to be escaped</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Including another template can be done using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">include template: 'other_template.tpl'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Including a file as raw contents, without escaping it, can be done like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">include unescaped: 'raw.txt'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Eventually, inclusion of text that should be escaped before rendering can be done using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">include escaped: 'to_be_escaped.txt'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, you can use the following helper methods instead:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>includeGroovy(&lt;name&gt;)</code> to include another template</p>
</li>
<li>
<p><code>includeEscaped(&lt;name&gt;)</code> to include another file with escaping</p>
</li>
<li>
<p><code>includeUnescaped(&lt;name&gt;)</code> to include another file without escaping</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Calling those methods instead of the <code>include xxx:</code> syntax can be useful if the name of the file to be included is dynamic (stored in a variable for example).
Files to be included (independently of their type, template or text) are found on <strong>classpath</strong>. This is one of the reasons why the <code>MarkupTemplateEngine</code> takes
an optional <code>ClassLoader</code> as constructor argument (the other reason being that you can include code referencing other classes in a template).</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t want your templates to be on classpath, the <code>MarkupTemplateEngine</code> accepts a convenient constructor that lets you define the directory where
templates are to be found.</p>
</div>
</div>
<div class="sect5">
<h6 id="_fragments">Fragments</h6>
<div class="paragraph">
<p>Fragments are nested templates. They can be used to provide improved composition in a single template. A fragment consists of
a string, the inner template, and a model, used to render this template. Consider the following template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">ul {
    pages.each {
        fragment "li(line)", line:it
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>fragment</code> element creates a nested template, and renders it with a model which is specific to this template. Here,
we have the <code>li(line)</code> fragment, where <code>line</code> is bound to <code>it</code>. Since <code>it</code> corresponds to the iteration of <code>pages</code>,
we will generate a single <code>li</code> element for each page in our model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;ul&gt;&lt;li&gt;Page 1&lt;/li&gt;&lt;li&gt;Page 2&lt;/li&gt;&lt;/ul&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fragments are interesting to factorize template elements. They come at the price of the compilation of a fragment per template, and they cannot
be externalized.</p>
</div>
</div>
<div class="sect5">
<h6 id="_layouts">Layouts</h6>
<div class="paragraph">
<p>Layouts, unlike fragments, refer to other templates. They can be used to compose templates and share common structures. This is often
interesting if you have, for example, a common HTML page setup, and that you only want to replace the body. This can be done easily
with a <em>layout</em>. First of all, you need to create a layout template:</p>
</div>
<div class="listingblock">
<div class="title">layout-main.tpl</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">html {
    head {
        title(title)                <i class="conum" data-value="1"></i><b>(1)</b>
    }
    body {
        bodyContents()              <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>the <code>title</code> variable (inside the title tag) is a layout variable</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>the <code>bodyContents</code> call will render the body</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then what you need is a template that includes the layout:</p>
</div>
<div id="example-layout-simple" class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">layout 'layout-main.tpl',                                   <i class="conum" data-value="1"></i><b>(1)</b>
    title: 'Layout example',                                <i class="conum" data-value="2"></i><b>(2)</b>
    bodyContents: contents { p('This is the body') }        <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>use the <code>main-layout.tpl</code> layout file</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>set the <code>title</code> variable</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>set the <code>bodyContents</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see, <code>bodyContents</code> will be rendered inside the layout, thanks to the <code>bodyContents()</code> call in the layout file. As
a result, the template will be rendered as this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;html&gt;&lt;head&gt;&lt;title&gt;Layout example&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;This is the body&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The call to the <code>contents</code> method is used to tell the template engine that the block of code is in fact a specification of a
template, instead of a helper function to be rendered directly. If you don&#8217;t add <code>contents</code> before your specification, then
the contents would be rendered, but you would also see a random string generated, corresponding to the result value of the block.</p>
</div>
<div class="paragraph">
<p>Layouts are a powerful way to share common elements across multiple
templates, without having to rewrite everything or use includes.</p>
</div>
<div class="paragraph">
<p>Layouts use, by default, a model which is independent from the model of the page where they are used. It is however possible
to make them inherit from the parent model. Imagine that the model is defined like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">model = new HashMap&lt;String,Object&gt;();
model.put('title','Title from main model');</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the following template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">layout 'layout-main.tpl', true,                             <i class="conum" data-value="1"></i><b>(1)</b>
    bodyContents: contents { p('This is the body') }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>note the use of <code>true</code> to enable model inheritance</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>then it is not necessary to pass the <code>title</code> value to the layout as in the <a href="userGuides.html#example-layout-simple">previous example</a>. The result will be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;html&gt;&lt;head&gt;&lt;title&gt;Title from main model&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;This is the body&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>But it is also possible to override a value from the parent model:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">layout 'layout-main.tpl', true,                             <i class="conum" data-value="1"></i><b>(1)</b>
    title: 'Overriden title',                               <i class="conum" data-value="2"></i><b>(2)</b>
    bodyContents: contents { p('This is the body') }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>true</code> means inherit from the parent model</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>but <code>title</code> is overriden</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>then the output will be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;html&gt;&lt;head&gt;&lt;title&gt;Overriden title&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;This is the body&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_rendering_contents">Rendering contents</h5>
<div class="sect5">
<h6 id="_creation_of_a_template_engine">Creation of a template engine</h6>
<div class="paragraph">
<p>On the server side, rendering templates require an instance of <code>groovy.text.markup.MarkupTemplateEngine</code> and a
<code>groovy.text.markup.TemplateConfiguration</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">TemplateConfiguration config = new TemplateConfiguration();         <i class="conum" data-value="1"></i><b>(1)</b>
MarkupTemplateEngine engine = new MarkupTemplateEngine(config);     <i class="conum" data-value="2"></i><b>(2)</b>
Template template = engine.createTemplate("p('test template')");    <i class="conum" data-value="3"></i><b>(3)</b>
Map&lt;String, Object&gt; model = new HashMap&lt;&gt;();                        <i class="conum" data-value="4"></i><b>(4)</b>
Writable output = template.make(model);                             <i class="conum" data-value="5"></i><b>(5)</b>
output.writeTo(writer);                                             <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>creates a template configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>creates a template engine with this configuration</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>creates a template instance from a <code>String</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>creates a model to be used in the template</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>bind the model to the template instance</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>render output</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>There are several possible options to parse templates:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>from a <code>String</code>, using <code>createTemplate(String)</code></p>
</li>
<li>
<p>from a <code>Reader</code>, using <code>createTemplate(Reader)</code></p>
</li>
<li>
<p>from a <code>URL</code>, using <code>createTemplate(URL)</code></p>
</li>
<li>
<p>given a template name, using <code>createTemplateByPath(String)</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The last version should in general be preferred:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">Template template = engine.createTemplateByPath("main.tpl");
Writable output = template.make(model);
output.writeTo(writer);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="markuptemplate-config">Configuration options</h6>
<div class="paragraph">
<p>The behavior of the engine can be tweaked with several configuration options accessible through the <code>TemplateConfiguration</code> class:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 100%;">
<colgroup>
<col style="width: 14%;">
<col style="width: 14%;">
<col style="width: 28%;">
<col style="width: 42%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Option</th>
<th class="tableblock halign-left valign-top">Default value</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">declarationEncoding</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">null</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Determines the value of the encoding to be written when <code>xmlDeclaration</code> is called. It does <strong>not</strong> influence the writer you are using as output.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>Template</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">xmlDeclaration()</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;?xml version='1.0'?&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>TemplateConfiguration#getDeclarationEncoding</code> is not null:</p>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;?xml version='1.0' encoding='UTF-8'?&gt;</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">expandEmptyElements</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, empty tags are rendered in their expanded form.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>Template</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">p()</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;p/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>expandEmptyElements</code> is true:</p>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;p&gt;&lt;/p&gt;</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">useDoubleQuotes</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, use double quotes for attributes instead of simple quotes</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>Template</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">tag(attr:'value')</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;tag attr='value'/&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>useDoubleQuotes</code> is true:</p>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;tag attr="value"/&gt;</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">newLineString</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">System default (system property <code>line.separator</code>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Allows to choose what string is used when a new line is rendered</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p><strong>Template</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">p('foo')
newLine()
p('baz')</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>newLineString='BAR'</code>:</p>
</div>
<div class="paragraph">
<p><strong>Output</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;p&gt;foo&lt;/p&gt;BAR&lt;p&gt;baz&lt;/p&gt;</code></pre>
</div>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">autoEscape</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, variables from models are automatically escaped before rendering.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>See <a href="userGuides.html#markuptemplate-autoescape">the auto escape section</a></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">autoIndent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, performs automatic indentation after new lines</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>See <a href="userGuides.html#markuptemplate-autoformat">the auto formatting section</a></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">autoIndentString</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">four (4) spaces</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The string to be used as indent.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>See <a href="userGuides.html#markuptemplate-autoformat">the auto formatting section</a></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">autoNewLine</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If true, performs automatic insertion of new lines</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>See <a href="userGuides.html#markuptemplate-autoformat">the auto formatting section</a></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">baseTemplateClass</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>groovy.text.markup.BaseTemplate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the super class of compiled templates. This can be used to provide application specific templates.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>See <a href="userGuides.html#markuptemplate-basetemplate">the custom templates section</a></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">locale</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Default locale</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sets the default locale for templates.</p></td>
<td class="tableblock halign-left valign-top"><div><div class="paragraph">
<p>See <a href="userGuides.html#markuptemplate-i18n">the internationalization section</a></p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
Once the template engine has been created, it is <strong>unsafe</strong> to change the configuration.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="markuptemplate-autoformat">Automatic formatting</h6>
<div class="paragraph">
<p>By default, the template engine will render output without any specific formatting. Some <a href="userGuides.html#markuptemplate-config">configuration options</a> can improve the situation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>autoIndent</code> is responsible for auto-indenting after a new line is inserted</p>
</li>
<li>
<p><code>autoNewLine</code> is responsible for automatically inserting new lines based on the original formatting of the template source</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In general, it is recommanded to set both <code>autoIndent</code> and <code>autoNewLine</code> to true if you want human-readable, pretty printed, output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">config.setAutoNewLine(true);
config.setAutoIndent(true);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the following template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">html {
    head {
        title('Title')
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will now be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Title&lt;/title&gt;
    &lt;/head&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can slightly change the template so that the <code>title</code> intruction is found on the same line as the <code>head</code> one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">html {
    head { title('Title')
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the output will reflect that:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;html&gt;
    &lt;head&gt;&lt;title&gt;Title&lt;/title&gt;
    &lt;/head&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>New lines are <strong>only</strong> inserted where curly braces for tags are found, and the insertion corresponds to where the nested content is found. This means that
tags in the body of another tag will <strong>not</strong> trigger new lines unless they use curly braces themselves:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">html {
    head {
        meta(attr:'value')          <i class="conum" data-value="1"></i><b>(1)</b>
        title('Title')              <i class="conum" data-value="2"></i><b>(2)</b>
        newLine()                   <i class="conum" data-value="3"></i><b>(3)</b>
        meta(attr:'value2')         <i class="conum" data-value="4"></i><b>(4)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>a new line is inserted because <code>meta</code> is not on the same line as <code>head</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>no new line is inserted, because we&#8217;re on the same depth as the previous tag</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>we can force rendering of a new line by explicitly calling <code>newLine</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>and this tag will be rendered on a separate line</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This time, the output will be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;html&gt;
    &lt;head&gt;
        &lt;meta attr='value'/&gt;&lt;title&gt;Title&lt;/title&gt;
        &lt;meta attr='value2'/&gt;
    &lt;/head&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the renderer uses four(4) spaces as indent, but you can change it by setting the <code>TemplateConfiguration#autoIndentString</code> property.</p>
</div>
</div>
<div class="sect5">
<h6 id="markuptemplate-autoescape">Automatic escaping</h6>
<div class="paragraph">
<p>By default, contents which is read from the model is rendered <strong>as is</strong>. If this contents comes from user input, it can be sensible, and you might
want to escape it by default, for example to avoid XSS injection. For that, the template configuration provides an option which will automatically
escape objects from the model, as long as they inherit from <code>CharSequence</code> (typically, `String`s).</p>
</div>
<div class="paragraph">
<p>Let&#8217;s imagine the following setup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">config.setAutoEscape(false);
model = new HashMap&lt;String,Object&gt;();
model.put("unsafeContents", "I am an &lt;html&gt; hacker.");</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the following template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">html {
    body {
        div(unsafeContents)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you wouldn&#8217;t want the HTML from <code>unsafeContents</code> to be rendered as is, because of potential security issues:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;html&gt;&lt;body&gt;&lt;div&gt;I am an &lt;html&gt; hacker.&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Automatic escaping will fix this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">config.setAutoEscape(true);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now the output is properly escaped:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;html&gt;&lt;body&gt;&lt;div&gt;I am an &amp;lt;html&amp;gt; hacker.&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that using automatic escaping doesn&#8217;t prevent you from including unescaped contents from the model. To do this, your template should then explicitly
mention that a model variable should not be escaped by prefixing it with <code>unescaped.</code>, like in this example:</p>
</div>
<div class="listingblock">
<div class="title">Explicit bypass of automatic escaping</div>
<div class="content">
<pre class="prettyprint"><code class="html language-html">html {
    body {
        div(unescaped.unsafeContents)
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="markuptemplate-gotchas">Common gotchas</h6>
<div class="sect6">
<h7 id="_strings_containing_markup">Strings containing markup</h7>
<div class="paragraph">
<p>Say that you want to generate a <code>&lt;p&gt;</code> tag which contains a string containing markup:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">p {
    yield "This is a "
    a(href:'target.html', "link")
    yield " to another page"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and generates:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="html language-html">&lt;p&gt;This is a &lt;a href='target.html'&gt;link&lt;/a&gt; to another page&lt;/p&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Can&#8217;t this be written shorter? A naive alternative would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">p {
    yield "This is a ${a(href:'target.html', "link")} to another page"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>but the result will not look as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">&lt;p&gt;&lt;a href='target.html'&gt;link&lt;/a&gt;This is a  to another page&lt;/p&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The reason is that the markup template engine is a <em>streaming</em> engine. In the original version, the first <code>yield</code> call
generates a string which is streamed to the output, then the <code>a</code> link is generated and streamed, and then the last <code>yield</code>
call is streamed, leading in an execution <strong>in order</strong>. But with the string version above, the order of execution is different:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>the <code>yield</code> call requires an argument, a <em>string</em></p>
</li>
<li>
<p>that arguments needs to be evaluated <em>before</em> the <em>yield</em> call is generated</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>so evaluating the string leads to an execution of the <code>a(href:...)</code> call <strong>before</strong> <code>yield</code> is itself called. This is not
what you want to do. Instead, you want to generate a <em>string</em> which contains markup, which is then passed to the <code>yield</code>
call. This can be done this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">p("This is a ${stringOf {a(href:'target.html', "link")}} to another page")</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the <code>stringOf</code> call, which basically tells the markup template engine that the underlying markup needs to be rendered
separately and exported as a string. Note that for simple expressions, <code>stringOf</code> can be replaced by an alternate tag
notation that starts with a <em>dollar</em> sign:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">p("This is a ${$a(href:'target.html', "link")} to another page")</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="icon-tip" title="Tip"></i>
</td>
<td class="content">
It is worth noting that using <code>stringOf</code> or the special <code>$tag</code> notation triggers the creation of a distinct string writer
which is then used to render the markup. It is slower than using the version with calls to <code>yield</code> which perform direct
streaming of the markup instead.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect5">
<h6 id="markuptemplate-i18n">Internationalization</h6>
<div class="paragraph">
<p>The template engine has native support for internationalization. For that, when you create the <code>TemplateConfiguration</code>, you can provide
a <code>Locale</code> which is the default locale to be used for templates. Each template may have different versions, one for each locale. The
name of the template makes the difference:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>file.tpl</code>: default template file</p>
</li>
<li>
<p><code>file_fr_FR.tpl</code>: french version of the template</p>
</li>
<li>
<p><code>file_en_US.tpl</code>: american english version of the template</p>
</li>
<li>
<p>&#8230;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>When a template is rendered or included, then:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>if the template name or include name <strong>explicitly</strong> sets a locale, the <strong>specific</strong> version is included, or the default version if not found</p>
</li>
<li>
<p>if the template name doesn&#8217;t include a locale, the version for the <code>TemplateConfiguration</code> locale is used, or the default version if not found</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, imagine the default locale is set to <code>Locale.ENGLISH</code> and that the main template includes:</p>
</div>
<div class="listingblock">
<div class="title">Use an explicit locale in include</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">include template: 'locale_include_fr_FR.tpl'</code></pre>
</div>
</div>
<div class="paragraph">
<p>then the template is rendered using the specific template:</p>
</div>
<div class="listingblock">
<div class="title">Bypass the template configuration</div>
<div class="content">
<pre class="prettyprint"><code class="html language-html">Texte en français</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using an include without specifying a locale will make the template engine look for a template with the configured locale, and if not, fallback to the default, like here:</p>
</div>
<div class="listingblock">
<div class="title">Don&#8217;t use a locale in include</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">include template: 'locale_include.tpl'</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Fallback to the default template</div>
<div class="content">
<pre class="prettyprint"><code class="html language-html">Default text</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, changing the default locale of the template engine to <code>Locale.FRANCE</code> will change the output, because the template engine will now look for a file
with the <code>fr_FR</code> locale:</p>
</div>
<div class="listingblock">
<div class="title">Don&#8217;t fallback to the default template because a locale specific template was found</div>
<div class="content">
<pre class="prettyprint"><code class="html language-html">Texte en français</code></pre>
</div>
</div>
<div class="paragraph">
<p>This strategy lets you translate your templates one by one, by relying on default templates, for which no locale is set in the file name.</p>
</div>
</div>
<div class="sect5">
<h6 id="markuptemplate-basetemplate">Custom template classes</h6>
<div class="paragraph">
<p>By default, templates created inherit the <code>groovy.text.markup.BaseTemplate</code> class. It may be interesting for an application to provide a different
template class, for example to provide additional helper methods which are aware of the application, or customized rendering primitives (for HTML,
for example).</p>
</div>
<div class="paragraph">
<p>The template engine provides this ability by setting an alternative <code>baseTemplateClass</code> in the <code>TemplateConfiguration</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">config.setBaseTemplateClass(MyTemplate.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The custom base class has to extend <code>BaseClass</code> like in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">public abstract class MyTemplate extends BaseTemplate {
    private List&lt;Module&gt; modules
    public MyTemplate(
            final MarkupTemplateEngine templateEngine,
            final Map model,
            final Map&lt;String, String&gt; modelTypes,
            final TemplateConfiguration configuration) {
        super(templateEngine, model, modelTypes, configuration)
    }

    List&lt;Module&gt; getModules() {
        return modules
    }

    void setModules(final List&lt;Module&gt; modules) {
        this.modules = modules
    }

    boolean hasModule(String name) {
        modules?.any { it.name == name }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows a class which provides an additional method named <code>hasModule</code>, which can then be used directly in the template:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">if (hasModule('foo')) {
    p 'Found module [foo]'
} else {
    p 'Module [foo] not found'
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_type_checked_templates">Type checked templates</h5>
<div class="sect5">
<h6 id="_optional_type_checking">Optional type checking</h6>
<div class="paragraph">
<p>Even if templates are not type checked, they are statically compiled. This means that once the templates are compiled, performance should be very good. For some
applications, it might be good to make sure that templates are valid before they are actually rendered. This means failing template compilation, for example, if
a method on a model variable doesn&#8217;t exist.</p>
</div>
<div class="paragraph">
<p>The <code>MarkupTemplateEngine</code> provides such a facility. Templates can be optionally type checked. For that, the developer must provide additional information at
template creation time, which is the types of the variables found in the model. Imagine a model exposing a list of pages, where a page is defined as:</p>
</div>
<div class="listingblock">
<div class="title">Page.groovy</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">public class Page {

    Long id
    String title
    String body
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then a list of pages can be exposed in the model, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">Page p = new Page();
p.setTitle("Sample page");
p.setBody("Page body");
List&lt;Page&gt; pages = new LinkedList&lt;&gt;();
pages.add(p);
model = new HashMap&lt;String,Object&gt;();
model.put("pages", pages);</code></pre>
</div>
</div>
<div class="paragraph">
<p>A template can use it easily:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">pages.each { page -&gt;                    <i class="conum" data-value="1"></i><b>(1)</b>
    p("Page title: $page.title")        <i class="conum" data-value="2"></i><b>(2)</b>
    p(page.text)                        <i class="conum" data-value="3"></i><b>(3)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>iterate on pages from the model</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>page.title</code> is valid</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><code>page.text</code> is <strong>not</strong> (should be <code>page.body</code>)</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Without type checking, the compilation of the template succeeds, because the template engine doesn&#8217;t know about the model until a page
is actually rendered. This means that the problem would only surface at runtime, once the page is rendered:</p>
</div>
<div class="listingblock">
<div class="title">Runtime error</div>
<div class="content">
<pre>No such property: text</pre>
</div>
</div>
<div class="paragraph">
<p>In some situations, this can be complicated to sort out or even notice. By declaring the type of the <code>pages</code> to the template engine, we&#8217;re now capable of failing at compile time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">modelTypes = new HashMap&lt;String,String&gt;();                                          <i class="conum" data-value="1"></i><b>(1)</b>
modelTypes.put("pages", "List&lt;Page&gt;");                                              <i class="conum" data-value="2"></i><b>(2)</b>
Template template = engine.createTypeCheckedModelTemplate("main.tpl", modelTypes)   <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>create a map which will hold the model types</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>declare the type of the <code>pages</code> variables (note the use of a string for the type)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>use <code>createTypeCheckedModelTemplate</code> instead of <code>createTemplate</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This time, when the template is compiled at the last line, an error occurs:</p>
</div>
<div class="listingblock">
<div class="title">Template compilation time error</div>
<div class="content">
<pre>[Static type checking] - No such property: text for class: Page</pre>
</div>
</div>
<div class="paragraph">
<p>This means that you don&#8217;t need to wait for the page to be rendered to see an error. The use of <code>createTypeCheckedModelTemplate</code> is mandatory.</p>
</div>
</div>
<div class="sect5">
<h6 id="_alternative_declaration_of_types">Alternative declaration of types</h6>
<div class="paragraph">
<p>Alternatively, if the developer is also the one who writes the templates, it is possible to declare the types of the expected variables
directly in the template. In this case, even if you call <code>createTemplate</code>, it will be type checked:</p>
</div>
<div class="listingblock">
<div class="title">Inline declaration of types</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">modelTypes = {                          <i class="conum" data-value="1"></i><b>(1)</b>
    List&lt;Page&gt; pages                    <i class="conum" data-value="2"></i><b>(2)</b>
}

pages.each { page -&gt;
    p("Page title: $page.title")
    p(page.text)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>types need to be declared in the <code>modelTypes</code> header</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>declare one variable per object in the model</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_performance_of_type_checked_templates">Performance of type checked templates</h6>
<div class="paragraph">
<p>An additional interest of using type checked models is that performance should improve. By telling the type checker what are the expected types,
you also let the compiler generate optimized code for that, so if you are looking for the best performance, consider using type checked templates.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_other_solutions">4.8.7. Other solutions</h4>
<div class="paragraph">
<p>Also, there are other templating solutions that can be used along with Groovy, such as <a href="http://freemarker.org">FreeMarker</a>, <a href="http://velocity.apache.org">Velocity</a>, <a href="http://stringtemplate.org">StringTemplate</a> and others.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_servlet_support_tbd">4.9. Servlet support (TBD)</h3>

</div>
<div class="sect2">
<h3 id="_integrating_groovy_in_a_java_application">4.10. Integrating Groovy in a Java application</h3>
<div class="sect3">
<h4 id="_groovy_integration_mechanisms">4.10.1. Groovy integration mechanisms</h4>
<div class="paragraph">
<p>The Groovy language proposes several ways to integrate itself into applications (Java or even Groovy) at runtime, from
the most basic, simple code execution to the most complete, integrating caching and compiler customization.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="icon-tip" title="Tip"></i>
</td>
<td class="content">
All the examples written in this section are using Groovy, but the same integration mechanisms can be used from
Java.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="integ-eval">Eval</h5>
<div class="paragraph">
<p>The <code>groovy.util.Eval</code> class is the simplest way to execute Groovy dynamically at runtime. This can be done by calling the <code>me</code>
method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.util.Eval

assert Eval.me('33*3') == 99
assert Eval.me('"foo".toUpperCase()') == 'FOO'</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Eval</code> supports multiple variants that accept parameters for simple evaluation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">assert Eval.x(4, '2*x') == 8                <i class="conum" data-value="1"></i><b>(1)</b>
assert Eval.me('k', 4, '2*k') == 8          <i class="conum" data-value="2"></i><b>(2)</b>
assert Eval.xy(4, 5, 'x*y') == 20           <i class="conum" data-value="3"></i><b>(3)</b>
assert Eval.xyz(4, 5, 6, 'x*y+z') == 26     <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Simple evaluation with one bound parameter named <code>x</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Same evaluation, with a custom bound parameter named <code>k</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Simple evaluation with two bound parameters named <code>x</code> and <code>y</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Simple evaluation with three bound parameters named <code>x</code>, <code>y</code> and <code>z</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>Eval</code> class makes it very easy to evaluate simple scripts, but doesn&#8217;t scale: there is no caching of the script, and
it isn&#8217;t meant to evaluate more than one liners.</p>
</div>
</div>
<div class="sect4">
<h5 id="integ-groovyshell">GroovyShell</h5>
<div class="sect5">
<h6 id="_multiple_sources">Multiple sources</h6>
<div class="paragraph">
<p>The <code>groovy.lang.GroovyShell</code> class is the preferred way to evaluate scripts with the ability to cache the resulting
script instance. Although the <code>Eval</code> class returns the result of the execution of the compiled script, the <code>GroovyShell</code>
class offers more options.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def shell = new GroovyShell()                           <i class="conum" data-value="1"></i><b>(1)</b>
def result = shell.evaluate '3*5'                       <i class="conum" data-value="2"></i><b>(2)</b>
def result2 = shell.evaluate(new StringReader('3*5'))   <i class="conum" data-value="3"></i><b>(3)</b>
assert result == result2
def script = shell.parse '3*5'                          <i class="conum" data-value="4"></i><b>(4)</b>
assert script instanceof groovy.lang.Script
assert script.run() == 15                               <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>create a new <code>GroovyShell</code> instance</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>can be used as <code>Eval</code> with direct execution of the code</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>can read from multiple sources (<code>String</code>, <code>Reader</code>, <code>File</code>, <code>InputStream</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>can defer execution of the script. <code>parse</code> returns a <code>Script</code> instance</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td><code>Script</code> defines a <code>run</code> method</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_sharing_data_between_a_script_and_the_application">Sharing data between a script and the application</h6>
<div class="paragraph">
<p>It is possible to share data between the application and the script using a <code>groovy.lang.Binding</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def sharedData = new Binding()                          <i class="conum" data-value="1"></i><b>(1)</b>
def shell = new GroovyShell(sharedData)                 <i class="conum" data-value="2"></i><b>(2)</b>
def now = new Date()
sharedData.setProperty('text', 'I am shared data!')     <i class="conum" data-value="3"></i><b>(3)</b>
sharedData.setProperty('date', now)                     <i class="conum" data-value="4"></i><b>(4)</b>

String result = shell.evaluate('"At $date, $text"')     <i class="conum" data-value="5"></i><b>(5)</b>

assert result == "At $now, I am shared data!"</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>create a new <code>Binding</code> that will contain shared data</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>create a <code>GroovyShell</code> using this shared data</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>add a string to the binding</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>add a date to the binding (you are not limited to simple types)</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>evaluate the script</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Note that it is also possible to write from the script into the binding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def sharedData = new Binding()                          <i class="conum" data-value="1"></i><b>(1)</b>
def shell = new GroovyShell(sharedData)                 <i class="conum" data-value="2"></i><b>(2)</b>

shell.evaluate('foo=123')                               <i class="conum" data-value="3"></i><b>(3)</b>

assert sharedData.getProperty('foo') == 123             <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>create a new <code>Binding</code> instance</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>create a new <code>GroovyShell</code> using that shared data</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>use an <strong>undeclared</strong> variable to store the result into the binding</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>read the result from the caller</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is important to understand that you need to use an undeclared variable if you want to write into the binding. Using
<code>def</code> or an <code>explicit</code> type like in the example below would fail because you would then create a <em>local variable</em>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def sharedData = new Binding()
def shell = new GroovyShell(sharedData)

shell.evaluate('int foo=123')

try {
    assert sharedData.getProperty('foo')
} catch (MissingPropertyException e) {
    println "foo is defined as a local variable"
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
You must be very careful when using shared data in a multithreaded environment. The <code>Binding</code> instance that
you pass to <code>GroovyShell</code> is <strong>not</strong> thread safe, and shared by all scripts.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is possible to work around the shared instance of <code>Binding</code> by leveraging the <code>Script</code> instance which is returned
by <code>parse</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def shell = new GroovyShell()

def b1 = new Binding(x:3)                       <i class="conum" data-value="1"></i><b>(1)</b>
def b2 = new Binding(x:4)                       <i class="conum" data-value="2"></i><b>(2)</b>
def script = shell.parse('x = 2*x')
script.binding = b1
script.run()
script.binding = b2
script.run()
assert b1.getProperty('x') == 6
assert b2.getProperty('x') == 8
assert b1 != b2</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>will store the <code>x</code> variable inside <code>b1</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>will store the <code>x</code> variable inside <code>b2</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>However, you must be aware that you are still sharing the <strong>same instance</strong> of a script. So this technique cannot be
used if you have two threads working on the same script. In that case, you must make sure of creating two distinct
script instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def shell = new GroovyShell()

def b1 = new Binding(x:3)
def b2 = new Binding(x:4)
def script1 = shell.parse('x = 2*x')            <i class="conum" data-value="1"></i><b>(1)</b>
def script2 = shell.parse('x = 2*x')            <i class="conum" data-value="2"></i><b>(2)</b>
assert script1 != script2
script1.binding = b1                            <i class="conum" data-value="3"></i><b>(3)</b>
script2.binding = b2                            <i class="conum" data-value="4"></i><b>(4)</b>
def t1 = Thread.start { script1.run() }         <i class="conum" data-value="5"></i><b>(5)</b>
def t2 = Thread.start { script2.run() }         <i class="conum" data-value="6"></i><b>(6)</b>
[t1,t2]*.join()                                 <i class="conum" data-value="7"></i><b>(7)</b>
assert b1.getProperty('x') == 6
assert b2.getProperty('x') == 8
assert b1 != b2</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>create an instance of script for thread 1</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>create an instance of script for thread 2</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>assign first binding to script 1</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>assign second binding to script 2</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>start first script in a separate thread</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>start second script in a separate thread</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>wait for completion</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In case you need thread safety like here, it is more advisable to use the <a href="userGuides.html#groovyclassloader">GroovyClassLoader</a>
directly instead.</p>
</div>
</div>
<div class="sect5">
<h6 id="_custom_script_class">Custom script class</h6>
<div class="paragraph">
<p>We have seen that the <code>parse</code> method returns an instance of <code>groovy.lang.Script</code>, but it is possible to use a custom
class, given that it extends <code>Script</code> itself. It can be used to provide additional behavior to the script like in
the example below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">abstract class MyScript extends Script {
    String name

    String greet() {
        "Hello, $name!"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The custom class defines a property called <code>name</code> and a new method called <code>greet</code>. This class can be used as the script
base class by using a custom configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.codehaus.groovy.control.CompilerConfiguration

def config = new CompilerConfiguration()                                    <i class="conum" data-value="1"></i><b>(1)</b>
config.scriptBaseClass = 'MyScript'                                         <i class="conum" data-value="2"></i><b>(2)</b>

def shell = new GroovyShell(this.class.classLoader, new Binding(), config)  <i class="conum" data-value="3"></i><b>(3)</b>
def script = shell.parse('greet()')                                         <i class="conum" data-value="4"></i><b>(4)</b>
assert script instanceof MyScript
script.setName('Michel')
assert script.run() == 'Hello, Michel!'</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>create a <code>CompilerConfiguration</code> instance</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>instruct it to use <code>MyScript</code> as the base class for scripts</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>then use the compiler configuration when you create the shell</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>the script now has access to the new method <code>greet</code></td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
You are not limited to the sole <em>scriptBaseClass</em> configuration. You can use any of the compiler configuration
tweaks, including the <a href="userGuides.html#compilation-customizers">compilation customizers</a>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect4">
<h5 id="groovyclassloader">GroovyClassLoader</h5>
<div class="paragraph">
<p>In the <a href="userGuides.html#integ-groovyshell">previous section</a>, we have shown that <code>GroovyShell</code> was an easy tool to execute scripts, but
it makes it complicated to compile anything but scripts. Internally, it makes use of the <code>groovy.lang.GroovyClassLoader</code>,
which is at the heart of the compilation and loading of classes at runtime.</p>
</div>
<div class="paragraph">
<p>By leveraging the <code>GroovyClassLoader</code> instead of <code>GroovyShell</code>, you will be able to load classes, instead of instances
of scripts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.lang.GroovyClassLoader

def gcl = new GroovyClassLoader()                                           <i class="conum" data-value="1"></i><b>(1)</b>
def clazz = gcl.parseClass('class Foo { void doIt() { println "ok" } }')    <i class="conum" data-value="2"></i><b>(2)</b>
assert clazz.name == 'Foo'                                                  <i class="conum" data-value="3"></i><b>(3)</b>
def o = clazz.newInstance()                                                 <i class="conum" data-value="4"></i><b>(4)</b>
o.doIt()                                                                    <i class="conum" data-value="5"></i><b>(5)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>create a new <code>GroovyClassLoader</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td><code>parseClass</code> will return an instance of <code>Class</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>you can check that the class which is returns is really the one defined in the script</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>and you can create a new instance of the class, which is not a script</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>then call any method on it</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
A GroovyClassLoader keeps a reference of all the classes it created, so it is easy to create a memory leak. In
particular, if you execute the same script twice, if it is a String, then you obtain two distinct classes!
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.lang.GroovyClassLoader

def gcl = new GroovyClassLoader()
def clazz1 = gcl.parseClass('class Foo { }')                                <i class="conum" data-value="1"></i><b>(1)</b>
def clazz2 = gcl.parseClass('class Foo { }')                                <i class="conum" data-value="2"></i><b>(2)</b>
assert clazz1.name == 'Foo'                                                 <i class="conum" data-value="3"></i><b>(3)</b>
assert clazz2.name == 'Foo'
assert clazz1 != clazz2                                                     <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>dynamically create a class named "Foo"</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>create an identical looking class, using a separate <code>parseClass</code> call</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>make sure both classes have the same name</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>but they are actually different!</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The reason is that a <code>GroovyClassLoader</code> doesn&#8217;t keep track of the source text. If you want to have the same instance,
then the source <strong>must</strong> be a file, like in this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def gcl = new GroovyClassLoader()
def clazz1 = gcl.parseClass(file)                                           <i class="conum" data-value="1"></i><b>(1)</b>
def clazz2 = gcl.parseClass(new File(file.absolutePath))                    <i class="conum" data-value="2"></i><b>(2)</b>
assert clazz1.name == 'Foo'                                                 <i class="conum" data-value="3"></i><b>(3)</b>
assert clazz2.name == 'Foo'
assert clazz1 == clazz2                                                     <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>parse a class from a <code>File</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>parse a class from a distinct file instance, but pointing to the same physical file</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>make sure our classes have the same name</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>but now, they are the same instance</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Using a <code>File</code> as input, the <code>GroovyClassLoader</code> is capable of <strong>caching</strong> the generated class file, which avoids
creating multiple classes at runtime for the same source.</p>
</div>
</div>
<div class="sect4">
<h5 id="_groovyscriptengine">GroovyScriptEngine</h5>
<div class="paragraph">
<p>The <code>groovy.util.GroovyScriptEngine</code> class provides a flexible foundation for applications which rely on script
reloading and script dependencies. While <code>GroovyShell</code> focuses on standalone <code>Script`s and `GroovyClassLoader</code> handles
dynamic compilation and loading of any Groovy class, the <code>GroovyScriptEngine</code> will add a layer on top of <code>GroovyClassLoader</code>
to handle both script dependencies and reloading.</p>
</div>
<div class="paragraph">
<p>To illustrate this, we will create a script engine and execute code in an infinite loop. First of all, you need to create
a directory with the following script inside:</p>
</div>
<div class="listingblock">
<div class="title">ReloadingTest.groovy</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Greeter {
    String sayHello() {
        def greet = "Hello, world!"
        greet
    }
}

new Greeter()</code></pre>
</div>
</div>
<div class="paragraph">
<p>then you can execute this code using a <code>GroovyScriptEngine</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def binding = new Binding()
def engine = new GroovyScriptEngine([tmpDir.toURI().toURL()] as URL[])          <i class="conum" data-value="1"></i><b>(1)</b>

while (true) {
    def greeter = engine.run('ReloadingTest.groovy', binding)                   <i class="conum" data-value="2"></i><b>(2)</b>
    println greeter.sayHello()                                                  <i class="conum" data-value="3"></i><b>(3)</b>
    Thread.sleep(1000)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>create a script engine which will look for sources into our source directory</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>execute the script, which will return an instance of <code>Greeter</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>print the greeting message</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>At this point, you should see a message printed every second:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Hello, world!
Hello, world!
...</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Without</strong> interrupting the script execution, now replace the contents of the <code>ReloadingTest</code> file with:</p>
</div>
<div class="listingblock">
<div class="title">ReloadingTest.groovy</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Greeter {
    String sayHello() {
        def greet = "Hello, Groovy!"
        greet
    }
}


new Greeter()</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the message should change to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Hello, world!
...
Hello, Groovy!
Hello, Groovy!
...</pre>
</div>
</div>
<div class="paragraph">
<p>But it is also possible to have a dependency on another script. To illustrate this, create the following file into
the same directory, without interrupting the executing script:</p>
</div>
<div class="listingblock">
<div class="title">Depencency.groovy</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Dependency {
    String message = 'Hello, dependency 1'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>and update the <code>ReloadingTest</code> script like this:</p>
</div>
<div class="listingblock">
<div class="title">ReloadingTest.groovy</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import Dependency

class Greeter {
    String sayHello() {
        def greet = new Dependency().message
        greet
    }
}

new Greeter()</code></pre>
</div>
</div>
<div class="paragraph">
<p>And this time, the message should change to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Hello, Groovy!
...
Hello, dependency 1!
Hello, dependency 1!
...</pre>
</div>
</div>
<div class="paragraph">
<p>And as a last test, you can update the <code>Dependency.groovy</code> file without touching the <code>ReloadingTest</code> file:</p>
</div>
<div class="listingblock">
<div class="title">Depencency.groovy</div>
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Dependency {
    String message = 'Hello, dependency 2'
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And you should observe that the dependent file was reloaded:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Hello, dependency 1!
...
Hello, dependency 2!
Hello, dependency 2!</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_compilationunit">CompilationUnit</h5>
<div class="paragraph">
<p>Ultimately, it is possible to perform more operations during compilation by relying directly on the
<code>org.codehaus.groovy.control.CompilationUnit</code> class. This class is responsible for determining the various steps of
compilation and would let you introduce new steps or even stop compilation at various phases. This is for example how
stub generation is done, for the joint compiler.</p>
</div>
<div class="paragraph">
<p>However, overriding <code>CompilationUnit</code> is not recommanded and should only be done if no other standard solution works.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_bean_scripting_framework">4.10.2. Bean Scripting Framework</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
The <a href="http://commons.apache.org/proper/commons-bsf/">Bean Scripting Framework</a> is an attempt to create an API
to allow calling scripting languages from Java. It hasn&#8217;t been updated for long and abandonned in favor of the
standard <a href="userGuides.html#jsr223">JSR-223</a> API.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The BSF engine for Groovy is implemented by the <code>org.codehaus.groovy.bsf.GroovyEngine</code> class. However, that fact is
normally hidden away by the BSF APIs. You just treat Groovy like any of the other scripting languages via the BSF
API.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
Since Groovy has its own native support for integration with Java, you only need to worry about BSF if you also
want to also be able to call other languages, e.g. <a href="http://jruby.codehaus.org/">JRuby</a> or if you want to remain very
loosely coupled from your scripting language.
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="_getting_started_2">Getting started</h5>
<div class="paragraph">
<p>Provided you have Groovy and BSF jars in your classpath, you can use the
following Java code to run a sample Groovy script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">String myScript = "println('Hello World')\n  return [1, 2, 3]";
BSFManager manager = new BSFManager();
List answer = (List) manager.eval("groovy", "myScript.groovy", 0, 0, myScript);
assertEquals(3, answer.size());</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_passing_in_variables">Passing in variables</h5>
<div class="paragraph">
<p>BSF lets you pass beans between Java and your scripting language. You
can <em>register</em>/<em>unregister</em> beans which makes them known to BSF. You can
then use BSF methods to <em>lookup</em> beans as required. Alternatively, you
can <em>declare</em>/<em>undeclare</em> beans. This will register them but also make
them available for use directly in your scripting language. This second
approach is the normal approach used with Groovy. Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">BSFManager manager = new BSFManager();
manager.declareBean("xyz", 4, Integer.class);
Object answer = manager.eval("groovy", "test.groovy", 0, 0, "xyz + 1");
assertEquals(5, answer);</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_other_calling_options">Other calling options</h5>
<div class="paragraph">
<p>The previous examples used the <em>eval</em> method. BSF makes multiple methods
available for your use (see the
<a href="http://commons.apache.org/proper/commons-bsf/manual.html">BSF documentation</a> for more
details). One of the other available methods is <em>apply</em>. It allows you
to define an anonymous function in your scripting language and apply
that function to arguments. Groovy supports this function using
closures. Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">BSFManager manager = new BSFManager();
Vector&lt;String&gt; ignoreParamNames = null;
Vector&lt;Integer&gt; args = new Vector&lt;Integer&gt;();
args.add(2);
args.add(5);
args.add(1);
Integer actual = (Integer) manager.apply("groovy", "applyTest", 0, 0,
        "def summer = { a, b, c -&gt; a * 100 + b * 10 + c }", ignoreParamNames, args);
assertEquals(251, actual.intValue());</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_access_to_the_scripting_engine">Access to the scripting engine</h5>
<div class="paragraph">
<p>Although you don’t normally need it, BSF does provide a hook that lets
you get directly to the scripting engine. One of the functions which the
engine can perform is to invoke a single method call on an object. Here
is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">BSFManager manager = new BSFManager();
BSFEngine bsfEngine = manager.loadScriptingEngine("groovy");
manager.declareBean("myvar", "hello", String.class);
Object myvar = manager.lookupBean("myvar");
String result = (String) bsfEngine.call(myvar, "reverse", new Object[0]);
assertEquals("olleh", result);</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="jsr223">4.10.3. JSR 223 javax.script API (TBD)</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="icon-warning" title="Warning"></i>
</td>
<td class="content">
JSR-223 is a standard API for calling scripting frameworks in Java. It is available since Java 6 and aims at
providing a common framework for calling multiple languages from Java. Groovy provides its own richer integration mechanisms,
and if you don&#8217;t plan to use multiple languages in the same application, it is recommanded that you use the Groovy
integration mechanisms instead of the limited JSR-223 API.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here is how you need to initialize the JSR-223 engine to talk to Groovy from Java:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import javax.script.ScriptEngine;
import javax.script.ScriptEngineManager;
import javax.script.ScriptException;
...
ScriptEngineManager factory = new ScriptEngineManager();
ScriptEngine engine = factory.getEngineByName("groovy");</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can execute Groovy scripts easily:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">Integer sum = (Integer) engine.eval("(1..10).sum()");
assertEquals(new Integer(55), sum);</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to share variables:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">engine.put("first", "HELLO");
engine.put("second", "world");
String result = (String) engine.eval("first.toLowerCase() + ' ' + second.toUpperCase()");
assertEquals("hello WORLD", result);</code></pre>
</div>
</div>
<div class="paragraph">
<p>This next example illustrates calling an invokable function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="java language-java">import javax.script.Invocable;
...
ScriptEngineManager factory = new ScriptEngineManager();
ScriptEngine engine = factory.getEngineByName("groovy");
String fact = "def factorial(n) { n == 1 ? 1 : n * factorial(n - 1) }";
engine.eval(fact);
Invocable inv = (Invocable) engine;
Object[] params = {5};
Object result = inv.invokeFunction("factorial", params);
assertEquals(new Integer(120), result);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The engine keeps per default hard references to the script functions. To
change this you should set a engine level scoped attribute to the script
context of the name <code>#jsr223.groovy.engine.keep.globals</code> with a
String being <code>phantom</code> to use phantom references, <code>weak</code> to use weak
references or <code>soft</code> to use soft references - casing is ignored. Any
other string will cause the use of hard references.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_domain_specific_languages">4.11. Domain-Specific Languages</h3>
<div class="sect3">
<h4 id="_command_chains">4.11.1. Command chains</h4>
<div class="paragraph">
<p>Groovy lets you omit parentheses around the arguments of a
method call for top-level statements. &#8220;command chain&#8221; feature extends this by allowing us to chain such
parentheses-free method calls, requiring neither parentheses around arguments, nor dots between the chained calls.
The general idea is that a call like <code>a b c d</code> will actually be equivalent to <code>a(b).c(d)</code>. This
also works with multiple arguments, closure arguments, and even named arguments. Furthermore, such command chains can
also appear on the right-hand side of assignments. Let’s have a look at some examples
supported by this new syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">// equivalent to: turn(left).then(right)
turn left then right

// equivalent to: take(2.pills).of(chloroquinine).after(6.hours)
take 2.pills of chloroquinine after 6.hours

// equivalent to: paint(wall).with(red, green).and(yellow)
paint wall with red, green and yellow

// with named parameters too
// equivalent to: check(that: margarita).tastes(good)
check that: margarita tastes good

// with closures as parameters
// equivalent to: given({}).when({}).then({})
given { } when { } then { }</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is also possible to use methods in the chain which take no arguments,
but in that case, the parentheses are needed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">// equivalent to: select(all).unique().from(names)
select all unique() from names</code></pre>
</div>
</div>
<div class="paragraph">
<p>If your command chain contains an odd number of elements, the chain will
be composed of method / arguments, and will finish by a final property
access:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">// equivalent to: take(3).cookies
// and also this: take(3).getCookies()
take 3 cookies</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command chain approach opens up interesting possibilities in terms of the much wider range of DSLs which
can now be written in Groovy.</p>
</div>
<div class="paragraph">
<p>The above examples illustrate using a command chain based DSL but not how to create one. There are various strategies
that you can use, but to illustrate creating such a DSL, we will show a couple of examples - first using maps and Closures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">show = { println it }
square_root = { Math.sqrt(it) }

def please(action) {
  [the: { what -&gt;
    [of: { n -&gt; action(what(n)) }]
  }]
}

// equivalent to: please(show).the(square_root).of(100)
please show the square_root of 100
// ==&gt; 10.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>As a second example, consider how you might write a DSL for simplifying
one of your existing APIs. Maybe you need to put this code in front of
customers, business analysts or testers who might be not hard-core Java
developers. We’ll use the <code>Splitter</code> from the Google
<a href="http://code.google.com/p/guava-libraries/">Guava libraries</a> project as it
already has a nice Fluent API. Here is how we might use it out of the
box:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grab('com.google.guava:guava:r09')
import com.google.common.base.*
def result = Splitter.on(',').trimResults(CharMatcher.is('_' as char)).split("_a ,_b_ ,c__").iterator().toList()</code></pre>
</div>
</div>
<div class="paragraph">
<p>It reads fairly well for a Java developer but if that is not your target
audience or you have many such statements to write, it could be
considered a little verbose. Again, there are many options for writing a
DSL. We’ll keep it simple with Maps and Closures. We’ll first write a
helper method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grab('com.google.guava:guava:r09')
import com.google.common.base.*
def split(string) {
  [on: { sep -&gt;
    [trimming: { trimChar -&gt;
      Splitter.on(sep).trimResults(CharMatcher.is(trimChar as char)).split(string).iterator().toList()
    }]
  }]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>now instead of this line from our original example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def result = Splitter.on(',').trimResults(CharMatcher.is('_' as char)).split("_a ,_b_ ,c__").iterator().toList()</code></pre>
</div>
</div>
<div class="paragraph">
<p>we can write this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def result = split "_a ,_b_ ,c__" on ',' trimming '_\'</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_operator_overloading_tbd">4.11.2. Operator overloading (TBD)</h4>

</div>
<div class="sect3">
<h4 id="_script_base_classes_tbd">4.11.3. Script base classes (TBD)</h4>

</div>
<div class="sect3">
<h4 id="_adding_properties_to_numbers_tbd">4.11.4. Adding properties to numbers (TBD)</h4>

</div>
<div class="sect3">
<h4 id="section-delegatesto">4.11.5. @DelegatesTo</h4>
<div class="sect4">
<h5 id="TheDelegatesToannotation-DSLsmadeeasy">Explaining delegation strategy at compile time</h5>
<div class="paragraph">
<p><code>@groovy.lang.DelegatesTo</code> is a documentation and compile-time annotation aimed at:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>documenting APIs that use closures as arguments</p>
</li>
<li>
<p>providing type information for the static type checker and compiler</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The Groovy language is a platform of choice for building DSLs. Using
closures, it’s quite easy to create custom control structures, as well
as it is simple to create builders. Imagine that you have the following
code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">email {
    from 'dsl-guru@mycompany.com'
    to 'john.doe@waitaminute.com'
    subject 'The pope has resigned!'
    body {
        p 'Really, the pope has resigned!'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>One way of implementing this is using the builder strategy, which
implies a method, named <code>email</code> which accepts a closure as an argument.
The method may delegate subsequent calls to an object that implements
the <code>from</code>, <code>to</code>, <code>subject</code> and <code>body</code> methods. Again, <code>body</code> is a
method which accepts a closure as an argument and that uses the builder
strategy.</p>
</div>
<div class="paragraph">
<p>Implementing such a builder is usually done the following way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def email(Closure cl) {
    def email = new EmailSpec()
    def code = cl.rehydrate(email, this, this)
    code.resolveStrategy = Closure.DELEGATE_ONLY
    code()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>the <code>EmailSpec</code> class implements the <code>from</code>, <code>to</code>, … methods. By
calling <code>rehydrate</code>, we’re creating a copy of the closure for which we
set the <code>delegate</code>, <code>owner</code> and <code>thisObject</code> values. Setting the owner
and the <code>this</code> object is not very important here since we will use the
<code>DELEGATE_ONLY</code> strategy which says that the method calls will be
resolved only against the delegate of the closure.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class EmailSpec {
    void from(String from) { println "From: $from"}
    void to(String... to) { println "To: $to"}
    void subject(String subject) { println "Subject: $subject"}
    void body(Closure body) {
        def bodySpec = new BodySpec()
        def code = body.rehydrate(bodySpec, this, this)
        code.resolveStrategy = Closure.DELEGATE_ONLY
        code()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>EmailSpec</code> class has itself a <code>body</code> method accepting a closure that is cloned and executed. This is what
we call the builder pattern in Groovy.</p>
</div>
<div class="paragraph">
<p>One of the problems with the code that we’ve shown is that the user of
the <code>email</code> method doesn’t have any information about the methods that
he’s allowed to call inside the closure. The only possible information
is from the method documentation. There are two issues with this: first
of all, documentation is not always written, and if it is, it’s not
always available (javadoc not downloaded, for example). Second, it
doesn’t help IDEs. What would be really interesting, here, is for IDEs
to help the developer by suggesting, once they are in the closure body,
methods that exist on the <code>email</code> class.</p>
</div>
<div class="paragraph">
<p>Moreover, if the user calls a method in the closure which is not defined
by the <code>EmailSpec</code> class, the IDE should at least issue a warning (because
it’s very likely that it will break at runtime).</p>
</div>
<div class="paragraph">
<p>One more problem with the code above is that it is not compatible with static type checking. Type checking would let
the user know if a method call is authorized at compile time instead of runtime, but if you try to perform type
checking on this code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">email {
    from 'dsl-guru@mycompany.com'
    to 'john.doe@waitaminute.com'
    subject 'The pope has resigned!'
    body {
        p 'Really, the pope has resigned!'
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then the type checker will know that there’s an <code>email</code> method accepting
a <code>Closure</code>, but it will complain for every method call <strong>inside</strong> the
closure, because <code>from</code>, for example, is not a method which is defined
in the class. Indeed, it’s defined in the <code>EmailSpec</code> class and it has
absolutely no hint to help it knowing that the closure delegate will, at
runtime, be of type <code>EmailSpec</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@groovy.transform.TypeChecked
void sendEmail() {
    email {
        from 'dsl-guru@mycompany.com'
        to 'john.doe@waitaminute.com'
        subject 'The pope has resigned!'
        body {
            p 'Really, the pope has resigned!'
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>will fail compilation with errors like this one:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[Static type checking] - Cannot find matching method MyScript#from(java.lang.String). Please check if the declared type is right and if the method exists.
 @ line 31, column 21.
                       from 'dsl-guru@mycompany.com'</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="TheDelegatesToannotation-DelegatesTo">@DelegatesTo</h5>
<div class="paragraph">
<p>For those reasons, Groovy 2.1 introduced a new annotation
named <code>@DelegatesTo</code>. The goal of this annotation is to solve both the
documentation issue, that will let your IDE know about the expected
methods in the closure body, and it will also solve the type checking
issue, by giving hints to the compiler about what are the potential
receivers of method calls in the closure body.</p>
</div>
<div class="paragraph">
<p>The idea is to annotate the <code>Closure</code> parameter of the <code>email</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def email(@DelegatesTo(EmailSpec) Closure cl) {
    def email = new EmailSpec()
    def code = cl.rehydrate(email, this, this)
    code.resolveStrategy = Closure.DELEGATE_ONLY
    code()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>What we’ve done here is telling the compiler (or the IDE) that when the
method will be called with a closure, the delegate of this closure will
be set to an object of type <code>email</code>. But there is still a problem: the
defaut delegation strategy is not the one which is used in our method.
So we will give more information and tell the compiler (or the IDE) that
the delegation strategy is also changed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def email(@DelegatesTo(strategy=Closure.DELEGATE_ONLY, value=EmailSpec) Closure cl) {
    def email = new EmailSpec()
    def code = cl.rehydrate(email, this, this)
    code.resolveStrategy = Closure.DELEGATE_ONLY
    code()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, both the IDE and the type checker (if you are using <code>@TypeChecked</code>)
will be aware of the delegate and the delegation strategy. This is very
nice because it will both allow the IDE to provide smart completion, but
it will also remove errors at compile time that exist only because the
behaviour of the program is normally only known at runtime!</p>
</div>
<div class="paragraph">
<p>The following code will now pass compilation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@TypeChecked
void doEmail() {
    email {
        from 'dsl-guru@mycompany.com'
        to 'john.doe@waitaminute.com'
        subject 'The pope has resigned!'
        body {
            p 'Really, the pope has resigned!'
        }
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="TheDelegatesToannotation-DelegatesTomodes">DelegatesTo modes</h5>
<div class="paragraph">
<p><code>@DelegatesTo</code> supports multiple modes that we will describe with examples
in this section.</p>
</div>
<div class="sect5">
<h6 id="TheDelegatesToannotation-Simpledelegation">Simple delegation</h6>
<div class="paragraph">
<p>In this mode, the only mandatory parameter is the <em>value</em> which says to
which class we delegate calls. Nothing more. We’re telling the compiler
that the type of the delegate will <strong>always</strong> be of the type documented
by <code>@DelegatesTo</code> (note that it can be a subclass, but if it is, the
methods defined by the subclass will not be visible to the type
checker).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">void body(@DelegatesTo(BodySpec) Closure cl) {
    // ...
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="TheDelegatesToannotation-Delegationstrategy">Delegation strategy</h6>
<div class="paragraph">
<p>In this mode, you must specify both the delegate class <strong>and</strong> a
delegation strategy. This must be used if the closure will not be called
with the default delegation strategy, which is <code>Closure.OWNER_FIRST</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">void body(@DelegatesTo(strategy=Closure.DELEGATE_ONLY, value=BodySpec) Closure cl) {
    // ...
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="TheDelegatesToannotation-Delegatetoparameter">Delegate to parameter</h6>
<div class="paragraph">
<p>In this variant, we will tell the compiler that we are delegating to
another parameter of the method. Take the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def exec(Object target, Closure code) {
   def clone = code.rehydrate(target, this, this)
   clone()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the delegate which will be used is <strong>not</strong> created inside the <code>exec</code>
method. In fact, we take an argument of the method and delegate to it.
Usage may look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def email = new Email()
exec(email) {
   from '...'
   to '...'
   send()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each of the method calls are delegated to the <code>email</code> parameter. This is
a widely used pattern which is also supported by <code>@DelegatesTo</code> using a
companion annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def exec(@DelegatesTo.Target Object target, @DelegatesTo Closure code) {
   def clone = code.rehydrate(target, this, this)
   clone()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A closure is annotated with <code>@DelegatesTo</code>, but this time, without
specifying any class. Instead, we’re annotating another parameter
with <code>@DelegatesTo.Target</code>. The type of the delegate is then determined
at compile time. One could think that we are using the parameter type,
which in this case is <code>Object</code> but this is not true. Take this code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Greeter {
   void sayHello() { println 'Hello' }
}
def greeter = new Greeter()
exec(greeter) {
   sayHello()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that this works out of the box <strong>without</strong> having to annotate
with <code>@DelegatesTo</code>. However, to make the IDE aware of the delegate
type, or the <strong>type checker</strong> aware of it, we need to add <code>@DelegatesTo</code>.
And in this case, it will now that the <code>Greeter</code> variable is of
type <code>Greeter</code>, so it will not report errors on the <em>sayHello</em>
method <strong>even if the exec method doesn’t explicitely define the target as
of type Greeter</strong>. This is a very powerful feature, because it prevents
you from writing multiple versions of the same <code>exec</code> method for
different receiver types!</p>
</div>
<div class="paragraph">
<p>In this mode, the <code>@DelegatesTo</code> annotation also supports the <code>strategy</code>
parameter that we’ve described upper.</p>
</div>
</div>
<div class="sect5">
<h6 id="TheDelegatesToannotation-Multipleclosures">Multiple closures</h6>
<div class="paragraph">
<p>In the previous example, the <code>exec</code> method accepted only one closure,
but you may have methods that take multiple closures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">void fooBarBaz(Closure foo, Closure bar, Closure baz) {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then nothing prevents you from annotating each closure
with <code>@DelegatesTo</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Foo { void foo(String msg) { println "Foo ${msg}!" } }
class Bar { void bar(int x) { println "Bar ${x}!" } }
class Baz { void baz(Date d) { println "Baz ${d}!" } }

void fooBarBaz(@DelegatesTo(Foo) Closure foo, @DelegatesTo(Bar) Closure bar, @DelegatesTo(Baz) Closure baz) {
   ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>But more importantly, if you have multiple closures <strong>and</strong> multiple
arguments, you can use several targets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">void fooBarBaz(
    @DelegatesTo.Target('foo') foo,
    @DelegatesTo.Target('bar') bar,
    @DelegatesTo.Target('baz') baz,

    @DelegatesTo(target='foo') Closure cl1,
    @DelegatesTo(target='bar') Closure cl2,
    @DelegatesTo(target='baz') Closure cl3) {
    cl1.rehydrate(foo, this, this).call()
    cl2.rehydrate(bar, this, this).call()
    cl3.rehydrate(baz, this, this).call()
}

def a = new Foo()
def b = new Bar()
def c = new Baz()
fooBarBaz(
    a, b, c,
    { foo('Hello') },
    { bar(123) },
    { baz(new Date()) }
)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
At this point, you may wonder why we don’t use the parameter names as
references. The reason is that the information (the parameter name) is
not always available (it’s a debug-only information), so it’s a
limitation of the JVM.
</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_delegating_to_a_generic_type">Delegating to a generic type</h6>
<div class="paragraph">
<p>In some situations, it is interesting to instruct the IDE or the compiler that the delegate type will not be a parameter
but a generic type. Imagine a configurator that runs on a list of elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">public &lt;T&gt; void configure(List&lt;T&gt; elements, Closure configuration) {
   elements.each { e-&gt;
      def clone = configuration.rehydrate(e, this, this)
      clone.resolveStrategy = Closure.DELEGATE_FIRST
      clone.call()
   }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then this method can be called with any list like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@groovy.transform.ToString
class Realm {
   String name
}
List&lt;Realm&gt; list = []
3.times { list &lt;&lt; new Realm() }
configure(list) {
   name = 'My Realm'
}
assert list.every { it.name == 'My Realm' }</code></pre>
</div>
</div>
<div class="paragraph">
<p>To let the type checker and the IDE know that the <code>configure</code> method calls the closure on each element of the list, you
 need to use <code>@DelegatesTo</code> differently:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">public &lt;T&gt; void configure(
    @DelegatesTo.Target List&lt;T&gt; elements,
    @DelegatesTo(strategy=Closure.DELEGATE_FIRST, genericTypeIndex=0) Closure configuration) {
   def clone = configuration.rehydrate(e, this, this)
   clone.resolveStrategy = Closure.DELEGATE_FIRST
   clone.call()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>@DelegatesTo</code> takes an optional <code>genericTypeIndex</code> argument that tells what is the index of the generic type that will
be used as the delegate type. This <strong>must</strong> be used in conjunction with <code>@DelegatesTo.Target</code> and the index starts at 0. In
the example above, that means that the delegate type is resolved against <code>List&lt;T&gt;</code>, and since the generic type at index
0 is <code>T</code> and inferred as a <code>Realm</code>, the type checker infers that the delegate type will be of type <code>Realm</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
We&#8217;re using a <code>genericTypeIndex</code> instead of a placeholder (<code>T</code>) because of JVM limitations.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="compilation-customizers">4.11.6. Compilation customizers</h4>
<div class="sect4">
<h5 id="_introduction_4">Introduction</h5>
<div class="paragraph">
<p>Whether you are using <code>groovyc</code> to compile classes or a <code>GroovyShell</code>,
for example, to execute scripts, under the hood, a <em>compiler configuration</em> is used. This configuration holds information
like the source encoding or the classpath but it can also be used to perform more operations like adding imports by
default, applying AST transformations transparently or disabling global AST transformations.</p>
</div>
<div class="paragraph">
<p>The goal of compilation customizers is to make those common tasks easy to implement. For that, the <code>CompilerConfiguration</code>
class is the entry point. The general schema will always be based on the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.codehaus.groovy.control.CompilerConfiguration
// create a configuration
def config = new CompilerConfiguration()
// tweak the configuration
config.addCompilationCustomizers(...)
// run your script
def shell = new GroovyShell(config)
shell.evaluate(script)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Compilation customizers must extend the <em>org.codehaus.groovy.control.customizers.CompilationCustomizer</em> class. A customizer works:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>on a specific compilation phase</p>
</li>
<li>
<p>on <em>every</em> class node being compiled</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can implement your own compilation customizer but Groovy includes some of the most common operations.</p>
</div>
</div>
<div class="sect4">
<h5 id="_import_customizer">Import customizer</h5>
<div class="paragraph">
<p>Using this compilation customizer, your code will have imports added
transparently. This is in particular useful for scripts implementing a
DSL where you want to avoid users from having to write imports. The
import customizer will let you add all the variants of imports the
Groovy language allows, that is:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>class imports, optionally aliased</p>
</li>
<li>
<p>star imports</p>
</li>
<li>
<p>static imports, optionally aliased</p>
</li>
<li>
<p>static star imports</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.codehaus.groovy.control.customizers.ImportCustomizer

def icz = new ImportCustomizer()
// "normal" import
icz.addImports('java.util.concurrent.atomic.AtomicInteger', 'java.util.concurrent.ConcurrentHashMap')
// "aliases" import
icz.addImport('CHM', 'java.util.concurrent.ConcurrentHashMap')
// "static" import
icz.addStaticImport('java.lang.Math', 'PI') // import static java.lang.Math.Pi
// "aliased static" import
icz.addStaticImport('pi', 'java.lang.Math', 'PI') // import static java.lang.Math.PI as pi
// "star" import
icz.addStarImports 'java.util.concurrent' // import java.util.concurrent.*
// "static star" import
icz.addStaticStars 'java.lang.Math' // import static java.lang.Math.*</code></pre>
</div>
</div>
<div class="paragraph">
<p>A detailed description of all shortcuts can be found in <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?org/codehaus/groovy/control/customizers/ImportCustomizer.html' target='_blank'><code>org.codehaus.groovy.control.customizers.ImportCustomizer</code></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_ast_transformation_customizer">AST transformation customizer</h5>
<div class="paragraph">
<p>The AST transformation customizer is meant to apply AST transformations
transparently. Unlike global AST transformations that apply on every
class beeing compiled as long as the transform is found on classpath
(which has drawbacks like increasing the compilation time or side
effects due to transformations applied where they should not), the
customizer will allow you to selectively apply a transform only for
specific scripts or classes.</p>
</div>
<div class="paragraph">
<p>As an example, let’s say you want to be able to use <code>@Log</code> in a script.
The problem is that <code>@Log</code> is normally applied on a class node and a
script, by definition, doesn’t require one. But implementation wise,
scripts are classes, it’s just that you cannot annotate this implicit
class node with <code>@Log</code>. Using the AST customizer, you have a workaround
to do it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.codehaus.groovy.control.customizers.ASTTransformationCustomizer
import groovy.util.logging.Log

def acz = new ASTTransformationCustomizer(Log)
config.addCompilationCustomizers(acz)</code></pre>
</div>
</div>
<div class="paragraph">
<p>That’s all! Internally, the <code>@Log</code> AST transformation is applied to
every class node in the compilation unit. This means that it will be
applied to the script, but also to classes defined within the script.</p>
</div>
<div class="paragraph">
<p>If the AST transformation that you are using accepts parameters, you can
use parameters in the constructor too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def acz = new ASTTransformationCustomizer(Log, value: 'LOGGER')
// use name 'LOGGER' instead of the default 'log'
config.addCompilationCustomizers(acz)</code></pre>
</div>
</div>
<div class="paragraph">
<p>As the AST transformation customizers works with objects instead of AST
nodes, not all values can be converted to AST transformation parameters.
For example, primitive types are converted to <code>ConstantExpression</code> (that
is <code>LOGGER</code> is converted to <code>new ConstantExpression('LOGGER')</code>, but if
your AST transformation takes a closure as an argument, then you have to
give it a <code>ClosureExpression</code>, like in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def configuration = new CompilerConfiguration()
def expression = new AstBuilder().buildFromCode(CompilePhase.CONVERSION) { -&gt; true }.expression[0]
def customizer = new ASTTransformationCustomizer(ConditionalInterrupt, value: expression, thrown: SecurityException)
configuration.addCompilationCustomizers(customizer)
def shell = new GroovyShell(configuration)
shouldFail(SecurityException) {
    shell.evaluate("""
        // equivalent to adding @ConditionalInterrupt(value={true}, thrown: SecurityException)
        class MyClass {
            void doIt() { }
        }
        new MyClass().doIt()
    """)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a complete list of options, please refer to <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?org/codehaus/groovy/control/customizers/ASTTransformationCustomizer.html' target='_blank'><code>org.codehaus.groovy.control.customizers.ASTTransformationCustomizer</code></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_secure_ast_customizer">Secure AST customizer</h5>
<div class="paragraph">
<p>This customizer will allow the developer of a DSL to restrict the
<strong>grammar</strong> of the language, to prevent users from using some constructs,
for example. It is only &#8220;secure&#8221; in that sense only and it is very
important to understand that it does <strong>not</strong> replace a security manager.
The only reason for it to exist is to limit the expressiveness of the
language. This customizer only works at the AST (abstract syntax tree)
level, not at runtime! It can be strange at first glance, but it makes
much more sense if you think of Groovy as a platform to build DSLs. You
may not want a user to have a complete language at hand. In the example
below, we will demonstrate it using an example of language that only
allows arithmetic operations, but this customizer allows you to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>allow/disallow creation of closures</p>
</li>
<li>
<p>allow/disallow imports</p>
</li>
<li>
<p>allow/disallow package definition</p>
</li>
<li>
<p>allow/disallow definition of methods</p>
</li>
<li>
<p>restrict the receivers of method calls</p>
</li>
<li>
<p>restrict the kind of AST expressions a user can use</p>
</li>
<li>
<p>restrict the tokens (grammar-wise) a user can use</p>
</li>
<li>
<p>restrict the types of the constants that can be used in code</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For all those features, the secure AST customizer works using either a
whitelist (list of elements that are allowed) <strong>or</strong> a blacklist (list of
elements that are disallowed). For each type of feature (imports,
tokens, …) you have the choice to use either a whitelist or a blacklist,
but you can mix whitelists and blacklists for distinct features. In
general, you will choose whitelists (disallow all, allow selected).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.codehaus.groovy.control.customizers.SecureASTCustomizer
import static org.codehaus.groovy.syntax.Types.* <i class="conum" data-value="1"></i><b>(1)</b>

def scz = new SecureASTCustomizer()
scz.with {
    closuresAllowed = false // user will not be able to write closures
    methodDefinitionAllowed = false // user will not be able to define methods
    importsWhitelist = [] // empty whitelist means imports are disallowed
    staticImportsWhitelist = [] // same for static imports
    staticStarImportsWhitelist = ['java.lang.Math'] // only java.lang.Math is allowed
    // the list of tokens the user can find
    // constants are defined in org.codehaus.groovy.syntax.Types
    tokensWhitelist = [ <i class="conum" data-value="1"></i><b>(1)</b>
            PLUS,
            MINUS,
            MULTIPLY,
            DIVIDE,
            MOD,
            POWER,
            PLUS_PLUS,
            MINUS_MINUS,
            COMPARE_EQUAL,
            COMPARE_NOT_EQUAL,
            COMPARE_LESS_THAN,
            COMPARE_LESS_THAN_EQUAL,
            COMPARE_GREATER_THAN,
            COMPARE_GREATER_THAN_EQUAL,
    ].asImmutable()
    // limit the types of constants that a user can define to number types only
    constantTypesClassesWhiteList = [ <i class="conum" data-value="2"></i><b>(2)</b>
            Integer,
            Float,
            Long,
            Double,
            BigDecimal,
            Integer.TYPE,
            Long.TYPE,
            Float.TYPE,
            Double.TYPE
    ].asImmutable()
    // method calls are only allowed if the receiver is of one of those types
    // be careful, it's not a runtime type!
    receiversClassesWhiteList = [ <i class="conum" data-value="2"></i><b>(2)</b>
            Math,
            Integer,
            Float,
            Double,
            Long,
            BigDecimal
    ].asImmutable()
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>use for token types from <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?org/codehaus/groovy/syntax/Types.html' target='_blank'><code>org.codehaus.groovy.syntax.Types</code></a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>you can use class literals here</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If what the secure AST customizer provides out of the box isn’t enough
for your needs, before creating your own compilation customizer, you
might be interested in the expression and statement checkers that the
AST customizer supports. Basically, it allows you to add custom checks
on the AST tree, on expressions (expression checkers) or statements
(statement checkers). For this, you must
implement <code>org.codehaus.groovy.control.customizers.SecureASTCustomizer.StatementChecker</code>
or <code>org.codehaus.groovy.control.customizers.SecureASTCustomizer.ExpressionChecker</code>.</p>
</div>
<div class="paragraph">
<p>Those interfaces define a single method called <code>isAuthorized</code>, returning
a boolean, and taking a <code>Statement</code> (or <code>Expression</code>) as a parameter. It
allows you to perform complex logic over expressions or statements to
tell if a user is allowed to do it or not.</p>
</div>
<div class="paragraph">
<p>For example, there&#8217;s no predefined configuration flag in the customizer which
will let you prevent people from using an attribute expression. Using a custom
checker, it is trivial:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def scz = new SecureASTCustomizer()
def checker = { expr -&gt;
    !(expr instanceof AttributeExpression)
} as SecureASTCustomizer.ExpressionChecker
scz.addExpressionCheckers(checker)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we can make sure that this works by evaluating a simple script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">new GroovyShell(config).evaluate '''
    class A {
        int val
    }
    
    def a = new A(val: 123)
    a.@val <i class="conum" data-value="1"></i><b>(1)</b>
'''</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>will fail compilation</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Statements can be checked using <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?org/codehaus/groovy/control/customizers/SecureASTCustomizer/StatementChecker.html' target='_blank'><code>org.codehaus.groovy.control.customizers.SecureASTCustomizer.StatementChecker</code></a>
Expressions can be checked using <a href='http://docs.groovy-lang.org/2.3.6/html/gapi/index.html?org/codehaus/groovy/control/customizers/SecureASTCustomizer/ExpressionChecker.html' target='_blank'><code>org.codehaus.groovy.control.customizers.SecureASTCustomizer.ExpressionChecker</code></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_source_aware_customizer">Source aware customizer</h5>
<div class="paragraph">
<p>This customizer may be used as a filter on other customizers. The
filter, in that case, is the <code>org.codehaus.groovy.control.SourceUnit</code>.
For this, the source aware customizer takes another customizer as a
delegate, and it will apply customization of that delegate only and only
if predicates on the source unit match.</p>
</div>
<div class="paragraph">
<p><code>SourceUnit</code> gives you access to multiple things but in particular the
file being compiled (if compiling from a file, of course). It gives
you the potential to perform operation based on the file name, for
example. Here is how you would create a source aware customizer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.codehaus.groovy.control.customizers.SourceAwareCustomizer
import org.codehaus.groovy.control.customizers.ImportCustomizer

def delegate = new ImportCustomizer()
def sac = new SourceAwareCustomizer(delegate)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can use predicates on the source aware customizer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">// the customizer will only be applied to classes contained in a file name ending with 'Bean'
sac.baseNameValidator = { baseName -&gt;
    baseName.endsWith 'Bean'
}

// the customizer will only be applied to files which extension is '.spec'
sac.extensionValidator = { ext -&gt; ext == 'spec' }

// source unit validation
// allow compilation only if the file contains at most 1 class
sac.sourceUnitValidator = { SourceUnit sourceUnit -&gt; sourceUnit.AST.classes.size() == 1 }

// class validation
// the customizer will only be applied to classes ending with 'Bean'
sac.classValidator = { ClassNode cn -&gt; cn.endsWith('Bean') }</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_customizer_builder">Customizer builder</h5>
<div class="paragraph">
<p>If you are using compilation customizers in Groovy code (like the
examples above) then you can use an alternative syntax to customize compilation.
A builder (<code>org.codehaus.groovy.control.customizers.builder.CompilerCustomizationBuilder</code>)
simplifies the creation of customizers using a hierarchical DSL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.codehaus.groovy.control.CompilerConfiguration
import static org.codehaus.groovy.control.customizers.builder.CompilerCustomizationBuilder.withConfig <i class="conum" data-value="1"></i><b>(1)</b>

def conf = new CompilerConfiguration()
withConfig(conf) {
    // ... <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>static import of the builder method</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>configuration goes here</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The code sample above shows how to use the builder. A static
method, <em>withConfig</em>, takes a closure corresponding to the builder code,
and automatically registers compilation customizers to the
configuration. Every compilation customizer available in the distribution
can be configured this way:</p>
</div>
<div class="sect5">
<h6 id="_import_customizer_2">Import customizer</h6>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">withConfig(configuration) {
   imports { // imports customizer
      normal 'my.package.MyClass' // a normal import
      alias 'AI', 'java.util.concurrent.atomic.AtomicInteger' // an aliased import
      star 'java.util.concurrent' // star imports
      staticMember 'java.lang.Math', 'PI' // static import
      staticMember 'pi', 'java.lang.Math', 'PI' // aliased static import
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_ast_transformation_customizer_2">AST transformation customizer</h6>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">withConfig(conf) {
   ast(Log) <i class="conum" data-value="1"></i><b>(1)</b>
}

withConfig(conf) {
   ast(Log, value: 'LOGGER') <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>apply @Log transparently</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>apply @Log with a different name for the logger</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_secure_ast_customizer_2">Secure AST customizer</h6>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">withConfig(conf) {
   secureAst {
       closuresAllowed = false
       methodDefinitionAllowed = false
   }
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_source_aware_customizer_2">Source aware customizer</h6>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">withConfig(configuration){
    source(extension: 'sgroovy') {
        ast(CompileStatic) <i class="conum" data-value="1"></i><b>(1)</b>
    }
}

withConfig(configuration){
    source(extensions: ['sgroovy','sg']) {
        ast(CompileStatic) <i class="conum" data-value="2"></i><b>(2)</b>
    }
}

withConfig(configuration) {
    source(extensionValidator: { it.name in ['sgroovy','sg']}) {
        ast(CompileStatic) <i class="conum" data-value="2"></i><b>(2)</b>
    }
}

withConfig(configuration) {
    source(basename: 'foo') {
        ast(CompileStatic) <i class="conum" data-value="3"></i><b>(3)</b>
    }
}

withConfig(configuration) {
    source(basenames: ['foo', 'bar']) {
        ast(CompileStatic) <i class="conum" data-value="4"></i><b>(4)</b>
    }
}

withConfig(configuration) {
    source(basenameValidator: { it in ['foo', 'bar'] }) {
        ast(CompileStatic) <i class="conum" data-value="4"></i><b>(4)</b>
    }
}

withConfig(configuration) {
    source(unitValidator: { unit -&gt; !unit.AST.classes.any { it.name == 'Baz' } }) {
        ast(CompileStatic) <i class="conum" data-value="5"></i><b>(5)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>apply CompileStatic AST annotation on .sgroovy files</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>apply CompileStatic AST annotation on .sgroovy or .sg files</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>apply CompileStatic AST annotation on files whose name is <em>foo</em></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>apply CompileStatic AST annotation on files whose name is <em>foo</em> or <em>bar</em></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>apply CompileStatic AST annotation on files that do not contain a class named <em>Baz</em></td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_inlining_a_customizer">Inlining a customizer</h6>
<div class="paragraph">
<p>Inlined customizer allows you to write a compilation customizer
directly, without having to create a class for it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">withConfig(configuration) {
    inline(phase:'CONVERSION') { source, context, classNode -&gt;  <i class="conum" data-value="1"></i><b>(1)</b>
        println "visiting $classNode"                           <i class="conum" data-value="2"></i><b>(2)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>define an inlined customizer which will execute at the CONVERSION phase</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>prints the name of the class node being compiled</td>
</tr>
</table>
</div>
</div>
<div class="sect5">
<h6 id="_multiple_customizers">Multiple customizers</h6>
<div class="paragraph">
<p>Of course, the builder allows you to define multiple customizers at
once:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">withConfig(configuration) {
   ast(ToString)
   ast(EqualsAndHashCode)
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_config_script_flag">Config script flag</h5>
<div class="paragraph">
<p>So far, we have described how you can customize compilation using
a <code>CompilationConfiguration</code> class, but this is only possible if you
embed Groovy and that you create your own instances
of <code>CompilerConfiguration</code> (then use it to create a
<code>GroovyShell</code>, <code>GroovyScriptEngine</code>, …).</p>
</div>
<div class="paragraph">
<p>If you want it to be applied on the classes you compile with the normal
Groovy compiler (that is to say with  <code>groovyc</code>, <code>ant</code> or <code>gradle</code>,
for example), it is possible to use a compilation flag named <code>configscript</code>
that takes a Groovy configuration script as argument.</p>
</div>
<div class="paragraph">
<p>This script gives you access to the <code>CompilerConfiguration</code> instance <strong>before</strong>
the files are compiled (exposed into the configuration script as a variable named <code>configuration</code>),
so that you can tweak it.</p>
</div>
<div class="paragraph">
<p>It also transparently integrates the compiler configuration builder above. As an example, let&#8217;s see
how you would activate static compilation by default on all classes.</p>
</div>
<div class="sect5">
<h6 id="_static_compilation_by_default">Static compilation by default</h6>
<div class="paragraph">
<p>Normally, classes in Groovy are compiled with a dynamic runtime. You can activate static compilation
by placing an annotation named <code>@CompileStatic</code> on any class. Some people would like to have this
mode activated by default, that is to say not having to annotated classes. Using <code>configscript</code>,
this is possible. First of all, you need to create a file named <code>config.groovy</code> into <code>src/conf</code> with
the following contents:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">withConfig(configuration) { <i class="conum" data-value="1"></i><b>(1)</b>
   ast(groovy.transform.CompileStatic)
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><em>configuration</em> references a <code>CompilerConfiguration</code> instance</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>That is actually all you need. You don’t have to import the builder, it’s automatically
exposed in the script. Then, compile your files using the following command line:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>groovyc -configscript src/conf/config.groovy src/main/groovy/MyClass.groovy</pre>
</div>
</div>
<div class="paragraph">
<p>We strongly recommand you to separate configuration files from classes,
hence why we suggest using the <code>src/main</code> and <code>src/conf</code> directories above.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_ast_transformations_tbd">AST transformations (TBD)</h5>

</div>
</div>
<div class="sect3">
<h4 id="_custom_type_checking_extensions_tbd">4.11.7. Custom type checking extensions (TBD)</h4>

</div>
<div class="sect3">
<h4 id="_builders_tbd">4.11.8. Builders (TBD)</h4>
<div class="sect4">
<h5 id="_creating_a_builder_tbd">Creating a builder (TBD)</h5>
<div class="sect5">
<h6 id="_buildersupport_tbd">BuilderSupport (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_factorybuildersupport_tbd">FactoryBuilderSupport (TBD)</h6>

</div>
</div>
<div class="sect4">
<h5 id="_existing_builders_tbd">Existing builders (TBD)</h5>
<div class="sect5">
<h6 id="_markupbuilder_tbd">MarkupBuilder (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_streamingmarkupbuilder_tbd">StreamingMarkupBuilder (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_saxbuilder_tbd">SaxBuilder (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_staxbuilder_tbd">StaxBuilder (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_dombuilder_tbd">DomBuilder (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_nodebuilder_tbd">NodeBuilder (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_jsonbuilder_tbd">JsonBuilder (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_streamingjsonbuilder_tbd">StreamingJsonBuilder (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_swingbuilder_tbd">SwingBuilder (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_antbuilder_tbd">AntBuilder (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_clibuilder_tbd">CliBuilder (TBD)</h6>

</div>
<div class="sect5">
<h6 id="_objectgraphbuilder_tbd">ObjectGraphBuilder (TBD)</h6>

</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_jmx">4.12. Working with JMX</h3>
<div class="sect3">
<h4 id="_introduction_5">4.12.1. Introduction</h4>
<div class="paragraph">
<p>Given that Groovy sits directly on top of Java, Groovy can leverage the tremendous amount of work already done for <a href="http://www.oracle.com/technetwork/java/javase/tech/javamanagement-140525.html">JMX</a> with Java. In addition, Groovy provides a <code>GroovyMBean</code> class which makes an MBean look like a normal Groovy object. This simplifies Groovy code for interacting with <em>MBeans</em>. For example, the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">println server.getAttribute(beanName, 'Age')
server.setAttribute(beanName, new Attribute('Name', 'New name'))
Object[] params = [5, 20]
String[] signature = [Integer.TYPE, Integer.TYPE]
println server.invoke(beanName, 'add', params, signature)</code></pre>
</div>
</div>
<div class="paragraph">
<p>can be simplified to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def mbean = new GroovyMBean(server, beanName)
println mbean.Age
mbean.Name = 'New name'
println mbean.add(5, 20)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The remainder of this page shows you how to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Monitor the JVM using MXBeans</p>
</li>
<li>
<p>Monitor Apache Tomcat and display statistics</p>
</li>
<li>
<p>Monitor Oracle OC4J and display information</p>
</li>
<li>
<p>Monitor BEA WebLogic and display information</p>
</li>
<li>
<p>Leverage Spring&#8217;s MBean annotation support to export your Groovy beans as MBeans</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note: many of the examples on this page use Java 5 which incorporates JMX 1.2 (more recent versions if JMX or Java will also work). In some cases, you can run some of these examples using Java 1.4 by including a version of JMX on your <code>CLASSPATH</code>. MX4J is bundled with the full distribution of Groovy. In most cases, you can delete this jar from your distribution <code>lib</code> directory if you are running with Java 5 or above (in fact you might have to - see the Troubleshooting section below).</p>
</div>
</div>
<div class="sect3">
<h4 id="_monitoring_the_jvm">4.12.2. Monitoring the JVM</h4>
<div class="paragraph">
<p>MBeans are not accessed directly by an application but are managed by a repository called an <em>MBean server</em>. Java 5 and above includes a special MBean server called the <em>platform MBean server</em>, which is built into the JVM. Platform MBeans are registered in this server using unique names.</p>
</div>
<div class="paragraph">
<p>You can monitor the JVM through its platform MBeans with the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import java.lang.management.*

def os = ManagementFactory.operatingSystemMXBean
println """OPERATING SYSTEM:
\tarchitecture = $os.arch
\tname = $os.name
\tversion = $os.version
\tprocessors = $os.availableProcessors
"""

def rt = ManagementFactory.runtimeMXBean
println """RUNTIME:
\tname = $rt.name
\tspec name = $rt.specName
\tvendor = $rt.specVendor
\tspec version = $rt.specVersion
\tmanagement spec version = $rt.managementSpecVersion
"""

def cl = ManagementFactory.classLoadingMXBean
println """CLASS LOADING SYSTEM:
\tisVerbose = ${cl.isVerbose()}
\tloadedClassCount = $cl.loadedClassCount
\ttotalLoadedClassCount = $cl.totalLoadedClassCount
\tunloadedClassCount = $cl.unloadedClassCount
"""

def comp = ManagementFactory.compilationMXBean
println """COMPILATION:
\ttotalCompilationTime = $comp.totalCompilationTime
"""

def mem = ManagementFactory.memoryMXBean
def heapUsage = mem.heapMemoryUsage
def nonHeapUsage = mem.nonHeapMemoryUsage
println """MEMORY:
HEAP STORAGE:
\tcommitted = $heapUsage.committed
\tinit = $heapUsage.init
\tmax = $heapUsage.max
\tused = $heapUsage.used
NON-HEAP STORAGE:
\tcommitted = $nonHeapUsage.committed
\tinit = $nonHeapUsage.init
\tmax = $nonHeapUsage.max
\tused = $nonHeapUsage.used
"""

ManagementFactory.memoryPoolMXBeans.each { mp -&gt;
    println "\tname: " + mp.name
    String[] mmnames = mp.memoryManagerNames
    mmnames.each{ mmname -&gt;
        println "\t\tManager Name: $mmname"
    }
    println "\t\tmtype = $mp.type"
    println "\t\tUsage threshold supported = " + mp.isUsageThresholdSupported()
}
println()

def td = ManagementFactory.threadMXBean
println "THREADS:"
td.allThreadIds.each { tid -&gt;
    println "\tThread name = ${td.getThreadInfo(tid).threadName}"
}
println()

println "GARBAGE COLLECTION:"
ManagementFactory.garbageCollectorMXBeans.each { gc -&gt;
    println "\tname = $gc.name"
    println "\t\tcollection count = $gc.collectionCount"
    println "\t\tcollection time = $gc.collectionTime"
    String[] mpoolNames = gc.memoryPoolNames
    mpoolNames.each { mpoolName -&gt;
        println "\t\tmpool name = $mpoolName"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When run, you will see something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>OPERATING SYSTEM:
	architecture = x86
	name = Windows XP
	version = 5.1
	processors = 2

RUNTIME:
	name = 620@LYREBIRD
	spec name = Java Virtual Machine Specification
	vendor = Sun Microsystems Inc.
	spec version = 1.0
	management spec version = 1.0

CLASS LOADING SYSTEM:
	isVerbose = false
	loadedClassCount = 919
	totalLoadedClassCount = 919
	unloadedClassCount = 0

COMPILATION:
	totalCompilationTime = 91

MEMORY:
HEAP STORAGE:
	committed = 3108864
	init = 0
	max = 66650112
	used = 1994728
NON-HEAP STORAGE:
	committed = 9240576
	init = 8585216
	max = 100663296
	used = 5897880

	name: Code Cache
		Manager Name: CodeCacheManager
		mtype = Non-heap memory
		Usage threshold supported = true
	name: Eden Space
		Manager Name: MarkSweepCompact
		Manager Name: Copy
		mtype = Heap memory
		Usage threshold supported = false
	name: Survivor Space
		Manager Name: MarkSweepCompact
		Manager Name: Copy
		mtype = Heap memory
		Usage threshold supported = false
	name: Tenured Gen
		Manager Name: MarkSweepCompact
		mtype = Heap memory
		Usage threshold supported = true
	name: Perm Gen
		Manager Name: MarkSweepCompact
		mtype = Non-heap memory
		Usage threshold supported = true

THREADS:
	Thread name = Monitor Ctrl-Break
	Thread name = Signal Dispatcher
	Thread name = Finalizer
	Thread name = Reference Handler
	Thread name = main

GARBAGE COLLECTION:
	name = Copy
		collection count = 60
		collection time = 141
		mpool name = Eden Space
		mpool name = Survivor Space
	name = MarkSweepCompact
		collection count = 0
		collection time = 0
		mpool name = Eden Space
		mpool name = Survivor Space
		mpool name = Tenured Gen
		mpool name = Perm Gen</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_monitoring_tomcat">4.12.3. Monitoring Tomcat</h4>
<div class="paragraph">
<p>First start up <a href="http://tomcat.apache.org">Tomcat</a> with JMX monitoring enabled by setting the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="shell language-shell">set JAVA_OPTS=-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=9004\
 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can do this in your startup script and may choose any available port, we used 9004.</p>
</div>
<div class="paragraph">
<p>The following code uses JMX to discover the available MBeans in the running Tomcat, determine which are web modules, extract the processing time for each web module and displays the result in a graph using JFreeChart:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import groovy.swing.SwingBuilder

import javax.management.ObjectName
import javax.management.remote.JMXConnectorFactory as JmxFactory
import javax.management.remote.JMXServiceURL as JmxUrl
import javax.swing.WindowConstants as WC

import org.jfree.chart.ChartFactory
import org.jfree.data.category.DefaultCategoryDataset as Dataset
import org.jfree.chart.plot.PlotOrientation as Orientation

def serverUrl = 'service:jmx:rmi:///jndi/rmi://localhost:9004/jmxrmi'
def server = JmxFactory.connect(new JmxUrl(serverUrl)).MBeanServerConnection
def serverInfo = new GroovyMBean(server, 'Catalina:type=Server').serverInfo
println "Connected to: $serverInfo"

def query = new ObjectName('Catalina:*')
String[] allNames = server.queryNames(query, null)
def modules = allNames.findAll { name -&gt;
    name.contains('j2eeType=WebModule')
}.collect{ new GroovyMBean(server, it) }

println "Found ${modules.size()} web modules. Processing ..."
def dataset = new Dataset()

modules.each { m -&gt;
    println m.name()
    dataset.addValue m.processingTime, 0, m.path
}

def labels = ['Time per Module', 'Module', 'Time']
def options = [false, true, true]
def chart = ChartFactory.createBarChart(*labels, dataset,
                Orientation.VERTICAL, *options)
def swing = new SwingBuilder()
def frame = swing.frame(title:'Catalina Module Processing Time', defaultCloseOperation:WC.EXIT_ON_CLOSE) {
    panel(id:'canvas') { rigidArea(width:600, height:250) }
}
frame.pack()
frame.show()
chart.draw(swing.canvas.graphics, swing.canvas.bounds)</code></pre>
</div>
</div>
<div class="paragraph">
<p>When run, we will see a trace of progress being made:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Connected to: Apache Tomcat/6.0.13
Found 5 web modules. Processing ...
Catalina:j2eeType=WebModule,name=//localhost/,J2EEApplication=none,J2EEServer=none
Catalina:j2eeType=WebModule,name=//localhost/host-manager,J2EEApplication=none,J2EEServer=none
Catalina:j2eeType=WebModule,name=//localhost/docs,J2EEApplication=none,J2EEServer=none
Catalina:j2eeType=WebModule,name=//localhost/examples,J2EEApplication=none,J2EEServer=none
Catalina:j2eeType=WebModule,name=//localhost/manager,J2EEApplication=none,J2EEServer=none</pre>
</div>
</div>
<div class="paragraph">
<p>The output will look like this:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/catalina.gif" alt="catalina"></span></p>
</div>
<div class="paragraph">
<p>Note: if you get errors running this script, see the <strong>Troubleshooting</strong> section below.</p>
</div>
</div>
<div class="sect3">
<h4 id="_oc4j_example">4.12.4. OC4J Example</h4>
<div class="paragraph">
<p>Here is a script to access <a href="http://www.oracle.com/technology/products/oc4j">OC4J</a> and print out some information about the server, its runtime and (as an example) the configured JMS destinations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import javax.management.remote.*
import oracle.oc4j.admin.jmx.remote.api.JMXConnectorConstant

def serverUrl = new JMXServiceURL('service:jmx:rmi://localhost:23791')
def serverPath = 'oc4j:j2eeType=J2EEServer,name=standalone'
def jvmPath = 'oc4j:j2eeType=JVM,name=single,J2EEServer=standalone'
def provider = 'oracle.oc4j.admin.jmx.remote'
def credentials = [
    (JMXConnectorConstant.CREDENTIALS_LOGIN_KEY): 'oc4jadmin',
    (JMXConnectorConstant.CREDENTIALS_PASSWORD_KEY): 'admin'
]
def env = [
    (JMXConnectorFactory.PROTOCOL_PROVIDER_PACKAGES): provider,
    (JMXConnector.CREDENTIALS): credentials
]
def server = JmxFactory.connect(serverUrl, env).MBeanServerConnection
def serverInfo = new GroovyMBean(server, serverPath)
def jvmInfo = new GroovyMBean(server, jvmPath)
println """Connected to $serverInfo.node. \
Server started ${new Date(serverInfo.startTime)}.
OC4J version:  $serverInfo.serverVersion from $serverInfo.serverVendor
JVM version:   $jvmInfo.javaVersion from $jvmInfo.javaVendor
Memory usage:  $jvmInfo.freeMemory bytes free, \
$jvmInfo.totalMemory bytes total
"""

def query = new javax.management.ObjectName('oc4j:*')
String[] allNames = server.queryNames(query, null)
def dests = allNames.findAll { name -&gt;
    name.contains('j2eeType=JMSDestinationResource')
}.collect { new GroovyMBean(server, it) }

println "Found ${dests.size()} JMS destinations. Listing ..."
dests.each { d -&gt; println "$d.name: $d.location" }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the result of running this script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Connected to LYREBIRD. Server started Thu May 31 21:04:54 EST 2007.
OC4J version:  11.1.1.0.0 from Oracle Corp.
JVM version:   1.6.0_01 from Sun Microsystems Inc.
Memory usage:  8709976 bytes free, 25153536 bytes total

Found 5 JMS destinations. Listing ...
Demo Queue: jms/demoQueue
Demo Topic: jms/demoTopic
jms/Oc4jJmsExceptionQueue: jms/Oc4jJmsExceptionQueue
jms/RAExceptionQueue: jms/RAExceptionQueue
OracleASRouter_store: OracleASRouter_store</pre>
</div>
</div>
<div class="paragraph">
<p>As a slight variation, this script displays a pie chart of memory usage using JFreeChart:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.jfree.chart.ChartFactory
import javax.swing.WindowConstants as WC
import javax.management.remote.*
import oracle.oc4j.admin.jmx.remote.api.JMXConnectorConstant

def url = 'service:jmx:rmi://localhost:23791'
def credentials = [:]
credentials[JMXConnectorConstant.CREDENTIALS_LOGIN_KEY] = "oc4jadmin"
credentials[JMXConnectorConstant.CREDENTIALS_PASSWORD_KEY] = "password"
def env = [:]
env[JMXConnectorFactory.PROTOCOL_PROVIDER_PACKAGES] = "oracle.oc4j.admin.jmx.remote"
env[JMXConnector.CREDENTIALS] = credentials
def server = JMXConnectorFactory.connect(new JMXServiceURL(url), env).MBeanServerConnection
def jvmInfo = new GroovyMBean(server, 'oc4j:j2eeType=JVM,name=single,J2EEServer=standalone')

def piedata = new org.jfree.data.general.DefaultPieDataset()
piedata.setValue "Free", jvmInfo.freeMemory
piedata.setValue "Used", jvmInfo.totalMemory - jvmInfo.freeMemory

def options = [true, true, true]
def chart = ChartFactory.createPieChart('OC4J Memory Usage', piedata, *options)
chart.backgroundPaint = java.awt.Color.white
def swing = new groovy.swing.SwingBuilder()
def frame = swing.frame(title:'OC4J Memory Usage', defaultCloseOperation:WC.EXIT_ON_CLOSE) {
    panel(id:'canvas') { rigidArea(width:350, height:250) }
}
frame.pack()
frame.show()
chart.draw(swing.canvas.graphics, swing.canvas.bounds)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which looks like:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/oc4jpie.gif" alt="oc4jpie"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="_weblogic_example">4.12.5. WebLogic Example</h4>
<div class="paragraph">
<p>This script prints out information about the server followed by information about JMS Destinations (as an example). Many other mbeans are <a href="http://docs.oracle.com/cd/E13222_01/wls/docs90/wlsmbeanref/core/index.html">available</a>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import javax.management.remote.*
import javax.management.*
import javax.naming.Context

def urlRuntime = '/jndi/weblogic.management.mbeanservers.runtime'
def urlBase = 'service:jmx:t3://localhost:7001'

def serviceURL = new JMXServiceURL(urlBase + urlRuntime)
def h = new Hashtable()
h.put(Context.SECURITY_PRINCIPAL, 'weblogic')
h.put(Context.SECURITY_CREDENTIALS, 'weblogic')
h.put(JMXConnectorFactory.PROTOCOL_PROVIDER_PACKAGES, 'weblogic.management.remote')
def server = JMXConnectorFactory.connect(serviceURL, h).MBeanServerConnection
def domainName = new ObjectName('com.bea:Name=RuntimeService,Type=weblogic.management.mbeanservers.runtime.RuntimeServiceMBean')
def rtName = server.getAttribute(domainName, 'ServerRuntime')
def rt = new GroovyMBean(server, rtName)
println "Server: name=$rt.Name, state=$rt.State, version=$rt.WeblogicVersion"
def destFilter = Query.match(Query.attr('Type'), Query.value('JMSDestinationRuntime'))
server.queryNames(new ObjectName('com.bea:*'), destFilter).each { name -&gt;
    def jms = new GroovyMBean(server, name)
    println "JMS Destination: name=$jms.Name, type=$jms.DestinationType, messages=$jms.MessagesReceivedCount"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Server: name=examplesServer, state=RUNNING, version=WebLogic Server 10.0  Wed May 9 18:10:27 EDT 2007 933139
JMS Destination: name=examples-jms!exampleTopic, type=Topic, messages=0
JMS Destination: name=examples-jms!exampleQueue, type=Queue, messages=0
JMS Destination: name=examples-jms!jms/MULTIDATASOURCE_MDB_QUEUE, type=Queue, messages=0
JMS Destination: name=examplesJMSServer!examplesJMSServer.TemporaryQueue0, type=Queue, messages=68
JMS Destination: name=examples-jms!quotes, type=Topic, messages=0
JMS Destination: name=examples-jms!weblogic.wsee.wseeExamplesDestinationQueue, type=Queue, messages=0
JMS Destination: name=examples-jms!weblogic.examples.ejb30.ExampleQueue, type=Queue, messages=0</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_spring_example">4.12.6. Spring Example</h4>
<div class="paragraph">
<p>You can also use Spring to automatically register beans as JMX aware.</p>
</div>
<div class="paragraph">
<p>Here is an example class (Calculator.groovy):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.springframework.jmx.export.annotation.*

@ManagedResource(objectName="bean:name=calcMBean", description="Calculator MBean")
public class Calculator {

    private int invocations

    @ManagedAttribute(description="The Invocation Attribute")
    public int getInvocations() {
        return invocations
    }

    private int base = 10

    @ManagedAttribute(description="The Base to use when adding strings")
    public int getBase() {
        return base
    }

    @ManagedAttribute(description="The Base to use when adding strings")
    public void setBase(int base) {
        this.base = base
    }

    @ManagedOperation(description="Add two numbers")
    @ManagedOperationParameters([
        @ManagedOperationParameter(name="x", description="The first number"),
        @ManagedOperationParameter(name="y", description="The second number")])
    public int add(int x, int y) {
        invocations++
        return x + y
    }

    @ManagedOperation(description="Add two strings representing numbers of a particular base")
    @ManagedOperationParameters([
        @ManagedOperationParameter(name="x", description="The first number"),
        @ManagedOperationParameter(name="y", description="The second number")])
    public String addStrings(String x, String y) {
        invocations++
        def result = Integer.valueOf(x, base) + Integer.valueOf(y, base)
        return Integer.toString(result, base)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the Spring configuration file (beans.xml):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"&gt;
    &lt;bean id="mbeanServer"
          class="org.springframework.jmx.support.MBeanServerFactoryBean"&gt;
        &lt;property name="locateExistingServerIfPossible" value="true"/&gt;
    &lt;/bean&gt;

    &lt;bean id="exporter"
          class="org.springframework.jmx.export.MBeanExporter"&gt;
        &lt;property name="assembler" ref="assembler"/&gt;
        &lt;property name="namingStrategy" ref="namingStrategy"/&gt;
        &lt;property name="beans"&gt;
            &lt;map&gt;
                &lt;entry key="bean:name=defaultCalcName" value-ref="calcBean"/&gt;
            &lt;/map&gt;
        &lt;/property&gt;
        &lt;property name="server" ref="mbeanServer"/&gt;
        &lt;property name="autodetect" value="true"/&gt;
    &lt;/bean&gt;

    &lt;bean id="jmxAttributeSource"
          class="org.springframework.jmx.export.annotation.AnnotationJmxAttributeSource"/&gt;

    &lt;!-- will create management interface using annotation metadata --&gt;
    &lt;bean id="assembler"
          class="org.springframework.jmx.export.assembler.MetadataMBeanInfoAssembler"&gt;
        &lt;property name="attributeSource" ref="jmxAttributeSource"/&gt;
    &lt;/bean&gt;

    &lt;!-- will pick up the ObjectName from the annotation --&gt;
    &lt;bean id="namingStrategy"
          class="org.springframework.jmx.export.naming.MetadataNamingStrategy"&gt;
        &lt;property name="attributeSource" ref="jmxAttributeSource"/&gt;
    &lt;/bean&gt;

    &lt;bean id="calcBean"
          class="Calculator"&gt;
        &lt;property name="base" value="10"/&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a script which uses this bean and configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import org.springframework.context.support.ClassPathXmlApplicationContext
import java.lang.management.ManagementFactory
import javax.management.ObjectName
import javax.management.Attribute

// get normal bean
def ctx = new ClassPathXmlApplicationContext("beans.xml")
def calc = ctx.getBean("calcBean")

Thread.start {
    // access bean via JMX, use a separate thread just to
    // show that we could access remotely if we wanted
    def server = ManagementFactory.platformMBeanServer
    def mbean = new GroovyMBean(server, 'bean:name=calcMBean')
    sleep 1000
    assert 8 == mbean.add(7, 1)
    mbean.Base = 8
    assert '10' == mbean.addStrings('7', '1')
    mbean.Base = 16
    sleep 2000
    println "Number of invocations: $mbean.Invocations"
    println mbean
}

assert 15 == calc.add(9, 6)
assert '11' == calc.addStrings('10', '1')
sleep 2000
assert '20' == calc.addStrings('1f', '1')</code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is the resulting output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Number of invocations: 5
MBean Name:
  bean:name=calcMBean

Attributes:
  (rw) int Base
  (r) int Invocations
Operations:
  int add(int x, int y)
  java.lang.String addStrings(java.lang.String x, java.lang.String y)
  int getInvocations()
  int getBase()
  void setBase(int p1)</pre>
</div>
</div>
<div class="paragraph">
<p>You can even attach to the process while it is running with <a href="http://docs.oracle.com/javase/1.5.0/docs/guide/management/jconsole.html">jconsole</a>. It will look something like:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/jconsole.gif" alt="jconsole"></span></p>
</div>
<div class="paragraph">
<p>We started the Groovy application with the <code>-Dcom.sun.management.jmxremote</code> JVM argument using a Java 5 JVM.</p>
</div>
<div class="paragraph">
<p>See also:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="userGuides.html#_dynamic-language-beans-in-spring">Dynamic language beans in Spring</a></p>
</li>
<li>
<p><a href="userGuides.html#_using-spring-factories-with-groovy">Using Spring Factories with Groovy</a></p>
</li>
<li>
<p><a href="http://static.springsource.org/spring/docs/3.2.x/spring-framework-reference/html/jmx.html">Spring JMX Documentation</a></p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_troubleshooting">4.12.7. Troubleshooting</h4>
<div class="sect4">
<h5 id="_groovy_lang_missingmethodexception_or_groovy_lang_groovyruntimeexception">groovy.lang.MissingMethodException or groovy.lang.GroovyRuntimeException</h5>
<div class="paragraph">
<p>If you get an error like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>groovy.lang.MissingMethodException: No signature of method:
javax.management.remote.rmi.RMIConnector$RemoteMBeanServerConnection.queryMBeans()
is applicable for argument types: (javax.management.ObjectName, null)
values: {Catalina:*, null}</pre>
</div>
</div>
<div class="paragraph">
<p>or like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Caught: groovy.lang.GroovyRuntimeException: Could not find matching constructor for: groovy.util.GroovyMBean(javax.management.remote.rmi.RMIConnector$RemoteMBeanServerConnection, java.lang.String)</pre>
</div>
</div>
<div class="paragraph">
<p>you have to move away or delete "mx4j-*.jar" from <code>$GROOVY_HOME/lib</code>. MX4J is designed to add <code>javax.management</code> classes to 1.4 JVMs. If you already have a newer JMX jar on your classpath or are using a Java 5 or higher JVM, the MX4J classes will be incompatible with the ones from the newer Sun JVMs or newer versions of JMX.</p>
</div>
</div>
<div class="sect4">
<h5 id="_java_lang_securityexception">java.lang.SecurityException</h5>
<div class="paragraph">
<p>If you get the following error, your container&#8217;s JMX access is password protected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java.lang.SecurityException: Authentication failed! Credentials required</pre>
</div>
</div>
<div class="paragraph">
<p>To fix that, add an environment with the credentials when connecting, like this (password has to be set before that):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def jmxEnv = null
if (password != null) {
    jmxEnv = [(JMXConnector.CREDENTIALS): (String[])["monitor", password]]
}
def connector = JMXConnectorFactory.connect(new JMXServiceURL(serverUrl), jmxEnv)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Details for the software you are trying to monitor/manage may differ slightly. Check out the other examples using credentials above if appropriate (e.g. OC4J and WebLogic). If you still have troubles, you will have to consult the documentation for the software you are trying to monitor/manage for details on how to provide credentials.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jmxbuilder">4.12.8. JmxBuilder</h4>
<div class="paragraph">
<p><strong>JmxBuilder is a Groovy-based domain specific language for the Java Management Extension (JMX) API</strong>. It uses the builder pattern (FactoryBuilder) to create an internal DSL that facilitates the exposure of POJO&#8217;s and Groovy beans as management components via the MBean server. JmxBuilder hides the complexity of creating and exporting management beans via the JMX API and provides a set of natural Groovy constructs to interact with the JMX infrastructure.</p>
</div>
<div class="sect4">
<h5 id="_instantiating_jmxbuilder">Instantiating JmxBuilder</h5>
<div class="paragraph">
<p>To start using JmxBuilder, simply make sure the jar file is on your class path. Then you can do the following in your code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def jmx = new JmxBuilder()</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>That&#8217;s it!</strong> You are now ready to use the JmxBuilder.</p>
</div>
<div class="paragraph">
<p><strong>NOTE</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>You can pass in an instance of <strong>your own MBeanServer</strong> to the builder (<strong>JmxBuilder(MBeanServer)</strong>)</p>
</li>
<li>
<p>If no MBeanServer is specified, the builder instance will default to the underlying platform MBeanServer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Once you have an instance of JmxBuilder, you are now ready to invoke any of its builder nodes.</p>
</div>
</div>
<div class="sect4">
<h5 id="_jmx_connectors">JMX Connectors</h5>
<div class="paragraph">
<p>Remote connectivity is a crucial part of the JMX architecture. JmxBuilder facilitates the creation of connector servers and connector clients with nimimal amount of coding.</p>
</div>
<div class="sect5">
<h6 id="_connector_server">Connector Server</h6>
<div class="paragraph">
<p>JmxBuilder.connectoServer() supports the full Connector api syntax and will let you specify properties, override the URL, specify your own host, etc.</p>
</div>
<div class="paragraph">
<p><strong>Syntax</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>jmx.connectorServer(
    protocol:"rmi",
    host:"...",
    port:1099,
    url:"...",
    properties:[
        "authenticate":true|false,
        "passwordFile":"...",
        "accessFile":"...",
        "sslEnabled" : true | false
        // any valid connector property
    ]
)</pre>
</div>
</div>
<div class="paragraph">
<p>Note that the serverConnector node will accept four ServerConnector property aliases (authenticate, passwordFile,accessFile, and sslEnabled). You can use these aliases or provided any of the RMI-supported properties.</p>
</div>
<div class="paragraph">
<p><strong>Example - Connector Server (see correction below)</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">jmx.connectorServer(port: 9000).start()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The snippet above returns an RMI connector that will start listening on port 9000. By default, the builder will internally generate URL <strong>"service:jmx:rmi:///jndi/rmi://localhost:9000/jmxrmi"</strong>.</p>
</div>
<div class="paragraph">
<p><em>NOTE: Sadly you are as likely to get something like the following when attempting to run the previous snippet of code (example is incomplete, see below):</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre>Caught: java.io.IOException: Cannot bind to URL [rmi://localhost:9000/jmxrmi]: javax.naming.ServiceUnavailableException [Root exception is java.rmi.ConnectException: Connection refused to host: localhost; nested exception is:
?????? java.net.ConnectException: Connection refused]
??</pre>
</div>
</div>
<div class="paragraph">
<p><em>This occurs on Mac and Linux (CentOS 5) with Groovy 1.6 installed. Perhaps there were assumptions made about the configuration of the /etc/hosts file?</em></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="icon-note" title="Note"></i>
</td>
<td class="content">
<em>The correct example is shown below.</em>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Connector Example (Corrected) - Connector Server</strong></p>
</div>
<div class="paragraph">
<p>The example above does not create the RMI registry. So, in order to export, you have to first export the RMI object registry (make sure to import <code>java.rmi.registry.LocateRegistry</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">import java.rmi.registry.LocateRegistry
//...

LocateRegistry.createRegistry(9000)
jmx.connectorServer(port: 9000).start()</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_connector_client">Connector Client</h6>
<div class="paragraph">
<p>JmxBuilder.connectorClient() node lets you create JMX connector client object to connect to a JMX MBean Server.</p>
</div>
<div class="paragraph">
<p><strong>Syntax</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre>jmx.connectorClient (
    protocol:"rmi",
    host:"...",
    port:1099,
    url:"...",
)</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Example - Client Connector</strong></p>
</div>
<div class="paragraph">
<p>Creating a connector client can be done just as easily. With one line of code, you can create an instance of a JMX Connector Client as shown below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def client = jmx.connectorClient(port: 9000)
client.connect()</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can then access the MBeanServerConnection associated with the connector using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">client.getMBeanServerConnection()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_jmxbuilder_mbean_export">JmxBuilder MBean Export</h5>
<div class="paragraph">
<p>You can <strong>export a Java object or a Groovy object</strong> with minimal coding. JmxBuilder will even find and <strong>export dynamic Groovy methods</strong> injected at runtime.</p>
</div>
<div class="sect5">
<h6 id="_implicit_vs_explicit_descriptors">Implicit vs Explicit Descriptors</h6>
<div class="paragraph">
<p>When using the builder, you can <strong>let JmxBuilder implicitly generate</strong> all of your MBean descriptor info. This is useful when you want to write minimal code to quickly export your beans. You can also explicitly declare all descriptor info for the bean. This gives you total control on how you want to describe every piece of information that you want to export for the underlying bean.</p>
</div>
</div>
<div class="sect5">
<h6 id="_the_jmxbuilder_export_node">The JmxBuilder.export() Node</h6>
<div class="paragraph">
<p>The <strong>JmxBuilder.export() node provides a container</strong> where all management entities to be exported to the MBeanServer are placed. You can place one or more bean() or timer() nodes as children of the export() node. JmxBuilder will <strong>automatically batch export the entities described</strong> by the nodes to the MBean server for management (see example below).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def beans = jmx.export {
    bean(new Foo())
    bean(new Bar())
    bean(new SomeBar())
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the code snippet above, <strong>JmxBuilder.export() will export three management beans</strong> to the MBean server.</p>
</div>
</div>
<div class="sect5">
<h6 id="_jmxbuilder_export_syntax">JmxBuilder.export() Syntax</h6>
<div class="paragraph">
<p>JmxBuilder.export() node supports the <strong>registrationPolicy</strong> parameter to specify how JmxBuilder will behave to resolve bean name collision during MBean registration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>jmx.export(policy:"replace|ignore|error")
or
jmx.export(regPolicy:"replace|ignore|error")</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>replace</strong> - JmxBuilder.export() will replance any bean already registered with the MBean during export.</p>
</li>
<li>
<p><strong>ignore</strong> - The bean being exported will be ignored if the same bean is already registered.</p>
</li>
<li>
<p><strong>error</strong> - JmxBuilder.export() throws an error upon bean name collision during registration.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_integration_with_groovymbean_class">Integration with GroovyMBean Class</h6>
<div class="paragraph">
<p>When you export an MBean to the MBeanServer, <strong>JmxBuilder will return an instance of GroovyMBean</strong> representing the management bean that have been exported by the builder. Nodes such as <strong>bean()</strong> and <strong>timer()</strong> will return an instances of GroovyMBean when they are invoked. The <strong>export()</strong> node returns an <strong>array of all of GroovyMBean[]</strong> representing all managed objects exported to the MBean server.</p>
</div>
</div>
<div class="sect5">
<h6 id="_mbean_registration_with_jmxbuilder_bean">MBean Registration with JmxBuilder.bean()</h6>
<div class="paragraph">
<p>This portion of this reference uses class <strong>RequestController</strong> to illustrate how to use JmxBuilder to export runtime management beans. The class is for illustration purpose and can be a POJO or a Groovy bean.</p>
</div>
<div class="paragraph">
<p><strong>RequestController</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class RequestController {
    // constructors
    RequestController() { super() }
    RequestController(Map resource) { }

    // attributes
    boolean isStarted() { true }
    int getRequestCount() { 0 }
    int getResourceCount() { 0 }
    void setRequestLimit(int limit) { }
    int getRequestLimit() { 0 }

    // operations
    void start() { }
    void stop() { }
    void putResource(String name, Object resource) { }
    void makeRequest(String res) { }
    void makeRequest() { }
}</code></pre>
</div>
</div>
<div class="sect6">
<h7 id="_implicit_export">Implicit Export</h7>
<div class="paragraph">
<p>As mentioned earlier, you can use JmxBuilder&#8217;s flexible syntax to export any POJO/POGO with no descriptor. The builder can automatically describe all aspects of the management beans using implicit defaults. These default values can easily be overridden as we&#8217;ll see in this in the next section.</p>
</div>
<div class="paragraph">
<p>The simplest way to export a POJO or POGO is listed below.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">jmx.export {
    bean(new RequestController(resource: "Hello World"))
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>What this does:</strong></p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, the <strong>JmxBuilder.export() node will export</strong> an MBean to the MBeanServer representing <strong>the declared POJO</strong> instance.</p>
</li>
<li>
<p>The builder will <strong>generate a default ObjectName</strong> for the MBean and all other MBean descriptor information.</p>
</li>
<li>
<p><strong>JmxBuilder will automatically export</strong> all declared <strong>attributes</strong> (MBean getter/setters), <strong>constructors</strong>, and <strong>operations</strong> on the instance.</p>
</li>
<li>
<p>The exported <strong>attributes</strong> will have <strong>read-only</strong> visibility.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Remember, <strong>JmxBuilder.export() returns an array of GroovyMBean[] objects</strong> for all exported instances. So, once you call JmxBuilder.export(), <strong>you have immediate access to the underlying MBean proxy</strong> (via GroovyMBean).</p>
</div>
<div class="sect7">
<h8 id="_jconsole_view_of_exported_bean">JConsole view of Exported Bean</h8>
<div class="paragraph">
<p><span class="image"><img src="../assets/img/jconsole-implicit-export.png" alt="jconsole-implicit-export"></span></p>
</div>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_jmxbuilder_bean_syntax">JmxBuilder.bean() Syntax</h6>
<div class="paragraph">
<p>The JmxBuilder.bean() node supports an extensive set of descriptors to describe your bean for management. The JMX MBeanServer uses these descriptors to expose meta data about the bean exposed for management.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>jmx.export {
    bean(
        target:bean instance,
        name:ObjectName,
        desc:"...",
        attributes:"*",
        attributes:[]
        attributes:[ "AttrubuteName1","AttributeName2",...,"AttributeName_n" ]
        attributes:[
            "AttributeName":"*",
            "AttributeName":[
                desc:"...",
                defaultValue:value,
                writable:true|false,
                editable:true|false,
                onChange:{event-&gt; // event handler}
            ]
        ],

        constructors:"*",
        constructors:[
            "Constructor Name":[],
            "Constructor Name":[ "ParamType1","ParamType2,...,ParamType_n" ],
            "Constructor Name":[
                desc:"...",
                params:[
                    "ParamType1":"*",
                    "ParamType2":[desc:"...", name:"..."],...,
                    "ParamType_n":[desc:"...", name:"..."]
                ]
            ]
        ],

        operations:"*",
        operations:[ "OperationName1", "OperationName2",...,"OperationNameN" ],
        operations:[
            "OperationName1":"*",
            "OperationName2":[ "type1","type2,"type3" ]
            "OperationName3":[
                desc:"...",
                params:[
                    "ParamType1":"*"
                    "ParamType2":[desc:"...", name:"..."],...,
                    "ParamType_n":[desc:"...", name:"..."]
                ],
                onInvoked:{event-&gt; JmxBuilder.send(event:"", to:"")}
            ]
        ],

        listeners:[
            "ListenerName1":[event: "...", from:ObjectName, call:{event-&gt;}],
            "ListenerName2":[event: "...", from:ObjectName, call:&amp;methodPointer]
        ]

    )
}</pre>
</div>
</div>
<div class="paragraph">
<p>Instead of describing the entire node, the following section explore each attribute separately.</p>
</div>
</div>
<div class="sect5">
<h6 id="_bean_node_specifying_mbean_objectname">Bean() Node - Specifying MBean ObjectName</h6>
<div class="paragraph">
<p>Using the bean() node descriptors, you can specify your own MBean ObjectName.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def ctrl = new RequestController(resource:"Hello World")
def beans = jmx.export {
    bean(target: ctrl, name: "jmx.tutorial:type=Object")
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The ObjectName can be specified as a String or an instance of the ObjectName.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_bean_node_attribute_export">Bean() Node - Attribute Export</h5>
<div class="paragraph">
<p>JMX attributes are the setters and getters on the underlying bean. The JmxBuilder.bean() node provides several ways to flexibly describe and export MBean attributes. You can combine them however you want to achieve any level of attribute visibility. Let&#8217;s take a look.</p>
</div>
<div class="sect5">
<h6 id="_export_all_attributes_with_wildcard">Export All Attributes with Wildcard "*"</h6>
<div class="paragraph">
<p>The following code snippet <strong>will describe and export all attributes</strong> on the bean as read-only. <strong>JmxBuilder will use default values</strong> to describe the attributes that exported for management.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def objName = new ObjectName("jmx.tutorial:type=Object")
def beans = jmx.export {
    bean(target: new RequestController(),
    name: objName,
    attributes: "*")
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_export_attribute_list">Export Attribute List</h6>
<div class="paragraph">
<p>JmxBuilder will let you specify a list of attributes to export.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def objName = new ObjectName("jmx.tutorial:type=Object")
def beans = jmx.export {
    bean(
        target: new RequestController(),
        name: objName,
        attributes: ["Resource", "RequestCount"]
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the snippet above, <strong>only the "Resource" and "RequestCount" attributes will be exported</strong>. Again, since no descriptors are provided, <strong>JmxBuilder will use sensible defaults</strong> to describe the exported attributes.</p>
</div>
</div>
<div class="sect5">
<h6 id="_export_attribute_with_explicit_descriptors">Export Attribute with Explicit Descriptors</h6>
<div class="paragraph">
<p>One of the strengths of JmxBuilder is its flexibility in describing MBean. With the builder you can describe all aspects of the MBeans attribute that you want to export to the MBeanServer (see syntax above).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def objName = new ObjectName("jmx.tutorial:type=Object")
def beans = jmx.export {
    bean(
        target: new RequestController(),
        name: objName,
        attributes: [
            "Resource": [desc: "The resource to request.", readable: true, writable: true, defaultValue: "Hello"],
            "RequestCount": "*"
        ]
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the snippet above, attribute <strong>"Resource" is fully-described</strong> using all supported descriptors (i.e. desc, readable, writable, defaultValue) for a JMX attribute. However, we use the wildcard to describe attribute <strong>RequestCount</strong> and it will be exported and described using defaults.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_bean_node_constructor_export">Bean() Node - Constructor Export</h5>
<div class="paragraph">
<p>JmxBuilder <strong>supports the explicit description and export of constructors</strong> defined in the underlying bean. There are several options available when exporting constructors. You can combine them however you want to achieve the desired level of manageability.</p>
</div>
<div class="sect5">
<h6 id="_export_all_constructors_with">Export all Constructors with "*"</h6>
<div class="paragraph">
<p>You can use the builder&#8217;s special <em>""</em> <strong>notation to *export all constructors</strong> declared on the underlying bean. The builder will use default values to describe the MBean constructors.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def objName = new ObjectName("jmx.tutorial:type=Object")
def beans = jmx.export {
    bean(
        target: new RequestController(),
        name: objName,
        constructors: "*"
    )
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_export_constructors_using_parameter_descriptor">Export Constructors using Parameter Descriptor</h6>
<div class="paragraph">
<p>JmxBuilder lets you <strong>target specific constructor</strong> to export <strong>by describing the parameter signature</strong>. This is useful when you have several constructors with different parameter signature and you want to export specific constructors.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def objName = new ObjectName("jmx.tutorial:type=Object")
def beans = jmx.export {
    bean(
        target: new RequestController(),
        name: objName,
        constructors: [
            "RequestController": ["Object"]
        ]
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, JmxBuilder will <strong>export a constructor that takes one parameter of type "Object"</strong>. Again, JmxBuilder will use default values to fill in the description of the constructor and the parameters.</p>
</div>
</div>
<div class="sect5">
<h6 id="_export_constructor_with_explicit_descriptors">Export Constructor with Explicit Descriptors</h6>
<div class="paragraph">
<p>JmxBuilder allows you to <strong>fully-describe</strong> the constructor that you want to target for export (see syntax above).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def objName = new ObjectName("jmx.tutorial:type=Object")
def beans = jmx.export {
    bean(target: new RequestController(), name: objName,
        constructors: [
            "RequestController": [
                desc: "Constructor takes param",
                params: ["Object" : [name: "Resource", desc: "Resource for controller"]]
            ]
        ]
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the code above, JmxBuilder will target a constructor that takes one parameter for export to the MBeanServer. Notice how the constructor can be fully-described using all optional descriptor keys including parameter descriptors.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_bean_node_operation_export">Bean() Node - Operation Export</h5>
<div class="paragraph">
<p>Similar to constructors, JmxBuilder supports the description and export of MBean operations using a flexible notation (see above for syntax). You can combine these notations however you want to achieve the level of operation manageability desired.</p>
</div>
<div class="sect5">
<h6 id="_export_all_operations_with">Export All Operations with "*"</h6>
<div class="paragraph">
<p>You can use the builder&#8217;s special <em>""</em>' <strong>notation to *export all operations</strong> defined on the bean to be exposed for management. The builder will use default descriptor values for the operations being exported.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def objName = new ObjectName("jmx.tutorial:type=Object")
def beans = jmx.export {
    bean(
        target: new RequestController(),
        name: objName,
        operations: "*"
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this snippet, JmxBuilder will <strong>export all bean operations</strong> and will use default values to describe them in the MBeanServer.</p>
</div>
</div>
<div class="sect5">
<h6 id="_export_operation_list">Export Operation List</h6>
<div class="paragraph">
<p>JmxBuilder has a shorthand notation that lets you quickly target operations to be exported by providing a list of methods to export.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def objName = new ObjectName("jmx.tutorial:type=Object")
def beans = jmx.export {
    bean(
        target: new RequestController(),
        name: objName,
        operations: ["start", "stop"]
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the snippet above, the <strong>builder will only export methods start() and stop()</strong>. All other methods will be ignored. JmxBuilder will use default descriptor values to describe the operations being exported.</p>
</div>
</div>
<div class="sect5">
<h6 id="_export_operations_by_signature">Export Operations by Signature</h6>
<div class="paragraph">
<p>Using JmxBuilder, you can target methods to export for management using the methods&#8217;s parameter signature. This is useful when you want to distinguish methods with the same name that you want to export (i.e. stop() instead of stop(boolean)).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def objName = new ObjectName("jmx.tutorial:type=Object")
def beans = jmx.export {
    bean(
        target: new RequestController(),
        name: objName,
        operations: [
            "makeRequest": ["String"]
        ]
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the snipet above, JmxBuilder would <strong>select method makeRequest(String)</strong> to be exported instead of the other version makeRequest() which takes no parameter. In this shorthand context, the signature is specified as a list of type (i.e. "String").</p>
</div>
</div>
<div class="sect5">
<h6 id="_export_operations_with_explicit_descriptors">Export Operations with Explicit Descriptors</h6>
<div class="paragraph">
<p>JmxBuilder supports detailed descriptors for bean operations. You can supply deep descriptor info about any operation on your bean including a name, description, method parameters, parameter type, and parameter description.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def objName = new ObjectName("jmx.tutorial:type=Object")
def beans = jmx.export {
    bean(target: new RequestController(), name: objName,
        operations: [
            "start": [desc: "Starts request controller"],
            "stop": [desc: "Stops the request controller"],
            "setResource": [params: ["Object"]],
            "makeRequest": [
                desc: "Executes the request.",
                params: [
                    "String": [name: "Resource", desc: "The resource to request"]
                ]
            ]
        ]
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The snippet above shows all of the ways JmxBuilder allows you to describe an operation targeted for management:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Operations <strong>start() and stop()</strong> are described by the "desc" key (this is enough since there are no params).</p>
</li>
<li>
<p>In operation <strong>setResource()</strong> uses of a shorthand version of <strong>params</strong>: to describe the parameters for the method.</p>
</li>
<li>
<p><strong>makeRequest()</strong> uses the the extended descriptor syntax to describe all aspects of the operation.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_embedding_descriptor">Embedding Descriptor</h5>
<div class="paragraph">
<p>JmxBuilder supports the ability to <strong>embed descriptors directly in your Groovy class</strong>. So, instead of wrapping your description around the declared object (as we&#8217;ve seen here), you can ebmed your JMX descriptors directly in your class.</p>
</div>
<div class="paragraph">
<p><strong>RequestControllerGroovy</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class RequestControllerGroovy {
    // attributes
    boolean started
    int requestCount
    int resourceCount
    int requestLimit
    Map resources

    // operations
    void start() { }
    void stop(){ }
    void putResource(String name, Object resource) { }
    void makeRequest(String res) { }
    void makeRequest() { }

    static descriptor = [
        name: "jmx.builder:type=EmbeddedObject",
        operations: ["start", "stop", "putResource"],
        attributes: "*"
    ]
}

// export
jmx.export(
    bean(new RequestControllerGroovy())
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>There are two things going on in the code above:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Groovy class RequestControllerGroovy is defined and includes a <strong>static descriptor</strong> member. That member is used to declare a JmxBuilder descriptor to describe member of the class targeted for JMX export.</p>
</li>
<li>
<p>The second part of the code shows how to use JmxBuilder to export that class for management.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_timer_export">Timer Export</h5>
<div class="paragraph">
<p>JMX standards mandate that the implementation of the API makes available a timer service. Since JMX is a component-based architecture, timers provide an excellent signaling mechanism to communicate to registered listener components in the MBeanServer. JmxBuilder supports the creation and export of timers using the same easy syntax we&#8217;ve seen so far.</p>
</div>
<div class="sect5">
<h6 id="_timer_node_syntax">Timer Node Syntax</h6>
<div class="listingblock">
<div class="content">
<pre>timer(
    name:ObjectName,
    event:"...",
    message:"...",
    data:dataValue
    startDate:"now"|dateValue
    period:"99d"|"99h"|"99m"|"99s"|99
    occurences:long
)</pre>
</div>
</div>
<div class="paragraph">
<p>The timer() node supports several attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>name</strong>: - Required The qualified JMX ObjectName instance (or String) for the timer.</p>
</li>
<li>
<p><strong>event</strong>: - The JMX event type string that will be broadcast with every timing signal (default <strong>"jmx.builder.event"</strong>).</p>
</li>
<li>
<p><strong>message</strong>: - An optional string value that can be sent to listneners.</p>
</li>
<li>
<p><strong>data</strong>: - An optional object that can be sent to listeners of timing signal.</p>
</li>
<li>
<p><strong>startDate</strong>: - When to start timer. Set of valid values [ "now", date object ]. Default is "now"</p>
</li>
<li>
<p><strong>period</strong>: - A timer&#8217;s period expressed as either a number of millisecond or time unit (day, hour, minute, second). See description below.</p>
</li>
<li>
<p><strong>occurences</strong>: - A number indicating the number of time to repeat timer. Default is forever.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_exporting_a_timer">Exporting a Timer</h6>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def timer = jmx.timer(name: "jmx.builder:type=Timer", event: "heartbeat", period: "1s")
timer.start()</code></pre>
</div>
</div>
<div class="paragraph">
<p>This snippet above <strong>describes, creates, and exports a standard JMX Timer</strong> component. Here, the <strong>timer()</strong> node <strong>returns a GroovyMBean</strong> that represents the registered timer MBean in the MBeanServer.</p>
</div>
<div class="paragraph">
<p>An <strong>alternative way of exporting timers</strong> is within the JmxBuilder.export() node.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def beans = jmx.export {
    timer(name: "jmx.builder:type=Timer1", event: "event.signal", period: "1s")
    timer(name: "jmx.builder:type=Timer2", event: "event.log", period: "1s")
}
beans[0].start()
beans[1].start()</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_timer_period">Timer Period</h6>
<div class="paragraph">
<p>The <strong>timer() node supports a flexible notation</strong> for specifying the <strong>timer period values</strong>. You can specify the time in second, minutes, hour, and day. The default is millisecond.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>timer(<strong>period: 100</strong>) = 100 millisecond</p>
</li>
<li>
<p>timer(<strong>period: "1s"</strong>) = 1 second</p>
</li>
<li>
<p>timer(<strong>period: "1m"</strong>) = 1 minute</p>
</li>
<li>
<p>timer(<strong>period: "1h"</strong>) = 1 hour</p>
</li>
<li>
<p>timer(<strong>period: "1d"</strong>) = 1 day</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The node will automatically translate.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_jmxbuilder_and_events">JmxBuilder and Events</h5>
<div class="paragraph">
<p>An integral part of <strong>JMX</strong> is its <strong>event model</strong>. Registered management beans can <strong>communicate with each other by broadcasting events</strong> on the MBeanServer&#8217;s event bus. <strong>JmxBuilder provides several ways to easily listen and react to events</strong> broadcasted on the MBeanServer&#8217;s event bus. Developers can <strong>capture any event on the bus or throw their own</strong> to be consumed by other components registered on the MBeanServer.</p>
</div>
<div class="sect5">
<h6 id="_event_handling_closures">Event Handling Closures</h6>
<div class="paragraph">
<p>JmxBuilder leverages Groovy&#8217;s use of closures to provide simple, yet elegant, mean of reacting to JMX events. JmxBuilder supports two closure signatures:</p>
</div>
<div class="sect6">
<h7 id="_parameterless">Parameterless</h7>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">callback = { -&gt;
    // event handling code here.
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>JmxBuilder executes the closure and passes no information about the event that was captured on the bus.</p>
</div>
</div>
<div class="sect6">
<h7 id="_with_event_parameter">With Event Parameter</h7>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">callback = { event -&gt;
    // event handling code
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>JmxBuilder will pass an <strong>"event" object to the closure</strong> using this format. The event object contains information about the event was intercepted so that it can be handled by the handler. The parameter will contain different set of info depending on the event that was captured.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_handling_attribute_onchange_event">Handling Attribute onChange Event</h6>
<div class="paragraph">
<p>When describing attributes (see bean() node section above), you can <strong>provide a closure (or method pointer) for callback to be executed when the value of the attribute is updated</strong> on the exported MBean. This gives developers an opportunity to listen to and react to state changes on the MBean.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">jmx.export {
    bean(
        target: new RequestController(), name: "jmx.tutorial:type=Object",
        attributes: [
            "Resource": [
                readable: true, writable: true,
                onChange: { e -&gt;
                    println e.oldValue
                    println e.newValue
                }
            ]
        ]
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample snippet above shows how to <strong>specify an "onChange" callback closure</strong> when describing MBean attributes. In this sample code, whenever attribute "Resource" is updated via the exported MBean, the <strong>onChange event will be executed</strong>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_attribute_onchange_event_object">Attribute onChange Event Object</h6>
<div class="paragraph">
<p>When handling the attribute onChange event, the handler closure will receive an event object with the following info:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>event.<strong>oldValue</strong> - the previous attribute value before the change event.</p>
</li>
<li>
<p>event.<strong>newValue</strong> - the new value of the attribute after the change.</p>
</li>
<li>
<p>event.<strong>attribute</strong> - the name of the attribute on which the event occured.</p>
</li>
<li>
<p>event.<strong>attributeType</strong> - the data type of the attribute that causes the event.</p>
</li>
<li>
<p>event.<strong>sequenceNumber</strong> - a numeric value representing the sequence number of event.</p>
</li>
<li>
<p>event.<strong>timeStamp</strong> - a time stamp for the event occurence.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_handling_operation_oncall_event">Handling Operation onCall Event</h6>
<div class="paragraph">
<p>Similar to mbean attributes, JmxBuilder affords developers the <strong>ability to listen for operation invokation</strong> on an MBean registered in the MBeaServer. JmxBuilder accepts a <strong>callback closure that will be executed after the MBean method has invoked</strong>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class EventHandler {
    void handleStart(e){
        println e
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def handler = new EventHandler()

def beans = jmx.export {
    bean(target: new RequestController(), name: "jmx.tutorial:type=Object",
        operations: [
            "start": [
                desc:"Starts request controller",
                onCall:handler.&amp;handleStart
            ]
        ]
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The snippet above <strong>shows how to declare an "onCall" closure to be used as listener</strong> when operation "start()" is invoked on the MBean. This sample <strong>uses the method pointer syntax</strong> to illustrate the versatility of JmxBuilder.</p>
</div>
</div>
<div class="sect5">
<h6 id="_operation_oncall_event_object">Operation onCall Event Object</h6>
<div class="paragraph">
<p>When handling the operation onCall event, the callback closure will receive an event object with the following info:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>event.<strong>event</strong> - the event type string that was broadcasted.</p>
</li>
<li>
<p>event.<strong>source</strong> - The object on which the method was invoked.</p>
</li>
<li>
<p>event.<strong>data</strong> - the data type of the attribute that causes the event.</p>
</li>
<li>
<p>event.<strong>sequenceNumber</strong> - a numeric value representing the sequence number of event.</p>
</li>
<li>
<p>event.<strong>timeStamp</strong> - a time stamp for the event occurence.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_listener_mbean">Listener MBean</h5>
<div class="paragraph">
<p>When you export an MBean with the bean() node, you can define events the MBean can listen and react to. The bean() node provides a "listeners:" attribute that lets you define event listeners that your bean can react to.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def beans = jmx.export {
    timer(name: "jmx.builder:type=Timer", event: "heartbeat", period: "1s").start()
    bean(target: new RequestController(), name: "jmx.tutorial:type=Object",
        operations: "*",
        listeners: [
            heartbeat: [
                from: "jmx.builder:type=Timer",
                call: { e -&gt;
                    println e
                }
            ]
        ]
    )
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the sample above, we see the <strong>syntax for adding listeners to an exported MBean</strong>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Fist, a <strong>timer is exported</strong> and started.</p>
</li>
<li>
<p>Then an <strong>MBean is declared that will listen to the timer</strong> event and do something meaningful.</p>
</li>
<li>
<p>The <strong>"heartbeat:"</strong> name is arbitrary and has no correlation to the timer declared above.</p>
</li>
<li>
<p>The <strong>source</strong> of the event <strong>is specified using the "from:" attribute</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can also specify an <strong>event type</strong> you are interested in receiving from a broadcaster (since a broadcaster can be emitting multiple events).</p>
</div>
<div class="sect5">
<h6 id="_listening_to_jmx_events">Listening to JMX Events</h6>
<div class="paragraph">
<p>In some cases, you will want to create stand-alone event listensers (not attached to exported MBeans). JmxBuilder provides the Listener() node to let you create JMX listeners that can listen to MBeanServer events. This is useful when creating JMX client applications to monitor/manage JMX agents on remote JMX MBeanServers.</p>
</div>
</div>
<div class="sect5">
<h6 id="_listener_node_syntax">Listener Node Syntax</h6>
<div class="listingblock">
<div class="content">
<pre>jmx.listener(
    event: "...",
    from: "object name" | ObjectName,
    call: { event-&gt; }
)</pre>
</div>
</div>
<div class="paragraph">
<p>Here is the description of the <strong>lisetener()</strong> node attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>event: An optional string that identifies the JMX event type to listen for.</p>
</li>
<li>
<p>from (required): The JMX ObjectName of the component to listen to. This can be specified as a string or an instance of ObjectName</p>
</li>
<li>
<p>call: The closure to execute when the event is captured. This can also be specified as a Groovy method pointer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is an example of JmxBuilder&#8217;s listener node:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">jmx.timer(name: "jmx.builder:type=Timer", period: "1s").start()

jmx.listener(
    from: "jmx.builder:type=Timer",
    call: { e -&gt;
        println "beep..."
    }
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example shows how you can use a stand alone listener (outside of an MBean export). Here, we <strong>export a timer with a 1 second</strong> resolution. Then, we specify a listener to that timer that will print "beep" every second.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_emitting_jmx_events">Emitting JMX Events</h5>
<div class="paragraph">
<p>JmxBuilder provides the <strong>tools needed to broadcast your own events</strong> on the MBeanServer&#8217;s event bus. There are no restrictions on the event type you can broadcast. You simply <strong>declare your emitter</strong> and the event type that you want to send, then <strong>broadcast your event</strong> at any time. Any registered component in the MBeanServer can register themselves to listen to your events.</p>
</div>
<div class="sect5">
<h6 id="_emitter_syntax">Emitter Syntax</h6>
<div class="listingblock">
<div class="content">
<pre>jmx.emitter(name:"Object:Name", event:"type")</pre>
</div>
</div>
<div class="paragraph">
<p>The attributes for the node Emitter() can be summarized as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>name: an optional JMX ObjectName used to register your emitter in the MBeanServer. Default is jmx.builder:type=Emitter,name=Emitter@OBJECT_HASH_VALUE</p>
</li>
<li>
<p>event: an option string value that describes the JMX event type. Default is <strong>"jmx.builder.event.emitter"</strong>.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_declare_the_emitter">Declare the Emitter</h6>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def emitter = jmx.emitter()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The snippet <strong>declares the emitter using implicit descriptor syntax</strong>. JmxBuilder will do the followings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create and register an emitter MBean with a default ObjectName.</p>
</li>
<li>
<p>Setup a <strong>default event type</strong> with value <strong>"jmx.builder.event.emitter"</strong>.</p>
</li>
<li>
<p>Return a GroovyMBean representing the emitter.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>As with other nodes in the builder, <strong>you can override all keys in the emitter() node</strong>. You can specify the <strong>ObjectName</strong> and the <strong>event type</strong>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_broadcast_event">Broadcast Event</h6>
<div class="paragraph">
<p>Once you have declared your emitter, you can broadcast your event.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">emitter.send()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The sample above shows the <strong>emitter sending an event</strong>, once it has been declared. Any JMX component registered in the MBeanServer can register to receive message from this emitter.</p>
</div>
</div>
<div class="sect5">
<h6 id="_sending_event_objects">Sending Event Objects</h6>
<div class="paragraph">
<p>You can optionally pass data to the receiver when you send the message.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">emitter.send("Hello!")</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you use an <strong>event listener closure (see above) that accpets a parameter</strong>, you can access that value.</p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_further_jmx_information">4.12.9. Further JMX Information</h4>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.ddj.com/dept/java/184406481?pgno=1">Monitoring the Java Virtual Machine</a></p>
</li>
<li>
<p><a href="http://buttso.blogspot.com/2006/05/using-groovy-for-system-management.html">Using Groovy for System Management</a></p>
</li>
<li>
<p><a href="http://jmesnil.net/weblog/2007/03/23/jmx-scripts-using-jruby">JMX Scripts using JRuby - Part I</a></p>
</li>
<li>
<p><a href="http://jmesnil.net/weblog/2007/04/03/jmx-scripts-using-jruby-part-ii">JMX Scripts using JRuby - Part II</a></p>
</li>
<li>
<p><a href="https://blogs.oracle.com/sundararajan/entry/groovier_jconsole">Groovier jconsole!</a></p>
</li>
<li>
<p><a href="http://jmesnil.net/weblog/2007/05/23/jmx-scripts-with-eclipse-monkey">JMX Scripts with Eclipse Monkey</a></p>
</li>
<li>
<p><a href="http://activemq.apache.org/jmx.html">Using JMX to monitor Apache ActiveMQ</a></p>
</li>
<li>
<p><a href="http://jagger.berlios.de">Jagger project (JMX application monitoring with Groovy)</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_creating_swing_uis_tbd">4.13. Creating Swing UIs (TBD)</h3>

</div>
<div class="sect2">
<h3 id="_security_tbd">4.14. Security (TBD)</h3>

</div>
<div class="sect2">
<h3 id="_design_patterns_in_groovy">4.15. Design patterns in Groovy</h3>
<div class="paragraph">
<p>Using <a href="http://en.wikipedia.org/wiki/Design_pattern_%28computer_science%29">design patterns</a> with Java is a well-established topic. Design patterns also apply to Groovy:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>some patterns carry over directly (and can make use of normal Groovy syntax improvements for greater readability)</p>
</li>
<li>
<p>some patterns are no longer required because they are built right into the language or because Groovy supports a better way of achieving the intent of the pattern</p>
</li>
<li>
<p>some patterns that have to be expressed at the design level in other languages can be implemented directly in Groovy (due to the way Groovy can blur the distinction between design and implementation)</p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_patterns">4.15.1. Patterns</h4>
<div class="sect4">
<h5 id="_abstract_factory_pattern">Abstract Factory Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/Abstract_factory_pattern">Abstract Factory Pattern</a> provides a way to encapsulate a group of individual factories that have a common theme. It embodies the intent of a normal factory, i.e. remove the need for code using an interface to know the concrete implementation behind the interface, but applies to a set of interfaces and selects an entire family of concrete classes which implement those interfaces.</p>
</div>
<div class="paragraph">
<p>As an example, I might have interfaces Button, TextField and Scrollbar. I might have WindowsButton, MacButton, FlashButton as concrete classes for Button. I might have WindowsScrollBar, MacScrollBar and FlashScrollBar as concrete implementations for ScrollBar. Using the Abstract Factory Pattern should allow me to select which windowing system (i.e. Windows, Mac, Flash) I want to use once and from then on should be able to write code that references the interfaces but is always using the appropriate concrete classes (all from the one windowing system) under the covers.</p>
</div>
<div class="sect5">
<h6 id="_example">Example</h6>
<div class="paragraph">
<p>Suppose we want to write a game system. We might note that many games have very similar features and control.</p>
</div>
<div class="paragraph">
<p>We decide to try to split the common and game-specific code into separate classes.</p>
</div>
<div class="paragraph">
<p>First let&#8217;s look at the game-specific code for a <a href="http://en.wikipedia.org/wiki/Two-Up">Two-up</a> game:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class TwoupMessages {
    def welcome = 'Welcome to the twoup game, you start with $1000'
    def done = 'Sorry, you have no money left, goodbye'
}

class TwoupInputConverter {
    def convert(input) { input.toInteger() }
}

class TwoupControl {
    private money = 1000
    private random = new Random()
    private tossWasHead() {
        def next = random.nextInt()
        return next % 2 == 0
    }
    def moreTurns() {
        if (money &gt; 0) {
            println "You have $money, how much would you like to bet?"
            return true
        }

        false
    }
    def play(amount) {
        def coin1 = tossWasHead()
        def coin2 = tossWasHead()
        if (coin1 &amp;&amp; coin2) {
            money += amount
            println 'You win'
        } else if (!coin1 &amp;&amp; !coin2) {
            money -= amount
            println 'You lose'
        } else {
            println 'Draw'
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s look at the game-specific code for a number guessing game:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class GuessGameMessages {
    def welcome = 'Welcome to the guessing game, my secret number is between 1 and 100'
    def done = 'Correct'
}

class GuessGameInputConverter {
    def convert(input) { input.toInteger() }
}

class GuessGameControl {
    private lower = 1
    private upper = 100
    private guess = new Random().nextInt(upper - lower) + lower
    def moreTurns() {
        def done = (lower == guess || upper == guess)
        if (!done) {
            println "Enter a number between $lower and $upper"
        }

        !done
    }
    def play(nextGuess) {
        if (nextGuess &lt;= guess) {
            lower = [lower, nextGuess].max()
        }
        if (nextGuess &gt;= guess) {
            upper = [upper, nextGuess].min()
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, let&#8217;s write our factory code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def guessFactory = [messages: GuessGameMessages, control: GuessGameControl, converter: GuessGameInputConverter]
def twoupFactory = [messages: TwoupMessages, control: TwoupControl, converter: TwoupInputConverter]

class GameFactory {
    def static factory
    def static getMessages() { return factory.messages.newInstance() }
    def static getControl() { return factory.control.newInstance() }
    def static getConverter() { return factory.converter.newInstance() }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The important aspect of this factory is that it allows selection of an entire family of concrete classes.</p>
</div>
<div class="paragraph">
<p>Here is how we would use the factory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">GameFactory.factory = twoupFactory
def messages = GameFactory.messages
def control = GameFactory.control
def converter = GameFactory.converter
println messages.welcome
def reader = new BufferedReader(new InputStreamReader(System.in))
while (control.moreTurns()) {
    def input = reader.readLine().trim()
    control.play(converter.convert(input))
}
println messages.done</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the first line configures which family of concrete game classes we will use. It&#8217;s not important that we selected which family to use by using the factory property as shown in the first line. Other ways would be equally valid examples of this pattern. For example, we may have asked the user which game they wanted to play or determined which game from an environment setting.</p>
</div>
<div class="paragraph">
<p>With the code as shown, the game might look like this when run:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Welcome to the twoup game, you start with $1000
You have 1000, how much would you like to bet?
300
Draw
You have 1000, how much would you like to bet?
700
You win
You have 1700, how much would you like to bet?
1700
You lose
Sorry, you have no money left, goodbye</pre>
</div>
</div>
<div class="paragraph">
<p>If we change the first line of the script to <code>GameFactory.factory = guessFactory</code>, then the sample run might look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Welcome to the guessing game, my secret number is between 1 and 100
Enter a number between 1 and 100
75
Enter a number between 1 and 75
35
Enter a number between 1 and 35
15
Enter a number between 1 and 15
5
Enter a number between 5 and 15
10
Correct</pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_adapter_pattern">Adapter Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/Adapter_pattern">Adapter Pattern</a> (sometimes called the wrapper pattern) allows objects satisfying one interface to be used where another type of interface is expected. There are two typical flavours of the pattern: the <em>delegation</em> flavour and the <em>inheritance</em> flavour.</p>
</div>
<div class="sect5">
<h6 id="_delegation_example">Delegation Example</h6>
<div class="paragraph">
<p>Suppose we have the following classes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class SquarePeg {
    def width
}

class RoundPeg {
    def radius
}

class RoundHole {
    def radius
    def pegFits(peg) {
        peg.radius &lt;= radius
    }
    String toString() { "RoundHole with radius $radius" }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can ask the <code>RoundHole</code> class if a <code>RoundPeg</code> fits in it, but if we ask the same question for a <code>SquarePeg</code>, then it will fail because the <code>SquarePeg</code> class doesn&#8217;t have a <code>radius</code> property (i.e. doesn&#8217;t satisfy the required interface).</p>
</div>
<div class="paragraph">
<p>To get around this problem, we can create an adapter to make it appear to have the correct interface. It would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class SquarePegAdapter {
    def peg
    def getRadius() {
        Math.sqrt(((peg.width / 2) ** 2) * 2)
    }
    String toString() {
        "SquarePegAdapter with peg width $peg.width (and notional radius $radius)"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the adapter like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def hole = new RoundHole(radius: 4.0)
(4..7).each { w -&gt;
    def peg = new SquarePegAdapter(peg: new SquarePeg(width: w))
    if (hole.pegFits(peg)) {
        println "peg $peg fits in hole $hole"
    } else {
        println "peg $peg does not fit in hole $hole"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which results in the following output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>peg SquarePegAdapter with peg width 4 (and notional radius 2.8284271247461903) fits in hole RoundHole with radius 4.0
peg SquarePegAdapter with peg width 5 (and notional radius 3.5355339059327378) fits in hole RoundHole with radius 4.0
peg SquarePegAdapter with peg width 6 (and notional radius 4.242640687119285) does not fit in hole RoundHole with radius 4.0
peg SquarePegAdapter with peg width 7 (and notional radius 4.949747468305833) does not fit in hole RoundHole with radius 4.0</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_inheritance_example">Inheritance Example</h6>
<div class="paragraph">
<p>Let&#8217;s consider the same example again using inheritance. First, here are the original classes (unchanged):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class SquarePeg {
    def width
}

class RoundPeg {
    def radius
}

class RoundHole {
    def radius
    def pegFits(peg) {
        peg.radius &lt;= radius
    }
    String toString() { "RoundHole with radius $radius" }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>An adapter using inheritance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class SquarePegAdapter extends SquarePeg {
    def getRadius() {
        Math.sqrt(((width / 2) ** 2) * 2)
    }
    String toString() {
        "SquarePegAdapter with width $width (and notional radius $radius)"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using the adapter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def hole = new RoundHole(radius: 4.0)
(4..7).each { w -&gt;
    def peg = new SquarePegAdapter(peg: new SquarePeg(width: w))
    if (hole.pegFits(peg)) {
        println "peg $peg fits in hole $hole"
    } else {
        println "peg $peg does not fit in hole $hole"
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>peg SquarePegAdapter with width 4 (and notional radius 2.8284271247461903) fits in hole RoundHole with radius 4.0
peg SquarePegAdapter with width 5 (and notional radius 3.5355339059327378) fits in hole RoundHole with radius 4.0
peg SquarePegAdapter with width 6 (and notional radius 4.242640687119285) does not fit in hole RoundHole with radius 4.0
peg SquarePegAdapter with width 7 (and notional radius 4.949747468305833) does not fit in hole RoundHole with radius 4.0</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_adapting_using_closures">Adapting using Closures</h6>
<div class="paragraph">
<p>As a variation of the previous examples, we could instead define the following interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">interface RoundThing {
    def getRadius()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can then define an adapter as a closure as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def adapter = {
    p -&gt; [getRadius: { Math.sqrt(((p.width / 2) ** 2) * 2) }] as RoundThing
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And use it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def peg = new SquarePeg(width: 4)
if (hole.pegFits(adapter(peg))) {
    // ... as before
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_adapting_using_the_expandometaclass">Adapting using the ExpandoMetaClass</h6>
<div class="paragraph">
<p>As of Groovy 1.1, there is a built-in MetaClass which can automatically add properties and methods dynamically.</p>
</div>
<div class="paragraph">
<p>Here is how the example would work using that feature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def peg = new SquarePeg(width: 4)
peg.metaClass.radius = Math.sqrt(((peg.width / 2) ** 2) * 2)</code></pre>
</div>
</div>
<div class="paragraph">
<p>After you create a peg object, you can simply add a property to it on the fly. No need to change the original class and no need for an adapter class.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_bouncer_pattern">Bouncer Pattern</h5>
<div class="paragraph">
<p>The <a href="http://www.c2.com/cgi/wiki?BouncerPattern">Bouncer Pattern</a> describes usage of a method whose sole purpose is to either throw an exception (when particular conditions hold) or do nothing. Such methods are often used to defensively guard pre-conditions of a method.</p>
</div>
<div class="paragraph">
<p>When writing utility methods, you should always guard against faulty input arguments. When writing internal methods, you may be able to ensure that certain pre-conditions always hold by having sufficient unit tests in place. Under such circumstances, you may reduce the desirability to have guards on your methods.</p>
</div>
<div class="paragraph">
<p>Groovy differs from other languages in that you frequently use the <code>assert</code> method within your methods rather than having a large number of utility checker methods or classes.</p>
</div>
<div class="sect5">
<h6 id="_null_checking_example">Null Checking Example</h6>
<div class="paragraph">
<p>We might have a utility method such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class NullChecker {
    static check(name, arg) {
        if (arg == null) {
            throw new IllegalArgumentException(name + ' is null')
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we would use it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">void doStuff(String name, Object value) {
    NullChecker.check('name', name)
    NullChecker.check('value', value)
    // do stuff
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>But a more Groovy way to do this would simply be like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">void doStuff(String name, Object value) {
    assert name != null, 'name should not be null'
    assert value != null, 'value should not be null'
    // do stuff
}</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_validation_example">Validation Example</h6>
<div class="paragraph">
<p>As an alternative example, we might have this utility method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class NumberChecker {
    static final String NUMBER_PATTERN = "\\\\d+(\\\\.\\\\d+(E-?\\\\d+)?)?"
    static isNumber(str) {
        if (!str ==~ NUMBER_PATTERN) {
            throw new IllegalArgumentException("Argument '$str' must be a number")
        }
    }
    static isNotZero(number) {
        if (number == 0) {
            throw new IllegalArgumentException('Argument must not be 0')
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we would use it like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def stringDivide(String dividendStr, String divisorStr) {
    NumberChecker.isNumber(dividendStr)
    NumberChecker.isNumber(divisorStr)
    def dividend = dividendStr.toDouble()
    def divisor = divisorStr.toDouble()
    NumberChecker.isNotZero(divisor)
    dividend / divisor
}

println stringDivide('1.2E2', '3.0')
// =&gt; 40.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>But with Groovy we could just as easily use:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def stringDivide(String dividendStr, String divisorStr) {
    assert dividendStr =~ NumberChecker.NUMBER_PATTERN
    assert divisorStr =~ NumberChecker.NUMBER_PATTERN
    def dividend = dividendStr.toDouble()
    def divisor = divisorStr.toDouble()
    assert divisor != 0, 'Divisor must not be 0'
    dividend / divisor
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_chain_of_responsibility_pattern">Chain of Responsibility Pattern</h5>
<div class="paragraph">
<p>In the Chain of Responsibility Pattern, objects using and implementing an interface (one or more methods) are intentionally loosely coupled. A set of objects that <em>implement</em> the interface are organised in a list (or in rare cases a tree). Objects using the interface make requests from the first <em>implementor</em> object. It will decide whether to perform any action itself and whether to pass the request further down the line in the list (or tree). Sometimes a default implementation for some request is also coded into the pattern if none of the implementors respond to the request.</p>
</div>
<div class="sect5">
<h6 id="_example_2">Example</h6>
<div class="paragraph">
<p>In this example, the script sends requests to the <code>lister</code> object. The <code>lister</code> points to a <code>UnixLister</code> object. If it can&#8217;t handle the request, it sends the request to the <code>WindowsLister</code>. If it can&#8217;t handle the request, it sends the request to the <code>DefaultLister</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class UnixLister {
    private nextInLine
    UnixLister(next) { nextInLine = next }
    def listFiles(dir) {
        if (System.getProperty('os.name') == 'Linux') {
            println "ls $dir".execute().text
        } else {
            nextInLine.listFiles(dir)
        }
    }
}

class WindowsLister {
    private nextInLine
    WindowsLister(next) { nextInLine = next }
    def listFiles(dir) {
        if (System.getProperty('os.name') == 'Windows XP') {
            println "cmd.exe /c dir $dir".execute().text
        } else {
            nextInLine.listFiles(dir)
        }
    }
}

class DefaultLister {
    def listFiles(dir) {
        new File(dir).eachFile { f -&gt; println f }
    }
}

def lister = new UnixLister(new WindowsLister(new DefaultLister()))

lister.listFiles('Downloads')</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output will be a list of files (with slightly different format depending on the operating system).</p>
</div>
<div class="paragraph">
<p>Here is a UML representation:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../assets/img/ChainOfResponsibilityClasses.gif" alt="ChainOfResponsibilityClasses">
</div>
</div>
<div class="paragraph">
<p>Variations to this pattern:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>we could have an explicit interface, e.g. <code>Lister</code>, to statically type the implementations but because of <em>duck-typing</em> this is optional</p>
</li>
<li>
<p>we could use a chain tree instead of a list, e.g. <code>if (animal.hasBackbone())</code> delegate to <code>VertebrateHandler</code> else delegate to <code>InvertebrateHandler</code></p>
</li>
<li>
<p>we could always pass down the chain even if we processed a request</p>
</li>
<li>
<p>we could decide at some point to not respond and not pass down the chain</p>
</li>
<li>
<p>we could use Groovy’s meta-programming capabilities to pass unknown methods down the chain</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_composite_pattern">Composite Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/Composite_pattern">Composite Pattern</a> allows you to treat single instances of an object the same way as a group of objects. The pattern is often used with hierarchies of objects. Typically, one or more methods should be callable in the same way for either <em>leaf</em> or <em>composite</em> nodes within the hierarchy. In such a case, composite nodes typically invoke the same named method for each of their children nodes.</p>
</div>
<div class="sect5">
<h6 id="_example_3">Example</h6>
<div class="paragraph">
<p>Consider this usage of the composite pattern where we want to call <code>toString()</code> on either <code>Leaf</code> or <code>Composite</code> objects.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../assets/img/CompositeClasses.gif" alt="CompositeClasses">
</div>
</div>
<div class="paragraph">
<p>In Java, the <code>Component</code> class is essential as it provides the type used for both leaf and composite nodes. In Groovy, because of duck-typing, we don&#8217;t need it for that purpose, however, it can still server as a useful place to place common behaviour between the leaf and composite nodes.</p>
</div>
<div class="paragraph">
<p>For our purposes, we will assemble the following hierarchy of components.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../assets/img/CompositeComponents.gif" alt="CompositeComponents">
</div>
</div>
<div class="paragraph">
<p>Here is the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">abstract class Component {
    def name
    def toString(indent) {
        ("-" * indent) + name
    }
}

class Composite extends Component {
    private children = []
    def toString(indent) {
        def s = super.toString(indent)
        children.each { child -&gt;
            s += "\\n" + child.toString(indent + 1)
        }
        s
    }
    def leftShift(component) {
        children &lt;&lt; component
    }
}

class Leaf extends Component { }

def root = new Composite(name: "root")
root &lt;&lt; new Leaf(name: "leaf A")
def comp = new Composite(name: "comp B")
root &lt;&lt; comp
root &lt;&lt; new Leaf(name: "leaf C")
comp &lt;&lt; new Leaf(name: "leaf B1")
comp &lt;&lt; new Leaf(name: "leaf B2")
println root.toString(0)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the resulting output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>root
-leaf A
-comp B
--leaf B1
--leaf B2
-leaf C</pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_decorator_pattern">Decorator Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/Decorator_pattern">Decorator Pattern</a> provides a mechanism to embellish the behaviour of an object without changing its essential interface. A decorated object should be able to be substituted wherever the original (non-decorated) object was expected. Decoration typically does not involve modifying the source code of the original object and decorators should be able to be combined in flexible ways to produce objects with several embellishments.</p>
</div>
<div class="sect5">
<h6 id="_traditional_example">Traditional Example</h6>
<div class="paragraph">
<p>Suppose we have the following <code>Logger</code> class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Logger {
    def log(String message) {
        println message
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There might be times when it is useful to timestamp a log message, or times when we might want to change the case of the message. We could try to build all of this functionality into our <code>Logger</code> class. If we did that, the <code>Logger</code> class would start to be very complex. Also, everyone would obtain all of features even when they might not want a small subset of the features. Finally, feature interaction would become quite difficult to control.</p>
</div>
<div class="paragraph">
<p>To overcome these drawbacks, we instead define two decorator classes. Uses of the <code>Logger</code> class are free to embellish their base logger with zero or more decorator classes in whatever order they desire. The classes look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class TimeStampingLogger extends Logger {
    private Logger logger
    TimeStampingLogger(logger) {
        this.logger = logger
    }
    def log(String message) {
        def now = Calendar.instance
        logger.log("$now.time: $message")
    }
}

class UpperLogger extends Logger {
    private Logger logger
    UpperLogger(logger) {
        this.logger = logger
    }
    def log(String message) {
        logger.log(message.toUpperCase())
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the decorators like so:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def logger = new UpperLogger(new TimeStampingLogger(new Logger()))
logger.log("G'day Mate")
// =&gt; Tue May 22 07:13:50 EST 2007: G'DAY MATE</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see that we embellish the logger behaviour with both decorators. Because of the order we chose to apply the decorators, our log message comes out capitalised and the timestamp is in normal case. If we swap the order around, let&#8217;s see what happens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">logger = new TimeStampingLogger(new UpperLogger(new Logger()))
logger.log('Hi There')
// =&gt; TUE MAY 22 07:13:50 EST 2007: HI THERE</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the timestamp itself has also been changed to be uppercase.</p>
</div>
</div>
<div class="sect5">
<h6 id="_a_touch_of_dynamic_behaviour">A touch of dynamic behaviour</h6>
<div class="paragraph">
<p>Our previous decorators were specific to <code>Logger</code> objects. We can use Groovy&#8217;s Meta-Object Programming capabilities to create a decorator which is far more general purpose in nature. Consider this class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class GenericLowerDecorator {
    private delegate
    GenericLowerDecorator(delegate) {
        this.delegate = delegate
    }
    def invokeMethod(String name, args) {
        def newargs = args.collect { arg -&gt;
            if (arg instanceof String) {
                return arg.toLowerCase()
            } else {
                return arg
            }
        }
        delegate.invokeMethod(name, newargs)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It takes any class and decorates it so that any <code>String</code> method parameter will automatically be changed to lower case.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">logger = new GenericLowerDecorator(new TimeStampingLogger(new Logger()))
logger.log('IMPORTANT Message')
// =&gt; Tue May 22 07:27:18 EST 2007: important message</code></pre>
</div>
</div>
<div class="paragraph">
<p>Just be careful with ordering here. The original decorators were restricted to decorating <code>Logger</code> objects. This decorator work with any object type, so we can&#8217;t swap the ordering around, i.e. this won&#8217;t work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>// Can't mix and match Interface-Oriented and Generic decorators
// logger = new TimeStampingLogger(new GenericLowerDecorator(new Logger()))</pre>
</div>
</div>
<div class="paragraph">
<p>We could overcome this limitation be generating an appropriate Proxy type at runtime but we won&#8217;t complicate the example here.</p>
</div>
</div>
<div class="sect5">
<h6 id="_runtime_behaviour_embellishment">Runtime behaviour embellishment</h6>
<div class="paragraph">
<p>You can also consider using the <code>ExpandoMetaClass</code> from Groovy 1.1 to dynamically embellish a class with behaviour. This isn&#8217;t the normal style of usage of the decorator pattern (it certainly isn&#8217;t nearly as flexible) but may help you to achieve similar results in some cases without creating a new class.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s what the code looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">// current mechanism to enable ExpandoMetaClass
GroovySystem.metaClassRegistry.metaClassCreationHandle = new ExpandoMetaClassCreationHandle()

def logger = new Logger()
logger.metaClass.log = { String m -&gt; println 'message: ' + m.toUpperCase() }
logger.log('x')
// =&gt; message: X</code></pre>
</div>
</div>
<div class="paragraph">
<p>This achieves a similar result to applying a single decorator but we have no way to easily apply and remove embellishments on the fly.</p>
</div>
</div>
<div class="sect5">
<h6 id="_more_dynamic_decorating">More dynamic decorating</h6>
<div class="paragraph">
<p>Suppose we have a calculator class (Actually any class would do).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Calc {
    def add(a, b) { a + b }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We might be interested in observing usage of the class over time. If it is buried deep within our codebase, it might be hard to determine when it is being called and with what parameters. Also, it might be hard to know if it is performing well. We can easily make a generic tracing decorator that prints out tracing information whenever any method on the <code>Calc</code> class is called and also provide timing information about how long it took to execute. Here is the code for the tracing decorator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class TracingDecorator {
    private delegate
    TracingDecorator(delegate) {
        this.delegate = delegate
    }
    def invokeMethod(String name, args) {
        println "Calling $name$args"
        def before = System.currentTimeMillis()
        def result = delegate.invokeMethod(name, args)
        println "Got $result in ${System.currentTimeMillis()-before} ms"
        result
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is how to use the class in a script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def tracedCalc = new TracingDecorator(new Calc())
assert 15 == tracedCalc.add(3, 12)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is what you would see after running this script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Calling add{3, 12}
Got 15 in 31 ms</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_decorating_with_an_interceptor">Decorating with an Interceptor</h6>
<div class="paragraph">
<p>The above timing example hooks into the lifecycle of Groovy objects (via <code>invokeMethod</code>). This is such an important style performing meta-programming that Groovy has special support for this style of decorating using <em>interceptors</em>.</p>
</div>
<div class="paragraph">
<p>Groovy even comes with a built-in <code>TracingInterceptor</code>. We can extend the built-in class like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class TimingInterceptor extends TracingInterceptor {
    private beforeTime
    def beforeInvoke(object, String methodName, Object[] arguments) {
        super.beforeInvoke(object, methodName, arguments)
        beforeTime = System.currentTimeMillis()
    }
    Object afterInvoke(Object object, String methodName, Object[] arguments, Object result) {
        super.afterInvoke(object, methodName, arguments, result)
        def duration = System.currentTimeMillis() - beforeTime
        writer.write("Duration: $duration ms\\n")
        writer.flush()
        result
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is an example of using this new class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def proxy = ProxyMetaClass.getInstance(Calc)
proxy.interceptor = new TimingInterceptor()
proxy.use {
    assert 7 == new Calc().add(1, 6)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is the output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>before Calc.ctor()
after  Calc.ctor()
Duration: 0 ms
before Calc.add(java.lang.Integer, java.lang.Integer)
after  Calc.add(java.lang.Integer, java.lang.Integer)
Duration: 2 ms</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_decorating_with_java_lang_reflect_proxy">Decorating with java.lang.reflect.Proxy</h6>
<div class="paragraph">
<p>If you are trying to decorate an object (i.e. just a particular instance of the class, not the class generally), then you can use Java&#8217;s <code>java.lang.reflect.Proxy</code>. Groovy makes working with this easier than just Java. Below is a code sample taken out of a grails project that wraps a <code>java.sql.Connection</code> so that it&#8217;s close method is a no-op:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">protected Sql getGroovySql() {
    final Connection con = session.connection()
    def invoker = { object, method, args -&gt;
        if (method.name == "close") {
            log.debug("ignoring call to Connection.close() for use by groovy.sql.Sql")
        } else {
            log.trace("delegating $method")
            return con.invokeMethod(method.name, args)
        }
    } as InvocationHandler;
    def proxy = Proxy.newProxyInstance( getClass().getClassLoader(), [Connection] as Class[], invoker )
    return new Sql(proxy)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If there were many methods to intercept, then this approach could be modified to look up closure in a map by method name and invoke it.</p>
</div>
</div>
<div class="sect5">
<h6 id="_decorating_with_spring">Decorating with Spring</h6>
<div class="paragraph">
<p>The <a href="http://www.springframework.org">Spring Framework</a> allows decorators to be applied with <em>interceptors</em> (you may have heard the terms <em>advice</em> or <em>aspect</em>). You can leverage this mechanism from Groovy as well.</p>
</div>
<div class="paragraph">
<p>First define a class that you want to decorate (we&#8217;ll also use an interface as is normal Spring practice):</p>
</div>
<div class="paragraph">
<p>Here&#8217;s the interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">interface Calc {
    def add(a, b)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s the class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class CalcImpl implements Calc {
    def add(a, b) { a + b }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we define our wiring in a file called <code>beans.xml</code> as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="xml language-xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:lang="http://www.springframework.org/schema/lang"
	xsi:schemaLocation="
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/lang http://www.springframework.org/schema/lang/spring-lang.xsd"&gt;

    &lt;bean id="performanceInterceptor" autowire="no"
          class="org.springframework.aop.interceptor.PerformanceMonitorInterceptor"&gt;
        &lt;property name="loggerName" value="performance"/&gt;
    &lt;/bean&gt;
    &lt;bean id="calc" class="util.CalcImpl"/&gt;
    &lt;bean class="org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator"&gt;
        &lt;property name="beanNames" value="calc"/&gt;
        &lt;property name="interceptorNames" value="performanceInterceptor"/&gt;
    &lt;/bean&gt;
&lt;/beans&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, our script looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grab('org.springframework:spring-context:3.2.2.RELEASE')
import org.springframework.context.support.ClassPathXmlApplicationContext

def ctx = new ClassPathXmlApplicationContext('beans.xml')
def calc = ctx.getBean('calc')
println calc.add(3, 25)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And when we run it, we see the results:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>21/05/2007 23:02:35 org.springframework.aop.interceptor.PerformanceMonitorInterceptor invokeUnderTrace
FINEST: StopWatch 'util.Calc.add': running time (millis) = 16</pre>
</div>
</div>
<div class="paragraph">
<p>You may have to adjust your <code>logging.properties</code> file for messages at log level <code>FINEST</code> to be displayed.</p>
</div>
</div>
<div class="sect5">
<h6 id="_asynchronous_decorators_using_gpars">Asynchronous Decorators using GPars</h6>
<div class="paragraph">
<p>Using the example code in <a href="http://www.cs.iastate.edu/~design/projects/panini/docs/starting.shtml">Panini</a> for inspiration. Here is a Groovy version that avoids using an <code>@AddedBehavior</code> annotation at the expense of not having as general an algorithm for selecting the methods to decorate. This isn&#8217;t a limitation of the particular approach chosen but just a simplification for illustrative purposes (but don&#8217;t assume below is an exact equivalent).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grab('org.codehaus.gpars:gpars:0.10')
import static groovyx.gpars.GParsPool.withPool

interface Document {
    void print()
    String getText()
}

class DocumentImpl implements Document {
    def document
    void print() { println document }
    String getText() { document }
}

def words(String text) {
    text.replaceAll('[^a-zA-Z]', ' ').trim().split("\\\\s+")*.toLowerCase()
}

def avgWordLength = {
    def words = words(it.text)
    sprintf "Avg Word Length: %4.2f", words*.size().sum() / words.size()
}
def modeWord = {
    def wordGroups = words(it.text).groupBy {it}.collectEntries { k, v -&gt; [k, v.size()] }
    def maxSize = wordGroups*.value.max()
    def maxWords = wordGroups.findAll { it.value == maxSize }
    "Mode Word(s): ${maxWords*.key.join(', ')} ($maxSize occurrences)"
}
def wordCount = { d -&gt; "Word Count: " + words(d.text).size() }

def asyncDecorator(Document d, Closure c) {
    ProxyGenerator.INSTANCE.instantiateDelegate([print: {
        withPool {
            def result = c.callAsync(d)
            d.print()
            println result.get()
        }
    }], [Document], d)
}

Document d = asyncDecorator(asyncDecorator(asyncDecorator(
        new DocumentImpl(document:"This is the file with the words in it\\n\\t\\nDo you see the words?\\n"),
//        new DocumentImpl(document: new File('AsyncDecorator.groovy').text),
        wordCount), modeWord), avgWordLength)
d.print()</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_delegation_pattern">Delegation Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/Delegation_pattern">Delegation Pattern</a> is a technique where an object&#8217;s behavior (public methods) is implemented by delegating responsibility to one or more associated objects.</p>
</div>
<div class="paragraph">
<p>Groovy allows the traditional style of applying the delegation pattern, e.g. see <a href="userGuides.html#_replace_inheritance_with_delegation">Replace Inheritance with Delegation</a>.</p>
</div>
<div class="sect5">
<h6 id="_implement_delegation_pattern_using_expandometaclass">Implement Delegation Pattern using ExpandoMetaClass</h6>
<div class="paragraph">
<p>The <a href="http://groovy.codehaus.org/ExpandoMetaClass">ExpandoMetaClass</a> allows usage of this pattern to be encapsulated in a library. This allows Groovy to emulate similar libraries available for the Ruby language.</p>
</div>
<div class="paragraph">
<p>Consider the following library class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Delegator {
    private targetClass
    private delegate
    Delegator(targetClass, delegate) {
        this.targetClass = targetClass
        this.delegate = delegate
    }
    def delegate(String methodName) {
        delegate(methodName, methodName)
    }
    def delegate(String methodName, String asMethodName) {
        targetClass.metaClass."$asMethodName" = delegate.&amp;"$methodName"
    }
    def delegateAll(String[] names) {
        names.each { delegate(it) }
    }
    def delegateAll(Map names) {
        names.each { k, v -&gt; delegate(k, v) }
    }
    def delegateAll() {
        delegate.class.methods*.name.each { delegate(it) }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this in your classpath, you can now apply the delegation pattern dynamically as shown in the following examples. First, consider we have the following classes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Person {
    String name
}

class MortgageLender {
    def borrowAmount(amount) {
       "borrow \\$$amount"
    }
    def borrowFor(thing) {
       "buy \\$thing"
    }
}

def lender = new MortgageLender()

def delegator = new Delegator(Person, lender)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now use the <em>delegator</em> to automatically borrow methods from the <em>lender</em> object to extend the <em>Person</em> class. We can borrow the methods as is or with a rename:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">delegator.delegate 'borrowFor'
delegator.delegate 'borrowAmount', 'getMoney'

def p = new Person()

println p.borrowFor('present')   // =&gt; buy present
println p.getMoney(50)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first line above, adds the <em>borrowFor</em> method to the <em>Person</em> class by delegating to the <em>lender</em> object. The second line adds a <em>getMoney</em> method to the <em>Person</em> class by delegating to the <em>lender</em> object&#8217;s <em>borrowAmount</em> method.</p>
</div>
<div class="paragraph">
<p>Alternatively, we could borrow multiple methods like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">delegator.delegateAll 'borrowFor', 'borrowAmount'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which adds these two methods to the <em>Person</em> class.</p>
</div>
<div class="paragraph">
<p>Or if we want all the methods, like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">delegator.delegateAll()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which will make all the methods in the delegate object available in the <em>Person</em> class.</p>
</div>
<div class="paragraph">
<p>Alternatively, we can use a map notation to rename multiple methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">delegator.delegateAll borrowAmount:'getMoney', borrowFor:'getThing'</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_implement_delegation_pattern_using_delegate_annotation">Implement Delegation Pattern using @Delegate annotation</h6>
<div class="paragraph">
<p>Since version 1.6 you can use the built-in delegation mechanism which is based on AST transformation.</p>
</div>
<div class="paragraph">
<p>This make delegation even easier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Person {
    def name
    @Delegate MortgageLender mortgageLender = new MortgageLender()
}

class MortgageLender {
    def borrowAmount(amount) {
       "borrow \\$$amount"
    }
    def borrowFor(thing) {
       "buy $thing"
    }
}

def p = new Person()

assert "buy present" == p.borrowFor('present')
assert "borrow \\$50" == p.borrowAmount(50)</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_flyweight_pattern">Flyweight Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/Flyweight_pattern">Flyweight Pattern</a> is a pattern for greatly reducing memory requirements by not requiring that heavy-weight objects be created in large numbers when dealing with systems that contain many things that are mostly the same. If for instance, a document was modeled using a complex character class that knew about unicode, fonts, positioning, etc., then the memory requirements could be quite large for large documents if each physical character in the document required its own character class instance. Instead, characters themselves might be kept within Strings and we might have one character class (or a small number such as one character class for each font type) that knew the specifics of how to deal with characters.</p>
</div>
<div class="paragraph">
<p>In such circumstances, we call the state that is shared with many other things (e.g. the character type) <em>instrinsic</em> state. It is captured within the heavy-weight class. The state which distinguishes the physical character (maybe just its ASCII code or Unicode) is called its <em>extrinsic</em> state.</p>
</div>
<div class="sect5">
<h6 id="_example_4">Example</h6>
<div class="paragraph">
<p>First we are going to model some complex aircraft (the first being a hoax competitor of the second - not that is relevant to the example).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Boeing797 {
    def wingspan = '80.8 m'
    def capacity = 1000
    def speed = '1046 km/h'
    def range = '14400 km'
    // ...
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../assets/img/b797-hoax.jpg" alt="b797 hoax">
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Airbus380 {
    def wingspan = '79.8 m'
    def capacity = 555
    def speed = '912 km/h'
    def range = '10370 km'
    // ...
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="../assets/img/a380.jpg" alt="a380">
</div>
</div>
<div class="paragraph">
<p>If we want to model our fleet, our first attempt might involve using many instances of these heavy-weight objects. It turns out though that only a few small pieces of state (our extrinsic state) change for each aircraft, so we will have singletons for the heavy-weight objects and capture the extrinsic state (bought date and asset number in the code below) separately.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class FlyweightFactory {
    static instances = [797: new Boeing797(), 380: new Airbus380()]
}

class Aircraft {
    private type         // instrinsic state
    private assetNumber  // extrinsic state
    private bought       // extrinsic state
    Aircraft(typeCode, assetNumber, bought) {
        type = FlyweightFactory.instances[typeCode]
        this.assetNumber = assetNumber
        this.bought = bought
    }
    def describe() {
        println """
        Asset Number: $assetNumber
        Capacity: $type.capacity people
        Speed: $type.speed
        Range: $type.range
        Bought: $bought
        """
    }
}

def fleet = [
    new Aircraft(380, 1001, '10-May-2007'),
    new Aircraft(380, 1002, '10-Nov-2007'),
    new Aircraft(797, 1003, '10-May-2008'),
    new Aircraft(797, 1004, '10-Nov-2008')
]

fleet.each { p -&gt; p.describe() }</code></pre>
</div>
</div>
<div class="paragraph">
<p>So here, even if our fleet contained hundreds of planes, we would only have one heavy-weight object for each type of aircraft.</p>
</div>
<div class="paragraph">
<p>As a further efficiency measure, we might use lazy creation of the flyweight objects rather than create the initial map up front as in the above example.</p>
</div>
<div class="paragraph">
<p>Running this script results in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Asset Number: 1001
Capacity: 555 people
Speed: 912 km/h
Range: 10370 km
Bought: 10-May-2007

Asset Number: 1002
Capacity: 555 people
Speed: 912 km/h
Range: 10370 km
Bought: 10-Nov-2007

Asset Number: 1003
Capacity: 1000 people
Speed: 1046 km/h
Range: 14400 km
Bought: 10-May-2008

Asset Number: 1004
Capacity: 1000 people
Speed: 1046 km/h
Range: 14400 km
Bought: 10-Nov-2008</pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_iterator_pattern">Iterator Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/Iterator_pattern">Iterator Pattern</a> allows sequential access to the elements of an aggregate object without exposing its underlying representation.</p>
</div>
<div class="paragraph">
<p>Groovy has the iterator pattern built right in to many of its closure operators, e.g. <code>each</code> and <code>eachWithIndex</code> as well as the <code>for .. in</code> loop.</p>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def printAll(container) {
    for (item in container) { println item }
}

def numbers = [ 1,2,3,4 ]
def months = [ Mar:31, Apr:30, May:31 ]
def colors = [ java.awt.Color.BLACK, java.awt.Color.WHITE ]
printAll numbers
printAll months
printAll colors</code></pre>
</div>
</div>
<div class="paragraph">
<p>Results in the output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>1
2
3
4
May=31
Mar=31
Apr=30
java.awt.Color[r=0,g=0,b=0]
java.awt.Color[r=255,g=255,b=255]</pre>
</div>
</div>
<div class="paragraph">
<p>Another example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">colors.eachWithIndex { item, pos -&gt;
    println "Position $pos contains '$item'"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Results in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Position 0 contains 'java.awt.Color[r=0,g=0,b=0]'
Position 1 contains 'java.awt.Color[r=255,g=255,b=255]'</pre>
</div>
</div>
<div class="paragraph">
<p>The iterator pattern is also built in to other special operators such as the <code>eachByte</code>, <code>eachFile</code>, <code>eachDir</code>, <code>eachLine</code>, <code>eachObject</code>, <code>eachMatch</code> operators for working with streams, URLs, files, directories and regular expressions matches.</p>
</div>
</div>
<div class="sect4">
<h5 id="_loan_my_resource_pattern">Loan my Resource Pattern</h5>
<div class="paragraph">
<p>The <a href="https://wiki.scala-lang.org/display/SYGN/Loan">Loan my Resource</a> pattern ensures that a resource is deterministically disposed of once it goes out of scope.</p>
</div>
<div class="paragraph">
<p>This pattern is built in to many Groovy helper methods. You should consider using it yourself if you need to work with resources in ways beyond what Groovy supports.</p>
</div>
<div class="sect5">
<h6 id="_example_5">Example</h6>
<div class="paragraph">
<p>Consider the following code which works with a file. First we might write some line to the file and then print its size:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def f = new File('junk.txt')
f.withPrintWriter { pw -&gt;
    pw.println(new Date())
    pw.println(this.class.name)
}
println f.size()
// =&gt; 42</code></pre>
</div>
</div>
<div class="paragraph">
<p>We could also read back the contents of the file a line at a time and print each line out:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">f.eachLine { line -&gt;
    println line
}
// =&gt;
// Mon Jun 18 22:38:17 EST 2007
// RunPattern</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that normal Java <code>Reader</code> and <code>PrintWriter</code> objects were used under the covers by Groovy but the code writer did not have to worry about explicitly creating or closing those resources. The built-in Groovy methods loan the respective reader or writer to the closure code and then tidy up after themselves. So, you are using this pattern without having to do any work.</p>
</div>
<div class="paragraph">
<p>Sometimes however, you wish to do things slightly differently to what you can get for free using Groovy&#8217;s built-in mechanisms. You should consider utilising this pattern within your own resource-handling operations.</p>
</div>
<div class="paragraph">
<p>Consider how you might process the list of words on each line within the file. We could actually do this one too using Groovy&#8217;s built-in functions, but bear with us and assume we have to do some resource handling ourselves. Here is how we might write the code without using this pattern:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def reader = f.newReader()
reader.splitEachLine(' ') { wordList -&gt;
    println wordList
}
reader.close()
// =&gt;
// [ "Mon", "Jun", "18", "22:38:17", "EST", "2007" ]
// [ "RunPattern" ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice that we now have an explicit call to <code>close()</code> in our code. If we didn&#8217;t code it just right (here we didn&#8217;t surround the code in a <code>try &#8230; finally</code> block, we run the risk of leaving the file handle open.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s now apply the loan pattern. First, we&#8217;ll write a helper method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def withListOfWordsForEachLine(File f, Closure c) {
    def r = f.newReader()
    try {
        r.splitEachLine(' ', c)
    } finally {
        r?.close()
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, we can re-write our code as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">withListOfWordsForEachLine(f) { wordList -&gt;
    println wordList
}
// =&gt;
// [ "Mon", "Jun", "18", "22:38:17", "EST", "2007" ]
// [ "RunPattern" ]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is much simpler and has removed the explicit <code>close()</code>. This is now catered for in one spot so we can apply the appropriate level of testing or reviewing in just one spot to be sure we have no problems.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_null_object_pattern">Null Object Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/Null_Object_pattern">Null Object Pattern</a> involves using a special object place-marker object representing null. Typically, if you have a reference to null, you can&#8217;t invoke <code>reference.field</code> or <code>reference.method()</code>. You receive the dreaded <code>NullPointerException</code>. The null object pattern uses a special object representing null, instead of using an actual <code>null</code>. This allows you to invoke field and method references on the null object. The result of using the null object should semantically be equivalent to <em>doing nothing</em>.</p>
</div>
<div class="sect5">
<h6 id="_simple_example">Simple Example</h6>
<div class="paragraph">
<p>Suppose we have the following system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Job {
    def salary
}

class Person {
    def name
    def Job job
}

def people = [
    new Person(name: 'Tom', job: new Job(salary: 1000)),
    new Person(name: 'Dick', job: new Job(salary: 1200)),
]

def biggestSalary = people.collect { p -&gt; p.job.salary }.max()
println biggestSalary</code></pre>
</div>
</div>
<div class="paragraph">
<p>When run, this prints out <code>1200</code>. Suppose now that we now invoke:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">people &lt;&lt; new Person(name: 'Harry')</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we now try to calculate <code>biggestSalary</code> again, we receive a null pointer exception.</p>
</div>
<div class="paragraph">
<p>To overcome this problem, we can introduce a <code>NullJob</code> class and change the above statement to become:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class NullJob extends Job { def salary = 0 }

people &lt;&lt; new Person(name: 'Harry', job: new NullJob())
biggestSalary = people.collect { p -&gt; p.job.salary }.max()
println biggestSalary</code></pre>
</div>
</div>
<div class="paragraph">
<p>This works as we require but it&#8217;s not always the best way to do this with Groovy. Groovy&#8217;s safe-dereference operator (<code>?.</code>) operator and null aware closures often allow Groovy to avoid the need to create a special null object or null class. This is illustrated by examining a groovier way to write the above example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">people &lt;&lt; new Person(name:'Harry')
biggestSalary = people.collect { p -&gt; p.job?.salary }.max()
println biggestSalary</code></pre>
</div>
</div>
<div class="paragraph">
<p>Two things are going on here to allow this to work. First of all, <code>max()</code> is <em>'null aware&#8217;</em> so that <code>[300, null, 400].max() == 400</code>. Secondly, with the <code>?.</code> operator, an expression like <code>p?.job?.salary</code> will be equal to null if <code>salary</code> is equal to null, or if <code>job</code> is equal to null or if <code>p</code> is equal to null. You don&#8217;t need to code a complex nested <code>if &#8230; then &#8230; else</code> to avoid a <code>NullPointerException</code>.</p>
</div>
</div>
<div class="sect5">
<h6 id="_tree_example">Tree Example</h6>
<div class="paragraph">
<p>Consider the following example where we want to calculate size, cumulative sum and cumulative product of all the values in a tree structure.</p>
</div>
<div class="paragraph">
<p>Our first attempt has special logic within the calculation methods to handle null values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class NullHandlingTree {
    def left, right, value

    def size() {
        1 + (left ? left.size() : 0) + (right ? right.size() : 0)
    }

    def sum() {
       value + (left ? left.sum() : 0) + (right ? right.sum() : 0)
    }

    def product() {
       value * (left ? left.product() : 1) * (right ? right.product() : 1)
    }
}

def root = new NullHandlingTree(
    value: 2,
    left: new NullHandlingTree(
        value: 3,
        right: new NullHandlingTree(value: 4),
        left: new NullHandlingTree(value: 5)
    )
)

println root.size()
println root.sum()
println root.product()</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we introduce the null object pattern (here by defining the <code>NullTree</code> class), we can now simplify the logic in the <code>size()</code>, <code>sum()</code> and <code>product()</code> methods. These methods now much more clearly represent the logic for the normal (and now universal) case. Each of the methods within <code>NullTree</code> returns a value which represents doing nothing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Tree {
    def left = new NullTree(), right = new NullTree(), value

    def size() {
        1 + left.size() + right.size()
    }

    def sum() {
       value + left.sum() + right.sum()
    }

    def product() {
       value * left.product() * right.product()
    }
}

class NullTree {
    def size() { 0 }
    def sum() { 0 }
    def product() { 1 }
}

def root = new Tree(
    value: 2,
    left: new Tree(
        value: 3,
        right: new Tree(value: 4),
        left: new Tree(value: 5)
    )
)

println root.size()
println root.sum()
println root.product()</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result of running either of these examples is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>4
14
120</pre>
</div>
</div>
<div class="paragraph">
<p>Note: a slight variation with the null object pattern is to combine it with the singleton pattern. So, we wouldn&#8217;t write <code>new NullTree()</code> wherever we needed a null object as shown above. Instead we would have a single null object instance which we would place within our data structures as needed.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_pimp_my_library_pattern">Pimp my Library Pattern</h5>
<div class="paragraph">
<p>The <a href="http://www.artima.com/weblogs/viewpost.jsp?thread=179766">Pimp my Library</a> Pattern suggests an approach for extending a library that nearly does everything that you need but just needs a little more. It assumes that you do not have source code for the library of interest.</p>
</div>
<div class="sect5">
<h6 id="_example_6">Example</h6>
<div class="paragraph">
<p>Suppose we want to make use of the built-in Integer facilities in Groovy (which build upon the features already in Java). Those libraries have nearly all of the features we want but not quite everything. We may not have all of the source code to the Groovy and Java libraries so we can&#8217;t just change the library. Instead we augment the library. Groovy has a number of ways to do this. One way is to use a Category.</p>
</div>
<div class="paragraph">
<p>First, we&#8217;ll define a suitable category.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class EnhancedInteger {
    static boolean greaterThanAll(Integer self, Object[] others) {
        greaterThanAll(self, others)
    }
    static boolean greaterThanAll(Integer self, others) {
        others.every { self &gt; it }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have added two methods which augment the Integer methods by providing the <code>greaterThanAll</code> method. Categories follow conventions where they are defined as static methods with a special first parameter representing the class we wish to extend. The <code>greaterThanAll(Integer self, others)</code> static method becomes the <code>greaterThanAll(other)</code> instance method.</p>
</div>
<div class="paragraph">
<p>We defined two versions of <code>greaterThanAll</code>. One which works for collections, ranges etc. The other which works with a variable number of <code>Integer</code> arguments.</p>
</div>
<div class="paragraph">
<p>Here is how you would use the category.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">use(EnhancedInteger) {
    assert 4.greaterThanAll(1, 2, 3)
    assert !5.greaterThanAll(2, 4, 6)
    assert 5.greaterThanAll(-4..4)
    assert 5.greaterThanAll([])
    assert !5.greaterThanAll([4, 5])
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, using this technique you can effectively enrich an original class without having access to its source code. Moreover, you can apply different enrichments in different parts of the system as well as work with un-enriched objects if we need to.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_proxy_pattern">Proxy Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/Proxy_pattern">Proxy Pattern</a> allows one object to act as a pretend replacement for some other object. In general, whoever is using the proxy, doesn&#8217;t realise that they are not using the real thing. The pattern is useful when the real object is hard to create or use: it may exist over a network connection, or be a large object in memory, or be a file, database or some other resource that is expensive or impossible to duplicate.</p>
</div>
<div class="sect5">
<h6 id="_example_7">Example</h6>
<div class="paragraph">
<p>One common use of the proxy pattern is when talking to remote objects in a different JVM. Here is the client code for creating a proxy that talks via sockets to a server object as well as an example usage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class AccumulatorProxy {
    def accumulate(args) {
        def result
        def s = new Socket("localhost", 54321)
        s.withObjectStreams { ois, oos -&gt;
            oos &lt;&lt; args
            result = ois.readObject()
        }
        s.close()
        return result
    }
}

println new AccumulatorProxy().accumulate([1, 2, 3, 4, 5, 6, 7, 8, 9, 10])
// =&gt; 55</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is what your server code might look like (start this first):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Accumulator {
    def accumulate(args) {
        args.inject(0) { total, arg -&gt; total += arg }
    }
}

def port = 54321
def accumulator = new Accumulator()
def server = new ServerSocket(port)
println "Starting server on port $port"
while(true) {
    server.accept() { socket -&gt;
        socket.withObjectStreams { ois, oos -&gt;
            def args = ois.readObject()
            oos &lt;&lt; accumulator.accumulate(args)
        }
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_singleton_pattern">Singleton Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/Singleton_pattern">Singleton Pattern</a> is used to make sure only one object of a particular class is ever created. This can be useful when when exactly one object is needed to coordinate actions across a system; perhaps for efficiency where creating lots of identical objects would be wasteful, perhaps because a particular algorithm needing a single point of control is required or perhaps when an object is used to interact with a non-shareable resource.</p>
</div>
<div class="paragraph">
<p>Weaknesses of the Singleton pattern include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It can reduce reuse. For instance, there are issues if you want to use inheritance with Singletons. If <code>SingletonB</code> extends <code>SingletonA</code>, should there be exactly (at most) one instance of each or should the creation of an object from one of the classes prohibit creation from the other. Also, if you decide both classes can have an instance, how do you override the <code>getInstance()</code> method which is static?</p>
</li>
<li>
<p>It is also hard to test singletons in general because of the static methods but Groovy can support that if required.</p>
</li>
</ul>
</div>
<div class="sect5">
<h6 id="_example_the_classic_java_singleton">Example: The Classic Java Singleton</h6>
<div class="paragraph">
<p>Suppose we wish to create a class for collecting votes. Because getting the right number of votes may be very important, we decide to use the singleton pattern. There will only ever be one <code>VoteCollector</code> object, so it makes it easier for us to reason about that objects creation and use.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class VoteCollector {
    def votes = 0
    private static final INSTANCE = new VoteCollector()
    static getInstance() { return INSTANCE }
    private VoteCollector() { }
    def display() { println "Collector:${hashCode()}, Votes:$votes" }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some points of interest about this code:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it has a private constructor, so no <code>VoteCollector</code> objects can be created in our system (except for the <code>INSTANCE</code> we create)</p>
</li>
<li>
<p>the <code>INSTANCE</code> is also private, so it can&#8217;t be changed once set</p>
</li>
<li>
<p>we haven&#8217;t made the updating of votes thread-safe at this point (it doesn&#8217;t add to this example)</p>
</li>
<li>
<p>the vote collector instance is not lazyily created (if we never reference the class, the instance won&#8217;t be created; however, as soon as we reference the class, the instance will be created even if not needed initially)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We can use this singleton class in some script code as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def collector = VoteCollector.instance
collector.display()
collector.votes++
collector = null

Thread.start{
    def collector2 = VoteCollector.instance
    collector2.display()
    collector2.votes++
    collector2 = null
}.join()

def collector3 = VoteCollector.instance
collector3.display()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we used the instance 3 times. The second usage was even in a different thread (but don&#8217;t try this in a scenario with a new class loader).</p>
</div>
<div class="paragraph">
<p>Running this script yields (your hashcode value will vary):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Collector:15959960, Votes:0
Collector:15959960, Votes:1
Collector:15959960, Votes:2</pre>
</div>
</div>
<div class="paragraph">
<p>Variations to this pattern:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>To support lazy-loading and multi-threading, we could just use the <code>synchronized</code> keyword with the <code>getInstance()</code> method. This has a performance hit but will work.</p>
</li>
<li>
<p>We can consider variations involving double-checked locking and the <code>volatile</code> keyword (for Java 5 and above), but see the limitations of this approach <a href="http://www.ibm.com/developerworks/java/library/j-dcl/index.html">here</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect5">
<h6 id="_example_singleton_via_metaprogramming">Example: Singleton via MetaProgramming</h6>
<div class="paragraph">
<p>Groovy&#8217;s meta-programming capabilities allow concepts like the singleton pattern to be enacted in a far more fundamental way. This example illustrates a simple way to use Groovy&#8217;s meta-programming capabilities to achieve the singleton pattern but not necessarily the most efficient way.</p>
</div>
<div class="paragraph">
<p>Suppose we want to keep track of the total number of calculations that a calculator performs. One way to do that is to use a singleton for the calculator class and keep a variable in the class with the count.</p>
</div>
<div class="paragraph">
<p>First we define some base classes. A <code>Calculator</code> class which performs calculations and records how many such calculations it performs and a <code>Client</code> class which acts as a facade to the calculator.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Calculator {
    private total = 0
    def add(a, b) { total++; a + b }
    def getTotalCalculations() { 'Total Calculations: ' + total }
    String toString() { 'Calc: ' + hashCode() }
}

class Client {
    def calc = new Calculator()
    def executeCalc(a, b) { calc.add(a, b) }
    String toString() { 'Client: ' + hashCode() }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can define and register a <em>MetaClass</em> which intercepts all attempts to create a <code>Calculator</code> object and always provides a pre-created instance instead. We also register this MetaClass with the Groovy system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class CalculatorMetaClass extends MetaClassImpl {
    private static final INSTANCE = new Calculator()
    CalculatorMetaClass() { super(Calculator) }
    def invokeConstructor(Object[] arguments) { return INSTANCE }
}

def registry = GroovySystem.metaClassRegistry
registry.setMetaClass(Calculator, new CalculatorMetaClass())</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we use instances of our <code>Client</code> class from within a script. The client class will attempt to create new instances of the calculator but will always get the singleton.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def client = new Client()
assert 3 == client.executeCalc(1, 2)
println "$client, $client.calc, $client.calc.totalCalculations"

client = new Client()
assert 4 == client.executeCalc(2, 2)
println "$client, $client.calc, $client.calc.totalCalculations"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the result of running this script (your hashcode values may vary):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Client: 7306473, Calc: 24230857, Total Calculations: 1
Client: 31436753, Calc: 24230857, Total Calculations: 2</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_guice_example">Guice Example</h6>
<div class="paragraph">
<p>We can also implement the Singleton Pattern using <a href="http://code.google.com/p/google-guice/">Guice</a>. This example relies on annotations. Annotations are a Groovy 1.1 feature and will need to be run on a Java 5 or above JVM.</p>
</div>
<div class="paragraph">
<p>Consider the Calculator example again.</p>
</div>
<div class="paragraph">
<p>Guice is a Java-oriented framework that supports Interface-Oriented design. Hence we create a <code>Calculator</code> interface first. We can then create our <code>CalculatorImpl</code> implementation and a <code>Client</code> object which our script will interact with. The <code>Client</code> class isn&#8217;t strictly needed for this example but allows us to show that non-singleton instances are the default. Here is the code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grapes([@Grab('aopalliance:aopalliance:1.0'), @Grab('com.google.code.guice:guice:1.0')])
import com.google.inject.*

interface Calculator {
    def add(a, b)
}

class CalculatorImpl implements Calculator {
    private total = 0
    def add(a, b) { total++; a + b }
    def getTotalCalculations() { 'Total Calculations: ' + total }
    String toString() { 'Calc: ' + hashCode() }
}

class Client {
    @Inject Calculator calc
    def executeCalc(a, b) { calc.add(a, b) }
    String toString() { 'Client: ' + hashCode() }
}

def injector = Guice.createInjector (
    [configure: { binding -&gt;
        binding.bind(Calculator)
               .to(CalculatorImpl)
               .asEagerSingleton() } ] as Module
)

def client = injector.getInstance(Client)
assert 3 == client.executeCalc(1, 2)
println "$client, $client.calc, $client.calc.totalCalculations"

client = injector.getInstance(Client)
assert 4 == client.executeCalc(2, 2)
println "$client, $client.calc, $client.calc.totalCalculations"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the <code>@Inject</code> annotation in the <code>Client</code> class. We can always tell right in the source code which fields will be injected.</p>
</div>
<div class="paragraph">
<p>In this example we chose to use an <em>explicit</em> binding. All of our dependencies (ok, only one in this example at the moment) are configured in the binding. The Guide injector knows about the binding and injects the dependencies as required when we create objects. For the singleton pattern to hold, you must always use Guice to create your instances. Nothing shown so far would stop you creating another instance of the calculator manually using <code>new CalculatorImpl()</code> which would of course violate the desired singleton behaviour.</p>
</div>
<div class="paragraph">
<p>In other scenarios (though probably not in large systems), we could choose to express dependencies using annotations, such as the following example shows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grapes([@Grab('aopalliance:aopalliance:1.0'), @Grab('com.google.code.guice:guice:1.0')])
import com.google.inject.*

@ImplementedBy(CalculatorImpl)
interface Calculator {
    // as before ...
}

@Singleton
class CalculatorImpl implements Calculator {
    // as before ...
}

class Client {
    // as before ...
}

def injector = Guice.createInjector()

// ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note the <code>@Singleton</code> annotation on the <code>CalculatorImpl</code> class and the <code>@ImplementedBy</code> annotation in the <code>Calculator</code> interface.</p>
</div>
<div class="paragraph">
<p>When run, the above example (using either approach) yields (your hashcode values will vary):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Client: 8897128, Calc: 17431955, Total Calculations: 1
Client: 21145613, Calc: 17431955, Total Calculations: 2</pre>
</div>
</div>
<div class="paragraph">
<p>You can see that we obtained a new client object whenever we asked for an instance but it was injected with the same calculator object.</p>
</div>
</div>
<div class="sect5">
<h6 id="_spring_example_2">Spring Example</h6>
<div class="paragraph">
<p>We can do the Calculator example again using Spring as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">@Grapes([@Grab('org.springframework:spring-core:3.2.2.RELEASE'), @Grab('org.springframework:spring-beans:3.2.2.RELEASE')])
import org.springframework.beans.factory.support.*

interface Calculator {
    def add(a, b)
}

class CalculatorImpl implements Calculator {
    private total = 0
    def add(a, b) { total++; a + b }
    def getTotalCalculations() { 'Total Calculations: ' + total }
    String toString() { 'Calc: ' + hashCode() }
}

class Client {
    Client(Calculator calc) { this.calc = calc }
    def calc
    def executeCalc(a, b) { calc.add(a, b) }
    String toString() { 'Client: ' + hashCode() }
}

// Here we 'wire' up our dependencies through the API. Alternatively,
// we could use XML-based configuration or the Grails Bean Builder DSL.
def factory = new DefaultListableBeanFactory()
factory.registerBeanDefinition('calc', new RootBeanDefinition(CalculatorImpl))
def beanDef = new RootBeanDefinition(Client, false)
beanDef.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_AUTODETECT)
factory.registerBeanDefinition('client', beanDef)

def client = factory.getBean('client')
assert 3 == client.executeCalc(1, 2)
println "$client, $client.calc, $client.calc.totalCalculations"

client = factory.getBean('client')
assert 4 == client.executeCalc(2, 2)
println "$client, $client.calc, $client.calc.totalCalculations"</code></pre>
</div>
</div>
<div class="paragraph">
<p>And here is the result (your hashcode values will vary):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Client: 29418586, Calc: 10580099, Total Calculations: 1
Client: 14800362, Calc: 10580099, Total Calculations: 2</pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_further_information">Further information</h6>
<div class="ulist">
<ul>
<li>
<p><a href="http://www.javaworld.com/javaworld/jw-04-2003/jw-0425-designpatterns.html?page=1">Simply Singleton</a></p>
</li>
<li>
<p><a href="http://www.ibm.com/developerworks/webservices/library/co-single/index.html">Use your singletons wisely</a></p>
</li>
<li>
<p><a href="http://www.ibm.com/developerworks/java/library/j-dcl/index.html">Double-checked locking and the Singleton pattern</a></p>
</li>
<li>
<p><a href="http://crazybob.org/2007/01/lazy-loading-singletons.html">Lazy Loading Singletons</a></p>
</li>
<li>
<p><a href="http://www.yoda.arachsys.com/csharp/singleton.html">Implementing the Singleton Pattern in C#</a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_state_pattern">State Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/State_pattern">State Pattern</a> provides a structured approach to partitioning the behaviour within complex systems. The overall behaviour of a system is partitioned into well-defined states. Typically, each state is implemented by a class. The overall system behaviour can be determined firstly by knowing the <em>current state</em> of the system; secondly, by understanding the behaviour possible while in that state (as embodied in the methods of the class corresponding to that state).</p>
</div>
<div class="sect5">
<h6 id="_example_8">Example</h6>
<div class="paragraph">
<p>Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Client {
    def context = new Context()
    def connect() {
        context.state.connect()
    }
    def disconnect() {
        context.state.disconnect()
    }
    def send_message(message) {
        context.state.send_message(message)
    }
    def receive_message() {
        context.state.receive_message()
    }
}

class Context {
    def state = new Offline(this)
}

class ClientState {
    def context
    ClientState(context) {
        this.context = context
        inform()
    }
}

class Offline extends ClientState {
    Offline(context) {
        super(context)
    }
    def inform() {
        println "offline"
    }
    def connect() {
        context.state = new Online(context)
    }
    def disconnect() {
        println "error: not connected"
    }
    def send_message(message) {
        println "error: not connected"
    }
    def receive_message() {
        println "error: not connected"
    }
}

class Online extends ClientState {
    Online(context) {
        super(context)
    }
    def inform() {
        println "connected"
    }
    def connect() {
        println "error: already connected"
    }
    def disconnect() {
        context.state = new Offline(context)
    }
    def send_message(message) {
        println "\"$message\" sent"
    }
    def receive_message() {
        println "message received"
    }
}

client = new Client()
client.send_message("Hello")
client.connect()
client.send_message("Hello")
client.connect()
client.receive_message()
client.disconnect()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>offline
error: not connected
connected
"Hello" sent
error: already connected
message received
offline</pre>
</div>
</div>
<div class="paragraph">
<p>One of the great things about a dynamic language like Groovy though is that we can take this example and express it in many different ways depending on our particular needs. Some potential variations for this example are shown below.</p>
</div>
</div>
<div class="sect5">
<h6 id="_variation_1_leveraging_interface_oriented_design">Variation 1: Leveraging Interface-Oriented Design</h6>
<div class="paragraph">
<p>One approach we could take is to leverage <a href="http://www.pragmaticprogrammer.com/titles/kpiod/index.html">Interface-Oriented Design</a>. To do this, we could introduce the following interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">interface State {
    def connect()
    def disconnect()
    def send_message(message)
    def receive_message()
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then our <code>Client</code>, <code>Online</code> and <code>Offline</code> classes could be modified to implement that interface, e.g.:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Client implements State {
  // ... as before ...
}

class Online implements State {
  // ... as before ...
}

class Offline implements State {
  // ... as before ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You might ask: Haven&#8217;t we just introduced additional boilerplate code? Can&#8217;t we rely on duck-typing for this? The answer is <em>yes</em> and <em>no</em>. We can get away with duck-typing but one of the key intentions of the state pattern is to partition complexity. If we know that the <em>client</em> class and each <em>state</em> class all satisfy one interface, then we have placed some key boundaries around the complexity. We can look at any state class in isolation and know the bounds of behaviour possible for that state.</p>
</div>
<div class="paragraph">
<p>We don&#8217;t have to use interfaces for this, but it helps express the intent of this particular style of partitioning and it helps reduce the size of our unit tests (we would have to have additional tests in place to express this intent in languages which have less support for interface-oriented design).</p>
</div>
</div>
<div class="sect5">
<h6 id="_variation_2_extract_state_pattern_logic">Variation 2: Extract State Pattern Logic</h6>
<div class="paragraph">
<p>Alternatively, or in combination with other variations, we might decide to extract some of our State Pattern logic into helper classes. For example, we could define the following classes in a state pattern package/jar/script:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">abstract class InstanceProvider {
    static def registry = GroovySystem.metaClassRegistry
    static def create(objectClass, param) {
        registry.getMetaClass(objectClass).invokeConstructor([param] as Object[])
    }
}

abstract class Context {
    private context
    protected setContext(context) {
        this.context = context
    }
    def invokeMethod(String name, Object arg) {
        context.invokeMethod(name, arg)
    }
    def startFrom(initialState) {
        setContext(InstanceProvider.create(initialState, this))
    }
}

abstract class State {
    private client

    State(client) { this.client = client }

    def transitionTo(nextState) {
        client.setContext(InstanceProvider.create(nextState, client))
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is all quite generic and can be used wherever we want to introduce the state pattern. Here is what our code would look like now:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Client extends Context {
    Client() {
        startFrom(Offline)
    }
}

class Offline extends State {
    Offline(client) {
        super(client)
        println "offline"
    }
    def connect() {
        transitionTo(Online)
    }
    def disconnect() {
        println "error: not connected"
    }
    def send_message(message) {
        println "error: not connected"
    }
    def receive_message() {
        println "error: not connected"
    }
}

class Online extends State {
    Online(client) {
        super(client)
        println "connected"
    }
    def connect() {
        println "error: already connected"
    }
    def disconnect() {
        transitionTo(Offline)
    }
    def send_message(message) {
        println "\"$message\" sent"
    }
    def receive_message() {
        println "message received"
    }
}

client = new Client()
client.send_message("Hello")
client.connect()
client.send_message("Hello")
client.connect()
client.receive_message()
client.disconnect()</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can see here the <code>startFrom</code> and <code>transitionTo</code> methods begin to give our example code a DSL feel.</p>
</div>
</div>
<div class="sect5">
<h6 id="_variation_3_bring_on_the_dsl">Variation 3: Bring on the DSL</h6>
<div class="paragraph">
<p>Alternatively, or in combination with other variations, we might decide to fully embrace a Domain Specific Language (DSL) approach to this example.</p>
</div>
<div class="paragraph">
<p>We can define the following generic helper functions (first discussed <a href="http://www.bytemycode.com/snippets/snippet/640/">here</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class Grammar {
    def fsm

    def event
    def fromState
    def toState

    Grammar(a_fsm) {
        fsm = a_fsm
    }

    def on(a_event) {
        event = a_event
        this
    }

    def on(a_event, a_transitioner) {
        on(a_event)
        a_transitioner.delegate = this
        a_transitioner.call()
        this
    }

    def from(a_fromState) {
        fromState = a_fromState
        this
    }

    def to(a_toState) {
        assert a_toState, "Invalid toState: $a_toState"
        toState = a_toState
        fsm.registerTransition(this)
        this
    }

    def isValid() {
        event &amp;&amp; fromState &amp;&amp; toState
    }

    public String toString() {
        "$event: $fromState=&gt;$toState"
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class FiniteStateMachine {
    def transitions = [:]

    def initialState
    def currentState

    FiniteStateMachine(a_initialState) {
        assert a_initialState, "You need to provide an initial state"
        initialState = a_initialState
        currentState = a_initialState
    }

    def record() {
        Grammar.newInstance(this)
    }

    def reset() {
        currentState = initialState
    }

    def isState(a_state) {
        currentState == a_state
    }

    def registerTransition(a_grammar) {
        assert a_grammar.isValid(), "Invalid transition ($a_grammar)"
        def transition
        def event = a_grammar.event
        def fromState = a_grammar.fromState
        def toState = a_grammar.toState

        if (!transitions[event]) {
            transitions[event] = [:]
        }

        transition = transitions[event]
        assert !transition[fromState], "Duplicate fromState $fromState for transition $a_grammar"
        transition[fromState] = toState
    }

    def fire(a_event) {
        assert currentState, "Invalid current state '$currentState': passed into constructor"
        assert transitions.containsKey(a_event), "Invalid event '$a_event', should be one of ${transitions.keySet()}"
        def transition = transitions[a_event]
        def nextState = transition[currentState]
        assert nextState, "There is no transition from '$currentState' to any other state"
        currentState = nextState
        currentState
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can define and test our state machine like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class StatePatternDslTest extends GroovyTestCase {
    private fsm

    protected void setUp() {
        fsm = FiniteStateMachine.newInstance('offline')
        def recorder = fsm.record()
        recorder.on('connect').from('offline').to('online')
        recorder.on('disconnect').from('online').to('offline')
        recorder.on('send_message').from('online').to('online')
        recorder.on('receive_message').from('online').to('online')
    }

    void testInitialState() {
        assert fsm.isState('offline')
    }

    void testOfflineState() {
        shouldFail{
            fsm.fire('send_message')
        }
        shouldFail{
            fsm.fire('receive_message')
        }
        shouldFail{
            fsm.fire('disconnect')
        }
        assert 'online' == fsm.fire('connect')
    }

    void testOnlineState() {
        fsm.fire('connect')
        fsm.fire('send_message')
        fsm.fire('receive_message')
        shouldFail{
            fsm.fire('connect')
        }
        assert 'offline' == fsm.fire('disconnect')
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This example isn&#8217;t an exact equivalent of the others. It doesn&#8217;t use predefined <code>Online</code> and <code>Offline</code> classes. Instead it defines the entire state machine on the fly as needed. See the <a href="http://www.bytemycode.com/snippets/snippet/640/">previous reference</a> for more elaborate examples of this style.</p>
</div>
<div class="paragraph">
<p>See also: <a href="userGuides.html#_model_based_testing_using_modeljunit">Model-based testing using ModelJUnit</a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_strategy_pattern">Strategy Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/Strategy_pattern">Strategy Pattern</a> allows you to abstract away particular algorithms from their usage. This allows you to easily swap the algorithm being used without having to change the calling code. The general form of the pattern is:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../assets/img/StrategyClasses.gif" alt="StrategyClasses">
</div>
</div>
<div class="paragraph">
<p>In Groovy, because of its ability to treat code as a first class object using anonymous methods (which we loosely call <em>Closures</em>), the need for the strategy pattern is greatly reduced. You can simply place algorithms inside Closures.</p>
</div>
<div class="sect5">
<h6 id="_example_9">Example</h6>
<div class="paragraph">
<p>First let&#8217;s look at the traditional way of encapsulating the Strategy Pattern.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">interface Calc {
    def execute(n, m)
}

class CalcByMult implements Calc {
    def execute(n, m) { n * m }
}

class CalcByManyAdds implements Calc {
    def execute(n, m) {
        def result = 0
        n.times{
            result += m
        }

        result
    }
}

def sampleData = [
    [3, 4, 12],
    [5, -5, -25]
]

Calc[] multiplicationStrategies = [
    new CalcByMult(),
    new CalcByManyAdds()
]

sampleData.each{ data -&gt;
    multiplicationStrategies.each { calc -&gt;
        assert data[2] == calc.execute(data[0], data[1])
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here we have defined an interface <code>Calc</code> which our concrete strategy classes will implement (we could also have used an abstract class). We then defined two algorithms for doing simple multiplication: <code>CalcByMult</code> the normal way, and <code>CalcByManyAdds</code> using only addition (don&#8217;t try this one using negative numbers - yes we could fix this but it would just make the example longer). We then use normal <a href="http://en.wikipedia.org/wiki/Polymorphism_in_object-oriented_programming">polymorphism</a> to invoke the algorithms.</p>
</div>
<div class="paragraph">
<p>Here is the Groovier way to achieve the same thing using Closures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">def multiplicationStrategies = [
    { n, m -&gt; n * m },
    { n, m -&gt; def result = 0; n.times{ result += m }; result }
]

def sampleData = [
    [3, 4, 12],
    [5, -5, -25]
]

sampleData.each{ data -&gt;
    multiplicationStrategies.each { calc -&gt;
        assert data[2] == calc(data[0], data[1])
    }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_template_method_pattern">Template Method Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/Template_method_pattern">Template Method Pattern</a> abstracts away the details of several algorithms. The generic part of an algorithm is contained within a base class. Particular implementation details are captured within base classes. The generic pattern of classes involved looks like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../assets/img/TemplateMethodClasses.gif" alt="TemplateMethodClasses">
</div>
</div>
<div class="sect5">
<h6 id="_example_10">Example</h6>
<div class="paragraph">
<p>In this example, <code>Accumulator</code> captures the essence of the accumulation algorithm. The base classes <code>Sum</code> and <code>Product</code> provide particular customised ways to use the generic accumulation algorithm.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">abstract class Accumulator {
    protected initial
    abstract doAccumulate(total, v)
    def accumulate(values) {
        def total = initial
        values.each { v -&gt; total = doAccumulate(total, v) }
        total
    }
}

class Sum extends Accumulator {
    def Sum() { initial = 0 }
    def doAccumulate(total, v) { total + v }
}

class Product extends Accumulator {
    def Product() { initial = 1 }
    def doAccumulate(total, v) { total * v }
}

println new Sum().accumulate([1,2,3,4])
println new Product().accumulate([1,2,3,4])</code></pre>
</div>
</div>
<div class="paragraph">
<p>The resulting output is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>10
24</pre>
</div>
</div>
<div class="paragraph">
<p>In this particular case, you could use Groovy&#8217;s inject method to achieve a similar result using Closures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">Closure addAll = { total, item -&gt; total += item }
def accumulated = [1, 2, 3, 4].inject(0, addAll)
println accumulated    // =&gt; 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>Thanks to duck-typing, this would also work with other objects which support an add (plus() in Groovy) method, e.g.:</p>
</div>
<div class="paragraph">
<p>In this particular case, you could use Groovy&#8217;s inject method to achieve a similar result using Closures:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">accumulated = [ "1", "2", "3", "4" ].inject("", addAll)
println accumulated    // =&gt; "1234"</code></pre>
</div>
</div>
<div class="paragraph">
<p>We could also do the multiplication case as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">Closure multAll = { total, item -&gt; total *= item }
accumulated = [1, 2, 3, 4].inject(1, multAll)
println accumulated    // =&gt; 24</code></pre>
</div>
</div>
<div class="paragraph">
<p>Using closures this way looks more like the <a href="userGuides.html#_strategy_pattern">Strategy Pattern</a> but if we realise that the built-in <code>inject</code> method is the generic part of the algorithm for our template method, then the Closures become the customised parts of the template method pattern.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_visitor_pattern">Visitor Pattern</h5>
<div class="paragraph">
<p>The <a href="http://en.wikipedia.org/wiki/Visitor_pattern">Visitor Pattern</a> is one of those well-known but not often used patterns. I think this is strange, as it is really a nice thing.</p>
</div>
<div class="paragraph">
<p>The goal of the pattern is to separate an algorithm from an object structure. A practical result of this separation is the ability to add new operations to existing object structures without modifying those structures.</p>
</div>
<div class="sect5">
<h6 id="_simple_example_2">Simple Example</h6>
<div class="paragraph">
<p>This example considers how to calculate the bounds of shapes (or collections of shapes). Our first attempt uses the traditional visitor pattern. We will see a more Groovy way to do this shortly.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">abstract class Shape { }

class Rectangle extends Shape {
    def x, y, width, height

    Rectangle(x, y, width, height) {
        this.x = x; this.y = y; this.width = width; this.height = height
    }

    def union(rect) {
        if (!rect) return this
        def minx = [rect.x, x].min()
        def maxx = [rect.x + width, x + width].max()
        def miny = [rect.y, y].min()
        def maxy = [rect.y + height, y + height].max()
        new Rectangle(minx, miny, maxx - minx, maxy - miny)
    }

    def accept(visitor) {
        visitor.visit_rectangle(this)
    }
}

class Line extends Shape {
    def x1, y1, x2, y2

    Line(x1, y1, x2, y2) {
        this.x1 = x1; this.y1 = y1; this.x2 = x2; this.y2 = y2
    }

    def accept(visitor){
        visitor.visit_line(this)
    }
}

class Group extends Shape {
    def shapes = []
    def add(shape) { shapes += shape }
    def remove(shape) { shapes -= shape }
    def accept(visitor) {
        visitor.visit_group(this)
    }
}

class BoundingRectangleVisitor {
    def bounds

    def visit_rectangle(rectangle) {
        if (bounds)
            bounds = bounds.union(rectangle)
        else
            bounds = rectangle
    }

    def visit_line(line) {
        def line_bounds = new Rectangle(line.x1, line.y1, line.x2-line.y1, line.x2-line.y2)
        if (bounds)
            bounds = bounds.union(line_bounds)
        else
            bounds = line_bounds
    }

    def visit_group(group) {
        group.shapes.each { shape -&gt; shape.accept(this) }
    }
}

def group = new Group()
group.add(new Rectangle(100, 40, 10, 5))
group.add(new Rectangle(100, 70, 10, 5))
group.add(new Line(90, 30, 60, 5))
def visitor = new BoundingRectangleVisitor()
group.accept(visitor)
bounding_box = visitor.bounds
println bounding_box.dump()</code></pre>
</div>
</div>
<div class="paragraph">
<p>That took quite a bit of code.</p>
</div>
<div class="paragraph">
<p>We can improve the clarity of our code (and make it about half the size) by making use of Groovy Closures as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">abstract class Shape {
    def accept(Closure yield) { yield(this) }
}

class Rectangle extends Shape {
    def x, y, w, h
    def bounds() { this }
    def union(rect) {
        if (!rect) return this
        def minx = [ rect.x, x ].min()
        def maxx = [ rect.x + w, x + w ].max()
        def miny = [ rect.y, y ].min()
        def maxy = [ rect.y + h, y + h ].max()
        new Rectangle(x:minx, y:miny, w:maxx - minx, h:maxy - miny)
    }
}

class Line extends Shape {
    def x1, y1, x2, y2
    def bounds() {
        new Rectangle(x:[x1, x2].min(), y:[y1, y2].min(), w:(x2 - x1).abs(), h:(y2 - y1).abs())
    }
}

class Group {
    def shapes = []
    def leftShift(shape) { shapes += shape }
    def accept(Closure yield) { shapes.each{it.accept(yield)} }
}

def group = new Group()
group &lt;&lt; new Rectangle(x:100, y:40, w:10, h:5)
group &lt;&lt; new Rectangle(x:100, y:70, w:10, h:5)
group &lt;&lt; new Line(x1:90, y1:30, x2:60, y2:5)
def bounds
group.accept{ bounds = it.bounds().union(bounds) }
println bounds.dump()</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_advanced_example">Advanced Example</h6>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">interface Visitor {
    void visit(NodeType1 n1)
    void visit(NodeType2 n2)
}

interface Visitable {
    void accept(Visitor visitor)
}

class NodeType1 implements Visitable {
    Visitable[] children = new Visitable[0]
    void accept(Visitor visitor) {
        visitor.visit(this)
        for(int i = 0; i &lt; children.length; ++i) {
            children[i].accept(visitor)
        }
    }
}

class NodeType2 implements Visitable {
    Visitable[] children = new Visitable[0]
    void accept(Visitor visitor) {
        visitor.visit(this)
        for(int i = 0; i &lt; children.length; ++i) {
            children[i].accept(visitor)
        }
    }
}

class NodeType1Counter implements Visitor {
    int count = 0
    void visit(NodeType1 n1) {
        count++
    }
    void visit(NodeType2 n2){}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we now use <code>NodeType1Counter</code> on a tree like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">NodeType1 root = new NodeType1()
root.children = new Visitable[2]
root.children[0] = new NodeType1()
root.children[1] = new NodeType2()</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then we have one <code>NodeType1</code> object as root and one of the children is also a <code>NodeType1</code> instance. The other child is a <code>NodeType2</code> instance. That means using <code>NodeType1Counter</code> here should count 2 <code>NodeType1</code> objects.</p>
</div>
<div class="sect6">
<h7 id="_why_to_use_this">Why to use this</h7>
<div class="paragraph">
<p>As you can see here very good we have a visitor that has a state while the tree of objects is not changed. That&#8217;s pretty useful in different areas, for example you could have a visitor counting all node types, or how many different types are used, or you could use methods special to the node to gather information about the tree and much more.</p>
</div>
</div>
<div class="sect6">
<h7 id="_what_happens_if_we_add_a_new_type">What happens if we add a new type?</h7>
<div class="paragraph">
<p>In this case we have to do much work.. we have to change Visitor to accept the new type, we have to write the new type itself of course and we have to change every Visitor we have already implemented. After very few changes you will modify all your Visitors to extend a default implementation of the visitor, so you don&#8217;t need to change every Visitor each time you add a new type.</p>
</div>
</div>
<div class="sect6">
<h7 id="_what_if_we_want_to_have_different_iteration_patterns">What if we want to have different iteration patterns?</h7>
<div class="paragraph">
<p>Then you have a problem. since the node describes how to iterate, you have no influence and stop iteration at a point or change the order. So maybe we should change this a little to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">interface Visitor {
    void visit(NodeType1 n1)
    void visit(NodeType2 n2)
}

class DefaultVisitor implements Visitor{
    void visit(NodeType1 n1) {
        for(int i = 0; i &lt; n1.children.length; ++i) {
            n1.children[i].accept(this)
        }
    }
    void visit(NodeType2 n2) {
        for(int i = 0; i &lt; n2.children.length; ++i) {
            n2.children[i].accept(this)
        }
    }
}

interface Visitable {
    void accept(Visitor visitor)
}

class NodeType1 implements Visitable {
    Visitable[] children = new Visitable[0]
    void accept(Visitor visitor) {
        visitor.visit(this)
    }
}

class NodeType2 implements Visitable {
    Visitable[] children = new Visitable[0];
    void accept(Visitor visitor) {
        visitor.visit(this)
    }
}

class NodeType1Counter extends DefaultVisitor {
    int count = 0
    void visit(NodeType1 n1) {
        count++
        super.visit(n1)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some small changes but with big effect&#8230; the visitor is now recursive and tells me how to iterate. The implementation in the Nodes is minimized to <code>visitor.visit(this)</code>, <code>DefaultVisitor</code> is now able to catch the new types, we can stop iteration by not delegating to super. Of course the big disadvantage now is that it is no longer iterative, but you can&#8217;t get all the benefits.</p>
</div>
</div>
<div class="sect6">
<h7 id="_make_it_groovy">Make it Groovy</h7>
<div class="paragraph">
<p>The question now is how to make that a bit more Groovy. Didn&#8217;t you find this <code>visitor.visit(this)</code> strange? Why is it there? The answer is to simulate double dispatch. In Java the compile time type is used, so when I <code>visitor.visit(children[i])</code> then the compiler won&#8217;t be able to find the correct method, because <code>Visitor</code> does not contain a method <code>visit(Visitable)</code>. And even if it would, we would like to visit the more special methods with <code>NodeType1</code> or <code>NodeType2</code>.</p>
</div>
<div class="paragraph">
<p>Now Groovy is not using the static type, Groovy uses the runtime type. This means I could do <code>visitor.visit(children[i])</code> directly. Hmm.. since we minimized the accept method to just do the double dispatch part and since the runtime type system of Groovy will already cover that.. do we need the accept method? I think you can guess that I would answer no. But we can do more. We had the disadvantage of not knowing how to handle unknown tree elements. We had to extends the interface <code>Visitor</code> for that, resulting in changes to <code>DefaultVisitor</code> and then we have the task to provide a useful default like iterating the node or not doing anything at all. Now with Groovy we can catch that case by adding a <code>visit(Visitable)</code> method that does nothing. That would be the same in Java btw.</p>
</div>
<div class="paragraph">
<p>But don&#8217;t let us stop here&#8230; do we need the Visitor interface? If we don&#8217;t have the accept method, then we don&#8217;t need the <code>Visitor</code> interface at all. So the new code would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class DefaultVisitor {
    void visit(NodeType1 n1) {
        n1.children.each { visit(it) }
    }
    void visit(NodeType2 n2) {
        n2.children.each { visit(it) }
    }
    void visit(Visitable v) { }
}

interface Visitable { }

class NodeType1 implements Visitable {
    Visitable[] children = []
}

class NodeType2 implements Visitable {
    Visitable[] children = []
}

class NodeType1Counter extends DefaultVisitor {
    int count = 0
    void visit(NodeType1 n1) {
        count++
        super.visit(n1)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Looks like we saved a few lines of code here. But we made more. The Visitable nodes now do not refer to any <code>Visitor</code> class or interface. For me this is the best level of separation you could get here. But do we really need to stop here? No. Let us change the <code>Visitable</code> interface a little and let it return the children we want to visit next. This allows us a general iteration method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint"><code class="groovy language-groovy">class DefaultVisitor {
    void visit(Visitable v) {
        doIteraton(v)
    }
    void doIteraton(Visitable v) {
        v.children.each {
            visit(it)
        }
    }
}

interface Visitable {
    Visitable[] getChildren()
}

class NodeType1 implements Visitable {
    Visitable[] children = []
}

class NodeType2 implements Visitable {
    Visitable[] children = []
}

class NodeType1Counter extends DefaultVisitor {
    int count = 0
    void visit(NodeType1 n1) {
        count++
        super.visit(n1)
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>DefaultVisitor</code> now looks a bit different. I added a <code>doIteration</code> method that will get the children it should iterate over and then call visit on each element. Per default this will call <code>visit(Visitable)</code> which then iterates over the children of this child. I changed <code>Visitable</code> to ensure that any node will be able to return children (even if empty). I didn&#8217;t have to change the <code>NodeType1</code> and <code>NodeType2</code> class, because the way the children filed was defined already made them a property, which means Groovy is so nice to generate a get method for us. No the really interesting part is <code>NodeType1Counter</code>, it is interesting because we have not changed it. <code>super.visit(n1)</code> will now call <code>visit(Visitable)</code> which will call <code>doIteration</code> which will start the next level of iteration. So no change. But <code>visit(it)</code> will call <code>visit(NodeType1)</code> if it is of type <code>NodeType1</code>. In fact we don&#8217;t need the <code>doIteration</code> method, we could do that in <code>visit(Visitable)</code> too, but I thought this variant is better, because it allows us to write a new <code>Visitor</code> that overwrites visit(<code>Visitable</code>) for error cases which of course means we must not do <code>super.visit(n1)</code> but <code>doIteration(n1)</code>.</p>
</div>
</div>
<div class="sect6">
<h7 id="_summary">Summary</h7>
<div class="paragraph">
<p>In the end we got ~40% less code, a robust and stable architecture and we completely removed the Visitor from the Visitable. I heard about visitor implementations based on Reflection to get a more generic version. Well, with this you see there is really no need to do such thing. If we add new types we don&#8217;t need to change anything. It is said that the visitor pattern doesn&#8217;t fit extreme programming techniques very well because you need to make changes to so many classes all the time. I think I proved that this is because of Java not because the pattern is bad or something.</p>
</div>
<div class="paragraph">
<p>There are variants of the Visitor pattern, like the acyclic visitor pattern, that tries to solve the problem of adding new node types with special visitors. I don&#8217;t like that very much, it works with casts, catches the <code>ClassCastException</code> and other nasty things. In the end it tries to solve something we don&#8217;t even get with the Groovy version.</p>
</div>
<div class="paragraph">
<p>One more thing. <code>NodeType1Counter</code> could be implemented in Java as well. Groovy will recognize the visit methods and call them as needed because <code>DefaultVisitor</code> is still Groovy and does all the magic.</p>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_further_information_2">Further Information</h6>
<div class="ulist">
<ul>
<li>
<p><a href="http://se.ethz.ch/~meyer/publications/computer/visitor.pdf">Componentization: the Visitor example</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_references">4.15.2. References</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Erich Gamma, Richard Helm, Ralph Johnson, John Vlissides (1995). <em>Design Patterns: Elements of Reusable Object-Oriented Software</em>. Addison-Wesley. ISBN 0-201-63361-2.</p>
<div class="ulist">
<ul>
<li>
<p><em>The canonical reference of design patterns.</em></p>
</li>
</ul>
</div>
</li>
<li>
<p>Martin Fowler (1999). <em>Refactoring: Improving the Design of Existing Code</em>. Addison-Wesley. ISBN 0-201-48567-2.</p>
</li>
<li>
<p>Joshua Kerievsky (2004). <em>Refactoring To Patterns</em>. Addison-Wesley. ISBN 0-321-21335-1.</p>
</li>
<li>
<p>Eric Freeman, Elisabeth Freeman, Kathy Sierra, Bert Bates (2004). <em>Head First Design Patterns</em>. O’Reilly. ISBN 0-596-00712-4.
*<em>A great book to read, informative as well as amusing.</em></p>
</li>
<li>
<p>Dierk Koenig with Andrew Glover, Paul King, Guillaume Laforge and Jon Skeet (2007). <em>Groovy in Action</em>. Manning. ISBN 1-932394-84-2.</p>
<div class="ulist">
<ul>
<li>
<p><em>Discusses Visitor, Builder and other Patterns.</em></p>
</li>
</ul>
</div>
</li>
<li>
<p>Brad Appleton (1999). <a href="http://www.bradapp.com/docs/pizza-inv.html">Pizza Inversion - a Pattern for Efficient Resource Consumption</a>.</p>
<div class="ulist">
<ul>
<li>
<p><em>One of the most frequently used patterns by many software engineers!</em></p>
</li>
</ul>
</div>
</li>
<li>
<p><em>Design Patterns in Dynamic Languages</em> by Neil Ford. Houston Java User’s Group. Examples in Groovy and Ruby. <a href="http://www.hjug.org/present/Neal_Ford-Design_Patterns_in_Dynamic_Languages-slides.pdf">http://www.hjug.org/present/Neal_Ford-Design_Patterns_in_Dynamic_Languages-slides.pdf</a></p>
</li>
</ol>
</div>
<div class="paragraph">
<p>See also: <a href="userGuides.html#_refactoring_bwith_groovy">Refactoring with Groovy</a>.</p>
</div>
</div>
</div>
</div>
</div>

</div>



<div id="footer">
<div id="footer-text">
Version 2.3.6<br>
Last updated 2014-07-28 15:13:29 CEST
</div>
</div>
</body>
</html>